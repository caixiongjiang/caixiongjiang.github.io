<!DOCTYPE html>
<html><head>
<title>Golang 中的 Map 原理</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="Golang 中的 Map 原理" />
<meta property="og:description" content="什么是映射函数 要明白 map 是如何工作的的，我们需要先讨论一下 map 函数。一个 map 函数用以将一个值映射到另一个值。给定一个值，我们叫 key，它就会返回另外一个值，称为 value。
map(key) → value现在，map 还没什么用，除非我们放入一些数据。我们需要一个函数来将数据添加到 map 中
insert(map, key, value)和一个函数从 map 中移除数据
delete(map, key)在实现上还有一些有趣的点比如查询某个 key 当前在 map 中是否存在，但这已经超出了我们今天要讨论的范围。相反我们今天只专注于这几个点；插入，删除和如何将 key 映射到 value。
Go 中的 map 是一个 hashmap Hashmap 是我要讨论的的 map 的一种特定实现，因为这也是 Go runtime 中所采用的实现方式。Hashmap 是一种经典的数据结构，提供了平均 O(1) 的查询时间复杂度，即使在最糟的情况下也有 O(n) 的复杂度。也就是说，正常情况下，执行 map 函数的时间是个常量。
这个常量的大小部分取决于 hashmap 的设计方式，而 map 存取时间从 O(1) 到 O(n) 的变化则取决于它的 hash 函数。
hash 函数 什么是 hash 函数 ？一个 hash 函数用以接收一个未知长度的 key 然后返回一个固定长度的 value。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.riba2534.cn/blog/2019/golang%E4%B8%ADmap%E7%9A%84%E5%8E%9F%E7%90%86/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2019-07-14T17:12:00+08:00" />
<meta property="article:modified_time" content="2019-07-14T17:12:00+08:00" />











<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>


  




<link rel="icon" href="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210427152737.jpeg">



<link rel="stylesheet" href="https://blog.riba2534.cn/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://blog.riba2534.cn/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>


  
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script type="text/javascript" id="MathJax-script"
async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
MathJax.Hub.Queue(function() {



var all = MathJax.Hub.getAllJax(), i;
for(i = 0; i < all.length; i += 1) {
all[i].SourceElement().parentNode.className += ' has-jax';
}
});
</script>

<style>
code.has-jax {
font: inherit;
font-size: 100%;
background: inherit;
border: inherit;
color: #515151;
}
</style>





  
    <script src="/js/toc.js"></script>
  











<script src="https://cdn.jsdelivr.net/npm/twikoo@1.3.1/dist/twikoo.all.min.js"></script>




</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://blog.riba2534.cn/">
    
        <div class="nav-title">
            🌀riba2534&#39;s Blog
        </div>
        
        <div class="nav-subtitle">
            凡事有交代，件件有着落，事事有回音
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/blog">
                文章📖
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                分类📌
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                标签🏷️
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/series">
                系列📚
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/archive">
                归档📃
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                关于👋
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friends">
                友链🔗
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS📢
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<a href="https://blog.csdn.net/riba2534">
    CSDN
</a>
<br>

<a href="https://github.com/riba2534">
    GitHub
</a>
<br>

<a href="https://www.zhihu.com/people/riba2534">
    Zhihu
</a>
<br>

<a href="mailto:riba2534@qq.com">
    Email
</a>
<br>

        <hr>
        
魔改自 <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://blog.riba2534.cn">riba2534</a>
<br>

&copy;
	
	2021 🌀riba2534&#39;s Blog
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%98%a0%e5%b0%84%e5%87%bd%e6%95%b0" onclick="onNavClick(`#什么是映射函数-nav`)" id="什么是映射函数-nav">
									什么是映射函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#go-%e4%b8%ad%e7%9a%84-map-%e6%98%af%e4%b8%80%e4%b8%aa-hashmap" onclick="onNavClick(`#go-中的-map-是一个-hashmap-nav`)" id="go-中的-map-是一个-hashmap-nav">
									Go 中的 map 是一个 hashmap
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#hash-%e5%87%bd%e6%95%b0" onclick="onNavClick(`#hash-函数-nav`)" id="hash-函数-nav">
									hash 函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#hash-%e5%87%bd%e6%95%b0%e7%9a%84%e9%87%8d%e8%a6%81%e7%89%b9%e7%82%b9" onclick="onNavClick(`#hash-函数的重要特点-nav`)" id="hash-函数的重要特点-nav">
									hash 函数的重要特点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#hashmap-%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" onclick="onNavClick(`#hashmap-的数据结构-nav`)" id="hashmap-的数据结构-nav">
									hashmap 的数据结构
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#hashmap-%e7%9a%84%e5%9b%9b%e4%b8%aa%e8%a6%81%e7%82%b9" onclick="onNavClick(`#hashmap-的四个要点-nav`)" id="hashmap-的四个要点-nav">
									hashmap 的四个要点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%85%b6%e4%bb%96%e8%af%ad%e8%a8%80%e4%b8%ad%e7%9a%84-hashmap" onclick="onNavClick(`#其他语言中的-hashmap-nav`)" id="其他语言中的-hashmap-nav">
									其他语言中的 hashmap
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#c" onclick="onNavClick(`#c-nav`)" id="c-nav">
									C&#43;&#43;
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#java" onclick="onNavClick(`#java-nav`)" id="java-nav">
									Java
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%9d%83%e8%a1%a1" onclick="onNavClick(`#权衡-nav`)" id="权衡-nav">
									权衡
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#c-templated" onclick="onNavClick(`#c-templated-nav`)" id="c-templated-nav">
									C&#43;&#43; templated
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bc%98%e7%82%b9" onclick="onNavClick(`#优点-nav`)" id="优点-nav">
									优点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%ba%e7%82%b9" onclick="onNavClick(`#缺点-nav`)" id="缺点-nav">
									缺点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#java-util-hashmap" onclick="onNavClick(`#java-util-hashmap-nav`)" id="java-util-hashmap-nav">
									Java util Hashmap
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bc%98%e7%82%b9-1" onclick="onNavClick(`#优点-1-nav`)" id="优点-1-nav">
									优点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%ba%e7%82%b9-1" onclick="onNavClick(`#缺点-1-nav`)" id="缺点-1-nav">
									缺点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#go-%e4%b8%ad-hashmap-%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#go-中-hashmap-的实现-nav`)" id="go-中-hashmap-的实现-nav">
									Go 中 hashmap 的实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#go-runtime-%e4%bd%bf%e7%94%a8%e4%ba%86-interface-%e5%90%97" onclick="onNavClick(`#go-runtime-使用了-interface-吗-nav`)" id="go-runtime-使用了-interface-吗-nav">
									Go runtime 使用了 interface{} 吗？
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%96%e8%af%91%e5%99%a8%e6%98%af%e5%90%a6%e4%bd%bf%e7%94%a8%e4%ba%86%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90" onclick="onNavClick(`#编译器是否使用了代码生成-nav`)" id="编译器是否使用了代码生成-nav">
									编译器是否使用了代码生成？
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%96%e8%af%91%e6%97%b6%e9%97%b4%e9%87%8d%e5%86%99" onclick="onNavClick(`#编译时间重写-nav`)" id="编译时间重写-nav">
									编译时间重写
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#map-%e4%bb%a3%e7%a0%81%e8%a7%a3%e9%87%8a" onclick="onNavClick(`#map-代码解释-nav`)" id="map-代码解释-nav">
									map 代码解释
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%bb%93%e8%ae%ba" onclick="onNavClick(`#结论-nav`)" id="结论-nav">
									结论
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/blog">
                    文章📖
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    分类📌
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    标签🏷️
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/series">
                    系列📚
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/archive">
                    归档📃
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    关于👋
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friends">
                    友链🔗
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS📢
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%98%a0%e5%b0%84%e5%87%bd%e6%95%b0" onclick="onNavClick(`#什么是映射函数-nav`)" id="什么是映射函数-nav">
									什么是映射函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#go-%e4%b8%ad%e7%9a%84-map-%e6%98%af%e4%b8%80%e4%b8%aa-hashmap" onclick="onNavClick(`#go-中的-map-是一个-hashmap-nav`)" id="go-中的-map-是一个-hashmap-nav">
									Go 中的 map 是一个 hashmap
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#hash-%e5%87%bd%e6%95%b0" onclick="onNavClick(`#hash-函数-nav`)" id="hash-函数-nav">
									hash 函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#hash-%e5%87%bd%e6%95%b0%e7%9a%84%e9%87%8d%e8%a6%81%e7%89%b9%e7%82%b9" onclick="onNavClick(`#hash-函数的重要特点-nav`)" id="hash-函数的重要特点-nav">
									hash 函数的重要特点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#hashmap-%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" onclick="onNavClick(`#hashmap-的数据结构-nav`)" id="hashmap-的数据结构-nav">
									hashmap 的数据结构
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#hashmap-%e7%9a%84%e5%9b%9b%e4%b8%aa%e8%a6%81%e7%82%b9" onclick="onNavClick(`#hashmap-的四个要点-nav`)" id="hashmap-的四个要点-nav">
									hashmap 的四个要点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%85%b6%e4%bb%96%e8%af%ad%e8%a8%80%e4%b8%ad%e7%9a%84-hashmap" onclick="onNavClick(`#其他语言中的-hashmap-nav`)" id="其他语言中的-hashmap-nav">
									其他语言中的 hashmap
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#c" onclick="onNavClick(`#c-nav`)" id="c-nav">
									C&#43;&#43;
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#java" onclick="onNavClick(`#java-nav`)" id="java-nav">
									Java
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%9d%83%e8%a1%a1" onclick="onNavClick(`#权衡-nav`)" id="权衡-nav">
									权衡
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#c-templated" onclick="onNavClick(`#c-templated-nav`)" id="c-templated-nav">
									C&#43;&#43; templated
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bc%98%e7%82%b9" onclick="onNavClick(`#优点-nav`)" id="优点-nav">
									优点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%ba%e7%82%b9" onclick="onNavClick(`#缺点-nav`)" id="缺点-nav">
									缺点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#java-util-hashmap" onclick="onNavClick(`#java-util-hashmap-nav`)" id="java-util-hashmap-nav">
									Java util Hashmap
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bc%98%e7%82%b9-1" onclick="onNavClick(`#优点-1-nav`)" id="优点-1-nav">
									优点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%ba%e7%82%b9-1" onclick="onNavClick(`#缺点-1-nav`)" id="缺点-1-nav">
									缺点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#go-%e4%b8%ad-hashmap-%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#go-中-hashmap-的实现-nav`)" id="go-中-hashmap-的实现-nav">
									Go 中 hashmap 的实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#go-runtime-%e4%bd%bf%e7%94%a8%e4%ba%86-interface-%e5%90%97" onclick="onNavClick(`#go-runtime-使用了-interface-吗-nav`)" id="go-runtime-使用了-interface-吗-nav">
									Go runtime 使用了 interface{} 吗？
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%96%e8%af%91%e5%99%a8%e6%98%af%e5%90%a6%e4%bd%bf%e7%94%a8%e4%ba%86%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90" onclick="onNavClick(`#编译器是否使用了代码生成-nav`)" id="编译器是否使用了代码生成-nav">
									编译器是否使用了代码生成？
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%bc%96%e8%af%91%e6%97%b6%e9%97%b4%e9%87%8d%e5%86%99" onclick="onNavClick(`#编译时间重写-nav`)" id="编译时间重写-nav">
									编译时间重写
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#map-%e4%bb%a3%e7%a0%81%e8%a7%a3%e9%87%8a" onclick="onNavClick(`#map-代码解释-nav`)" id="map-代码解释-nav">
									map 代码解释
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%bb%93%e8%ae%ba" onclick="onNavClick(`#结论-nav`)" id="结论-nav">
									结论
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://blog.riba2534.cn/">
            🌀riba2534&#39;s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://blog.riba2534.cn/">
        <div class="single-column-header-title">🌀riba2534&#39;s Blog</div>
        
        <div class="single-column-header-subtitle">凡事有交代，件件有着落，事事有回音</div>
        

    </a>
</div>

            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210508221223.png')"
                    
                
            >
                <div class="post-title">
                    Golang 中的 Map 原理
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2019-07-14 17:12
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/">[技术分享]</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/golang">golang</a>
                                &nbsp;
                            
                        
                        
                            <i class="material-icons" style="">schedule</i>
                            

                            
                            

                            
                            22 min
                            
                            5 s.
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="什么是映射函数">什么是映射函数</h2>
<p>要明白 map 是如何工作的的，我们需要先讨论一下 <em>map 函数</em>。一个 map 函数用以将一个值映射到另一个值。给定一个值，我们叫 <em>key</em>，它就会返回另外一个值，称为 <em>value</em>。</p>
<pre tabindex="0"><code>map(key) → value
</code></pre><p>现在，map 还没什么用，除非我们放入一些数据。我们需要一个函数来将数据添加到 map 中</p>
<pre tabindex="0"><code>insert(map, key, value)
</code></pre><p>和一个函数从 map 中移除数据</p>
<pre tabindex="0"><code>delete(map, key)
</code></pre><p>在实现上还有一些有趣的点比如查询某个 key 当前在 map 中是否存在，但这已经超出了我们今天要讨论的范围。相反我们今天只专注于这几个点；插入，删除和如何将 key 映射到 value。</p>
<h2 id="go-中的-map-是一个-hashmap">Go 中的 map 是一个 hashmap</h2>
<p>Hashmap 是我要讨论的的 map 的一种特定实现，因为这也是 Go runtime 中所采用的实现方式。Hashmap 是一种经典的数据结构，提供了平均 O(1) 的查询时间复杂度，即使在最糟的情况下也有 O(n) 的复杂度。也就是说，正常情况下，执行 map 函数的时间是个常量。</p>
<p>这个常量的大小部分取决于 hashmap 的设计方式，而 map 存取时间从 O(1) 到 O(n) 的变化则取决于它的 <em>hash 函数</em>。</p>
<h3 id="hash-函数">hash 函数</h3>
<p>什么是 <em>hash 函数</em> ？一个 hash 函数用以接收一个未知长度的 key 然后返回一个固定长度的 value。</p>
<pre tabindex="0"><code>hash(key) → integer
</code></pre><p>这个 <em>hash value</em> 大多数情况下都是一个整数，原因我们后边会说到。</p>
<p>Hash 函数和映射函数是相似的。它们都接收一个 key 然后返回一个 value。然而 hash 函数的不同之处在于，它返回的 value 来源于 key，而不是关联于 key。</p>
<h3 id="hash-函数的重要特点">hash 函数的重要特点</h3>
<p>很有必要讨论一下一个好的 hash 函数的特点，因为 hash 函数的质量决定了其 map 函数运行复杂度是否接近于 O(1)。</p>
<p>Hashmap 的使用方面有两个重要的特点。第一个是<em>稳定性</em>。Hash 函数必须是稳定的。给定相同的 key，你的 hash 函数必须返回相同的值。否则你无法查找到你放入 map 中的数据。</p>
<p>第二个特点是<em>良好的分布</em>。给定两个相类似的 key，结果应该是极其不同的。这很重要，因为有两点原因。第一，跟我们稍后会看到的一样，hashmap 中的 value 值应当均匀地分布于 buckets 之间，否则存取的复杂度不会是 O(1)。第二，由于用户一定程度上可以控制 hash 函数的输入，它们也就能控制 hash 函数的输出。这就会导致糟糕的分布，在某些语言中是 DDoS 攻击的一种方式。这项特点也被叫做 <em>碰撞抵抗性（collision resistance）</em>。</p>
<h3 id="hashmap-的数据结构">hashmap 的数据结构</h3>
<p>关于 hashmap 的第二部分来说说数据是如何存储的。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/29/1644962e4cb94838?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="hashmap-data-structure"></p>
<p>经典的 hashmap 结构是一个 bucket 数组，其中的每项包含一个指针指向一个 key/value entry 数组。在当前例子中我们的 hashmap 中有 8 个 bucket（Go 语言即如此实现），并且每个 bucket 最多持有 8 个 key/value entry（同样也是 Go 语言的实现）。使用 2 的次方便于做位掩码和移位，而不必做昂贵的除法操作。</p>
<p>因为 entry 被添加到 map 中，假定有一个良好分布的 hash 函数，那么 buckets 大致会被均匀地填充。一旦 bucket 中的 entry 数量超过总数的某个百分比，也就是所说的 <em>负载因子（load factor）</em>，那么 map 就会翻倍 bucket 的数量并重新分配原先的 entry。</p>
<p>记住这个数据结构。假设我们现在有一个 map 用以存储项目名和对应的 Github star 数目，那么我们要如何往 map 中插入一个 value 呢？</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/29/1644962e4c998ad9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="insert-project-stars"></p>
<p>我们从 key 开始，把它传入 hash 函数，然后做掩码操作只取最低的几位来获取到 bucket 数组正确位置的偏移量。这也是要放入的 entry 所在的 bucket，它的 hash 值以 3（二进制 011） 结束。最终我们遍历这个 bucket 的 entry 列表直到我们找到一个空的位置，然后插入我们的 key 和 value。如果 key 已经存在了，我们就覆盖 value。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/29/1644962e4cabf7c5?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="map(moby/moby)"></p>
<p>现在，我们仍然用这个示意图来从 map 中查找 value。过程很相似。我们先将 key 做 hash 操作。因为我们的 bucket 数组包含 8 个元素，所以我们取最低 3 位，也就是第 5 号 bucket （二进制 101）。如果我们的 hash 函数是正确的，那么字符串 &ldquo;moby/moby&rdquo; 做 hash 操作之后得到的值永远是相同的。所以我们知道 key 不会存在于其他 bucket 中。现在我们再从 bucket 的 entry 列表中通过比较 key 做一次线性查找就能得到结果了。</p>
<h3 id="hashmap-的四个要点">hashmap 的四个要点</h3>
<p>这是个经典 hashmap 结构的比较高层的解释。我们已经看到了，要实现一个 hashmap 有四个要点；</p>
<ol>
<li>你需要一个给 key 做计算的 hash 函数。</li>
<li>你需要一个判断 key 相等的算法。</li>
<li>你需要知道 key 的大小。</li>
<li>你需要知道 value 的大小，因为这同样影响了 bucket 结构的大小。编译器需要知道 bucket 结构的大小，这决定了当你遍历或者新增数据时内存中的步进值。</li>
</ol>
<h2 id="其他语言中的-hashmap">其他语言中的 hashmap</h2>
<p>在讨论 Go 语言对于 hashmap 的实现之前，我想先简单介绍一下其他两个编程语言中是如何实现 hashmap 的。我选择了这两门语言，因为它们都提供了独立的 map 类型来适应各种不同的 key 和 value 类型。</p>
<h3 id="c">C++</h3>
<p>我们要讨论的第一个语言是 C++。C++ 标准模版库（STL）提供了 <code>std::unordered_map</code> 通常作为 hashmap 的实现来使用。</p>
<p>这是 <code>std::unordered_map</code> 的的定义。这是一个模版，所以参数实际的值取决于模版是如何初始化的。</p>
<pre tabindex="0"><code>template&lt;
    class Key,                             // the type of the key
    class T,                               // the type of the value
    class Hash = std::hash&lt;Key&gt;,            // the hash function
    class KeyEqual = std::equal_to&lt;Key&gt;,    // the key equality function
    class Allocator = std::allocator&lt; std::pair&lt;const Key, T&gt; &gt;
&gt; class unordered_map;
</code></pre><p>可以讲的有很多，但比较重要的有以下几点：</p>
<ul>
<li>模版接收了 key 和 value 的类型作为参数，所以知道它们的大小。</li>
<li>模版有一个 key 类型的 <code>std::hash</code> 函数，所以它知道如何 hash 传给它的 key 值。</li>
<li>模版还有一个 key 类型的 <code>std::equal_to</code> 函数，所以知道怎么比较两个 key 值。</li>
</ul>
<p>现在我们知道了在 C++ 的 <code>std::unordered_map</code> 中 hashmap 的四个要点是如何传达给编译器的了，所以我们来看一下它是如何实际工作的。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/29/1644962e4cbc28d1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="std::unordered_map"></p>
<p>首先我们将 key 传给 <code>std::hash</code> 函数以得到 key 的 hash 值。然后做掩码并取到 bucket 数组中的序号，接着再遍历对应 bucket 的 entry 列表并用 <code>std::equal_to</code> 函数来比较 key。</p>
<h3 id="java">Java</h3>
<p>我们要讨论的第二个语言是 Java。不出所料，在 Java 中 hashmap 类型就叫做 <code>java.util.Hashmap</code>。</p>
<p>在 Java 中，<code>java.util.Hashmap</code> 只能操作对象，因为在 Java 中几乎所有的东西都是 <code>java.lang.Object</code> 的子类。由于在 Java 中所有对象都起源于 <code>java.lang.Object</code>，所以可以继承或者重写 <code>hashCode</code> 和 <code>equals</code> 方法。</p>
<p>然而你不能直接存储 8 个基本类型；<code>boolean</code>，<code>int</code>，<code>short</code>，<code>long</code>，<code>byte</code>，<code>char</code>，<code>float</code> 和 <code>double</code>，因为它们不是 <code>java.lang.Object</code> 的子类。你既不能将它们作为 key，也不能将它们作为 value 来存储。为了突破这种限制，它们会被隐式地转换为代表它们各自的对象。也叫做装箱。</p>
<p>先把这种限制放一边，让我们来看一下在 Java 的 hashmap 中查找是怎样的。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/29/1644962ee2008db9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="java_hashmap"></p>
<p>首先我们调用 key 的 <code>hashCode</code> 方法来获取它的 hash 值。然后做掩码操作，获取到 bucket 数组中的对应位置，里面存放了一个指向 <code>Entry</code> 的指针。<code>Entry</code> 中有一个 key，一个 value，还有一个指向下一个 <code>Entry</code> 的指针，形成了一个 linked list。</p>
<h2 id="权衡">权衡</h2>
<p>现在我们知道 C++ 和 Java 是如何实现 hashmap 的了，让我们来比较一下它们各自的优缺点。</p>
<h3 id="c-templated">C++ templated</h3>
<p>std::unordered_map</p>
<h4 id="优点">优点</h4>
<ul>
<li>key 和 value 类型的大小在编译期间就确定了。</li>
<li>数据结构的大小总是确定的，不需要装箱操作。</li>
<li>由于代码在编译期间就定下来了，所以其他编译优化操作例如内联，常数折叠和死代码删除就可以介入了。</li>
</ul>
<p>总之，C++ 中的 map 和自己手写的为每种 key/value 类型组合定制的 map 一样快速高效，因为它其实就是这样的。</p>
<h4 id="缺点">缺点</h4>
<ul>
<li>代码膨胀。每个不同的 map 都是不同类型的。如果你的代码中有 N 个 map 类型，在你的代码库中你也就需要有 N 份 map 代码的拷贝。</li>
<li>编译时间膨胀。由于头文件和模版的工作方式，每个使用了 <code>std::unordered_map</code> 代码的文件中其实现都需要被生成，编译和优化。</li>
</ul>
<h3 id="java-util-hashmap">Java util Hashmap</h3>
<h4 id="优点-1">优点</h4>
<ul>
<li>一份 map 代码的实现可以服务于任何 java.util.Object 的子类。只需要编译一份 java.util.Object，在每个 class 文件中就都可以引用了。</li>
</ul>
<h4 id="缺点-1">缺点</h4>
<ul>
<li>所有东西必须是对象，即使它不是。这意味着基本类型的 map 必须用通过装箱操作转化为对象。装箱操作会增加垃圾回收的压力，并且额外的指针引用会增加缓存压力（每个对象都必须通过另外的指针来查找）。</li>
<li>Buckets 是以 linked lists 而不是顺序数组的方式存储的。这会导致在对象比较期间产生大量的指针追踪操作。</li>
<li>Hash 和 equals 函数需要代码编写者来实现。不正确的 hash 和 equals 函数会减慢 map 的运行速度，甚至导致 map 的行为错误。</li>
</ul>
<h2 id="go-中-hashmap-的实现">Go 中 hashmap 的实现</h2>
<p>现在，我们来讨论一下 Go 中 map 的实现。它保留了许多我们刚才讨论的实现中的优点，却没有那些缺点。</p>
<p>和 C++ 和 Java 一样， Go 中的 hashmap 是使用 Go 语言编写的。但是 Go 不支持范型，所以我们要如何来编写一个 hashmap 能够服务于（几乎）任何类型呢？</p>
<h3 id="go-runtime-使用了-interface-吗">Go runtime 使用了 interface{} 吗？</h3>
<p>不，Go runtime 并没有使用 interface{} 来实现 hashmap。虽然像 <code>container/{list,heap}</code> 这些包中使用了 interface{}，但 runtime 的 map 却没有使用。</p>
<h3 id="编译器是否使用了代码生成">编译器是否使用了代码生成？</h3>
<p>不，在 Go 语言可执行文件中只有一份 map 的实现。和 Java 不同，它并没有对 <code>interface{}</code> 做装箱操作。所以它是怎么工作的呢？</p>
<p>这要分成两部分来回答。它需要编译器和 runtime （运行时）之间的相互协作。</p>
<h3 id="编译时间重写">编译时间重写</h3>
<p>第一部分我们需要先理解 runtime 包中对于 map 的实现是如何做查找，插入和删除操作的。在编译期间 map 的操作被重写去调用了 runtime。例如。</p>
<pre tabindex="0"><code>v := m[&quot;key&quot;]     → runtime.mapaccess1(m, &quot;key&quot;, &amp;v)
v, ok := m[&quot;key&quot;] → runtime.mapaccess2(m, &quot;key&quot;, &amp;v, &amp;ok)
m[&quot;key&quot;] = 9001   → runtime.mapinsert(m, &quot;key&quot;, 9001)
delete(m, &quot;key&quot;)  → runtime.mapdelete(m, &quot;key&quot;)
</code></pre><p>值得注意的是，channel 中也做了相同的事，slice 却没有。</p>
<p>这是因为 channel 是复杂的数据类型。发送，接收和 <code>select</code> 操作和调度器之间都有复杂的交互，所以就被委托给了 runtime。相比较而言，slice 就简单很多了。像 slice 的存取，<code>len</code> 和 <code>cap</code> 这些操作编译器就自己做了，而像 <code>copy</code> 和 <code>append</code> 这种复杂的还是委托给了 runtime。</p>
<h3 id="map-代码解释">map 代码解释</h3>
<p>现在我们知道编译器重写了 map 的操作去调用了 runtime。我们也知道了在 runtime 内部，有一个叫 <code>mapaccess1</code> 的函数，一个叫 <code>mapaccess2</code> 的函数等等。</p>
<p>所以，编译器是如何重写</p>
<pre tabindex="0"><code>v := m[&quot;key&quot;]
</code></pre><p>到</p>
<pre tabindex="0"><code>runtime.mapaccess(m, &quot;key&quot;, &amp;v)
</code></pre><p>却没有使用 <code>interface{}</code> 的呢？要解释 Go 中的 map 类型是如何工作的最简单的函数是给你看一下 <code>runtime.mapaccess1</code> 的定义。</p>
<pre tabindex="0"><code>func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer
</code></pre><p>让我们来过一下这些参数。</p>
<ul>
<li><code>key</code> 是指向你提供的作为 key 值的指针。</li>
<li><code>h</code> 是个指向 <code>runtime.hmap</code> 结构的指针。<code>hmap</code> 是一个持有 buckets 和其他一些值的 runtime 的 hashmap 结构。</li>
<li><code>t</code> 是个指向 <code>maptype</code> 的指针。</li>
</ul>
<p>为什么我们已经有了 <code>*hmap</code> 之后还需要一个 <code>*maptype</code>？<code>*maptype</code> 是个特殊的东西，使得通用的 <code>*hmap</code> 可以服务于（几乎）任意 key 和 value 类型的组合。在你的程序中对于每一个独立的 map 定义都会有一个特定的 <code>maptype</code> 值。例如，有一个 <code>maptype</code> 值描述了从 <code>strings</code> 到 <code>ints</code> 的映射，另一个描述了 <code>strings</code> 到 <code>http.Headers</code> 的映射，等等。</p>
<p>C++ 中，对于每一个独立的 map 定义都有一个完整的实现。而 Go 并非如此，它在编译期间创建了一个 <code>maptype</code> 并在调用 runtime 的 map 函数的时候使用了它。</p>
<pre tabindex="0"><code>type maptype struct {
    typ           _type
    key           *_type
    elem          *_type
    bucket        *_type // internal type representing a hash bucket
    hmap          *_type // internal type representing a hmap
    keysize       uint8  // size of key slot
    indirectkey   bool   // store ptr to key instead of key itself
    valuesize     uint8  // size of value slot
    indirectvalue bool   // store ptr to value instead of value itself
    bucketsize    uint16 // size of bucket
    reflexivekey  bool   // true if k==k for all keys
    needkeyupdate bool   // true if we need to update key on overwrite
}
</code></pre><p>每个 <code>maptype</code> 中都包含了特定 map 中从 key 映射到 elem 所需的各种属性细节。它包含了关于 key 和 element 的信息。<code>maptype.key</code> 包含了指向我们传入的 key 的指针的信息。我们称之为 <em>类型描述符</em>。</p>
<pre tabindex="0"><code>type _type struct {
    size       uintptr
    ptrdata    uintptr // size of memory prefix holding all pointers
    hash       uint32
    tflag      tflag
    align      uint8
    fieldalign uint8
    kind       uint8
    alg        *typeAlg
    // gcdata stores the GC type data for the garbage collector.
    // If the KindGCProg bit is set in kind, gcdata is a GC program.
    // Otherwise it is a ptrmask bitmap. See mbitmap.go for details.
    gcdata     *byte
    str        nameOff
    ptrToThis  typeOff
}
</code></pre><p>在 <code>_type</code> 类型中，包含了它的大小。这很重要，因为我们只有一个指向 key 的指针，而不知道它实际多大并且是什么类型。它到底是一个整数，还是一个结构体，等等。我们也需要知道如何比较这种类型的值和如何 hash 这种类型的值，这也就是 <code>_type.alg</code> 字段的意义所在。</p>
<pre tabindex="0"><code>type typeAlg struct {
    // function for hashing objects of this type
    // (ptr to object, seed) -&gt; hash
    hash func(unsafe.Pointer, uintptr) uintptr
    // function for comparing objects of this type
    // (ptr to object A, ptr to object B) -&gt; ==?
    equal func(unsafe.Pointer, unsafe.Pointer) bool
}
</code></pre><p>在你的程序中这就是一个服务于特定类型的 <code>typeAlg</code> 值。</p>
<p>放在一起来看，这就是（轻微修改，便于理解） <code>runtime.mapaccess1</code> 函数。</p>
<pre tabindex="0"><code>// mapaccess1 returns a pointer to h[key].  Never returns nil, instead
// it will return a reference to the zero object for the value type if
// the key is not in the map.
func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer {
    if h == nil || h.count == 0 {
        return unsafe.Pointer(&amp;zeroVal[0])
    }
    alg := t.key.alg
    hash := alg.hash(key, uintptr(h.hash0))
    m := bucketMask(h.B)
    b := (*bmap)(add(h.buckets, (hash&amp;m)*uintptr(t.bucketsize)))
</code></pre><p>值得关注的一点是传递给 <code>alg.hash</code> 函数的 <code>h.hash0</code> 参数。<code>h.hash0</code> 是一个在 map 创建时生成的随机种子，为了防止在 Go runtime 中产生 hash 碰撞。</p>
<p>任何人都可以阅读 Go 语言的源码，所以可以找到一系列值，使得其使用 Go 语言中的 hash 函数计算后，得到的 hash 值会被放入同一个 bucket 中。种子的存在就为 hash 函数增加了很多随机性，为碰撞攻击提供了一些保护措施。</p>
<h2 id="结论">结论</h2>
<p>我很高兴能在 GoCon 大会上做这个演讲。因为 Go 中的 map 实现是一个介于 C++ 和 Java 之间的权衡，汲取了很多优点同时又没有包含很多缺点。</p>
<p>和 Java 不同，你可以直接使用基本类型数据，例如字符和整数，而不需要进行装箱操作。和 C++ 不同，在最后的二进制文件中，没有 N 份 <code>runtime.hashmap</code> 的实现，只有 N 份 <code>runtime.maptype</code> 的值，显著减少了程序的体积和编译时间。</p>
<p>现在我想说明的是我不是在试图告诉你 Go 不应该支持范型。我今天的目的是阐述当前 Go 1 的现状和在当前情形下 map 类型的工作方式。现今 Go 语言下 map 的实现是非常高效的，提供了很多模版类型的优点，而没有代码生成和编译时间膨胀的缺点。</p>
<p>我视之为一次值得学习赞赏的设计案例。</p>
<ol>
<li>你可以在这里找到更多关于 runtime.hmap 结构的内容。[dave.cheney.net/2017/04/30/…](</li>
</ol>

                    
                    <HR width="100%" id="EOF">
		            <p style="color:#777;">最后修改于 2019-07-14</p>
                    
                    
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210508215939.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://blog.riba2534.cn/blog/2019/%E4%B9%90%E8%A7%82%E9%94%81%E5%92%8C%E6%82%B2%E8%A7%82%E9%94%81/">
			下回<br>乐观锁和悲观锁
                </a>
                
                
                
                <a class="older-posts" href="https://blog.riba2534.cn/blog/2019/golang%E7%9B%B8%E5%85%B3%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E6%90%9C%E5%88%B0%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/">
			上回<br>GoLang相关的问题以及搜到的解决办法
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                








<div id="tcomment"></div>



            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
魔改自 <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://blog.riba2534.cn">riba2534</a>
<br>

&copy;
	
	2021 🌀riba2534&#39;s Blog
	</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            },
            debounce(func, wait, options) {
                let lastArgs,
                    lastThis,
                    maxWait,
                    result,
                    timerId,
                    lastCallTime

                let lastInvokeTime = 0
                let leading = false
                let maxing = false
                let trailing = true

                
                const useRAF = (!wait && wait !== 0 && typeof root.requestAnimationFrame === 'function')

                if (typeof func !== 'function') {
                    throw new TypeError('Expected a function')
                }
                function isObject(value) {
                    const type = typeof value
                    return value != null && (type === 'object' || type === 'function')
                }

                wait = +wait || 0
                if (isObject(options)) {
                    leading = !!options.leading
                    maxing = 'maxWait' in options
                    maxWait = maxing ? Math.max(+options.maxWait || 0, wait) : maxWait
                    trailing = 'trailing' in options ? !!options.trailing : trailing
                }

                function invokeFunc(time) {
                    const args = lastArgs
                    const thisArg = lastThis

                    lastArgs = lastThis = undefined
                    lastInvokeTime = time
                    result = func.apply(thisArg, args)
                    return result
                }

                function startTimer(pendingFunc, wait) {
                    if (useRAF) {
                    root.cancelAnimationFrame(timerId)
                    return root.requestAnimationFrame(pendingFunc)
                    }
                    return setTimeout(pendingFunc, wait)
                }

                function cancelTimer(id) {
                    if (useRAF) {
                    return root.cancelAnimationFrame(id)
                    }
                    clearTimeout(id)
                }

                function leadingEdge(time) {
                    
                    lastInvokeTime = time
                    
                    timerId = startTimer(timerExpired, wait)
                    
                    return leading ? invokeFunc(time) : result
                }

                function remainingWait(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime
                    const timeWaiting = wait - timeSinceLastCall

                    return maxing
                    ? Math.min(timeWaiting, maxWait - timeSinceLastInvoke)
                    : timeWaiting
                }

                function shouldInvoke(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime

                    
                    
                    
                    return (lastCallTime === undefined || (timeSinceLastCall >= wait) ||
                    (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait))
                }

                function timerExpired() {
                    const time = Date.now()
                    if (shouldInvoke(time)) {
                    return trailingEdge(time)
                    }
                    
                    timerId = startTimer(timerExpired, remainingWait(time))
                }

                function trailingEdge(time) {
                    timerId = undefined

                    
                    
                    if (trailing && lastArgs) {
                    return invokeFunc(time)
                    }
                    lastArgs = lastThis = undefined
                    return result
                }

                function cancel() {
                    if (timerId !== undefined) {
                    cancelTimer(timerId)
                    }
                    lastInvokeTime = 0
                    lastArgs = lastCallTime = lastThis = timerId = undefined
                }

                function flush() {
                    return timerId === undefined ? result : trailingEdge(Date.now())
                }

                function pending() {
                    return timerId !== undefined
                }

                function debounced(...args) {
                    const time = Date.now()
                    const isInvoking = shouldInvoke(time)

                    lastArgs = args
                    lastThis = this
                    lastCallTime = time

                    if (isInvoking) {
                    if (timerId === undefined) {
                        return leadingEdge(lastCallTime)
                    }
                    if (maxing) {
                        
                        timerId = startTimer(timerExpired, wait)
                        return invokeFunc(lastCallTime)
                    }
                    }
                    if (timerId === undefined) {
                    timerId = startTimer(timerExpired, wait)
                    }
                    return result
                }
                debounced.cancel = cancel
                debounced.flush = flush
                debounced.pending = pending
                return debounced
                }

    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
        
        
            twikoo.init({
                envId: "blog-9g6ht92ca9c564c6",
                el: '#tcomment',
                region:  null ,
            });
        

        document.querySelectorAll("table").forEach(function(elem){
            elem.classList.add("table-striped");
            elem.classList.add("table");
            elem.classList.add("table-responsive");
            elem.classList.add("table-hover");
        })

        
        spy();
        window.addEventListener('scroll', this.debounce(spy, 250, { 'maxWait': 250 }), false);
        
        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});



</script>
    </body>
</html>
