<!DOCTYPE html>
<html><head>
<title>Linux内核数据结构</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="Linux内核数据结构" />
<meta property="og:description" content="Linux 内核数据结构 获得源码 目前，Linux 内核的源码维护在 GitHub 上，地址为：https://github.com/torvalds/linux
 克隆到本地  git clone https://github.com/torvalds/linux 本书使用的源码版本为 2.6.34 ，所以切换到对应 Tag：  cd linuxgit checkout v2.6.34或者直接在：https://github.com/torvalds/linux/releases/tag/v2.6.34 下载
Linux 源码树根目录说明 $ tree -L 1.├── arch # 特定体系结构的源码├── block # 块设备 I/O 层├── COPYING # 内核许可证（GNU GPL v2）├── CREDITS # 内核代码开发者列表├── crypto # 加密 API├── Documentation # 内核源码文档├── drivers # 设备驱动程序├── firmware # 使用某些驱动程序而需要的设备固件 ├── fs # VFS 和各种文件系统├── include # 内核头文件├── init # 内核引导和初始化├── ipc # 进程间通信代码├── Kbuild # 用于编译Linux内核文件，对makefile进行了扩充 ├── kernel # 像调度程序这样的核心子系统├── lib # 通用内核函数├── MAINTAINERS # 维护者列表以及如何提交内核更改的说明文件├── Makefile # makefile├── mm # 内存管理子系统和vm ├── net # 网络子系统 ├── README # README├── REPORTING-BUGS # Linux内核常见问题解答 ├── samples # 示例├── scripts # 编译内核所用的脚本 ├── security # Linux安全模块├── sound # 语音子系统├── tools # 在Linux开发中有用的工具├── usr # 早期用户空间代码（所谓的 inittranfs）└── virt # 虚拟化基础结构21 directories, 7 files内核数据结构简介 介绍通用数据结构中最有用的几个：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://caixiongjiang.github.io/blog/2020/linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-08-28T01:49:53+08:00" />
<meta property="article:modified_time" content="2020-08-28T01:49:53+08:00" />











<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>


  




<link rel="icon" href="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210427152737.jpeg">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>


  
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script type="text/javascript" id="MathJax-script"
async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
MathJax.Hub.Queue(function() {



var all = MathJax.Hub.getAllJax(), i;
for(i = 0; i < all.length; i += 1) {
all[i].SourceElement().parentNode.className += ' has-jax';
}
});
</script>

<style>
code.has-jax {
font: inherit;
font-size: 100%;
background: inherit;
border: inherit;
color: #515151;
}
</style>





  
    <script src="/js/toc.js"></script>
  











<script src="https://cdn.jsdelivr.net/npm/twikoo@1.3.1/dist/twikoo.all.min.js"></script>




</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://caixiongjiang.github.io/">
    
        <div class="nav-title">
            🌀riba2534&#39;s Blog
        </div>
        
        <div class="nav-subtitle">
            凡事有交代，件件有着落，事事有回音
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/blog">
                文章📖
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                分类📌
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                标签🏷️
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/series">
                系列📚
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/archive">
                归档📃
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                关于👋
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friends">
                友链🔗
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS📢
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<a href="https://blog.csdn.net/riba2534">
    CSDN
</a>
<br>

<a href="https://github.com/riba2534">
    GitHub
</a>
<br>

<a href="https://www.zhihu.com/people/riba2534">
    Zhihu
</a>
<br>

<a href="mailto:riba2534@qq.com">
    Email
</a>
<br>

        <hr>
        
魔改自 <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://blog.riba2534.cn">riba2534</a>
<br>

&copy;
	
	2021 🌀riba2534&#39;s Blog
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#linux-%e5%86%85%e6%a0%b8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" onclick="onNavClick(`#linux-内核数据结构-nav`)" id="linux-内核数据结构-nav">
									Linux 内核数据结构
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%8e%b7%e5%be%97%e6%ba%90%e7%a0%81" onclick="onNavClick(`#获得源码-nav`)" id="获得源码-nav">
									获得源码
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#linux-%e6%ba%90%e7%a0%81%e6%a0%91%e6%a0%b9%e7%9b%ae%e5%bd%95%e8%af%b4%e6%98%8e" onclick="onNavClick(`#linux-源码树根目录说明-nav`)" id="linux-源码树根目录说明-nav">
									Linux 源码树根目录说明
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e6%a0%b8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e7%ae%80%e4%bb%8b" onclick="onNavClick(`#内核数据结构简介-nav`)" id="内核数据结构简介-nav">
									内核数据结构简介
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%93%be%e8%a1%a8" onclick="onNavClick(`#链表-nav`)" id="链表-nav">
									链表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e7%ae%80%e5%8d%95%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#简单定义-nav`)" id="简单定义-nav">
									简单定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#kernel%e4%b8%ad%e7%9a%84%e9%93%be%e8%a1%a8" onclick="onNavClick(`#kernel中的链表-nav`)" id="kernel中的链表-nav">
									kernel中的链表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%8a%82%e7%82%b9%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#节点定义-nav`)" id="节点定义-nav">
									节点定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#container_of-%e5%ae%8f" onclick="onNavClick(`#container_of-宏-nav`)" id="container_of-宏-nav">
									container_of 宏
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bb%8b%e7%bb%8d" onclick="onNavClick(`#介绍-nav`)" id="介绍-nav">
									介绍
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8a%9f%e8%83%bd%e5%8f%8a%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" onclick="onNavClick(`#功能及使用方法-nav`)" id="功能及使用方法-nav">
									功能及使用方法
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%93%be%e8%a1%a8%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#链表操作-nav`)" id="链表操作-nav">
									链表操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5%e8%8a%82%e7%82%b9" onclick="onNavClick(`#插入节点-nav`)" id="插入节点-nav">
									插入节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5%e5%88%b0%e9%93%be%e8%a1%a8%e5%b0%be%e9%83%a8" onclick="onNavClick(`#插入到链表尾部-nav`)" id="插入到链表尾部-nav">
									插入到链表尾部：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4%e8%8a%82%e7%82%b9" onclick="onNavClick(`#删除节点-nav`)" id="删除节点-nav">
									删除节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%a7%bb%e5%8a%a8%e5%92%8c%e5%90%88%e5%b9%b6%e8%8a%82%e7%82%b9" onclick="onNavClick(`#移动和合并节点-nav`)" id="移动和合并节点-nav">
									移动和合并节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%81%8d%e5%8e%86%e9%93%be%e8%a1%a8" onclick="onNavClick(`#遍历链表-nav`)" id="遍历链表-nav">
									遍历链表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%ad%a3%e5%90%91%e9%81%8d%e5%8e%86" onclick="onNavClick(`#正向遍历-nav`)" id="正向遍历-nav">
									正向遍历
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%8d%e5%90%91%e9%81%8d%e5%8e%86" onclick="onNavClick(`#反向遍历-nav`)" id="反向遍历-nav">
									反向遍历
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%81%8d%e5%8e%86%e5%90%8c%e6%97%b6%e5%88%a0%e9%99%a4" onclick="onNavClick(`#遍历同时删除-nav`)" id="遍历同时删除-nav">
									遍历同时删除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%98%9f%e5%88%97" onclick="onNavClick(`#队列-nav`)" id="队列-nav">
									队列
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#kfifo" onclick="onNavClick(`#kfifo-nav`)" id="kfifo-nav">
									Kfifo
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%9b%e5%bb%ba%e9%98%9f%e5%88%97" onclick="onNavClick(`#创建队列-nav`)" id="创建队列-nav">
									创建队列
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%a5%e9%98%9f%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#入队操作-nav`)" id="入队操作-nav">
									入队操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%87%ba%e9%98%9f%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#出队操作-nav`)" id="出队操作-nav">
									出队操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%8e%b7%e5%8f%96%e9%98%9f%e5%88%97%e9%95%bf%e5%ba%a6" onclick="onNavClick(`#获取队列长度-nav`)" id="获取队列长度-nav">
									获取队列长度
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%87%8d%e7%bd%ae%e5%92%8c%e6%92%a4%e9%94%80%e9%98%9f%e5%88%97" onclick="onNavClick(`#重置和撤销队列-nav`)" id="重置和撤销队列-nav">
									重置和撤销队列
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%98%a0%e5%b0%84" onclick="onNavClick(`#映射-nav`)" id="映射-nav">
									映射
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e9%80%89%e5%9e%8b" onclick="onNavClick(`#数据结构选型-nav`)" id="数据结构选型-nav">
									数据结构选型
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" onclick="onNavClick(`#初始化-nav`)" id="初始化-nav">
									初始化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e9%85%8duid" onclick="onNavClick(`#分配uid-nav`)" id="分配uid-nav">
									分配UID
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%9f%a5%e6%89%beuid" onclick="onNavClick(`#查找uid-nav`)" id="查找uid-nav">
									查找UID
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4uid" onclick="onNavClick(`#删除uid-nav`)" id="删除uid-nav">
									删除UID
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%92%a4%e9%94%80-idr" onclick="onNavClick(`#撤销-idr-nav`)" id="撤销-idr-nav">
									撤销 idr
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e4%ba%8c%e5%8f%89%e6%a0%91" onclick="onNavClick(`#二叉树-nav`)" id="二叉树-nav">
									二叉树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%ba%8c%e5%8f%89%e6%a0%91%e6%90%9c%e7%b4%a2%e6%a0%91bst" onclick="onNavClick(`#二叉树搜索树bst-nav`)" id="二叉树搜索树bst-nav">
									二叉树搜索树（BST）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b9%b3%e8%a1%a1%e4%ba%8c%e5%8f%89%e6%a0%91" onclick="onNavClick(`#平衡二叉树-nav`)" id="平衡二叉树-nav">
									平衡二叉树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b9%b3%e8%a1%a1%e4%ba%8c%e5%8f%89%e6%90%9c%e7%b4%a2%e6%a0%91" onclick="onNavClick(`#平衡二叉搜索树-nav`)" id="平衡二叉搜索树-nav">
									平衡二叉搜索树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%87%aa%e5%b9%b3%e8%a1%a1%e4%ba%8c%e5%8f%89%e6%90%9c%e7%b4%a2%e6%a0%91" onclick="onNavClick(`#自平衡二叉搜索树-nav`)" id="自平衡二叉搜索树-nav">
									自平衡二叉搜索树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#avl%e6%a0%91" onclick="onNavClick(`#avl树-nav`)" id="avl树-nav">
									AVL树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e6%9c%ac%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#基本定义-nav`)" id="基本定义-nav">
									基本定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#具体实现-nav`)" id="具体实现-nav">
									具体实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%b3%e6%97%8b%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#右旋操作-nav`)" id="右旋操作-nav">
									右旋操作：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b7%a6%e6%97%8b%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#左旋操作-nav`)" id="左旋操作-nav">
									左旋操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%9c%80%e8%a6%81%e5%b9%b3%e8%a1%a1%e7%9a%84%e5%9b%9b%e7%a7%8d%e6%83%85%e5%86%b5" onclick="onNavClick(`#需要平衡的四种情况-nav`)" id="需要平衡的四种情况-nav">
									需要平衡的四种情况
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5" onclick="onNavClick(`#插入-nav`)" id="插入-nav">
									插入
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4" onclick="onNavClick(`#删除-nav`)" id="删除-nav">
									删除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%ba%a2%e9%bb%91%e6%a0%91" onclick="onNavClick(`#红黑树-nav`)" id="红黑树-nav">
									红黑树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%80%a7%e8%b4%a8" onclick="onNavClick(`#性质-nav`)" id="性质-nav">
									性质
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%97%8b%e8%bd%ac" onclick="onNavClick(`#旋转-nav`)" id="旋转-nav">
									旋转
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5-1" onclick="onNavClick(`#插入-1-nav`)" id="插入-1-nav">
									插入
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4-1" onclick="onNavClick(`#删除-1-nav`)" id="删除-1-nav">
									删除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%af%94%e8%be%83" onclick="onNavClick(`#比较-nav`)" id="比较-nav">
									比较
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%86%85%e6%a0%b8%e4%b8%ad%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#内核中的实现-nav`)" id="内核中的实现-nav">
									内核中的实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e8%8a%82%e7%82%b9%e5%ae%9a%e4%b9%89-1" onclick="onNavClick(`#节点定义-1-nav`)" id="节点定义-1-nav">
									节点定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#操作-nav`)" id="操作-nav">
									操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e7%9a%84%e9%80%89%e6%8b%a9" onclick="onNavClick(`#数据结构的选择-nav`)" id="数据结构的选择-nav">
									数据结构的选择
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%80%9d%e8%80%83" onclick="onNavClick(`#思考-nav`)" id="思考-nav">
									思考
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%b6%e4%bb%96" onclick="onNavClick(`#其他-nav`)" id="其他-nav">
									其他
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" onclick="onNavClick(`#参考资料-nav`)" id="参考资料-nav">
									参考资料
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/blog">
                    文章📖
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    分类📌
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    标签🏷️
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/series">
                    系列📚
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/archive">
                    归档📃
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    关于👋
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friends">
                    友链🔗
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS📢
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#linux-%e5%86%85%e6%a0%b8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" onclick="onNavClick(`#linux-内核数据结构-nav`)" id="linux-内核数据结构-nav">
									Linux 内核数据结构
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%8e%b7%e5%be%97%e6%ba%90%e7%a0%81" onclick="onNavClick(`#获得源码-nav`)" id="获得源码-nav">
									获得源码
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#linux-%e6%ba%90%e7%a0%81%e6%a0%91%e6%a0%b9%e7%9b%ae%e5%bd%95%e8%af%b4%e6%98%8e" onclick="onNavClick(`#linux-源码树根目录说明-nav`)" id="linux-源码树根目录说明-nav">
									Linux 源码树根目录说明
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e6%a0%b8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e7%ae%80%e4%bb%8b" onclick="onNavClick(`#内核数据结构简介-nav`)" id="内核数据结构简介-nav">
									内核数据结构简介
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%93%be%e8%a1%a8" onclick="onNavClick(`#链表-nav`)" id="链表-nav">
									链表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e7%ae%80%e5%8d%95%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#简单定义-nav`)" id="简单定义-nav">
									简单定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#kernel%e4%b8%ad%e7%9a%84%e9%93%be%e8%a1%a8" onclick="onNavClick(`#kernel中的链表-nav`)" id="kernel中的链表-nav">
									kernel中的链表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%8a%82%e7%82%b9%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#节点定义-nav`)" id="节点定义-nav">
									节点定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#container_of-%e5%ae%8f" onclick="onNavClick(`#container_of-宏-nav`)" id="container_of-宏-nav">
									container_of 宏
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bb%8b%e7%bb%8d" onclick="onNavClick(`#介绍-nav`)" id="介绍-nav">
									介绍
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8a%9f%e8%83%bd%e5%8f%8a%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" onclick="onNavClick(`#功能及使用方法-nav`)" id="功能及使用方法-nav">
									功能及使用方法
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%93%be%e8%a1%a8%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#链表操作-nav`)" id="链表操作-nav">
									链表操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5%e8%8a%82%e7%82%b9" onclick="onNavClick(`#插入节点-nav`)" id="插入节点-nav">
									插入节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5%e5%88%b0%e9%93%be%e8%a1%a8%e5%b0%be%e9%83%a8" onclick="onNavClick(`#插入到链表尾部-nav`)" id="插入到链表尾部-nav">
									插入到链表尾部：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4%e8%8a%82%e7%82%b9" onclick="onNavClick(`#删除节点-nav`)" id="删除节点-nav">
									删除节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%a7%bb%e5%8a%a8%e5%92%8c%e5%90%88%e5%b9%b6%e8%8a%82%e7%82%b9" onclick="onNavClick(`#移动和合并节点-nav`)" id="移动和合并节点-nav">
									移动和合并节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%81%8d%e5%8e%86%e9%93%be%e8%a1%a8" onclick="onNavClick(`#遍历链表-nav`)" id="遍历链表-nav">
									遍历链表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%ad%a3%e5%90%91%e9%81%8d%e5%8e%86" onclick="onNavClick(`#正向遍历-nav`)" id="正向遍历-nav">
									正向遍历
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%8d%e5%90%91%e9%81%8d%e5%8e%86" onclick="onNavClick(`#反向遍历-nav`)" id="反向遍历-nav">
									反向遍历
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%81%8d%e5%8e%86%e5%90%8c%e6%97%b6%e5%88%a0%e9%99%a4" onclick="onNavClick(`#遍历同时删除-nav`)" id="遍历同时删除-nav">
									遍历同时删除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%98%9f%e5%88%97" onclick="onNavClick(`#队列-nav`)" id="队列-nav">
									队列
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#kfifo" onclick="onNavClick(`#kfifo-nav`)" id="kfifo-nav">
									Kfifo
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%9b%e5%bb%ba%e9%98%9f%e5%88%97" onclick="onNavClick(`#创建队列-nav`)" id="创建队列-nav">
									创建队列
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%a5%e9%98%9f%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#入队操作-nav`)" id="入队操作-nav">
									入队操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%87%ba%e9%98%9f%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#出队操作-nav`)" id="出队操作-nav">
									出队操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%8e%b7%e5%8f%96%e9%98%9f%e5%88%97%e9%95%bf%e5%ba%a6" onclick="onNavClick(`#获取队列长度-nav`)" id="获取队列长度-nav">
									获取队列长度
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%87%8d%e7%bd%ae%e5%92%8c%e6%92%a4%e9%94%80%e9%98%9f%e5%88%97" onclick="onNavClick(`#重置和撤销队列-nav`)" id="重置和撤销队列-nav">
									重置和撤销队列
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%98%a0%e5%b0%84" onclick="onNavClick(`#映射-nav`)" id="映射-nav">
									映射
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e9%80%89%e5%9e%8b" onclick="onNavClick(`#数据结构选型-nav`)" id="数据结构选型-nav">
									数据结构选型
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" onclick="onNavClick(`#初始化-nav`)" id="初始化-nav">
									初始化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e9%85%8duid" onclick="onNavClick(`#分配uid-nav`)" id="分配uid-nav">
									分配UID
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%9f%a5%e6%89%beuid" onclick="onNavClick(`#查找uid-nav`)" id="查找uid-nav">
									查找UID
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4uid" onclick="onNavClick(`#删除uid-nav`)" id="删除uid-nav">
									删除UID
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%92%a4%e9%94%80-idr" onclick="onNavClick(`#撤销-idr-nav`)" id="撤销-idr-nav">
									撤销 idr
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e4%ba%8c%e5%8f%89%e6%a0%91" onclick="onNavClick(`#二叉树-nav`)" id="二叉树-nav">
									二叉树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%ba%8c%e5%8f%89%e6%a0%91%e6%90%9c%e7%b4%a2%e6%a0%91bst" onclick="onNavClick(`#二叉树搜索树bst-nav`)" id="二叉树搜索树bst-nav">
									二叉树搜索树（BST）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b9%b3%e8%a1%a1%e4%ba%8c%e5%8f%89%e6%a0%91" onclick="onNavClick(`#平衡二叉树-nav`)" id="平衡二叉树-nav">
									平衡二叉树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b9%b3%e8%a1%a1%e4%ba%8c%e5%8f%89%e6%90%9c%e7%b4%a2%e6%a0%91" onclick="onNavClick(`#平衡二叉搜索树-nav`)" id="平衡二叉搜索树-nav">
									平衡二叉搜索树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%87%aa%e5%b9%b3%e8%a1%a1%e4%ba%8c%e5%8f%89%e6%90%9c%e7%b4%a2%e6%a0%91" onclick="onNavClick(`#自平衡二叉搜索树-nav`)" id="自平衡二叉搜索树-nav">
									自平衡二叉搜索树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#avl%e6%a0%91" onclick="onNavClick(`#avl树-nav`)" id="avl树-nav">
									AVL树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e6%9c%ac%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#基本定义-nav`)" id="基本定义-nav">
									基本定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#具体实现-nav`)" id="具体实现-nav">
									具体实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%b3%e6%97%8b%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#右旋操作-nav`)" id="右旋操作-nav">
									右旋操作：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%b7%a6%e6%97%8b%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#左旋操作-nav`)" id="左旋操作-nav">
									左旋操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%9c%80%e8%a6%81%e5%b9%b3%e8%a1%a1%e7%9a%84%e5%9b%9b%e7%a7%8d%e6%83%85%e5%86%b5" onclick="onNavClick(`#需要平衡的四种情况-nav`)" id="需要平衡的四种情况-nav">
									需要平衡的四种情况
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5" onclick="onNavClick(`#插入-nav`)" id="插入-nav">
									插入
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4" onclick="onNavClick(`#删除-nav`)" id="删除-nav">
									删除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%ba%a2%e9%bb%91%e6%a0%91" onclick="onNavClick(`#红黑树-nav`)" id="红黑树-nav">
									红黑树
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%80%a7%e8%b4%a8" onclick="onNavClick(`#性质-nav`)" id="性质-nav">
									性质
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%97%8b%e8%bd%ac" onclick="onNavClick(`#旋转-nav`)" id="旋转-nav">
									旋转
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8f%92%e5%85%a5-1" onclick="onNavClick(`#插入-1-nav`)" id="插入-1-nav">
									插入
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%a0%e9%99%a4-1" onclick="onNavClick(`#删除-1-nav`)" id="删除-1-nav">
									删除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%af%94%e8%be%83" onclick="onNavClick(`#比较-nav`)" id="比较-nav">
									比较
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%86%85%e6%a0%b8%e4%b8%ad%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#内核中的实现-nav`)" id="内核中的实现-nav">
									内核中的实现
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e8%8a%82%e7%82%b9%e5%ae%9a%e4%b9%89-1" onclick="onNavClick(`#节点定义-1-nav`)" id="节点定义-1-nav">
									节点定义
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#操作-nav`)" id="操作-nav">
									操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e7%9a%84%e9%80%89%e6%8b%a9" onclick="onNavClick(`#数据结构的选择-nav`)" id="数据结构的选择-nav">
									数据结构的选择
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%80%9d%e8%80%83" onclick="onNavClick(`#思考-nav`)" id="思考-nav">
									思考
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%b6%e4%bb%96" onclick="onNavClick(`#其他-nav`)" id="其他-nav">
									其他
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" onclick="onNavClick(`#参考资料-nav`)" id="参考资料-nav">
									参考资料
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://caixiongjiang.github.io/">
            🌀riba2534&#39;s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://caixiongjiang.github.io/">
        <div class="single-column-header-title">🌀riba2534&#39;s Blog</div>
        
        <div class="single-column-header-subtitle">凡事有交代，件件有着落，事事有回音</div>
        

    </a>
</div>

            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://image.riba2534.cn/18-12-22/35474812.jpg')"
                    
                
            >
                <div class="post-title">
                    Linux内核数据结构
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2020-08-28 01:49
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/linux">Linux</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/linux%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0">linux内核设计与实现</a>
                                &nbsp;
                            
                                <a href="/tags/linux">Linux</a>
                                &nbsp;
                            
                        
                        
                            <i class="material-icons" style="">schedule</i>
                            

                            
                            

                            
                            61 min
                            
                            19 s.
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h1 id="linux-内核数据结构">Linux 内核数据结构</h1>
<h1 id="获得源码">获得源码</h1>
<p>目前，Linux 内核的源码维护在 GitHub 上，地址为：https://github.com/torvalds/linux</p>
<ol>
<li>克隆到本地</li>
</ol>
<pre tabindex="0"><code>git clone https://github.com/torvalds/linux
</code></pre><ol>
<li>本书使用的源码版本为 2.6.34 ，所以切换到对应 Tag：</li>
</ol>
<pre tabindex="0"><code>cd linux
git checkout v2.6.34
</code></pre><p>或者直接在：https://github.com/torvalds/linux/releases/tag/v2.6.34 下载</p>
<h1 id="linux-源码树根目录说明">Linux 源码树根目录说明</h1>
<pre tabindex="0"><code>$ tree -L 1
.
├── arch       # 特定体系结构的源码
├── block      # 块设备 I/O 层
├── COPYING     # 内核许可证（GNU GPL v2）
├── CREDITS     # 内核代码开发者列表
├── crypto      # 加密 API
├── Documentation  # 内核源码文档
├── drivers     # 设备驱动程序
├── firmware     # 使用某些驱动程序而需要的设备固件 
├── fs        # VFS 和各种文件系统
├── include     # 内核头文件
├── init       # 内核引导和初始化
├── ipc       # 进程间通信代码
├── Kbuild      # 用于编译Linux内核文件，对makefile进行了扩充 
├── kernel      # 像调度程序这样的核心子系统
├── lib       # 通用内核函数
├── MAINTAINERS   # 维护者列表以及如何提交内核更改的说明文件
├── Makefile     # makefile
├── mm        # 内存管理子系统和vm   
├── net       # 网络子系统 
├── README      # README
├── REPORTING-BUGS  # Linux内核常见问题解答  
├── samples     # 示例
├── scripts     # 编译内核所用的脚本 
├── security     # Linux安全模块
├── sound      # 语音子系统
├── tools      # 在Linux开发中有用的工具
├── usr       # 早期用户空间代码（所谓的 inittranfs）
└── virt       # 虚拟化基础结构
21 directories, 7 files
</code></pre><h1 id="内核数据结构简介">内核数据结构简介</h1>
<p>介绍通用数据结构中最有用的几个：</p>
<ul>
<li>
<p>链表</p>
</li>
<li>
<p>队列</p>
</li>
<li>
<p>映射</p>
</li>
<li>
<p>二叉树</p>
</li>
</ul>
<h1 id="链表">链表</h1>
<p>include/linux/list.h</p>
<h2 id="简单定义">简单定义</h2>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#228b22">// 单向链表
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">struct</span> list_element
{
  <span style="color:#00688b;font-weight:bold">void</span> *data;
  <span style="color:#8b008b;font-weight:bold">struct</span> list_element *next; <span style="color:#a61717;background-color:#e3d2d2">*/</span>/ <span style="color:#a61717;background-color:#e3d2d2">指向下一个</span>*
};
<span style="color:#228b22">// 双向链表
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">struct</span> list_element
{
  <span style="color:#00688b;font-weight:bold">void</span> *data;
  <span style="color:#8b008b;font-weight:bold">struct</span> list_element *next; <span style="color:#a61717;background-color:#e3d2d2">*/</span>/ <span style="color:#a61717;background-color:#e3d2d2">指向下一个</span>*
  <span style="color:#8b008b;font-weight:bold">struct</span> list_element *prev; <span style="color:#a61717;background-color:#e3d2d2">*/</span>/ <span style="color:#a61717;background-color:#e3d2d2">指向前一个</span>*
};
</code></pre></td></tr></table>
</div>
</div><p>环形链表即把链表的尾元素的下一个元素变为链表的头部。</p>
<h2 id="kernel中的链表">kernel中的链表</h2>
<ul>
<li>
<p>kernel中对链表的定义在：include/linux/list.h 下。</p>
</li>
<li>
<p>由于双向链表有比较强大的灵活性，所以linux中的链表采用<strong>环形双向链表</strong>来完成。</p>
</li>
<li>
<p>Linux与传统的方式与众不同，它<strong>不是将数据结构塞入链表，而是把链表节点塞入数据结构</strong>。</p>
</li>
</ul>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828012504.png" alt="8266c5d8-4ad4-4d93-a727-b16804b5fc10"></p>
<h2 id="节点定义">节点定义</h2>
<p>链表节点定义为：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#228b22">// include/linux/list.h  19
</span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">struct</span> list_head {
  <span style="color:#8b008b;font-weight:bold">struct</span> list_head *next, *prev;
};
</code></pre></td></tr></table>
</div>
</div><p>节点本身并没有意义，它需要被嵌入自己的数据结构中才能生效，链表需要在使用前进行初始化，因为多数元素是动态创建的。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#228b22">// include/linux/list.h  23行
</span><span style="color:#228b22"></span><span style="color:#1e889b">#define LIST_HEAD_INIT(*name*) { &amp;(name), &amp;(name) }
</span></code></pre></td></tr></table>
</div>
</div><p>看起比较简单，那如何使用这个链表节点呢，书中提供了一个例子：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8b008b;font-weight:bold">struct</span> fox
{
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> tail_length;
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span> weight;
  <span style="color:#00688b;font-weight:bold">bool</span> is_fantastic;
  <span style="color:#8b008b;font-weight:bold">struct</span> list_head list; <span style="color:#a61717;background-color:#e3d2d2">*/</span>/ <span style="color:#a61717;background-color:#e3d2d2">所有</span> fox <span style="color:#a61717;background-color:#e3d2d2">结构形成链表</span>*
};
</code></pre></td></tr></table>
</div>
</div><h2 id="container_of-宏">container_of 宏</h2>
<h3 id="介绍">介绍</h3>
<p>原型定义如下：</p>
<p>include/linux/kernel.h 709行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#1e889b">#define container_of(*ptr*, *type*, *member*) ({      \
</span><span style="color:#1e889b">  const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);   \ </span><span style="color:#228b22">// 1
</span><span style="color:#228b22"></span>  (type *)( (<span style="color:#00688b;font-weight:bold">char</span> *)__mptr - offsetof(type,member) );})   <span style="color:#228b22">// 2
</span></code></pre></td></tr></table>
</div>
</div><p>其中 offsetof 的定义为：</p>
<p>include/linux/stddef.h 24行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#1e889b">#define offsetof(*TYPE*, *MEMBER*) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)
</span></code></pre></td></tr></table>
</div>
</div><p>其中：</p>
<ul>
<li>
<p>上面 typeof 为 GNU gcc 扩展语法，可用来获取一个变量的类型</p>
</li>
<li>
<p>以上1代码去掉后，将2中的 __mptr替换为ptr也可正常工作。看似无用，实则用于编译期间类型检查</p>
</li>
</ul>
<p>在链表结构中，使用了一个 list_entry 的宏，为：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#1e889b">#define list_entry(*ptr*, *type*, *member*) \
</span><span style="color:#1e889b">  container_of(ptr, type, member)
</span></code></pre></td></tr></table>
</div>
</div><p>实质上就是调用了一下 container_of</p>
<h3 id="功能及使用方法">功能及使用方法</h3>
<p>功能：<em>通过成员变量的地址得到它所在结构的首地址</em></p>
<p>参数：</p>
<ul>
<li>
<p>type 需要操作的数据类型</p>
</li>
<li>
<p>member type结构的成员名称</p>
</li>
<li>
<p>ptr member类型定义的指针变量</p>
</li>
</ul>
<p>使用方法例如：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&lt;stdio.h&gt;</span><span style="color:#1e889b">
</span><span style="color:#1e889b">#define container_of(*ptr*, *type*, *member*) ({      \
</span><span style="color:#1e889b">  const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);   \
</span><span style="color:#1e889b">  (type *)( (char *)__mptr - offsetof(type,member) ); })
</span><span style="color:#1e889b">#define offsetof(*TYPE*, *MEMBER*) ((size_t) &amp; ((TYPE *)0)-&gt;MEMBER)
</span><span style="color:#1e889b"></span><span style="color:#8b008b;font-weight:bold">struct</span> typeabc
{
  <span style="color:#00688b;font-weight:bold">int</span> mem0;
  <span style="color:#00688b;font-weight:bold">float</span> mem2;
  <span style="color:#00688b;font-weight:bold">double</span> mem4;
  <span style="color:#00688b;font-weight:bold">char</span> mem6;
};
<span style="color:#00688b;font-weight:bold">int</span> <span style="color:#008b45">main</span>()
{
  <span style="color:#8b008b;font-weight:bold">struct</span> typeabc abc, *pabc;
  abc.mem2 = <span style="color:#b452cd">0.0</span>;
  <span style="color:#00688b;font-weight:bold">float</span> *pmem2 = &amp;abc.mem2;
  <span style="color:#a61717;background-color:#e3d2d2">*/</span>/<span style="color:#a61717;background-color:#e3d2d2">通过成员变量的地址得到它所在结构的首地址</span>*
  pabc = container_of(pmem2, <span style="color:#8b008b;font-weight:bold">struct</span> typeabc, mem2);
  printf(<span style="color:#cd5555">&#34;%p</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>, pabc);
  <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>放在内核中，使用 container_of 可以方便的从链表指针找到其父结构中包含的任何变量，因为在C语言中，一个给定结构的变量偏移在编译的时候地址就被固定了下来。</p>
<h2 id="链表操作">链表操作</h2>
<p>所有操作的复杂度都是 O(1)</p>
<h3 id="插入节点">插入节点</h3>
<p>内核提供了一组链表操作流程，使用 list_add() 方法加入一个新节点到链表中：</p>
<p>从以下代码中可以看出，插入一个新节点时，是把新节点插入到了头结点和其下一个点的中间。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#228b22">// include/linux/list.h  34行
</span><span style="color:#228b22"></span><span style="color:#a61717;background-color:#e3d2d2">*/</span>**
 ** Insert a* *new* *entry between two known consecutive entries.*
 ***
 ** This is only* *<span style="color:#8b008b;font-weight:bold">for</span>* *internal* *list* *manipulation where we know*
 ** the prev/next entries already!*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#ifndef CONFIG_DEBUG_LIST
</span><span style="color:#1e889b"></span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> __list_add(<span style="color:#8b008b;font-weight:bold">struct</span> list_head *new,
         <span style="color:#8b008b;font-weight:bold">struct</span> list_head **prev*,
         <span style="color:#8b008b;font-weight:bold">struct</span> list_head **next*)
{
  next-&gt;prev = new;
  new-&gt;next = next;
  new-&gt;prev = prev;
  prev-&gt;next = new;
}
<span style="color:#1e889b">#else
</span><span style="color:#1e889b"></span><span style="color:#8b008b;font-weight:bold">extern</span> <span style="color:#00688b;font-weight:bold">void</span> __list_add(<span style="color:#8b008b;font-weight:bold">struct</span> list_head *new,
         <span style="color:#8b008b;font-weight:bold">struct</span> list_head **prev*,
         <span style="color:#8b008b;font-weight:bold">struct</span> list_head **next*);
<span style="color:#1e889b">#endif
</span><span style="color:#1e889b"></span><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_add - add a* *new* *entry*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>**new**:* *new* *entry to be added*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head:* *list* *head to add it after*
 ***
 ** Insert a* *new* *entry after the specified head.*
 ** This is good* *<span style="color:#8b008b;font-weight:bold">for</span>* *implementing stacks.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> list_add(<span style="color:#8b008b;font-weight:bold">struct</span> list_head *new, <span style="color:#8b008b;font-weight:bold">struct</span> list_head **head*)
{
  __list_add(new, head, head-&gt;next);
}
</code></pre></td></tr></table>
</div>
</div><h3 id="插入到链表尾部">插入到链表尾部：</h3>
<p>实质上是调用了 __list_add() 方法。把元素插在了投机前的前一个到头结点中间</p>
<p>include/linux/list.h 70行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_add_tail - add a* *new* *entry*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>**new**:* *new* *entry to be added*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head:* *list* *head to add it before*
 ***
 ** Insert a* *new* *entry before the specified head.*
 ** This is useful* *<span style="color:#8b008b;font-weight:bold">for</span>* *implementing queues.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> list_add_tail(<span style="color:#8b008b;font-weight:bold">struct</span> list_head *new, <span style="color:#8b008b;font-weight:bold">struct</span> list_head **head*)
{
  __list_add(new, head-&gt;prev, head);
}
</code></pre></td></tr></table>
</div>
</div><h3 id="删除节点">删除节点</h3>
<p>代码很容易看懂</p>
<p>include/linux/list.h 83行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>**
 ** Delete a* *list* *entry by making the prev/next entries*
 ** point to each other.*
 ***
 ** This is only* *<span style="color:#8b008b;font-weight:bold">for</span>* *internal* *list* *manipulation where we know*
 ** the prev/next entries already!*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> __list_del(<span style="color:#8b008b;font-weight:bold">struct</span> list_head * *prev*, <span style="color:#8b008b;font-weight:bold">struct</span> list_head * *next*)
{
  next-&gt;prev = prev;
  prev-&gt;next = next;
}
<span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_del - deletes entry from* *list**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>entry: the element to* *delete* *from the* *list**.*
 ** Note: list_empty() on entry does* *not* *<span style="color:#8b008b;font-weight:bold">return</span>* *<span style="color:#658b00">true</span>* *after* *this**, the entry is*
 ** in an undefined state.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#ifndef CONFIG_DEBUG_LIST
</span><span style="color:#1e889b"></span><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> list_del(<span style="color:#8b008b;font-weight:bold">struct</span> list_head **entry*)
{
  __list_del(entry-&gt;prev, entry-&gt;next);
  entry-&gt;next = LIST_POISON1;
  entry-&gt;prev = LIST_POISON2;
}
<span style="color:#1e889b">#else
</span><span style="color:#1e889b"></span><span style="color:#8b008b;font-weight:bold">extern</span> <span style="color:#00688b;font-weight:bold">void</span> list_del(<span style="color:#8b008b;font-weight:bold">struct</span> list_head **entry*);
<span style="color:#1e889b">#endif
</span></code></pre></td></tr></table>
</div>
</div><p>include/linux/list.h 136行 从链表中删除一个节点，并对其重新初始化</p>
<pre tabindex="0"><code>*/***
 ** list_del_init - deletes entry from* *list* *and* *reinitialize it.*
 ** @entry: the element to* *delete* *from the* *list**.*
 **/*
static inline void list_del_init(struct list_head **entry*)
{
  __list_del(entry-&gt;prev, entry-&gt;next);
  INIT_LIST_HEAD(entry);
}
// 重新初始化的方法，把下一个和前一个节点变成自己
static inline void INIT_LIST_HEAD(struct list_head **list*)
{
  list-&gt;next = list;
  list-&gt;prev = list;
}
</code></pre><h3 id="移动和合并节点">移动和合并节点</h3>
<p>直接把要移动的节点这一段的头尾给接起来，然后再插入到新的地方</p>
<p>移动节点 90行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_move - delete from one* *list* *and* *add* *as* *another**<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>s head*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>**list**: the entry to move*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head: the head that will precede our entry*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> list_move(<span style="color:#8b008b;font-weight:bold">struct</span> list_head **list*, <span style="color:#8b008b;font-weight:bold">struct</span> list_head **head*)
{
  __list_del(list-&gt;prev, list-&gt;next);
  list_add(list, head);
}
</code></pre></td></tr></table>
</div>
</div><p>合并节点 271行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">__list_splice</span>(<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">struct</span> list_head **list*,
         <span style="color:#8b008b;font-weight:bold">struct</span> list_head **prev*,
         <span style="color:#8b008b;font-weight:bold">struct</span> list_head **next*)
{
  <span style="color:#8b008b;font-weight:bold">struct</span> list_head *first = list-&gt;next;
  <span style="color:#8b008b;font-weight:bold">struct</span> list_head *last = list-&gt;prev;
  first-&gt;prev = prev;
  prev-&gt;next = first;
  last-&gt;next = next;
  next-&gt;prev = last;
}
<span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_splice - join two lists, this is designed* *<span style="color:#8b008b;font-weight:bold">for</span>* *stacks*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>**list**: the* *new* *list* *to add.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head: the place to add it in the first* *list**.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> list_splice(<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">struct</span> list_head **list*,
        <span style="color:#8b008b;font-weight:bold">struct</span> list_head **head*)
{
  <span style="color:#8b008b;font-weight:bold">if</span> (!list_empty(list))
    __list_splice(list, head, head-&gt;next);
}
</code></pre></td></tr></table>
</div>
</div><h2 id="遍历链表">遍历链表</h2>
<h3 id="正向遍历">正向遍历</h3>
<p>include/linux/list.h  367行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_for_each   -  iterate over a* *list*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>pos:   the &amp;<span style="color:#8b008b;font-weight:bold">struct</span> list_head to* *use* *as* *a* *loop* *cursor**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head:  the head* *<span style="color:#8b008b;font-weight:bold">for</span>* *your* *list**.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#define list_for_each(*pos*, *head*) \
</span><span style="color:#1e889b">  for (pos = (head)-&gt;next; prefetch(pos-&gt;next), pos != (head); \
</span><span style="color:#1e889b">      pos = pos-&gt;next)
</span></code></pre></td></tr></table>
</div>
</div><p>其中，使用了 prefetch() 宏，其功能是数据的预先读取。当你确认后继续要读取某内存的信息的时候，可以采用prefetch将这一块数据读 取到cache之中，以便后继快速访问。</p>
<p>利用上面提到的 list_entry() ，可以实现优美的遍历，把当前链表节点所在的结构体的结构地址拿出来。</p>
<p>418行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_for_each_entry  -  iterate over* *list* *of given type*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>pos:   the type <span style="color:#a61717;background-color:#e3d2d2">\</span>* to* *use* *as* *a* *loop* *cursor**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head:  the head* *<span style="color:#8b008b;font-weight:bold">for</span>* *your* *list**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>member: the name of the list_struct within the <span style="color:#8b008b;font-weight:bold">struct</span>.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#define list_for_each_entry(*pos*, *head*, *member*)        \
</span><span style="color:#1e889b">  for (pos = list_entry((head)-&gt;next, typeof(*pos), member);  \
</span><span style="color:#1e889b">     &amp;pos-&gt;member != (head);   \
</span><span style="color:#1e889b">     pos = list_entry(pos-&gt;member.next, typeof(*pos), member))
</span></code></pre></td></tr></table>
</div>
</div><p>可以看一个实际的例子：</p>
<p>fs/notify/inotify/inotify.c 213行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>**
 ** inotify_find_handle - find the watch associated with the given inode* *and*
 ** handle*
 ***
 ** Callers must hold inode-&gt;inotify_mutex.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">struct</span> inotify_watch *inode_find_handle(<span style="color:#8b008b;font-weight:bold">struct</span> inode **inode*,
              <span style="color:#8b008b;font-weight:bold">struct</span> inotify_handle **ih*)
{
  <span style="color:#8b008b;font-weight:bold">struct</span> inotify_watch *watch;
  list_for_each_entry(watch, &amp;inode-&gt;inotify_watches, i_list) {
    <span style="color:#8b008b;font-weight:bold">if</span> (watch-&gt;ih == ih)
      <span style="color:#8b008b;font-weight:bold">return</span> watch;
  }
  <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>这是linux中内核文件系统的更新通知机制，函数遍历了 inode-&gt;inotify_watchs中的所有项</p>
<h3 id="反向遍历">反向遍历</h3>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#228b22">// 425行
</span><span style="color:#228b22"></span><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_for_each_entry_reverse - iterate backwards over* *list* *of given type.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>pos:   the type <span style="color:#a61717;background-color:#e3d2d2">\</span>* to* *use* *as* *a* *loop* *cursor**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head:  the head* *<span style="color:#8b008b;font-weight:bold">for</span>* *your* *list**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>member: the name of the list_struct within the <span style="color:#8b008b;font-weight:bold">struct</span>.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#define list_for_each_entry_reverse(*pos*, *head*, *member*)      \
</span><span style="color:#1e889b">  for (pos = list_entry((head)-&gt;prev, typeof(*pos), member);  \
</span><span style="color:#1e889b">     prefetch(pos-&gt;member.prev), &amp;pos-&gt;member != (head);   \
</span><span style="color:#1e889b">     pos = list_entry(pos-&gt;member.prev, typeof(*pos), member))
</span></code></pre></td></tr></table>
</div>
</div><p>和上面一样，无非是沿着前驱遍历。</p>
<h3 id="遍历同时删除">遍历同时删除</h3>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#228b22">// 487行
</span><span style="color:#228b22"></span><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** list_for_each_entry_safe - iterate over* *list* *of given type safe against removal of* *list* *entry*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>pos:   the type <span style="color:#a61717;background-color:#e3d2d2">\</span>* to* *use* *as* *a* *loop* *cursor**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>n:    another type <span style="color:#a61717;background-color:#e3d2d2">\</span>* to* *use* *as* *temporary* *storage*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>head:  the head* *<span style="color:#8b008b;font-weight:bold">for</span>* *your* *list**.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>member: the name of the list_struct within the <span style="color:#8b008b;font-weight:bold">struct</span>.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#define list_for_each_entry_safe(*pos*, *n*, *head*, *member*)      \
</span><span style="color:#1e889b">  for (pos = list_entry((head)-&gt;next, typeof(*pos), member),  \
</span><span style="color:#1e889b">    n = list_entry(pos-&gt;member.next, typeof(*pos), member); \
</span><span style="color:#1e889b">     &amp;pos-&gt;member != (head);           \
</span><span style="color:#1e889b">     pos = n, n = list_entry(n-&gt;member.next, typeof(*n), member))
</span></code></pre></td></tr></table>
</div>
</div><p>删除的原理是，在删除之前存储 next 指针到一个临时变量，以便能执行删除操作。</p>
<p>比如在 fs/notify/inotify/inotify.c 452行中：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** inotify_inode_is_dead - an inode has been deleted, cleanup any watches*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>inode: inode that is about to be removed*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">void</span> inotify_inode_is_dead(<span style="color:#8b008b;font-weight:bold">struct</span> inode **inode*)
{
  <span style="color:#8b008b;font-weight:bold">struct</span> inotify_watch *watch, *next;
  mutex_lock(&amp;inode-&gt;inotify_mutex);
  list_for_each_entry_safe(watch, next, &amp;inode-&gt;inotify_watches, i_list) {
    <span style="color:#8b008b;font-weight:bold">struct</span> inotify_handle *ih = watch-&gt;ih;
    mutex_lock(&amp;ih-&gt;mutex);
    inotify_remove_watch_locked(ih, watch);
    mutex_unlock(&amp;ih-&gt;mutex);
  }
  mutex_unlock(&amp;inode-&gt;inotify_mutex);
}
</code></pre></td></tr></table>
</div>
</div><p>此函数遍历 inotify_watches 链表中所有项</p>
<p>其余链表还有很多操作，都可以在该头文件中找到。</p>
<h1 id="队列">队列</h1>
<p>操作系统的编程模型有生产者和消费者，生产者生产数据，消费者消费数据，需要一个队列来当中间人。</p>
<p>原理无非是先入先出（FIFO）。</p>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828012915.png" alt="img"></p>
<p>Linux内核中的队实现在 <code>kernel/kfifo.c</code> 中，而声明在 <code>include/linux/kfifo.h</code> 中。</p>
<h2 id="kfifo">Kfifo</h2>
<p>include/linux/kfifo.h 47行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8b008b;font-weight:bold">struct</span> kfifo {
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">char</span> *buffer;  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* the buffer holding the data <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> size;  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* the size of the allocated buffer <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> in;   <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* data is added at offset (in % size) <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> out;  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* data is extracted from off. (out % size) <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
};
</code></pre></td></tr></table>
</div>
</div><p>Linux的kfifo提供了两个操作：</p>
<ul>
<li>
<p>enqueue 入队</p>
</li>
<li>
<p>dequeue 出队</p>
</li>
</ul>
<p>kfifo对象维护了两个对象：</p>
<ul>
<li>
<p>入口偏移量：下一次入队列时候的位置</p>
</li>
<li>
<p>出口偏移量：下一次出队列时的位置</p>
</li>
</ul>
<blockquote>
<p>出口偏移量总是小于入口偏移量，否则无意义，因为那样说明要出队列的元素根本还没有入队列</p>
</blockquote>
<ul>
<li>
<p>入队是拷贝数据到队列的入口偏移量。之后入口偏移量增加推入的元素数目。</p>
</li>
<li>
<p>出队操作是从队列的出口偏移量处拷贝数据。之后出口偏移量减去摘取元素的数目。</p>
</li>
<li>
<p>In == out 时说明队列空了，在新的数据被推入前，不可以在摘取任何数据了。</p>
</li>
<li>
<p>入口偏移量等于队列长度时，说明在队列 resize 前，不可以再加入新数据</p>
</li>
</ul>
<h2 id="创建队列">创建队列</h2>
<p>kernel/kfifo.c 56行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_alloc - allocates a* *new* *FIFO internal buffer*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>fifo: the fifo to assign then* *new* *buffer*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>size: the size of the buffer to be allocated,* *this* *have to be a power of* *<span style="color:#b452cd">2.</span>*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>gfp_mask: get_free_pages mask,* *passed to* *kmalloc**()*
 ***
 ** This function dynamically allocates a* *new* *fifo internal buffer*
 ***
 ** The size will be rounded-up to a power of* *<span style="color:#b452cd">2.</span>*
 *** *The buffer will be release with* *kfifo_free**()**.*
 ** Return* *<span style="color:#b452cd">0</span>* *<span style="color:#8b008b;font-weight:bold">if</span>* *no error, otherwise the an error code*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">int</span> kfifo_alloc(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*, <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> *size*, gfp_t *gfp_mask*)
{
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">char</span> *buffer;
  <span style="color:#a61717;background-color:#e3d2d2">*/</span>**
   ** round up to the next power of* *<span style="color:#b452cd">2</span>**, since our* *<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>let the indices*
   ** wrap<span style="color:#a61717;background-color:#e3d2d2">&#39;</span> technique works only in* *this* *<span style="color:#8b008b;font-weight:bold">case</span>**.*
   *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
  <span style="color:#8b008b;font-weight:bold">if</span> (!is_power_of_2(size)) {
    BUG_ON(size &gt; <span style="color:#b452cd">0x80000000</span>);
    size = roundup_pow_of_two(size);
  }
  buffer = kmalloc(size, gfp_mask);
  <span style="color:#8b008b;font-weight:bold">if</span> (!buffer) {
    _kfifo_init(fifo, <span style="color:#658b00">NULL</span>, <span style="color:#b452cd">0</span>);
    <span style="color:#8b008b;font-weight:bold">return</span> -ENOMEM;
  }
  _kfifo_init(fifo, buffer, size);
  <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>此函数初始化了一个大小为 size 的kfifo</p>
</li>
<li>
<p>使用 gfp_mask 标识分配队列</p>
</li>
<li>
<p>如果成功会返回0，如果错误会返回一个错误码。</p>
</li>
<li>
<p>size必须是2的次幂</p>
</li>
</ul>
<blockquote>
<p>kfifo的size是2^n。所以当in &gt; 2^n的时候，(in &amp; 2^n - 1) == (in % 2^n)，所以这里可以用与操作替代求余来获取in在队列中实际的位置。</p>
</blockquote>
<p>其中</p>
<p>kernel/kfifo.c 31行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">_kfifo_init</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*, <span style="color:#00688b;font-weight:bold">void</span> **buffer*,
    <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> *size*)
{
  fifo-&gt;buffer = buffer;
  fifo-&gt;size = size;
  kfifo_reset(fifo);
}
</code></pre></td></tr></table>
</div>
</div><ul>
<li>此函数创建并初始化一个 kfifo 对象，使用 buffer指向的 size 字节大小的内存。</li>
</ul>
<p>静态声明方法：</p>
<p>include/linux/kfifo.h 67行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** DECLARE_KFIFO - macro to* *declare* *a kfifo* *and* *the associated buffer*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>name: name of the declared kfifo datatype*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>size: size of the fifo buffer. Must be a power of two.*
 ***
 ** Note1: the macro can be used inside <span style="color:#8b008b;font-weight:bold">struct</span>* *or* *<span style="color:#8b008b;font-weight:bold">union</span> declaration*
 ** Note2: the macro creates two objects:*
 **  A kfifo object with the given name* *and* *a buffer* *<span style="color:#8b008b;font-weight:bold">for</span>* *the kfifo*
 **  object named name**<span style="color:#a61717;background-color:#e3d2d2">##</span>kfifo_buffer*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#define DECLARE_KFIFO(*name*, *size*) \
</span><span style="color:#1e889b">union { \
</span><span style="color:#1e889b">  struct kfifo name; \
</span><span style="color:#1e889b">  unsigned char name##kfifo_buffer[size + sizeof(struct kfifo)]; \
</span><span style="color:#1e889b">}
</span></code></pre></td></tr></table>
</div>
</div><p>和</p>
<p>include/linux/kfifo.h 83行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** INIT_KFIFO - Initialize a kfifo declared by DECLARE_KFIFO*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>name: name of the declared kfifo datatype*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#1e889b">#define INIT_KFIFO(*name*) \
</span><span style="color:#1e889b">  name = __kfifo_initializer(sizeof(name##kfifo_buffer) - \
</span><span style="color:#1e889b">        sizeof(struct kfifo), \
</span><span style="color:#1e889b">        name##kfifo_buffer + sizeof(struct kfifo))
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>上面两个方法会创建一个名为 name ，大小为 size 的 kfifo 对象，和前面一样，size 必须是2的幂。</li>
</ul>
<h2 id="入队操作">入队操作</h2>
<p>kernel/kfifo.c 240行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_in - puts some data into the FIFO*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>fifo: the fifo to be used.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>from: the data to be added.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>**len**: the length of the data to be added.*
 ***
 ** This function copies at most <span style="color:#a61717;background-color:#e3d2d2">@</span>**len* *bytes from the <span style="color:#a61717;background-color:#e3d2d2">@</span>from buffer into*
 ** the FIFO depending on the free space, and returns the number of*
 ** bytes copied.*
 ***
 ** Note that with only one concurrent reader and one concurrent*
 ** writer, you don**<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>t need extra locking to use these functions.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> kfifo_in(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*, <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">void</span> **from*,
        <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> *len*)
{
  len = min(kfifo_avail(fifo), len);
  __kfifo_in_data(fifo, from, len, <span style="color:#b452cd">0</span>);
  __kfifo_add_in(fifo, len);
  <span style="color:#8b008b;font-weight:bold">return</span> len;
}
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>把 from 指针指向的 len  字节数据拷贝到 fifo 所指的队列中，如果成功，则返回推入字节的大小。</p>
</li>
<li>
<p>如果队列中的空闲字节 &lt; len，则该函数值最多可拷贝队列可用空间那么多的数据。</p>
</li>
</ul>
<p>从  kernel/kfifo.c 119行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">__kfifo_in_data</span>(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*,
    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">void</span> **from*, <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> *len*, <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> *off*)
{
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> l;
  <span style="color:#a61717;background-color:#e3d2d2">*/</span>**
   ** Ensure that we sample the fifo-&gt;out index -before- we*
   ** start putting bytes into the kfifo.*
   *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
  smp_mb();
  off = __kfifo_off(fifo, fifo-&gt;in + off);
  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* first put the data starting from fifo-&gt;in to buffer end <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  l = min(len, fifo-&gt;size - off);
  memcpy(fifo-&gt;buffer + off, from, l);
  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* then put the rest (<span style="color:#8b008b;font-weight:bold">if</span> any) at the beginning of the buffer <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  memcpy(fifo-&gt;buffer, from + l, len - l);
}
</code></pre></td></tr></table>
</div>
</div><p>可以看出，拷贝数据的时候使用的是函数 memcpy</p>
<h2 id="出队操作">出队操作</h2>
<p>kernel/kfifo.c 283行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_out - gets some data from the FIFO*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>fifo: the fifo to be used.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>to: where the data must be copied.*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>**len**: the size of the destination buffer.*
 ***
 ** This function copies at most <span style="color:#a61717;background-color:#e3d2d2">@</span>**len* *bytes from the FIFO into the*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>to buffer and returns the number of copied bytes.*
 ***
 ** Note that with only one concurrent reader and one concurrent*
 ** writer, you don**<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>t need extra locking to use these functions.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> kfifo_out(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*, <span style="color:#00688b;font-weight:bold">void</span> **to*, <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> *len*)
{
  len = min(kfifo_len(fifo), len);
  __kfifo_out_data(fifo, to, len, <span style="color:#b452cd">0</span>);
  __kfifo_add_out(fifo, len);
  <span style="color:#8b008b;font-weight:bold">return</span> len;
}
</code></pre></td></tr></table>
</div>
</div><ul>
<li>该函数从 fifo 指向的队列中拷贝出长度为len的字节到to所指的缓冲中。如果成功，则返回拷贝数据的长度。如果队列中数据大小小于len，则该函数拷贝出的数据必然小于需要的数据大小</li>
</ul>
<p>当数据被摘取后，数据就会被删除掉，如果只是想看一下队列的数据，而不像被删除，可以使用 kernel/kfifo.c 306行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_out_peek - copy some data from the FIFO, but* *<span style="color:#8b008b;font-weight:bold">do</span>* *not remove it*
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>fifo**: the fifo to be used.*
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>to**: where the data must be copied.*
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>len**: the size of the destination buffer.*
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>offset**: offset into the fifo*
 ***
 ** This function copies at most* *<span style="color:#a61717;background-color:#e3d2d2">@</span>len* *bytes at* *<span style="color:#a61717;background-color:#e3d2d2">@</span>offset* *from the FIFO*
 ** into the* *<span style="color:#a61717;background-color:#e3d2d2">@</span>to* *buffer and returns the number of copied bytes.*
 ** The data is not removed from the FIFO.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> kfifo_out_peek(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*, <span style="color:#00688b;font-weight:bold">void</span> **to*, <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> *len*,
        <span style="color:#00688b;font-weight:bold">unsigned</span> *offset*)
{
  len = min(kfifo_len(fifo), len + offset);
  __kfifo_out_data(fifo, to, len, offset);
  <span style="color:#8b008b;font-weight:bold">return</span> len;
}
</code></pre></td></tr></table>
</div>
</div><p>进行只读数据。</p>
<h2 id="获取队列长度">获取队列长度</h2>
<p>include/linux/kfifo.h 148行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_size - returns the size of the fifo in bytes*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>fifo: the fifo to be used.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> __must_check <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> kfifo_size(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo *fifo)
{
  <span style="color:#8b008b;font-weight:bold">return</span> fifo-&gt;size;
}
</code></pre></td></tr></table>
</div>
</div><ul>
<li>此函数获得存储 kfifo 队列的总体空间大小（字节为单位）</li>
</ul>
<p>include/linux/kfifo.h 157行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_len - returns the number of used bytes in the FIFO*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>fifo: the fifo to be used.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span> kfifo_len(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*)
{
  <span style="color:#8b008b;font-weight:bold">register</span> <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">int</span>  out;
  out = fifo-&gt;out;
  smp_rmb();
  <span style="color:#8b008b;font-weight:bold">return</span> fifo-&gt;in - out;
}
</code></pre></td></tr></table>
</div>
</div><ul>
<li>此函数表示当前队列中的元素数量，从源码可以看出来，是做了一次减法运算。</li>
</ul>
<h2 id="重置和撤销队列">重置和撤销队列</h2>
<p>重置队列：include/linux/kfifo.h 129行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_reset - removes the entire FIFO contents*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>fifo: the fifo to be emptied.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#8b008b;font-weight:bold">static</span> <span style="color:#8b008b;font-weight:bold">inline</span> <span style="color:#00688b;font-weight:bold">void</span> kfifo_reset(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*)
{
  fifo-&gt;in = fifo-&gt;out = <span style="color:#b452cd">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>从源码可以看出，实质上是直接把入口和出口偏移量变成了0</p>
<p>撤销队列：kernel/kfifo.c 93行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** kfifo_free - frees the FIFO internal buffer*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>fifo: the fifo to be freed.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">void</span> kfifo_free(<span style="color:#8b008b;font-weight:bold">struct</span> kfifo **fifo*)
{
  kfree(fifo-&gt;buffer);
  _kfifo_init(fifo, <span style="color:#658b00">NULL</span>, <span style="color:#b452cd">0</span>);
}
</code></pre></td></tr></table>
</div>
</div><p>从源码可以看出，首先调用了 kfee 释放了内存，然后初始化了一个 NULL 的kfifo对象</p>
<h1 id="映射">映射</h1>
<p>映射就是我们常见的 k-v 键值对。是由唯一键组成的集合，而每个键必然关联一个特定的值。这种键到值的关系称为映射，映射至少要支持三个操作：</p>
<ul>
<li>
<p>ADD(k,v)</p>
</li>
<li>
<p>Remove（key）</p>
</li>
<li>
<p>Value = Lookup (key)</p>
</li>
</ul>
<p>Linux 内核提供了简单的、有效的映射数据结构。但是他并非是一个通用的映射，他的目标是：映射一个唯一的标识数（UID）到一个指针</p>
<h2 id="数据结构选型">数据结构选型</h2>
<p>我们知道，散列表（Hash）也是一种常用的实现 k,v 的方法，为什么在 linux 中选用了红黑树呢？</p>
<ol>
<li>
<p>用散列表需要设定具体大小和散列函数，而红黑树优雅的扩展存储任意键</p>
</li>
<li>
<p>散列表如果遇到哈希冲突，那么最坏的时间复杂度是 O(n)，而红黑树最坏情况下是 O(logn)，所以红黑树在最坏的复杂度下有更好的表现</p>
</li>
<li>
<p>二叉搜索树是有序的，可以给用户的按序遍历带来良好的性能</p>
</li>
<li>
<p>二叉搜索树不需要散列函数</p>
</li>
</ol>
<h2 id="初始化">初始化</h2>
<p>idr的定义：include/linux/idr.h 59行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8b008b;font-weight:bold">struct</span> idr {
  <span style="color:#8b008b;font-weight:bold">struct</span> idr_layer *top;
  <span style="color:#8b008b;font-weight:bold">struct</span> idr_layer *id_free;
  <span style="color:#00688b;font-weight:bold">int</span>    layers; <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* only valid without concurrent changes <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  <span style="color:#00688b;font-weight:bold">int</span>    id_free_cnt;
  spinlock_t   lock;
};
</code></pre></td></tr></table>
</div>
</div><p>初始化函数：lib/idr.c 680行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** idr_init - initialize idr handle*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>idp:   idr handle*
 ***
 *** *This function is use to* *set* *up the* *handle* *(<span style="color:#a61717;background-color:#e3d2d2">@</span>idp)* *that you will pass*
 ** to the rest of the functions.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">void</span> idr_init(<span style="color:#8b008b;font-weight:bold">struct</span> idr **idp*)
{
  memset(idp, <span style="color:#b452cd">0</span>, <span style="color:#8b008b;font-weight:bold">sizeof</span>(<span style="color:#8b008b;font-weight:bold">struct</span> idr));
  spin_lock_init(&amp;idp-&gt;lock);
}
</code></pre></td></tr></table>
</div>
</div><p>调用了一下 memset函数，把对应空间置零，然后初始化了其中的 lock .</p>
<h2 id="分配uid">分配UID</h2>
<p>建立 idr 后，就可以分配新的 UID 了.</p>
<ol>
<li>
<p>告诉idr需要分配新的UID，允许其在必要时调整后备树大小</p>
</li>
<li>
<p>请求真正的新的UID</p>
</li>
</ol>
<p>lib/idr.c 108行  调整后备树的大小</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** idr_pre_get - reserver resources* *<span style="color:#8b008b;font-weight:bold">for</span>* *idr allocation*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>idp:   idr handle*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>gfp_mask:  memory allocation flags*
 ***
 ** This function should be called prior to locking* *and* *calling the*
 ** idr_get_new<span style="color:#a61717;background-color:#e3d2d2">\</span>* functions. It preallocates enough memory to satisfy*
 ** the worst possible allocation.*
 ***
 ** If the system is REALLY out of memory* *this* *function returns* *<span style="color:#b452cd">0</span>**,*
 ** otherwise* *<span style="color:#b452cd">1.</span>*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">int</span> idr_pre_get(<span style="color:#8b008b;font-weight:bold">struct</span> idr **idp*, gfp_t *gfp_mask*)
{
  <span style="color:#8b008b;font-weight:bold">while</span> (idp-&gt;id_free_cnt &lt; IDR_FREE_MAX) {
    <span style="color:#8b008b;font-weight:bold">struct</span> idr_layer *new;
    new = kmem_cache_zalloc(idr_layer_cache, gfp_mask);
    <span style="color:#8b008b;font-weight:bold">if</span> (new == <span style="color:#658b00">NULL</span>)
      <span style="color:#8b008b;font-weight:bold">return</span> (<span style="color:#b452cd">0</span>);
    move_to_free_list(idp, new);
  }
  <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">1</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>从源码可以看出，调整由 idp 指向 idr 的大小，如果真的需要调整大小，内存分配例程使用 gfp 标识：gfp_mask</p>
<p>lib/idr.c 315行  实际执行获取新的UID</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** idr_get_new - allocate* *new* *idr entry*
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>idp**: idr handle*
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>ptr**: pointer you want associated with the id*
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>id**: pointer to the allocated handle*
 ***
 ** This is the allocate id function.  It should be called with any*
 ** required locks.*
 ***
 ** If memory is required, it will* *<span style="color:#8b008b;font-weight:bold">return</span>* *-EAGAIN, you should unlock*
 *** *and go back to the* *idr_pre_get**()* *call.  If the idr is full, it will*
 *** *<span style="color:#8b008b;font-weight:bold">return</span>* *-ENOSPC.*
 ***
 *** *<span style="color:#a61717;background-color:#e3d2d2">@</span>id* *returns a value in the range* *<span style="color:#b452cd">0</span>* *...* *<span style="color:#b452cd">0x7fffffff</span>*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">int</span> idr_get_new(<span style="color:#8b008b;font-weight:bold">struct</span> idr **idp*, <span style="color:#00688b;font-weight:bold">void</span> **ptr*, <span style="color:#00688b;font-weight:bold">int</span> **id*)
{
  <span style="color:#00688b;font-weight:bold">int</span> rv;
  rv = idr_get_new_above_int(idp, ptr, <span style="color:#b452cd">0</span>);
  <span style="color:#a61717;background-color:#e3d2d2">*/</span>**
   ** This is a cheap hack until the IDR code can be fixed to*
   *** *<span style="color:#8b008b;font-weight:bold">return</span>* *proper error values.*
   *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
  <span style="color:#8b008b;font-weight:bold">if</span> (rv &lt; <span style="color:#b452cd">0</span>)
    <span style="color:#8b008b;font-weight:bold">return</span> _idr_rc_to_errno(rv);
  *id = rv;
  <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>该方法使用 idp 指向的 idr 分配一个新的 UID ，并且将其关联到指针 ptr 上。成功时，该方法返回0，并且将新的 UID 存于 id.</p>
<h2 id="查找uid">查找UID</h2>
<p>lib/idr.c 490行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** idr_find -* *<span style="color:#8b008b;font-weight:bold">return</span>* *pointer* *<span style="color:#8b008b;font-weight:bold">for</span>* *given id*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>idp: idr handle*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>id: lookup key*
 ***
 ** Return the pointer given the id it has been registered with.  A %**<span style="color:#658b00">NULL</span>*
 *** *<span style="color:#8b008b;font-weight:bold">return</span>* *indicates that <span style="color:#a61717;background-color:#e3d2d2">@</span>id is* *not* *valid* *or* *you passed %**<span style="color:#658b00">NULL</span>* *in*
 ** idr_get_new().*
 ***
 *** *This function can be called under* *rcu_read_lock**()**, given that the leaf*
 ** pointers lifetimes are correctly managed.*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">void</span> *idr_find(<span style="color:#8b008b;font-weight:bold">struct</span> idr **idp*, <span style="color:#00688b;font-weight:bold">int</span> *id*)
{
  <span style="color:#00688b;font-weight:bold">int</span> n;
  <span style="color:#8b008b;font-weight:bold">struct</span> idr_layer *p;
  p = rcu_dereference_raw(idp-&gt;top);
  <span style="color:#8b008b;font-weight:bold">if</span> (!p)
    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
  n = (p-&gt;layer+<span style="color:#b452cd">1</span>) * IDR_BITS;
  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* Mask off upper bits we don<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>t use <span style="color:#8b008b;font-weight:bold">for</span> the search. <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  id &amp;= MAX_ID_MASK;
  <span style="color:#8b008b;font-weight:bold">if</span> (id &gt;= (<span style="color:#b452cd">1</span> &lt;&lt; n))
    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#658b00">NULL</span>;
  BUG_ON(n == <span style="color:#b452cd">0</span>);
  <span style="color:#8b008b;font-weight:bold">while</span> (n &gt; <span style="color:#b452cd">0</span> &amp;&amp; p) {
    n -= IDR_BITS;
    BUG_ON(n != p-&gt;layer*IDR_BITS);
    p = rcu_dereference_raw(p-&gt;ary[(id &gt;&gt; n) &amp; IDR_MASK]);
  }
  <span style="color:#8b008b;font-weight:bold">return</span>((<span style="color:#00688b;font-weight:bold">void</span> *)p);
}
</code></pre></td></tr></table>
</div>
</div><p>如果调用成功，则返回id关联的指针，如果错误则返回空指针</p>
<h2 id="删除uid">删除UID</h2>
<p>lib/idr.c 390行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** idr_remove - remove the given id* *and* *free it**<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>s slot*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>idp: idr handle*
 ** <span style="color:#a61717;background-color:#e3d2d2">@</span>id: unique key*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">void</span> idr_remove(<span style="color:#8b008b;font-weight:bold">struct</span> idr **idp*, <span style="color:#00688b;font-weight:bold">int</span> *id*)
{
  <span style="color:#8b008b;font-weight:bold">struct</span> idr_layer *p;
  <span style="color:#8b008b;font-weight:bold">struct</span> idr_layer *to_free;
  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* Mask off upper bits we don<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>t use <span style="color:#8b008b;font-weight:bold">for</span> the search. <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
  id &amp;= MAX_ID_MASK;
  sub_remove(idp, (idp-&gt;layers - <span style="color:#b452cd">1</span>) * IDR_BITS, id);
  <span style="color:#8b008b;font-weight:bold">if</span> (idp-&gt;top &amp;&amp; idp-&gt;top-&gt;count == <span style="color:#b452cd">1</span> &amp;&amp; (idp-&gt;layers &gt; <span style="color:#b452cd">1</span>) &amp;&amp;
    idp-&gt;top-&gt;ary[<span style="color:#b452cd">0</span>]) {
    <span style="color:#a61717;background-color:#e3d2d2">*/</span>**
     ** Single child at leftmost slot: we can shrink the tree.*
     ** This level is not needed anymore since when layers are*
     ** inserted, they are inserted at the top of the existing*
     ** tree.*
     *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
    to_free = idp-&gt;top;
    p = idp-&gt;top-&gt;ary[<span style="color:#b452cd">0</span>];
    rcu_assign_pointer(idp-&gt;top, p);
    --idp-&gt;layers;
    to_free-&gt;bitmap = to_free-&gt;count = <span style="color:#b452cd">0</span>;
    free_layer(to_free);
  }
  <span style="color:#8b008b;font-weight:bold">while</span> (idp-&gt;id_free_cnt &gt;= IDR_FREE_MAX) {
    p = get_from_free_list(idp);
    <span style="color:#a61717;background-color:#e3d2d2">*/</span>**
     ** Note: we don**<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>t call the rcu callback here, since the only*
     ** layers that fall into the freelist are those that have been*
     ** preallocated.*
     *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
    kmem_cache_free(idr_layer_cache, p);
  }
  <span style="color:#8b008b;font-weight:bold">return</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>如果删除成功，会将id关联的指针一起从映射中删除。但是，这个函数没有办法提示任何错误。</p>
<h2 id="撤销-idr">撤销 idr</h2>
<p>lib/idr.c 477行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#a61717;background-color:#e3d2d2">*/</span>***
 ** idr_destroy - release all cached layers within an idr tree*
 ** idp: idr handle*
 *<span style="color:#a61717;background-color:#e3d2d2">*/</span>*
<span style="color:#00688b;font-weight:bold">void</span> idr_destroy(<span style="color:#8b008b;font-weight:bold">struct</span> idr **idp*)
{
  <span style="color:#8b008b;font-weight:bold">while</span> (idp-&gt;id_free_cnt) {
    <span style="color:#8b008b;font-weight:bold">struct</span> idr_layer *p = get_from_free_list(idp);
    kmem_cache_free(idr_layer_cache, p);
  }
}
</code></pre></td></tr></table>
</div>
</div><p>这个源码很好懂，通过循环，直接释放idr中未使用的内存。但是它并不释放当前分配给UID使用的任何内存。通常来说，内核代码不会撤销 idr</p>
<h1 id="二叉树">二叉树</h1>
<p>树是一个有向无环图（DAG）图，二叉树是每个节点最多只有两个出边以及0或1个入边的树。</p>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828013724.png" alt="img"></p>
<h2 id="二叉树搜索树bst">二叉树搜索树（BST）</h2>
<p>遵循以下规则：</p>
<ol>
<li>
<p>一个节点的左儿子小于这个节点的值</p>
</li>
<li>
<p>这个节点的右儿子大于这个节点的值</p>
</li>
<li>
<p>其所有的子树也是二叉搜索树</p>
</li>
</ol>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828013747.png" alt="img"></p>
<h2 id="平衡二叉树">平衡二叉树</h2>
<p>平衡二叉树递归定义如下：</p>
<ol>
<li>
<p>左右子树的高度差小于等于 1。</p>
</li>
<li>
<p>其每一个子树均为平衡二叉树。</p>
</li>
</ol>
<h2 id="平衡二叉搜索树">平衡二叉搜索树</h2>
<ol>
<li>
<p>必须是一棵二叉树</p>
</li>
<li>
<p>必须是一棵二叉搜索树</p>
</li>
<li>
<p>要满足平衡的特性</p>
</li>
</ol>
<p>定义：</p>
<ul>
<li>
<p>深度：从根节点起，到达他一共经过的父节点数目。</p>
</li>
<li>
<p>叶子节点：树的最底层节点（没有儿子）</p>
</li>
<li>
<p>树的高度：树中处于最底层节点的数目</p>
</li>
</ul>
<p>平衡二叉搜索树（英语：Balanced Binary Search Tree）是一种结构平衡的二叉搜索树，它是一种每个节点的左右两子树高度差都不超过一的二叉树。它能在O(logn)内完成插入、查找和删除操作，最早被发明的平衡二叉搜索树为AVL树。</p>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828013835.png" alt="img"></p>
<h2 id="自平衡二叉搜索树">自平衡二叉搜索树</h2>
<p>定义：在保证是一棵二叉搜索树的前提下，要保证自平衡</p>
<h3 id="avl树">AVL树</h3>
<p>虽然书上没有AVL，但是还是拿出来说一下。</p>
<h4 id="基本定义">基本定义</h4>
<p>为了保证平衡的特性，AVL 树引入了所谓监督机制，就是在树的某一部分的不平衡度超过一个阈值后触发相应的平衡操作。保证树的平衡度在可以接受的范围内。</p>
<p>定义：</p>
<ul>
<li>
<p>平衡因子：某个节点的左子树高度减去右子树高度的差值。</p>
</li>
<li>
<p>AVL 树： 所有结点的平衡因子的绝对值都不超过 1 的二叉树。</p>
</li>
</ul>
<p>所以当插入新节点时，层数会增加导致AVL的性质被破坏，这时就需要进行一些操作，来使树具有AVL性质。最多旋转的次数是二叉树的层数，所以时间复杂度是 O(nlogn)</p>
<h4 id="具体实现">具体实现</h4>
<p>二叉树的平衡化有两大基础操作： 左旋和右旋。左旋，即是逆时针旋转；右旋，即是顺时针旋转。这种旋转在整个平衡化过程中可能进行一次或多次，这两种操作都是从失去平衡的最小子树根结点开始的(即离插入结点最近且平衡因子超过1的祖结点)。</p>
<h4 id="右旋操作">右旋操作：</h4>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828013905.png" alt="img"></p>
<p>所谓右旋操作，就是把上图中的 B 节点和 C 节点进行所谓“父子交换”。在仅有这三个节点时候，是十分简单的。但是当 B 节点处存在右孩子时，事情就变得有点复杂了。我们通常的操作是：<strong>抛弃右孩子，将之和旋转后的节点 C 相连，成为节点 C 的左孩子</strong>。</p>
<h4 id="左旋操作">左旋操作</h4>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828013918.png" alt="img"></p>
<p>左旋操作和右旋操作十分类似，唯一不同的就是需要将左右呼唤下。我们可以认为这两种操作是对称的</p>
<h4 id="需要平衡的四种情况">需要平衡的四种情况</h4>
<h5 id="ll型">LL型</h5>
<p><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828013938.png" alt="img"></p>
<p>所谓 LL 型就是上图左边那种情况，即因为在根节点的左孩子的左子树添加了新节点，导致根节点的平衡因子变为 +2，二叉树失去平衡。对于这种情况，对节点 n 右旋一次即可。</p>
<h5 id="rr型">RR型</h5>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828013959.png" alt="img"></p>
<p>RR 型的情况和 LL 型完全对称。只需要对节点 n 进行一次左旋即可修正。</p>
<h5 id="lr型">LR型</h5>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014003.png" alt="img"></p>
<p>LR 就是将新的节点插入到了 n 的左孩子的右子树上导致的不平衡的情况。这时我们需要的是先对 i 进行一次左旋再对 n 进行一次右旋。</p>
<h5 id="rl型">RL型</h5>
<p>RL 就是将新的节点插入到了 n 的右孩子的左子树上导致的不平衡的情况。这时我们需要的是先对 i 进行一次右旋再对 n 进行一次左旋。</p>
<p>这四种情况的判断很简单。我们根据破坏树的平衡性（平衡因子的绝对值大于 1）的节点以及其子节点的平衡因子来判断平衡化类型。</p>
<h4 id="插入">插入</h4>
<p>插入成功后，在递归回溯时依次对经过的结点判断是否失衡，若失衡就需要对其进行对应的旋转操作使其恢复平衡，在这期间，原先作为一棵子树的根结点就会因为旋转被替换</p>
<h4 id="删除">删除</h4>
<p>删除操作的四种失衡情况和插入操作一样</p>
<h3 id="红黑树">红黑树</h3>
<p>红黑树（英语：Red–black tree）是一种自平衡二叉查找树，是在计算机科学中用到的一种数据结构，典型的用途是实现关联数组。它在1972年由鲁道夫·贝尔发明，被称为&quot;对称二叉B树&quot;，它现代的名字源于Leo J. Guibas和Robert Sedgewick于1978年写的一篇论文。红黑树的结构复杂，但它的操作有着良好的最坏情况运行时间，并且在实践中高效：它可以在O(logn)时间内完成查找、插入和删除，这里的n是树中元素的数目</p>
<h4 id="性质">性质</h4>
<ol>
<li>
<p>每个节点要么是红的，要么是黑的</p>
</li>
<li>
<p>根节点时黑色的</p>
</li>
<li>
<p>所有的叶子节点都是黑色的（叶子节点是NIL节点）</p>
</li>
<li>
<p>如果一个节点是红色的，则它的两个儿子都是黑色的（从每个叶子到根的所有路径上不能有两个连续的红色节点。）</p>
</li>
<li>
<p>从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。</p>
</li>
</ol>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014137.png" alt="img"></p>
<p>这些约束确保了红黑树的关键特性：</p>
<p><strong>从根到叶子的最长的可能路径不多于最短的可能路径的两倍长。结果是这个树大致上是平衡的</strong>。</p>
<p>因为操作比如插入、删除和查找某个值的最坏情况时间都要求与树的高度成比例，这个在高度上的理论上限允许红黑树在最坏情况下都是高效的，而不同于普通的二叉查找树。</p>
<p>要知道为什么这些性质确保了这个结果，注意到性质4导致了路径不能有两个相连的红色节点就足够了。最短的可能路径都是黑色节点，最长的可能路径有交替的红色和黑色节点。因为根据性质5所有最长的路径都有相同数目的黑色节点，这就表明了没有路径能多于任何其他路径的两倍长。</p>
<p>在很多树数据结构的表示中，一个节点有可能只有一个子节点，而叶子节点包含数据。用这种范例表示红黑树是可能的，但是这会改变一些性质并使算法复杂。为此，本文中我们使用&quot;nil叶子&quot;或&quot;空（null）叶子&quot;，如上图所示，它不包含数据而只充当树在此结束的指示。这些节点在绘图中经常被省略，导致了这些树好像同上述原则相矛盾，而实际上不是这样。与此有关的结论是所有节点都有两个子节点，尽管其中的一个或两个可能是空叶子。</p>
<h4 id="旋转">旋转</h4>
<p>红黑树也是一个特化的二叉查找树，所以只读操作和普通而二叉查找树相同。</p>
<p>但是插入或删除会导致不符合红黑树性质，所以需要O(logn)的颜色变更（每个节点不超过三次旋转）</p>
<p>对于重新着色，并不困难。可以看一下「旋转」方式：</p>
<h5 id="左旋">左旋</h5>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014201.png" alt="img"></p>
<p>x变成y的左儿子，x的右儿子变成y的左儿子</p>
<h5 id="右旋">右旋</h5>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014205.png" alt="img"></p>
<p>x变成y的右儿子,x的左儿子变成y的右儿子</p>
<h4 id="插入-1">插入</h4>
<p>将红黑树当作一颗二叉查找树，将结点插入，插入后，该树仍然是一棵二叉查找树，但是它可能已经不是红黑树了，所以接下来就要通过 &ldquo;旋转&rdquo; 和 &ldquo;重新着色&rdquo; 来使它重新成为红黑树。</p>
<ol>
<li>把插入的新节点的颜色变成红色</li>
</ol>
<blockquote>
<p>如果设为黑色，就会导致根到叶子的路径上有一条路上，多一个额外的黑节点，这个是很难调整的。但是设为红色节点后，可能会导致出现两个连续红色节点的冲突，那么可以通过颜色调换和树旋转来调整。</p>
</blockquote>
<ol>
<li>
<p>插入的节点一共会有以下三种情况：</p>
</li>
<li>
<ol>
<li>被插入结点是根结点，那我们把此结点涂为黑色就行了；</li>
</ol>
</li>
<li>
<ol>
<li>被插入结点的父亲结点是黑色的，那么什么也不需要做，结点被插入后，仍然是红黑树。</li>
</ol>
</li>
<li>
<ol>
<li>被插入结点的父亲结点是红色的，那么此时是违背 &ldquo;性质 3&rdquo; 的，需要调整。</li>
</ol>
</li>
</ol>
<p>调整方案：</p>
<p>此种情况，被插入的节点一定存在祖父节点（爸爸的爸爸），可以划分为六种情况，由于涉及镜像操作，可以分成三种：</p>
<ul>
<li><strong>Case 1 ：当前结点的父亲是红色，叔叔存在且也是红色</strong></li>
</ul>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014224.png" alt="img"></p>
<ul>
<li>
<p>图中，&ldquo;结点 1&rdquo; 为 &ldquo;当前结点&rdquo;。那么我们的处理策略就是：</p>
</li>
<li>
<ul>
<li>将 &ldquo;父亲结点&rdquo; 改为黑色；</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;叔叔结点&rdquo; 改为黑色；</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;祖父结点&rdquo; 改为红色；</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;祖父结点&rdquo; 设为 &ldquo;当前结点&rdquo;，继续进行操作。</li>
</ul>
</li>
</ul>
<p>处理完后，图中显示的两条路径上，黑色结点数相同且和原图数目一致。</p>
<ul>
<li><strong>Case 2：当前结点的父亲是红色，叔叔不存在或是黑色，且当前结点是其父亲的右孩子</strong></li>
</ul>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014231.png" alt="img"></p>
<ul>
<li>
<p>图中，&ldquo;结点 2&rdquo; 为 &ldquo;当前结点&rdquo;。那么我们的处理策略就是：</p>
</li>
<li>
<ul>
<li>将 &ldquo;父亲结点&rdquo; 设为 &ldquo;当前结点&rdquo;；</li>
</ul>
</li>
<li>
<ul>
<li>以新的 &ldquo;当前结点&rdquo; 为支点进行左旋。</li>
</ul>
</li>
</ul>
<p>处理完上述操作之后，仍然发现不满足红黑树的性质，这就是下一条 Case</p>
<ul>
<li><strong>Case 3：当前结点的父亲是红色，叔叔不存在或是黑色，且当前结点是其父亲的左孩子</strong></li>
</ul>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014236.png" alt="img"></p>
<ul>
<li>
<p>图中，&ldquo;结点 1&rdquo; 为 &ldquo;当前结点&rdquo;。那么我们的处理策略就是：</p>
</li>
<li>
<ul>
<li>将 &ldquo;父亲结点&rdquo; 改为黑色；</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;祖父结点&rdquo; 改为红色；</li>
</ul>
</li>
<li>
<ul>
<li>以 &ldquo;祖父结点&rdquo; 为支点进行右旋。</li>
</ul>
</li>
</ul>
<p>处理完后，图中显示的两条路径上，黑色结点数相同且和原图数目一致。</p>
<h4 id="删除-1">删除</h4>
<p><strong>首先</strong>，和删除一棵普通二叉查找树的结点相同，我们会遇到三种情况：</p>
<ol>
<li>
<p>&ldquo;被删结点&rdquo; 没有孩子，如果它是红色的，那么可以直接删除；</p>
</li>
<li>
<p>&ldquo;被删结点&rdquo; 只有一个孩子，那么删除该结点后，用这个孩子去替换它即可；</p>
</li>
<li>
<p>&ldquo;被删结点&rdquo; 有两个孩子，那么先找出它的 &ldquo;后继结点&rdquo;，然后用 &ldquo;后继结点&rdquo; 去替换 &ldquo;被删结点&rdquo;，把问题转化为删除 &ldquo;后继结点&rdquo; ，也就是说， &ldquo;后继结点&rdquo; 才是真正的 &ldquo;被删结点&rdquo;。</p>
</li>
</ol>
<p><strong>接着</strong>，我们来看看 &ldquo;原先结点&rdquo; 被删掉后，会遇到哪几种情况，分析发现，一共有四种：</p>
<ol>
<li>
<p>&ldquo;原先结点&rdquo; 为黑色，&ldquo;当前结点&rdquo; 为红色，那么我们把 &ldquo;原先结点&rdquo; 删掉后，拿 &ldquo;当前结点&rdquo; 去替换它，并修改颜色为黑色即可；</p>
</li>
<li>
<p>&ldquo;原先结点&rdquo; 为黑色，&ldquo;当前结点&rdquo; 为黑色，这种情况比较复杂</p>
</li>
<li>
<p>&ldquo;原先结点&rdquo; 为红色，&ldquo;当前结点&rdquo; 为红色，那么我们把 &ldquo;原先结点&rdquo; 删掉后，直接拿&quot;当前结点&quot; 去替换它即可；</p>
</li>
<li>
<p>&ldquo;原先结点&rdquo; 为红色，&ldquo;当前结点&rdquo; 为黑色，这和 &ldquo;情况 3&rdquo; 一样，直接拿&quot;当前结点&quot; 去替换它即可。</p>
</li>
</ol>
<p><strong>最后</strong>，对于上述的 &ldquo;情况 2&rdquo;。这种情况可以进一步再划分为 8 种情况，因为涉及到镜像操作，所以我们只需理解其中一边镜像的 4 种情况即可（注意，下面的图片上，&ldquo;原先结点&rdquo; 已被删除，故未画出，只画出了 &ldquo;当前结点&rdquo; ）：</p>
<p><strong>Case 1：当前结点是黑色，兄弟结点是红色</strong></p>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014252.png" alt="img"></p>
<ul>
<li>
<p>&ldquo;结点 1&rdquo; 为 &ldquo;当前结点&rdquo;。观察上图，因 &ldquo;原先结点&rdquo; 已被删除，故路径2-&gt;1上少了一个黑色结点（右侧路径的黑色结点未画完全），那么我们的处理策略就是：</p>
</li>
<li>
<ul>
<li>将 &ldquo;兄弟结点&rdquo; 改为黑色；也就是把上图中 4 变黑</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;父亲结点&rdquo; 改为红色；也就是把 2 变红</li>
</ul>
</li>
<li>
<ul>
<li>以 &ldquo;父亲结点&rdquo; 为支点进行左旋；以 2 为支点进行左旋</li>
</ul>
</li>
<li>
<ul>
<li>左旋后，重新设置 &ldquo;兄弟结点&rdquo;。</li>
</ul>
</li>
</ul>
<p>处理完后，我们发现依旧有 2 个黑色结点，说明当前状态并不满足红黑树性质。其实，这是进入了下面的 Case 2，Case 3，和 Case 4 阶段了。</p>
<p><strong>Case 2：当前结点是黑色，兄弟结点是黑色，两个孩子为空或是黑色</strong></p>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014255.png" alt="img"></p>
<ul>
<li>
<p>&ldquo;结点 1&rdquo; 为 &ldquo;当前节点&rdquo;。如上图，因 &ldquo;原先结点&rdquo; 已被删除，故路径2-&gt;1上少了一个黑色结点，那么我们的处理策略就是：</p>
</li>
<li>
<ul>
<li>将 &ldquo;兄弟结点&rdquo; 改为红色；就是把 4 变红</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;父亲结点&rdquo; 设置为新的 &ldquo;当前结点&rdquo;，继续进行操作。</li>
</ul>
</li>
</ul>
<p>处理完后，我们发现当前状态不满足红黑树性质，但是我们发现只要把 &ldquo;结点 2&rdquo; 着色为黑色不就行了么。</p>
<p><strong>Case 3：当前结点是黑色，兄弟结点是黑色，兄弟结点的左孩子是红色，右孩子为空或是黑色</strong></p>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014300.png" alt="img"></p>
<ul>
<li>
<p>&ldquo;结点 1&rdquo; 为 &ldquo;当前结点&rdquo;。观察上图，因 &ldquo;原先结点&rdquo; 已被删除，故路径2-&gt;1上少了一个黑色结点，那么我们的处理策略就是：</p>
</li>
<li>
<ul>
<li>将 &ldquo;兄弟结点&rdquo; 的左孩子改为黑色；就是将 3 变黑</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;兄弟结点&rdquo; 改为红色； 将 4 变红</li>
</ul>
</li>
<li>
<ul>
<li>以 &ldquo;兄弟结点&rdquo; 为支点进行右旋； 以 4 为支点右旋</li>
</ul>
</li>
<li>
<ul>
<li>右旋后，重新设置 &ldquo;当前结点&rdquo; 的 &ldquo;兄弟结点&rdquo;。 3 变成了新的兄弟节点</li>
</ul>
</li>
</ul>
<p>处理完后，我们发现图中2-&gt;1上还是只有 1 个黑色结点，说明当前状态不满足红黑树性质。其实这是进入了Case 4</p>
<p><strong>Case 4：当前结点是黑色，兄弟结点是黑色，兄弟结点的右孩子是红色，左孩子为空或红黑皆可</strong></p>
<p><em>|</em><img src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200828014306.png" alt="img"></p>
<ul>
<li>
<p>&ldquo;结点 1&rdquo; 为 &ldquo;当前结点&rdquo;。观察上图，因 &ldquo;原先结点&rdquo; 已被删除，故路径 2-&gt;1 上少了一个黑色结点，那么我们的处理策略就是：</p>
</li>
<li>
<ul>
<li>将 &ldquo;父亲结点&rdquo; 的颜色赋给 &ldquo;兄弟结点&rdquo;；把 2 的颜色给 4 ，相当于把 4 变红</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;父亲结点&rdquo; 改为黑色； 把 2 变黑</li>
</ul>
</li>
<li>
<ul>
<li>将 &ldquo;兄弟结点&rdquo; 的右孩子改为黑色； 把 5 变黑</li>
</ul>
</li>
<li>
<ul>
<li>以 &ldquo;父亲结点&rdquo; 为支点进行左旋； 以 2 为支点进行左旋</li>
</ul>
</li>
</ul>
<h3 id="比较">比较</h3>
<ol>
<li>
<p>对于 AVL 树，在插入或删除操作后，都要利用递归的回溯，去维护从被删结点到根结点这条路径上的所有结点的平衡性，回溯的量级是需要 O(logn) 的，其中插入操作最多需要两次旋转，删除操作可能是 1 次、2 次或 2 次以上。而红黑树在 插入的时候最多需要 2 次旋转，在 rebalance 的时候最多也只需要 3 次旋转。</p>
</li>
<li>
<p>其次，AVL 树的结构相较红黑树来说更为平衡，故在插入和删除结点时更容易引起不平衡。因此在大量数据需要插入或者删除时，AVL 树需要 rebalance 的频率会更高，相比之下，红黑树的效率会更高。</p>
</li>
</ol>
<h2 id="内核中的实现">内核中的实现</h2>
<p>内核中的实现，定义在 include/linux/rbtree.h 中，实现在 lib/rbtree.c 。</p>
<h3 id="节点定义-1">节点定义</h3>
<p>include/linux/rbtree.h 100行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#8b008b;font-weight:bold">struct</span> rb_node
{
  <span style="color:#00688b;font-weight:bold">unsigned</span> <span style="color:#00688b;font-weight:bold">long</span>  rb_parent_color;
<span style="color:#1e889b">#define RB_RED    0
</span><span style="color:#1e889b">#define RB_BLACK   1
</span><span style="color:#1e889b"></span>  <span style="color:#8b008b;font-weight:bold">struct</span> rb_node *rb_right;
  <span style="color:#8b008b;font-weight:bold">struct</span> rb_node *rb_left;
} __attribute__((aligned(<span style="color:#8b008b;font-weight:bold">sizeof</span>(<span style="color:#00688b;font-weight:bold">long</span>))));
  <span style="color:#a61717;background-color:#e3d2d2">*/\</span>* The alignment might seem pointless, but allegedly CRIS needs it <span style="color:#a61717;background-color:#e3d2d2">\*/</span>*
<span style="color:#8b008b;font-weight:bold">struct</span> rb_root
{
  <span style="color:#8b008b;font-weight:bold">struct</span> rb_node *rb_node;
};
</code></pre></td></tr></table>
</div>
</div><p>根节点由 rb_root 定义，给定一个 rb_node 。可以通过跟踪同名节点指针来找到他的左右子节点。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#228b22">// include/linux/rbtree.h 133行 通过指针寻找这个结构的地址
</span><span style="color:#228b22"></span><span style="color:#1e889b">#define rb_entry(*ptr*, *type*, *member*) container_of(ptr, type, member)
</span></code></pre></td></tr></table>
</div>
</div><h3 id="操作">操作</h3>
<p>引用一段代码注释：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"> *linux/include/linux/rbtree.h*
 *To* *use* *rbtrees you**<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>ll have to implement your own insert and search cores.*
 *This will avoid us to* *use* *callbacks* *and* *to* *drop* *drammatically performances.*
 *I know it<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>s not the cleaner way,  but in C (not in C++) to get*
 *performances and genericity...*
 *Some example of* *insert* *and* *search* *follows* *here. The* *search* *is* *a plain*
 *normal search over an ordered tree. The* *insert* *instead must be implemented*
 *in two steps: First, the code must* *insert* *the* *element* *in* *order* *as* *a red leaf*
 *in the tree, and then the support library function rb_insert_color() must*
 *be called. Such function will* *<span style="color:#8b008b;font-weight:bold">do</span>* *the* *not* *trivial* *work* *to* *rebalance the*
 *rbtree, <span style="color:#8b008b;font-weight:bold">if</span> necessary.*
</code></pre></td></tr></table>
</div>
</div><p>Rbtree 中并没有提供搜索和插入例程，这些历程希望由 rbtree 的用户自己定义。这是因为C语言不太容易进行泛型编程。</p>
<p>源码中也提供了使用内核中红黑树的例程：</p>
<p>include/linux/rbtree.h 34行</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">*<span style="color:#8b008b;font-weight:bold">static</span>* *<span style="color:#8b008b;font-weight:bold">inline</span>* *<span style="color:#8b008b;font-weight:bold">struct</span> page ** *rb_search_page_cache**(<span style="color:#8b008b;font-weight:bold">struct</span> inode <span style="color:#a61717;background-color:#e3d2d2">\</span>* inode,*
             *<span style="color:#00688b;font-weight:bold">unsigned</span>* *<span style="color:#00688b;font-weight:bold">long</span>* *offset)*
*{*
  *<span style="color:#8b008b;font-weight:bold">struct</span>* *rb_node* *** *n* *=* *inode**-&gt;**i_rb_page_cache**.**rb_node**;*
  *<span style="color:#8b008b;font-weight:bold">struct</span>* *page* *** *page**;*
  *<span style="color:#8b008b;font-weight:bold">while</span>* *(n)*
  *{*
    *page = rb_entry(n, <span style="color:#8b008b;font-weight:bold">struct</span> page, rb_page_cache);*
    *<span style="color:#8b008b;font-weight:bold">if</span>* *(offset &lt; page-&gt;offset)*
      *n = n-&gt;rb_left;*
    *<span style="color:#8b008b;font-weight:bold">else</span>* *<span style="color:#8b008b;font-weight:bold">if</span>* *(offset &gt; page-&gt;offset)*
      *n = n-&gt;rb_right;*
    *<span style="color:#8b008b;font-weight:bold">else</span>*
      *<span style="color:#8b008b;font-weight:bold">return</span>* *page;*
  *}*
  *<span style="color:#8b008b;font-weight:bold">return</span>* *<span style="color:#658b00">NULL</span>**;*
*}*
</code></pre></td></tr></table>
</div>
</div><p>上面的例子实现了，在页高速缓存中搜索一个文件区（由一个i节点和一个偏移量共同描述）。每个节点都有自己的 rbtree ，该函数将搜索给定节点i的rbtree，以寻找匹配的偏移值</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">*<span style="color:#8b008b;font-weight:bold">static</span>* *<span style="color:#8b008b;font-weight:bold">inline</span>* *<span style="color:#8b008b;font-weight:bold">struct</span>* *page* ** __**rb_insert_page_cache**(**<span style="color:#8b008b;font-weight:bold">struct</span>* *inode* *** *inode**,*
              *<span style="color:#00688b;font-weight:bold">unsigned</span>* *<span style="color:#00688b;font-weight:bold">long</span>* *offset,*
              *<span style="color:#8b008b;font-weight:bold">struct</span>* *rb_node* *** *node**)*
*{*
  *<span style="color:#8b008b;font-weight:bold">struct</span>* *rb_node* **** *p* *= &amp;**inode**-&gt;**i_rb_page_cache**.**rb_node**;*
  *<span style="color:#8b008b;font-weight:bold">struct</span>* *rb_node* *** *parent* *=* *<span style="color:#658b00">NULL</span>**;*
  *<span style="color:#8b008b;font-weight:bold">struct</span>* *page* *** *page**;*
  *<span style="color:#8b008b;font-weight:bold">while</span>* *(<span style="color:#a61717;background-color:#e3d2d2">\</span>*p)*
  *{*
    *parent = <span style="color:#a61717;background-color:#e3d2d2">\</span>*p;*
    *page = rb_entry(parent, <span style="color:#8b008b;font-weight:bold">struct</span> page, rb_page_cache);*
    *<span style="color:#8b008b;font-weight:bold">if</span>* *(offset &lt; page-&gt;offset)*
      *p = &amp;(<span style="color:#a61717;background-color:#e3d2d2">\</span>*p)-&gt;rb_left;*
    *<span style="color:#8b008b;font-weight:bold">else</span>* *<span style="color:#8b008b;font-weight:bold">if</span>* *(offset &gt; page-&gt;offset)*
      *p = &amp;(<span style="color:#a61717;background-color:#e3d2d2">\</span>*p)-&gt;rb_right;*
    *<span style="color:#8b008b;font-weight:bold">else</span>*
      *<span style="color:#8b008b;font-weight:bold">return</span>* *page;*
  *}*
  *rb_link_node(node, parent, p);*
  *<span style="color:#8b008b;font-weight:bold">return</span>* *<span style="color:#658b00">NULL</span>**;*
*}*
*<span style="color:#8b008b;font-weight:bold">static</span>* *<span style="color:#8b008b;font-weight:bold">inline</span>* *<span style="color:#8b008b;font-weight:bold">struct</span> page ** *rb_insert_page_cache**(<span style="color:#8b008b;font-weight:bold">struct</span> inode <span style="color:#a61717;background-color:#e3d2d2">\</span>* inode,*
             *<span style="color:#00688b;font-weight:bold">unsigned</span>* *<span style="color:#00688b;font-weight:bold">long</span>* *offset,*
             *<span style="color:#8b008b;font-weight:bold">struct</span>* *rb_node* *** *node**)*
*{*
  *<span style="color:#8b008b;font-weight:bold">struct</span>* *page* *** *ret**;*
  *<span style="color:#8b008b;font-weight:bold">if</span>* *((ret = __rb_insert_page_cache(inode, offset, node)))*
    *<span style="color:#8b008b;font-weight:bold">goto</span>* *out;*
  *<span style="color:#008b45">rb_insert_color</span>(node, &amp;inode-&gt;i_rb_page_cache);*
 *out:*
  *<span style="color:#8b008b;font-weight:bold">return</span>* *ret;*
*}*
</code></pre></td></tr></table>
</div>
</div><p>插入操作根据 offset选择插入方向，函数希望找不到匹配的offset，因为他想要找到的是新 offset 要插入的叶子节点，然后用 rb_link_node() 在给定位置插入新节点，插入之后再调用函数进行复杂的红黑树平衡过程，如果页被加入成功，则返回NULL，否则返回已经存在的页地址</p>
<h1 id="数据结构的选择">数据结构的选择</h1>
<ul>
<li>
<p>如果对数据集合的主要操作是遍历数据，那就使用链表。</p>
</li>
<li>
<p>如果代码符合 生产者/消费者模式，就使用队列</p>
</li>
<li>
<p>如果需要映射一个 UID 到一个对象，那就使用映射。</p>
</li>
<li>
<p>如果需要存储大量数据吗，并且需要检索快速，就用红黑树。插入删除复杂度都是O(logn)的</p>
</li>
</ul>
<h1 id="思考">思考</h1>
<ol>
<li>内核中不是把将数据结构塞入链表，而是将链表节点塞入数据结构，这是为什么？</li>
</ol>
<p>答：一条链表可以串联起多个不同对象，比较灵活</p>
<ol start="2">
<li>AVL树也是平衡二叉搜索树，为什么选用了红黑树而不是AVL?</li>
</ol>
<p>答：Documentation/rbtree.txt中第16行提到：红黑树类似于AVL树，但提供更快的实时性插入和删除的有界最坏情况性能（最多两个分别旋转和三次旋转以平衡树）。查找时间稍慢（但仍为O（log n））。</p>
<p>红黑树丧失了部分平衡性，来保证旋转的次数，总体来说，性能更好</p>
<h1 id="其他">其他</h1>
<p>内核的文件目录中，有中文文档，大家可以参考一下：</p>
<p><a href="https://github.com/torvalds/linux/tree/master/Documentation/translations/zh_CN/process">https://github.com/torvalds/linux/tree/master/Documentation/translations/zh_CN/process</a></p>
<p>比如，这里有内核规定的代码风格中文版：https://github.com/torvalds/linux/blob/master/Documentation/translations/zh_CN/process/coding-style.rst</p>
<h1 id="参考资料">参考资料</h1>
<ol>
<li>
<p><a href="https://www.cnblogs.com/yangguang-it/p/11667772.html">Linux内核链表——看这一篇文章就够了</a></p>
</li>
<li>
<p><a href="https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91">维基百科：红黑树</a></p>
</li>
</ol>

                    
                    <HR width="100%" id="EOF">
		            <p style="color:#777;">最后修改于 2020-08-28</p>
                    
                    
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210508215939.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://caixiongjiang.github.io/blog/2020/leetcode-214-%E6%9C%80%E7%9F%AD%E5%9B%9E%E6%96%87%E4%B8%B2kmpnext%E5%BA%94%E7%94%A8/">
			下回<br>LeetCode 214 最短回文串(kmp、next应用)
                </a>
                
                
                
                <a class="older-posts" href="https://caixiongjiang.github.io/blog/2020/leetcode-332-%E9%87%8D%E6%96%B0%E5%AE%89%E6%8E%92%E8%A1%8C%E7%A8%8B%E8%BE%93%E5%87%BA%E6%AC%A7%E6%8B%89%E8%B7%AF%E7%BB%8F/">
			上回<br>LeetCode 332 重新安排行程(输出欧拉路经)
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                








<div id="tcomment"></div>



            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
魔改自 <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://blog.riba2534.cn">riba2534</a>
<br>

&copy;
	
	2021 🌀riba2534&#39;s Blog
	</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            },
            debounce(func, wait, options) {
                let lastArgs,
                    lastThis,
                    maxWait,
                    result,
                    timerId,
                    lastCallTime

                let lastInvokeTime = 0
                let leading = false
                let maxing = false
                let trailing = true

                
                const useRAF = (!wait && wait !== 0 && typeof root.requestAnimationFrame === 'function')

                if (typeof func !== 'function') {
                    throw new TypeError('Expected a function')
                }
                function isObject(value) {
                    const type = typeof value
                    return value != null && (type === 'object' || type === 'function')
                }

                wait = +wait || 0
                if (isObject(options)) {
                    leading = !!options.leading
                    maxing = 'maxWait' in options
                    maxWait = maxing ? Math.max(+options.maxWait || 0, wait) : maxWait
                    trailing = 'trailing' in options ? !!options.trailing : trailing
                }

                function invokeFunc(time) {
                    const args = lastArgs
                    const thisArg = lastThis

                    lastArgs = lastThis = undefined
                    lastInvokeTime = time
                    result = func.apply(thisArg, args)
                    return result
                }

                function startTimer(pendingFunc, wait) {
                    if (useRAF) {
                    root.cancelAnimationFrame(timerId)
                    return root.requestAnimationFrame(pendingFunc)
                    }
                    return setTimeout(pendingFunc, wait)
                }

                function cancelTimer(id) {
                    if (useRAF) {
                    return root.cancelAnimationFrame(id)
                    }
                    clearTimeout(id)
                }

                function leadingEdge(time) {
                    
                    lastInvokeTime = time
                    
                    timerId = startTimer(timerExpired, wait)
                    
                    return leading ? invokeFunc(time) : result
                }

                function remainingWait(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime
                    const timeWaiting = wait - timeSinceLastCall

                    return maxing
                    ? Math.min(timeWaiting, maxWait - timeSinceLastInvoke)
                    : timeWaiting
                }

                function shouldInvoke(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime

                    
                    
                    
                    return (lastCallTime === undefined || (timeSinceLastCall >= wait) ||
                    (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait))
                }

                function timerExpired() {
                    const time = Date.now()
                    if (shouldInvoke(time)) {
                    return trailingEdge(time)
                    }
                    
                    timerId = startTimer(timerExpired, remainingWait(time))
                }

                function trailingEdge(time) {
                    timerId = undefined

                    
                    
                    if (trailing && lastArgs) {
                    return invokeFunc(time)
                    }
                    lastArgs = lastThis = undefined
                    return result
                }

                function cancel() {
                    if (timerId !== undefined) {
                    cancelTimer(timerId)
                    }
                    lastInvokeTime = 0
                    lastArgs = lastCallTime = lastThis = timerId = undefined
                }

                function flush() {
                    return timerId === undefined ? result : trailingEdge(Date.now())
                }

                function pending() {
                    return timerId !== undefined
                }

                function debounced(...args) {
                    const time = Date.now()
                    const isInvoking = shouldInvoke(time)

                    lastArgs = args
                    lastThis = this
                    lastCallTime = time

                    if (isInvoking) {
                    if (timerId === undefined) {
                        return leadingEdge(lastCallTime)
                    }
                    if (maxing) {
                        
                        timerId = startTimer(timerExpired, wait)
                        return invokeFunc(lastCallTime)
                    }
                    }
                    if (timerId === undefined) {
                    timerId = startTimer(timerExpired, wait)
                    }
                    return result
                }
                debounced.cancel = cancel
                debounced.flush = flush
                debounced.pending = pending
                return debounced
                }

    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
        
        
            twikoo.init({
                envId: "blog-9g6ht92ca9c564c6",
                el: '#tcomment',
                region:  null ,
            });
        

        document.querySelectorAll("table").forEach(function(elem){
            elem.classList.add("table-striped");
            elem.classList.add("table");
            elem.classList.add("table-responsive");
            elem.classList.add("table-hover");
        })

        
        spy();
        window.addEventListener('scroll', this.debounce(spy, 250, { 'maxWait': 250 }), false);
        
        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});



</script>
    </body>
</html>
