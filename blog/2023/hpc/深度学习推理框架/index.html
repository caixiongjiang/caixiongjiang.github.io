<!DOCTYPE html>
<html><head>
<title>ä»é›¶è‡ªåˆ¶æ·±åº¦å­¦ä¹ æ¨ç†æ¡†æ¶</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="æ·±åº¦å­¦ä¹ æ¨ç†æ¡†æ¶çš„æ¶æ„ï¼Œä»¥åŠç»†èŠ‚å®ç°ï¼">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="ä»é›¶è‡ªåˆ¶æ·±åº¦å­¦ä¹ æ¨ç†æ¡†æ¶" />
<meta property="og:description" content="æ·±åº¦å­¦ä¹ æ¨ç†æ¡†æ¶çš„æ¶æ„ï¼Œä»¥åŠç»†èŠ‚å®ç°ï¼" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://caixiongjiang.github.io/blog/2023/hpc/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-08-01T18:18:05+08:00" />
<meta property="article:modified_time" content="2023-09-01T09:19:06+08:00" />












<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>


  




<link rel="icon" href="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/avater.jfif">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>


  
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script type="text/javascript" id="MathJax-script"
async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
MathJax.Hub.Queue(function() {



var all = MathJax.Hub.getAllJax(), i;
for(i = 0; i < all.length; i += 1) {
all[i].SourceElement().parentNode.className += ' has-jax';
}
});
</script>

<style>
code.has-jax {
font: inherit;
font-size: 100%;
background: inherit;
border: inherit;
color: #515151;
}
</style>





  
    <script src="/js/toc.js"></script>
  











<script src="https://cdn.jsdelivr.net/npm/twikoo@1.5.11/dist/twikoo.all.min.js"></script>




</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://caixiongjiang.github.io/">
    
        <div class="nav-title">
            ğŸŒ€Jarson Cai&#39;s Blog
        </div>
        
        <div class="nav-subtitle">
            å¤´è„‘æ˜¯æ—¥ç”¨å“ï¼Œä¸æ˜¯è£…é¥°å“
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/blog">
                æ–‡ç« ğŸ“–
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                åˆ†ç±»ğŸ“Œ
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                æ ‡ç­¾ğŸ·ï¸
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/series">
                ç³»åˆ—ğŸ“š
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/archive">
                å½’æ¡£ğŸ“ƒ
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                å…³äºğŸ‘‹
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friends">
                å‹é“¾ğŸ”—
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSSğŸ“¢
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<a href="https://github.com/caixiongjiang">
    GitHub
</a>
<br>

<a href="https://jarson-cai.gitee.io/jarson-cai-blog">
    MiFeng
</a>
<br>

<a href="nau_cxj@163.com">
    Email
</a>
<br>

<a href="https://leetcode-cn.com/u/cai-xiong-jiang/">
    Leetcode
</a>
<br>

        <hr>
        
é­”æ”¹è‡ª <a href="https://github.com/riba2534/hugo-blog">Riba2534</a> by <a href="https://caixiongjiang.github.io">Jarson Cai</a>
<br>

&copy;
	
	2023 ğŸŒ€Jarson Cai&#39;s Blog
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- ç›®å½• -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#kuiperdatawhale" onclick="onNavClick(`#kuiperdatawhale-nav`)" id="kuiperdatawhale-nav">
									KuiperDatawhale
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" onclick="onNavClick(`#ä¸€ç¯å¢ƒæ­å»º-nav`)" id="ä¸€ç¯å¢ƒæ­å»º-nav">
									ä¸€ï¼šç¯å¢ƒæ­å»º
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c%e5%bc%a0%e9%87%8f%e7%9a%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#äºŒå¼ é‡çš„è®¾è®¡ä¸å®ç°-nav`)" id="äºŒå¼ é‡çš„è®¾è®¡ä¸å®ç°-nav">
									äºŒï¼šå¼ é‡çš„è®¾è®¡ä¸å®ç°
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%89%e8%ae%a1%e7%ae%97%e5%9b%be%e7%9a%84%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#ä¸‰è®¡ç®—å›¾çš„å®šä¹‰-nav`)" id="ä¸‰è®¡ç®—å›¾çš„å®šä¹‰-nav">
									ä¸‰ï¼šè®¡ç®—å›¾çš„å®šä¹‰
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%9b%9b%e6%9e%84%e5%bb%ba%e8%ae%a1%e7%ae%97%e5%9b%be%e5%85%b3%e7%b3%bb%e5%92%8c%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f" onclick="onNavClick(`#å››æ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº-nav`)" id="å››æ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº-nav">
									å››ï¼šæ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%94%e7%ae%97%e5%ad%90%e5%92%8c%e6%b3%a8%e5%86%8c%e5%b7%a5%e5%8e%82" onclick="onNavClick(`#äº”ç®—å­å’Œæ³¨å†Œå·¥å‚-nav`)" id="äº”ç®—å­å’Œæ³¨å†Œå·¥å‚-nav">
									äº”ï¼šç®—å­å’Œæ³¨å†Œå·¥å‚
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%ad%e5%8d%b7%e7%a7%af%e5%92%8c%e6%b1%a0%e5%8c%96%e7%ae%97%e5%ad%90%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#å…­å·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°-nav`)" id="å…­å·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°-nav">
									å…­ï¼šå·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%83%e8%a1%a8%e8%be%be%e5%bc%8f%e5%b1%82%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#ä¸ƒè¡¨è¾¾å¼å±‚çš„å®ç°-nav`)" id="ä¸ƒè¡¨è¾¾å¼å±‚çš„å®ç°-nav">
									ä¸ƒï¼šè¡¨è¾¾å¼å±‚çš„å®ç°
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/blog">
                    æ–‡ç« ğŸ“–
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    åˆ†ç±»ğŸ“Œ
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    æ ‡ç­¾ğŸ·ï¸
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/series">
                    ç³»åˆ—ğŸ“š
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/archive">
                    å½’æ¡£ğŸ“ƒ
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    å…³äºğŸ‘‹
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friends">
                    å‹é“¾ğŸ”—
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSSğŸ“¢
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- ç›®å½• -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#kuiperdatawhale" onclick="onNavClick(`#kuiperdatawhale-nav`)" id="kuiperdatawhale-nav">
									KuiperDatawhale
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%b8%80%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" onclick="onNavClick(`#ä¸€ç¯å¢ƒæ­å»º-nav`)" id="ä¸€ç¯å¢ƒæ­å»º-nav">
									ä¸€ï¼šç¯å¢ƒæ­å»º
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8c%e5%bc%a0%e9%87%8f%e7%9a%84%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#äºŒå¼ é‡çš„è®¾è®¡ä¸å®ç°-nav`)" id="äºŒå¼ é‡çš„è®¾è®¡ä¸å®ç°-nav">
									äºŒï¼šå¼ é‡çš„è®¾è®¡ä¸å®ç°
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%89%e8%ae%a1%e7%ae%97%e5%9b%be%e7%9a%84%e5%ae%9a%e4%b9%89" onclick="onNavClick(`#ä¸‰è®¡ç®—å›¾çš„å®šä¹‰-nav`)" id="ä¸‰è®¡ç®—å›¾çš„å®šä¹‰-nav">
									ä¸‰ï¼šè®¡ç®—å›¾çš„å®šä¹‰
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%9b%9b%e6%9e%84%e5%bb%ba%e8%ae%a1%e7%ae%97%e5%9b%be%e5%85%b3%e7%b3%bb%e5%92%8c%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f" onclick="onNavClick(`#å››æ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº-nav`)" id="å››æ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº-nav">
									å››ï¼šæ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%94%e7%ae%97%e5%ad%90%e5%92%8c%e6%b3%a8%e5%86%8c%e5%b7%a5%e5%8e%82" onclick="onNavClick(`#äº”ç®—å­å’Œæ³¨å†Œå·¥å‚-nav`)" id="äº”ç®—å­å’Œæ³¨å†Œå·¥å‚-nav">
									äº”ï¼šç®—å­å’Œæ³¨å†Œå·¥å‚
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%85%ad%e5%8d%b7%e7%a7%af%e5%92%8c%e6%b1%a0%e5%8c%96%e7%ae%97%e5%ad%90%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#å…­å·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°-nav`)" id="å…­å·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°-nav">
									å…­ï¼šå·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%83%e8%a1%a8%e8%be%be%e5%bc%8f%e5%b1%82%e7%9a%84%e5%ae%9e%e7%8e%b0" onclick="onNavClick(`#ä¸ƒè¡¨è¾¾å¼å±‚çš„å®ç°-nav`)" id="ä¸ƒè¡¨è¾¾å¼å±‚çš„å®ç°-nav">
									ä¸ƒï¼šè¡¨è¾¾å¼å±‚çš„å®ç°
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://caixiongjiang.github.io/">
            ğŸŒ€Jarson Cai&#39;s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://caixiongjiang.github.io/">
        <div class="single-column-header-title">ğŸŒ€Jarson Cai&#39;s Blog</div>
        
        <div class="single-column-header-subtitle">å¤´è„‘æ˜¯æ—¥ç”¨å“ï¼Œä¸æ˜¯è£…é¥°å“</div>
        

    </a>
</div>

            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/CUDA_title.jpg')"
                    
                
            >
                <div class="post-title">
                    ä»é›¶è‡ªåˆ¶æ·±åº¦å­¦ä¹ æ¨ç†æ¡†æ¶
                    
                    <div class="post-subtitle">
                        æ·±åº¦å­¦ä¹ æ¨ç†æ¡†æ¶çš„æ¶æ„ï¼Œä»¥åŠç»†èŠ‚å®ç°ï¼
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2023-08-01 18:18
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/">[C&#43;&#43;]</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/%E6%8E%A8%E7%90%86%E6%A1%86%E6%9E%B6">æ¨ç†æ¡†æ¶</a>
                                &nbsp;
                            
                        
                        
                            <i class="material-icons" style="">schedule</i>
                            

                            
                            

                            
                            56 min
                            
                            44 s.
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="kuiperdatawhale">KuiperDatawhale</h2>
<p>æœ¬æ¬¡è¯¾ç¨‹ä¸º<code>KuiperInfer</code>çš„å­é¡¹ç›®ï¼ˆå­¦ä¹ é¡¹ç›®ï¼‰ã€‚</p>
<p>å®Œæ•´æ¨ç†æ¡†æ¶é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/zjhellofss/kuiperinfer">https://github.com/zjhellofss/kuiperInfer</a></p>
<p>Bç«™è¯¾ç¨‹åœ°å€ï¼š<a href="https://www.bilibili.com/video/BV118411f7yM/?spm_id_from=333.788&amp;vd_source=841bd3506b40b195573d34fef4c5bdf7">https://www.bilibili.com/video/BV118411f7yM/?spm_id_from=333.788&amp;vd_source=841bd3506b40b195573d34fef4c5bdf7</a></p>
<p>æœ¬äººå­¦ä¹ é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/caixiongjiang/HPC">https://github.com/caixiongjiang/HPC</a></p>
<h3 id="ä¸€ç¯å¢ƒæ­å»º">ä¸€ï¼šç¯å¢ƒæ­å»º</h3>
<blockquote>
<p>æ¨ç†æ¡†æ¶è¦å®Œæˆçš„åŠŸèƒ½</p>
</blockquote>
<ul>
<li>å¯¹å·²ç»è®­ç»ƒå®Œæˆçš„ç¥ç»ç½‘ç»œæ¨¡å‹æ–‡ä»¶è¿›è¡ŒåŠ è½½</li>
<li>æ ¹æ®ç½‘ç»œç»“æ„å’Œæƒé‡å‚æ•°å¯¹è¾“å…¥å›¾åƒè¿›è¡Œé¢„æµ‹</li>
<li>æ¨ç†é˜¶æ®µçš„æƒé‡å·²ç»å›ºå®šï¼Œä¸éœ€è¦åå‘ä¼ æ’­æŠ€æœ¯</li>
</ul>
<blockquote>
<p>æ¨ç†æ¡†æ¶çš„æ¨¡å—</p>
</blockquote>
<ul>
<li><code>Operator</code>:æ·±åº¦å­¦ä¹ è®¡ç®—å›¾ä¸­çš„è®¡ç®—èŠ‚ç‚¹ï¼ŒåŒ…å«ï¼š
<ul>
<li>å­˜å‚¨è¾“å…¥è¾“å‡ºçš„å¼ é‡</li>
<li>è®¡ç®—èŠ‚ç‚¹çš„ç±»å‹å’Œåç§°</li>
<li>è®¡ç®—èŠ‚ç‚¹å‚æ•°ä¿¡æ¯ï¼ˆParamsï¼šå·ç§¯çš„æ­¥é•¿ï¼Œå·ç§¯æ ¸çš„å¤§å°ç­‰ï¼‰</li>
<li>è®¡ç®—èŠ‚ç‚¹çš„æƒé‡ä¿¡æ¯ï¼ˆattributesï¼šå­˜å‚¨weightså’Œbiasï¼‰</li>
</ul>
</li>
<li><code>Graph</code>:å¤šä¸ª<code>Operator</code>ä¸²è”å¾—åˆ°çš„æœ‰å‘æ— ç¯å›¾ï¼Œè§„å®šäº†å„ä¸ªèŠ‚ç‚¹ï¼ˆ<code>Operator</code>ï¼‰æ‰§è¡Œçš„æµç¨‹å’Œé¡ºåºã€‚</li>
<li><code>Layer</code>:è®¡ç®—èŠ‚ç‚¹è¿ç®—å…·ä½“çš„æ‰§è¡Œè€…ï¼Œ<code>Layer</code>ç±»å…ˆè¯»å…¥è¾“å…¥å¼ é‡ä¸­çš„æ•°æ®ï¼Œç„¶åå¯¹è¾“å…¥å¼ é‡è¿›è¡Œè®¡ç®—ï¼Œ<strong>ä¸åŒçš„ç®—å­ä¸­Layerçš„è®¡ç®—è¿‡ç¨‹ä¼šä¸ä¸€è‡´ï¼</strong></li>
<li><code>Tensor</code>ï¼šç”¨äºå­˜æ”¾<strong>å¤šç»´æ•°æ®</strong>çš„æ•°æ®ç»“æ„ï¼Œæ–¹ä¾¿æ•°æ®åœ¨è®¡ç®—èŠ‚ç‚¹ä¹‹é—´ä¼ é€’ï¼ŒåŒæ—¶è¯¥ç»“æ„ä¹Ÿå°è£…çŸ©é˜µä¹˜ã€ç‚¹ç§¯ç­‰ä¸çŸ©é˜µç›¸å…³çš„åŸºæœ¬æ“ä½œã€‚</li>
</ul>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img96.jpg" alt=""></p>
<blockquote>
<p>ä½¿ç”¨çš„æ¨¡å—</p>
</blockquote>
<ul>
<li>
<p>C++è¿ç®—åº“ï¼š<code>Armadillo</code>+<code>OpenBLAS</code>ã€‚</p>
</li>
<li>
<p>ç®—å­åŠ é€Ÿï¼š<code>OpenMP</code></p>
</li>
<li>
<p>å•å…ƒæµ‹è¯•ï¼š<code>Google Test</code></p>
</li>
<li>
<p>æ€§èƒ½æµ‹è¯•ï¼š<code>Google Benchmark</code></p>
</li>
</ul>
<blockquote>
<p>ä½œä¸šï¼šå®Œæˆæµ‹è¯•ç”¨ä¾‹</p>
</blockquote>
<p>ç›®çš„æ˜¯äº†è§£<code>Armadillo</code>æ•°å­¦åº“çš„åŸºæœ¬ç”¨æ³•ã€‚</p>
<h3 id="äºŒå¼ é‡çš„è®¾è®¡ä¸å®ç°">äºŒï¼šå¼ é‡çš„è®¾è®¡ä¸å®ç°</h3>
<blockquote>
<p>å¼ é‡ç±»çš„è®¾è®¡</p>
</blockquote>
<p>è¿™é‡Œåœ¨<code>arma::fmat</code>å’Œ<code>arma::fcube</code>çš„åŸºç¡€ä¸Šè¿›è¡Œå¼€å‘ï¼Œ<code>f</code>ä»£è¡¨<code>float</code>ï¼Œ<code>fcube</code>å¯ä»¥çœ‹åšæ˜¯<code>fmat</code>çš„å †å è€Œæˆçš„ç»“æ„ã€‚</p>
<p>ä¸Pytorchä¸­çš„çŸ©é˜µå­˜å‚¨ä¸åŒçš„æ˜¯ï¼Œ<code>fmat</code>æ˜¯åˆ—ä¸»åºçš„ï¼Œéœ€è¦è¿›è¡ŒåŒºåˆ†ã€‚</p>
<blockquote>
<p>å¼ é‡ç±»çš„æ–¹æ³•</p>
</blockquote>
<ul>
<li>åˆ›å»ºå¼ é‡ä»¥åŠè¿”å›å¼ é‡çš„ç»´åº¦ä¿¡æ¯ï¼šä¸»è¦æœ‰4ä¸ªå±æ€§ï¼Œ<code>rows</code>ï¼Œ<code>cols</code>ï¼Œ<code>channels</code>ï¼Œ<code>raw_shapes</code>ã€‚</li>
</ul>
<p>å…¶ä¸­åˆ›å»ºçš„æ–¹æ³•è°ƒç”¨äº†fcubeçš„åˆ›å»ºæ–¹æ³•ï¼š<code>arma::fcube(rows, cols, channels)</code>ã€‚è¿”å›ç»´åº¦ä¿¡æ¯çš„æ–¹æ³•åˆ†åˆ«æ˜¯<code>rows()</code>ï¼Œ<code>cols()</code>ï¼Œ<code>channels()</code>ï¼Œ<code>size()</code>ã€‚</p>
<ul>
<li>å¼ é‡çš„å¡«å……æ–¹æ³•ï¼ˆFillï¼‰ï¼šéœ€è¦æ³¨æ„è½¬ç½®çš„è¿‡ç¨‹ï¼ˆåˆ—ä¸»åºå’Œè¡Œä¸»åºçš„åŒºåˆ«ï¼‰</li>
<li>å¯¹å¼ é‡è¿›è¡Œå˜å½¢ï¼ˆReshapeï¼‰</li>
<li>è¿”å›æ˜¯å¦ä¸ºç©ºï¼ˆemptyï¼‰</li>
</ul>
<blockquote>
<p>ä½œä¸šä¸ºå®ç°Flattenå’ŒPaddingæ–¹æ³•</p>
</blockquote>
<p>Flatten:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;::Flatten(<span style="color:#00688b;font-weight:bold">bool</span> row_major) {
</span></span><span style="display:flex;"><span>  CHECK(!<span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.empty());
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">/// Homework1: è¯·è¡¥å……ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> total_elems = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.size();
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> rows = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;rows();
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> cols = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;cols();
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> channels = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.n_slices;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  std::vector&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt; flattened_data(total_elems);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">if</span> (row_major) {
</span></span><span style="display:flex;"><span>      <span style="color:#228b22">// æŒ‰è¡Œä¸»åºå–æ•°æ®, arma::fcubeæ•°æ®ä¸­ï¼Œæ¯ä¸ªchannelå†…çš„å–å€¼é¡ºåºæ˜¯æŒ‰åˆ—ä¸»åºçš„ï¼Œæ‰€ä»¥éœ€è¦æ”¹å˜ä¸€ä¸‹å–å€¼é¡ºåº
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>      <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> i = <span style="color:#b452cd">0</span>; i &lt; channels; ++i) {
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">auto</span>&amp; channel_data = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.slice(i);
</span></span><span style="display:flex;"><span>          <span style="color:#228b22">// t()ä»£è¡¨è½¬ç½®ï¼Œ&amp;çš„ä½œç”¨ï¼šchannel_data.t()` è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ `arma::fmat` å¯¹è±¡ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>          <span style="color:#228b22">// å¦‚æœæ²¡æœ‰ä½¿ç”¨å¼•ç”¨ç±»å‹çš„å˜é‡æ¥æ¥æ”¶å®ƒï¼Œé‚£ä¹ˆç¨‹åºå°±æ— æ³•æ“ä½œè¿™ä¸ªæ–°çš„å¯¹è±¡ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>          <span style="color:#8b008b;font-weight:bold">const</span> arma::fmat &amp;channel_data_t = channel_data.t();
</span></span><span style="display:flex;"><span>          std::copy(channel_data_t.begin(), channel_data_t.end(), flattened_data.begin() + i * rows * cols);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  } <span style="color:#8b008b;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#228b22">/// memptr()å±äºarmaæ•°å­¦åº“ä¸­æ•°æ®çš„æ–¹æ³•ï¼Œè€Œbegin()æ˜¯c++ä¸­vectorçš„æ–¹æ³•ï¼Œä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>      <span style="color:#228b22">// å› ä¸ºarmaçš„æ•°æ®æœ¬èº«å°±æ˜¯åˆ—ä¸»åºï¼Œåªè¦å°†æ•°æ®æ‰€æœ‰æ‹·è´åˆ°flatten_dataä¸­å°±å¥½äº†
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>      std::copy(<span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.memptr(), <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.memptr() + total_elems, flattened_data.begin());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">// æ”¹å˜æ•°ç»„çš„shapes
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.set_size(<span style="color:#b452cd">1</span>, total_elems, <span style="color:#b452cd">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">// å°†flattenæ•°æ®æ‹·è´å›åŸæ¥çš„å¼ é‡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ¥æ”¶çš„æ˜¯éœ€è¦æ‹·è´çš„èµ·å§‹åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  std::copy(flattened_data.begin(), flattened_data.end(), <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.memptr());
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">this</span>-&gt;raw_shapes_ = std::vector&lt;<span style="color:#00688b;font-weight:bold">uint32_t</span>&gt;{total_elems};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Padding:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;::Padding(<span style="color:#8b008b;font-weight:bold">const</span> std::vector&lt;<span style="color:#00688b;font-weight:bold">uint32_t</span>&gt;&amp; pads,
</span></span><span style="display:flex;"><span>                            <span style="color:#00688b;font-weight:bold">float</span> padding_value) {
</span></span><span style="display:flex;"><span>  CHECK(!<span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.empty());
</span></span><span style="display:flex;"><span>  CHECK_EQ(pads.size(), <span style="color:#b452cd">4</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">// å››å‘¨å¡«å……çš„ç»´åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#00688b;font-weight:bold">uint32_t</span> pad_rows1 = pads.at(<span style="color:#b452cd">0</span>);  <span style="color:#228b22">// up
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#00688b;font-weight:bold">uint32_t</span> pad_rows2 = pads.at(<span style="color:#b452cd">1</span>);  <span style="color:#228b22">// bottom
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#00688b;font-weight:bold">uint32_t</span> pad_cols1 = pads.at(<span style="color:#b452cd">2</span>);  <span style="color:#228b22">// left
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#00688b;font-weight:bold">uint32_t</span> pad_cols2 = pads.at(<span style="color:#b452cd">3</span>);  <span style="color:#228b22">// right
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">/// Homework2ï¼šè¯·è¡¥å……ä»£ç 
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> channels = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;channels();
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> rows = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;rows();
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> cols = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;cols();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> new_rows = rows + pad_rows1 + pad_rows2;
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> new_cols = cols + pad_cols1 + pad_cols2;
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">auto</span> new_tensor = arma::fcube(new_rows, new_cols, channels);
</span></span><span style="display:flex;"><span>  new_tensor.fill(padding_value);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">/// `cols()` å’Œ `rows()` æ–¹æ³•åˆ†åˆ«è¿”å›æ•°æ®å¼ é‡çš„åˆ—æ•°å’Œè¡Œæ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#228b22">/// è¿™ä¸ªå¼ é‡çš„å¤§å°æ˜¯åœ¨åˆ›å»ºå¯¹è±¡æ—¶æŒ‡å®šçš„ï¼Œä¸€æ—¦åˆ›å»ºåå°±ä¸èƒ½å†æ”¹å˜å¤§å°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#228b22">/// æ‹·è´åŸæ¥å¼ é‡ä¸­çš„å…ƒç´ åˆ°æ–°çš„å¼ é‡ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> i = <span style="color:#b452cd">0</span>; i &lt; channels; ++i) {
</span></span><span style="display:flex;"><span>      <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> j = <span style="color:#b452cd">0</span>; j &lt; cols; ++j) {
</span></span><span style="display:flex;"><span>          <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> k = <span style="color:#b452cd">0</span>; k &lt; rows; ++k) {
</span></span><span style="display:flex;"><span>              <span style="color:#228b22">//è®¡ç®—æ–°çš„å•å…ƒä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>              <span style="color:#00688b;font-weight:bold">uint32_t</span> new_j = j + pad_cols1;
</span></span><span style="display:flex;"><span>              <span style="color:#00688b;font-weight:bold">uint32_t</span> new_k = k + pad_rows1;
</span></span><span style="display:flex;"><span>              <span style="color:#228b22">//æ‹·è´å…ƒç´ 
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>              new_tensor.at(new_k, new_j, i) = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_.at(k, j, i);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">// å°†æ–°çš„å¼ é‡èµ‹å€¼ç»™ data_ ä½¿ç”¨moveå‡½æ•°ï¼Œç›´æ¥å°†æ•´ä¸ªå¯¹è±¡æ‹·è´äº†è¿‡æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">this</span>-&gt;data_ =  std::move(new_tensor);
</span></span><span style="display:flex;"><span>  <span style="color:#228b22">// æˆ‘ä»¬åœ¨åˆ›å»ºnew_tensorçš„æ—¶å€™å·²ç»å®šä¹‰äº†colsï¼Œrowsï¼Œchannelsã€‚ è¿˜éœ€è¦æŒ‡å®šç±»å†…æˆå‘˜raw_shape()_çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">this</span>-&gt;raw_shapes_ = std::vector&lt;<span style="color:#00688b;font-weight:bold">uint32_t</span>&gt;{channels, new_rows, new_cols};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä¸‰è®¡ç®—å›¾çš„å®šä¹‰">ä¸‰ï¼šè®¡ç®—å›¾çš„å®šä¹‰</h3>
<p>æˆ‘ä»¬ä½¿ç”¨çš„PNNXè®¡ç®—å›¾ï¼Œç›¸å¯¹äºONNXï¼Œå…¶å¯ä»¥<strong>ä½¿ç”¨æ¨¡ç‰ˆåŒ¹é…å°†å­å›¾ç”¨å¤§çš„ç®—å­ä»£æ›¿è®¸å¤šå°ç®—å­ï¼ŒPytorchä¸­çš„ç®—æ•°è¡¨è¾¾å¼ä¼šè¢«ä¿ç•™ï¼ŒPNNXæœ‰å¤§é‡çš„å›¾ä¼˜åŒ–æŠ€æœ¯ï¼ŒåŒ…æ‹¬äº†ç®—å­èåˆï¼Œå¸¸é‡æŠ˜å å’Œæ¶ˆé™¤ï¼Œå…¬å…±è¡¨è¾¾å¼æ¶ˆé™¤ç­‰æŠ€æœ¯ï¼</strong></p>
<blockquote>
<p>PNNXè®¡ç®—å›¾çš„æ ¼å¼</p>
</blockquote>
<p>PNNXä¸»è¦ç”±å›¾ç»“æ„(Graph)ï¼Œè¿ç®—ç¬¦ï¼ˆOperatorï¼‰å’Œæ“ä½œæ•°(Operand)ä¸‰ç§ç»“æ„ç»„æˆï¼Œè®¾è®¡ç®€æ´ã€‚</p>
<ol>
<li><code>Operator</code>ç±»ç”¨æ¥<strong>è¡¨ç¤ºè®¡ç®—å›¾ä¸­çš„è¿ç®—ç¬¦ï¼ˆç®—å­ï¼‰</strong>ï¼Œæ¯”å¦‚ä¸€ä¸ªæ¨¡å‹ä¸­çš„<code>Convolution</code>, <code>Pooling</code>ç­‰ç®—å­ï¼›</li>
<li><code>Operand</code>ç±»ç”¨æ¥<strong>è¡¨ç¤ºè®¡ç®—å›¾ä¸­çš„æ“ä½œæ•°</strong>ï¼Œå³<strong>ä¸ä¸€ä¸ªè¿ç®—ç¬¦æœ‰å…³çš„è¾“å…¥å’Œè¾“å‡ºå¼ é‡</strong>ï¼›</li>
<li><code>Graph</code>ç±»çš„æˆå‘˜å‡½æ•°æä¾›äº†æ–¹ä¾¿çš„æ¥å£ç”¨æ¥<strong>åˆ›å»ºå’Œè®¿é—®æ“ä½œç¬¦å’Œæ“ä½œæ•°</strong>ï¼Œä»¥æ„å»ºå’Œéå†è®¡ç®—å›¾ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯æ¨¡å‹ä¸­<strong>è¿ç®—ç¬¦ï¼ˆç®—å­ï¼‰å’Œæ“ä½œæ•°çš„é›†åˆ</strong>ã€‚</li>
</ol>
<blockquote>
<p>Operatorç»“æ„çš„ç»„æˆ</p>
</blockquote>
<p>åœ¨PNNXä¸­ï¼Œ<code>Operator</code>ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç®—å­ï¼Œå®ƒç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>
<ol>
<li><code>inputs</code>ï¼šç±»å‹ä¸º<code>std::vector&lt;operand&gt;</code>, è¡¨ç¤ºè¿™ä¸ªç®—å­åœ¨è®¡ç®—è¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„<strong>è¾“å…¥æ“ä½œæ•°</strong><code>operand</code>ï¼›</li>
<li><code>outputs</code>ï¼šç±»å‹ä¸º<code>std::vector&lt;operand&gt;</code>, è¡¨ç¤ºè¿™ä¸ªç®—å­åœ¨è®¡ç®—è¿‡ç¨‹ä¸­å¾—åˆ°çš„<strong>è¾“å‡ºæ“ä½œæ•°</strong><code>operand</code>ï¼›</li>
<li><code>type</code>å’Œ<code>name</code>ç±»å‹å‡ä¸º<code>std::string</code>, åˆ†åˆ«è¡¨ç¤º<strong>è¯¥è¿ç®—ç¬¦å·çš„ç±»å‹å’Œåç§°</strong>ï¼›</li>
<li><code>params</code>, ç±»å‹ä¸º<code>std::map</code>, ç”¨äºå­˜æ”¾<strong>è¯¥è¿ç®—ç¬¦çš„æ‰€æœ‰å‚æ•°</strong>ï¼ˆä¾‹å¦‚å·ç§¯è¿ç®—ç¬¦ä¸­çš„<code>params</code>ä¸­å°†å­˜æ”¾<code>stride</code>, <code>padding</code>, <code>kernel size</code>ç­‰ä¿¡æ¯ï¼‰ï¼›</li>
<li><code>attrs</code>, ç±»å‹ä¸º<code>std::map</code>, ç”¨äºå­˜æ”¾<strong>è¯¥è¿ç®—ç¬¦æ‰€éœ€è¦çš„å…·ä½“æƒé‡å±æ€§</strong>ï¼ˆä¾‹å¦‚å·ç§¯è¿ç®—ç¬¦ä¸­çš„<code>attrs</code>ä¸­å°±å­˜æ”¾ç€å·ç§¯çš„æƒé‡å’Œåç§»é‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª<code>float32</code>æ•°ç»„ï¼‰ã€‚</li>
</ol>
<blockquote>
<p>Operandçš„ç»“æ„ç»„æˆ</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">Operand</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">void</span> remove_consumer(<span style="color:#8b008b;font-weight:bold">const</span> Operator* c);
</span></span><span style="display:flex;"><span>    Operator* producer;
</span></span><span style="display:flex;"><span>    std::vector&lt;Operator*&gt; consumers;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">int</span> type;
</span></span><span style="display:flex;"><span>    std::vector&lt;<span style="color:#00688b;font-weight:bold">int</span>&gt; shape;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std::string name;
</span></span><span style="display:flex;"><span>    std::map&lt;std::string, Parameter&gt; params;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ“ä½œæ•°ç»“æ„ä¸­çš„<code>producer</code>å’Œ<code>customers</code>, åˆ†åˆ«è¡¨ç¤º<strong>äº§ç”Ÿè¿™ä¸ªæ“ä½œæ•°çš„ç®—å­</strong>å’Œ<strong>ä½¿ç”¨è¿™ä¸ªæ“ä½œæ•°çš„ç®—å­</strong>ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯äº§ç”Ÿè¿™ä¸ªæ“ä½œæ•°çš„ç®—å­åªèƒ½æœ‰ä¸€ä¸ªï¼Œè€Œä½¿ç”¨è¿™ä¸ªæ“ä½œæ•°çš„ç®—å­å¯ä»¥æœ‰å¾ˆå¤šä¸ªã€‚</p>
<blockquote>
<p>ä½¿ç”¨å‰ï¼Œéœ€è¦å¯¹PNNX::Operatorå†æ¬¡å°è£…</p>
</blockquote>
<p>å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>RuntimeOperator</code>çš„ç»“æ„ä½“ã€‚ç»“æ„ä½“åŒ…å«ä»¥ä¸‹æˆå‘˜å˜é‡ï¼š</p>
<ol>
<li>
<p><code>name</code>: <strong>è¿ç®—ç¬¦èŠ‚ç‚¹çš„åç§°</strong>ï¼Œå¯ä»¥ç”¨æ¥åŒºåˆ†ä¸€ä¸ªå”¯ä¸€èŠ‚ç‚¹ï¼Œä¾‹å¦‚ <code>Conv_1</code>, <code>Conv_2</code> ç­‰ï¼›</p>
</li>
<li>
<p><code>type</code>: <strong>è¿ç®—ç¬¦èŠ‚ç‚¹çš„ç±»å‹</strong>ï¼Œä¾‹å¦‚ <code>Convolution</code>, <code>Relu</code> ç­‰ç±»å‹ï¼›</p>
</li>
<li>
<p><code>layer</code>: <strong>è´Ÿè´£å®Œæˆå…·ä½“è®¡ç®—çš„ç»„ä»¶</strong>ï¼Œä¾‹å¦‚åœ¨ <code>Convolution Operator</code> ä¸­ï¼Œ<code>layer</code> å¯¹è¾“å…¥è¿›è¡Œå·ç§¯è®¡ç®—ï¼Œå³è®¡ç®—å…¶ç›¸åº”çš„å·ç§¯å€¼ï¼›</p>
</li>
<li>
<p><code>input_operands</code> å’Œ <code>output_operands</code> åˆ†åˆ«è¡¨ç¤º<strong>è¯¥è¿ç®—ç¬¦çš„è¾“å…¥å’Œè¾“å‡ºæ“ä½œæ•°</strong>ã€‚</p>
<p>å¦‚æœä¸€ä¸ªè¿ç®—ç¬¦(<code>RuntimeOperator</code>)çš„è¾“å…¥å¤§å°ä¸º <code>(4, 3, 224, 224)</code>ï¼Œé‚£ä¹ˆåœ¨ <code>input_operands</code> å˜é‡ä¸­ï¼Œ<code>datas</code> æ•°ç»„çš„é•¿åº¦ä¸º 4ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„å¼ é‡å¤§å°ä¸º <code>(3, 224, 224)</code>ï¼›</p>
</li>
<li>
<p><code>params</code> æ˜¯è¿ç®—ç¬¦(<code>RuntimeOperator</code>)çš„<strong>å‚æ•°ä¿¡æ¯</strong>ï¼ŒåŒ…æ‹¬å·ç§¯å±‚çš„å·ç§¯æ ¸å¤§å°ã€æ­¥é•¿ç­‰ä¿¡æ¯ï¼›</p>
</li>
<li>
<p><code>attribute</code> æ˜¯è¿ç®—ç¬¦(<code>RuntimeOperator</code>)çš„<strong>æƒé‡ã€åç§»é‡ä¿¡æ¯</strong>ï¼Œä¾‹å¦‚ <code>Matmul</code> å±‚æˆ– <code>Convolution</code> å±‚éœ€è¦çš„æƒé‡æ•°æ®ï¼›</p>
</li>
<li>
<p>å…¶ä»–å˜é‡çš„å«ä¹‰å¯å‚è€ƒæ³¨é‡Šã€‚</p>
</li>
</ol>
<blockquote>
<p>æŒ‰ç…§è¦æ±‚ï¼Œéœ€è¦å°†PNNXä¸­çš„Operatorå°è£…åˆ°åˆ°æ–°çš„RuntimeOperator</p>
</blockquote>
<p>å…·ä½“æ¥è¯´ï¼Œæœ‰ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>æå–PNNXä¸­çš„æ“ä½œæ•°Operandåˆ°RuntimeOperand</li>
<li>æå–PNNXä¸­çš„æƒé‡(Attribute)åˆ°RuntimeAttribute</li>
<li>æå–PNNXä¸­çš„å‚æ•°(Param)åˆ°RuntimeParamï¼ˆä½œä¸šï¼‰</li>
</ul>
<blockquote>
<p>ä½œä¸šä»£ç å¦‚ä¸‹</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span> <span style="color:#228b22">/// æå–PNNXä¸­çš„æ“ä½œæ•°Operandåˆ°RuntimeOperand åŒ…å«ï¼ˆInitGraphOperatorsInputï¼‰å’Œï¼ˆInitGraphOperatorsOutputï¼‰ä¸¤ä¸ªå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#228b22">/// ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºè¿ç®—ç¬¦çš„æ‰€æœ‰è¾“å…¥æ“ä½œæ•° Operand å’Œå¾…åˆå§‹åŒ–çš„ RuntimeOperator
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#00688b;font-weight:bold">void</span> RuntimeGraph::InitGraphOperatorsInput(
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::vector&lt;pnnx::Operand *&gt; &amp;inputs,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;runtime_operator) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// éå†æ‰€æœ‰è¾“å…¥çš„å¼ é‡
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> pnnx::Operand *input: inputs) {
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">if</span> (!input) {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> pnnx::Operator *producer = input-&gt;producer;
</span></span><span style="display:flex;"><span>            std::shared_ptr&lt;RuntimeOperand&gt; runtime_operand =
</span></span><span style="display:flex;"><span>                    std::make_shared&lt;RuntimeOperand&gt;();
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// æ¬è¿nameå’Œshape
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            runtime_operand-&gt;name = producer-&gt;name;
</span></span><span style="display:flex;"><span>            runtime_operand-&gt;shapes = input-&gt;shape;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">switch</span> (input-&gt;type) {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#b452cd">1</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#228b22">// æ¬è¿ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                    runtime_operand-&gt;type = RuntimeDataType::kTypeFloat32;
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#b452cd">0</span>: {
</span></span><span style="display:flex;"><span>                    runtime_operand-&gt;type = RuntimeDataType::kTypeUnknown;
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">default</span>: {
</span></span><span style="display:flex;"><span>                    LOG(FATAL) &lt;&lt; <span style="color:#cd5555">&#34;Unknown input operand type: &#34;</span> &lt;&lt; input-&gt;type;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            runtime_operator-&gt;input_operands.insert({producer-&gt;name, runtime_operand});
</span></span><span style="display:flex;"><span>            runtime_operator-&gt;input_operands_seq.push_back(runtime_operand);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/// ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºè¿ç®—ç¬¦çš„æ‰€æœ‰è¾“å‡ºæ“ä½œæ•° Operand å’Œå¾…åˆå§‹åŒ–çš„ RuntimeOperator
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#00688b;font-weight:bold">void</span> RuntimeGraph::InitGraphOperatorsOutput(
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::vector&lt;pnnx::Operand *&gt; &amp;outputs,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;runtime_operator) {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> pnnx::Operand *output: outputs) {
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">if</span> (!output) {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;consumers = output-&gt;consumers;
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;c: consumers) {
</span></span><span style="display:flex;"><span>                runtime_operator-&gt;output_names.push_back(c-&gt;name);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/// æå–PNNXä¸­çš„å‚æ•°ï¼ˆParamï¼‰åˆ°RuntimeParam
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#00688b;font-weight:bold">void</span> RuntimeGraph::InitGraphParams(
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::map&lt;std::string, pnnx::Parameter&gt; &amp;params,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;runtime_operator) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// ä¸€ä¸ªåå­—å¯¹åº”ä¸€ä¸ªdata
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;[name, parameter]:params) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//æ‹·è´ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">int</span> type = parameter.type;
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 0=null 1=b 2=i 3=f 4=s 5=ai 6=af 7=as 8=others
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">switch</span> (type) {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterUnknown): {
</span></span><span style="display:flex;"><span>                    <span style="color:#228b22">// åˆ›å»ºä¸€ä¸ªç©ºçš„RuntimeParameterç±»å‹çš„æ•°æ®,å› ä¸ºæ•°æ®ä¸ºç©ºï¼Œç›´æ¥æ’å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                    RuntimeParameter *runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameter;
</span></span><span style="display:flex;"><span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterBool): {
</span></span><span style="display:flex;"><span>                    RuntimeParameterBool *runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameterBool;
</span></span><span style="display:flex;"><span>                    runtime_parameter-&gt;value = parameter.b; <span style="color:#228b22">//æ‹·è´æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterInt): {
</span></span><span style="display:flex;"><span>                    RuntimeParameterInt *runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameterInt;
</span></span><span style="display:flex;"><span>                    runtime_parameter-&gt;value = parameter.i;
</span></span><span style="display:flex;"><span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterFloat): {
</span></span><span style="display:flex;"><span>                    RuntimeParameterFloat *runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameterFloat;
</span></span><span style="display:flex;"><span>                    runtime_parameter-&gt;value = parameter.f;
</span></span><span style="display:flex;"><span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterString): {
</span></span><span style="display:flex;"><span>                    RuntimeParameterString *runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameterString;
</span></span><span style="display:flex;"><span>                    runtime_parameter-&gt;value = parameter.s;
</span></span><span style="display:flex;"><span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterIntArray): {
</span></span><span style="display:flex;"><span>                    RuntimeParameterIntArray * runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameterIntArray;
</span></span><span style="display:flex;"><span>                    runtime_parameter-&gt;value = parameter.ai;
</span></span><span style="display:flex;"><span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterFloatArray): {
</span></span><span style="display:flex;"><span>                    RuntimeParameterFloatArray *runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameterFloatArray;
</span></span><span style="display:flex;"><span>                    runtime_parameter-&gt;value = parameter.af;
</span></span><span style="display:flex;"><span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">case</span> <span style="color:#008b45">int</span>(RuntimeParameterType::kParameterStringArray): {
</span></span><span style="display:flex;"><span>                    RuntimeParameterStringArray *runtime_parameter = <span style="color:#8b008b;font-weight:bold">new</span> RuntimeParameterStringArray;
</span></span><span style="display:flex;"><span>                    runtime_parameter-&gt;value = parameter.as;
</span></span><span style="display:flex;"><span>                    runtime_operator-&gt;params.insert({name, runtime_parameter});
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">default</span>: {
</span></span><span style="display:flex;"><span>                    LOG(FATAL) &lt;&lt; <span style="color:#cd5555">&#34;Unknown parameter type: &#34;</span> &lt;&lt; type;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å››æ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº">å››ï¼šæ„å»ºè®¡ç®—å›¾å…³ç³»å’Œæ‰§è¡Œé¡ºåº</h3>
<p>æ·±åº¦å­¦ä¹ æ¨¡å‹æ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ã€‚å¯¹äº<strong>æœ‰å‘å›¾ç»“æ„ä¸­çš„èŠ‚ç‚¹</strong>ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯æ·±åº¦å­¦ä¹ æ¨¡å‹ä¸­çš„<strong>è®¡ç®—èŠ‚ç‚¹ï¼ˆç®—å­ï¼‰</strong>ï¼Œè€Œ<strong>æœ‰å‘å›¾ç»“æ„ä¸­çš„è¾¹</strong>å¯ä»¥è®¤ä¸ºæ˜¯ç®—å­ä¹‹é—´<strong>è¿æ¥å’Œå‰åä¾èµ–å…³ç³»</strong>ã€‚</p>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li>è®¡ç®—å›¾åˆå§‹åŒ–ï¼ˆç¬¬ä¸‰èŠ‚çš„å†…å®¹ï¼‰</li>
<li>è®¡ç®—å›¾çš„æ„å»º</li>
<li>è®¡ç®—å›¾çš„é¡ºåºæ‰§è¡Œï¼ˆé€’å½’æ–¹æ³•ï¼‰</li>
</ol>
<p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ‹“æ‰‘æ’åºæ¥æ‰¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹åºåˆ—ï¼Œåœ¨åºåˆ—ä¸­<strong>æ¯ä¸ªèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹éƒ½èƒ½æ’åœ¨è¿™ä¸ªèŠ‚ç‚¹çš„å‰é¢</strong>ã€‚</p>
<blockquote>
<p>åŸºäºæ·±åº¦ä¼˜å…ˆçš„æ‹“æ‰‘æ’åºè®¡ç®—æ­¥éª¤</p>
</blockquote>
<ol>
<li>é€‰å®šä¸€ä¸ªå…¥åº¦ä¸ºé›¶çš„èŠ‚ç‚¹(<code>current_op</code>)ï¼Œå…¥åº¦ä¸ºé›¶æŒ‡çš„æ˜¯<strong>è¯¥èŠ‚ç‚¹æ²¡æœ‰å‰é©±èŠ‚ç‚¹æˆ–æ‰€æœ‰å‰é©±èŠ‚ç‚¹å·²ç»éƒ½è¢«æ‰§è¡Œè¿‡</strong>ï¼Œåœ¨é€‰å®šçš„åŒæ—¶å°†è¯¥èŠ‚ç‚¹çš„å·²æ‰§è¡Œæ ‡è®°ç½®ä¸º<code>True</code>ï¼Œå¹¶å°†è¯¥èŠ‚ç‚¹ä¼ å…¥åˆ°<code>ReverseTopo</code>å‡½æ•°ä¸­ï¼›</li>
<li>éå†1æ­¥éª¤ä¸­èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹(<code>current_op-&gt;output_operators</code>)ï¼›</li>
<li>å¦‚æœ1çš„æŸä¸ªåç»§èŠ‚ç‚¹æ²¡æœ‰è¢«æ‰§è¡Œè¿‡ï¼ˆå·²æ‰§è¡Œæ ‡è®°ä¸º<code>False</code>ï¼‰ï¼Œåˆ™é€’å½’å°†<strong>è¯¥åç»§èŠ‚ç‚¹</strong>ä¼ å…¥åˆ°<code>ReverseTopo</code>å‡½æ•°ä¸­ï¼›</li>
<li>ç¬¬2æ­¥ä¸­çš„éå†ç»“æŸåï¼Œæˆ‘ä»¬å°†å½“å‰èŠ‚ç‚¹æ”¾å…¥åˆ°æ‰§è¡Œé˜Ÿåˆ—(<code>topo_operators_</code>)ä¸­ã€‚</li>
</ol>
<p>è®¡ç®—å›¾é€’å½’æ‰§è¡Œçš„ç¨‹åº:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> RuntimeGraph::ReverseTopo(
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;root_op) {
</span></span><span style="display:flex;"><span>  CHECK(root_op != <span style="color:#8b008b;font-weight:bold">nullptr</span>) &lt;&lt; <span style="color:#cd5555">&#34;current operator is nullptr&#34;</span>;
</span></span><span style="display:flex;"><span>  root_op-&gt;has_forward = <span style="color:#658b00">true</span>; <span style="color:#228b22">// å°†å·²æ‰§è¡Œçš„æ ‡å¿—è®¾ç½®ä¸ºtrue
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;next_ops = root_op-&gt;output_operators; <span style="color:#228b22">// åç»§èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;[_, op] : next_ops) { <span style="color:#228b22">// éå†åç»§èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (op != <span style="color:#8b008b;font-weight:bold">nullptr</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#8b008b;font-weight:bold">if</span> (!op-&gt;has_forward) { <span style="color:#228b22">// å¦‚æœå…¶ä¸­ä¸€ä¸ªåç»§èŠ‚ç‚¹æ²¡æœ‰éå†è¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">this</span>-&gt;ReverseTopo(op); <span style="color:#228b22">// åˆ™ç›´æ¥å°†è¯¥èŠ‚ç‚¹å½“åšå½“å‰èŠ‚ç‚¹é€’å½’æ‰§è¡Œè¯¥ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;[_, op] : next_ops) {
</span></span><span style="display:flex;"><span>    CHECK_EQ(op-&gt;has_forward, <span style="color:#658b00">true</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">this</span>-&gt;topo_operators_.push_back(root_op); <span style="color:#228b22">// å°†æ²¡æœ‰åç»§èŠ‚ç‚¹çš„èŠ‚ç‚¹æ”¾å…¥root_opä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ä¸€ä¸ªç®€å•çš„è®¡ç®—å›¾ä¾‹å­æ¥èµ°ä¸€ä¸‹ä¸Šè¿°è¿‡ç¨‹ï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img97.jpg" alt=""></p>
<p>æ‰§è¡Œé˜Ÿåˆ—çš„é¡ºåºï¼š</p>
<p>æŒ‰ç…§æ‰§è¡Œé¡ºåºï¼Œé¦–å…ˆæ²¡æœ‰åç»§èŠ‚ç‚¹çš„æ˜¯<code>op4</code>ï¼Œç¬¬äºŒä¸ªæ²¡æœ‰åç»§èŠ‚ç‚¹çš„ä¸º<code>output</code>ã€‚</p>
<p>[<code>op4</code>ï¼Œ<code>output</code>ï¼Œ<code>op5</code>ï¼Œ<code>op3</code>ï¼Œ<code>op1</code>ï¼Œ<code>input</code>]ï¼Œé€†åºä¹‹åï¼ŒçœŸæ­£çš„æ‰§è¡Œé¡ºåºä¸º[<code>input</code>ï¼Œ<code>op1</code>ï¼Œ<code>op3</code>ï¼Œ<code>op5</code>ï¼Œ<code>output</code>, <code>op4</code>]ã€‚</p>
<blockquote>
<p>æ¨¡å‹çš„çŠ¶æ€</p>
</blockquote>
<p><code>RuntimeGraph</code>ä¸€å…±æœ‰ä¸‰ç§çŠ¶æ€ï¼Œè¡¨ç¤ºåŒä¸€ä¸ªæ¨¡å‹çš„ä¸åŒçŠ¶æ€ï¼ˆå¾…åˆå§‹åŒ–ï¼Œå¾…æ„å»ºï¼Œæ„å»ºå®Œæˆï¼‰ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">enum</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">GraphState</span> {
</span></span><span style="display:flex;"><span>  NeedInit = -<span style="color:#b452cd">2</span>;
</span></span><span style="display:flex;"><span>  NeedBuild = -<span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>  Complete = <span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åœ¨åˆå§‹æƒ…å†µä¸‹</strong>æ¨¡å‹çš„çŠ¶æ€<code>graph_state_</code>ä¸º<code>NeedInit</code>ï¼Œè¡¨ç¤ºæ¨¡å‹ç›®å‰<strong>å¾…åˆå§‹åŒ–</strong>ã€‚å› æ­¤æˆ‘ä»¬ä¸èƒ½åœ¨æ­¤åˆ»ç›´æ¥è°ƒç”¨<code>Build</code>å‡½æ•°ä¸­çš„åŠŸèƒ½ï¼Œ<strong>è€Œæ˜¯éœ€è¦åœ¨æ­¤ä¹‹å‰å…ˆè°ƒç”¨æ¨¡å‹çš„<code>Init</code>å‡½æ•°</strong>ï¼Œåœ¨åˆå§‹åŒ–å‡½æ•°(<code>Init</code>)è°ƒç”¨æˆåŠŸåä¼šå°†æ¨¡å‹çš„çŠ¶æ€è°ƒæ•´ä¸º<code>NeedBuild</code>.</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scss" data-lang="scss"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">NeedInit</span> ---&gt; <span style="color:#8b008b;font-weight:bold">NeedBuild</span> ---&gt; <span style="color:#8b008b;font-weight:bold">Complete</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ„å»ºå›¾å…³ç³»</p>
</blockquote>
<p>è¯¥éƒ¨åˆ†ä»£ç ä¸ºï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>	<span style="color:#228b22">// æ„å»ºå›¾å…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;current_op : <span style="color:#8b008b;font-weight:bold">this</span>-&gt;operators_) {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// è·å–å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰åç»§èŠ‚ç‚¹çš„namesï¼Œéå†æ ¹æ®next_op_nameä»operators_maps_ä¸­æ’å…¥æ‰€éœ€è¦çš„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">const</span> std::vector&lt;std::string&gt; &amp;output_names = current_op-&gt;output_names;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;kOutputName : output_names) {
</span></span><span style="display:flex;"><span>      <span style="color:#8b008b;font-weight:bold">if</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;output_op = <span style="color:#8b008b;font-weight:bold">this</span>-&gt;operators_maps_.find(kOutputName);
</span></span><span style="display:flex;"><span>          output_op != <span style="color:#8b008b;font-weight:bold">this</span>-&gt;operators_maps_.end()) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// output_operator ä»£è¡¨è¯¥èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        current_op-&gt;output_operators.insert({kOutputName, output_op-&gt;second});
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°æ¯æ¬¡éƒ½æ˜¯é€šè¿‡èŠ‚ç‚¹çš„namesï¼Œéå†æ ¹æ®next_op_nameï¼Œç„¶åæ’å…¥è¯¥èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>èŠ‚ç‚¹è¾“å‡ºå¼ é‡çš„åˆå§‹åŒ–</p>
</blockquote>
<p>æˆ‘ä»¬åœ¨<code>Build</code>å‡½æ•°ä¸­è¿˜éœ€è¦<strong>å®Œæˆè®¡ç®—èŠ‚ç‚¹ä¸­è¾“å‡ºå¼ é‡ç©ºé—´çš„åˆå§‹åŒ–</strong>ï¼Œè¿™æ ·æ˜¯ä¸ºäº†èŠ‚çœè¿è¡Œæ—¶ç”³è¯·å†…å­˜éœ€è¦çš„æ—¶é—´ï¼Œä»ä¸‹å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå½¢çŠ¶ä¸åŒçš„è¾“å‡ºå¼ é‡ï¼Œç”¨æ¥å­˜æ”¾è¯¥èŠ‚ç‚¹çš„è®¡ç®—è¾“å‡ºã€‚</p>
<p><em>é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸éœ€è¦å¯¹è¾“å…¥ç©ºé—´è¿›è¡Œåˆå§‹åŒ–å‘¢ï¼Ÿ</em></p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img98.jpg" alt=""></p>
<p><strong>ä¸»è¦çš„åŸå› å°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºç©ºé—´å’Œä¸‹ä¸ªèŠ‚ç‚¹çš„è¾“å…¥æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”³è¯·é¢å¤–çš„ç©ºé—´ã€‚</strong></p>
<p>å…¶ä¸­çš„å‡½æ•°æ˜¯ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#228b22">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯pnnxçš„è®¡ç®—èŠ‚ç‚¹ ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯RuntimeGraphçš„è®¡ç®—èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>InitOperatorOutput(graph_-&gt;ops, operators_);
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…·ä½“ä»£ç å¾ˆé•¿ï¼Œå…¶å…·ä½“è¿‡ç¨‹ï¼š</p>
<ol>
<li>å…ˆåˆ¤æ–­PNNXå’ŒRuntime_opæ˜¯å¦ç­‰é•¿</li>
<li>è·å¾—ç¬¬iä¸ªè®¡ç®—èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰è¾“å‡ºè®¡ç®—æ•°<code>operand</code>, <strong>æˆ‘ä»¬éœ€è¦æ ¹æ®è¿™ä¸ª<code>pnnx</code>è®¡ç®—æ•°<code>Operand</code>ä¸­è®°å½•çš„<code>Shape</code>å’Œ<code>Type</code>ä¿¡æ¯æ¥åˆå§‹åŒ–æˆ‘ä»¬<code>runtime_op</code>ä¸­è¾“å‡ºæ•°æ®å­˜å‚¨çš„ç©ºé—´</strong></li>
<li>æˆ‘ä»¬è¾“å‡ºå¼ é‡çš„ç»´åº¦åªæ”¯æŒäºŒç»´çš„ã€ä¸‰ç»´ä»¥åŠå››ç»´çš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨ä»¥ä¸Šä»£ç ä¸Šåš<code>check</code>.</li>
<li>åˆå§‹åŒ–ç»“æ„ä¸­<strong>å­˜æ”¾è¾“å‡ºæ•°æ®çš„<code>datas</code>å˜é‡</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼ é‡çš„æ•°ç»„ç±»å‹ï¼Œæ•°ç»„çš„é•¿åº¦ç­‰äºè¯¥è®¡ç®—èŠ‚ç‚¹çš„<code>batch_size</code>å¤§å°ã€‚</li>
<li>åœ¨å¾ªç¯åç»“æŸåï¼Œ<strong>æˆ‘ä»¬ä¼šå°†åˆå§‹åŒ–å¥½çš„<code>output_operands</code>ç»‘å®šåˆ°å¯¹åº”çš„è®¡ç®—èŠ‚ç‚¹ä¸­ç”¨äºä¿å­˜è®¡ç®—èŠ‚ç‚¹çš„è¾“å‡ºæ•°æ®ã€‚</strong></li>
</ol>
<blockquote>
<p>ä½œä¸šï¼šä½¿ç”¨å¦ä¸€ç§æ–¹å¼å®ç°æ‹“æ‰‘æ’åºï¼ˆä¸ä½¿ç”¨é€’å½’ï¼‰</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> RuntimeGraph::ReverseTopo(<span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;root_op) {
</span></span><span style="display:flex;"><span>    CHECK(root_op != <span style="color:#8b008b;font-weight:bold">nullptr</span>) &lt;&lt; <span style="color:#cd5555">&#34;current operator is nullptr&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std::stack&lt;std::shared_ptr&lt;RuntimeOperator&gt;&gt; stack;
</span></span><span style="display:flex;"><span>    stack.push(root_op);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">while</span>(!stack.empty()) {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">auto</span> current_op = stack.top();
</span></span><span style="display:flex;"><span>        stack.pop();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span>(!current_op-&gt;has_forward){ <span style="color:#228b22">//å…¶ä¸­ä¸€ä¸ªåç»§èŠ‚ç‚¹æ²¡æœ‰éå†è¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            current_op-&gt;has_forward = <span style="color:#658b00">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span>&amp; next_ops = current_op-&gt;output_operators;
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span>&amp;[_, op] : next_ops) {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">if</span> (op != <span style="color:#8b008b;font-weight:bold">nullptr</span> &amp;&amp; !op-&gt;has_forward){
</span></span><span style="display:flex;"><span>                    stack.push(op);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#8b008b;font-weight:bold">auto</span> &amp;[_, op] : next_ops) {
</span></span><span style="display:flex;"><span>                CHECK_EQ(op-&gt;has_forward, <span style="color:#658b00">true</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="äº”ç®—å­å’Œæ³¨å†Œå·¥å‚">äº”ï¼šç®—å­å’Œæ³¨å†Œå·¥å‚</h3>
<p>ä¸€ä¸ªå®Œæ•´çš„è®¡ç®—å›¾ï¼ŒåŒ…æ‹¬äº†è¾“å…¥ã€è¾“å‡ºèŠ‚ç‚¹ä»¥åŠè®¡ç®—èŠ‚ç‚¹ç­‰ã€‚è®¡ç®—èŠ‚ç‚¹åœ¨æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®ä¸­è¢«ç§°ä¹‹ä¸º<code>RuntimeOperator</code>, å…·ä½“çš„ç»“æ„å®šä¹‰å¦‚ä¸‹çš„ä»£ç æ‰€ç¤ºï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">struct</span> <span style="color:#008b45;font-weight:bold">RuntimeOperator</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">virtual</span> ~RuntimeOperator();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#00688b;font-weight:bold">bool</span> has_forward = <span style="color:#658b00">false</span>;
</span></span><span style="display:flex;"><span>  std::string name;      <span style="color:#228b22">/// è®¡ç®—èŠ‚ç‚¹çš„åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  std::string type;      <span style="color:#228b22">/// è®¡ç®—èŠ‚ç‚¹çš„ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  std::shared_ptr&lt;Layer&gt; layer;  <span style="color:#228b22">/// èŠ‚ç‚¹å¯¹åº”çš„è®¡ç®—Layer
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    
</span></span><span style="display:flex;"><span>  std::map&lt;std::string, std::shared_ptr&lt;RuntimeOperand&gt;&gt;
</span></span><span style="display:flex;"><span>      input_operands;  <span style="color:#228b22">/// èŠ‚ç‚¹çš„è¾“å…¥æ“ä½œæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  std::shared_ptr&lt;RuntimeOperand&gt; output_operands;  <span style="color:#228b22">/// èŠ‚ç‚¹çš„è¾“å‡ºæ“ä½œæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  std::vector&lt;std::shared_ptr&lt;RuntimeOperand&gt;&gt;
</span></span><span style="display:flex;"><span>      input_operands_seq;  <span style="color:#228b22">/// èŠ‚ç‚¹çš„è¾“å…¥æ“ä½œæ•°ï¼Œé¡ºåºæ’åˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  std::map&lt;std::string, std::shared_ptr&lt;RuntimeOperator&gt;&gt;
</span></span><span style="display:flex;"><span>      output_operators;  <span style="color:#228b22">/// è¾“å‡ºèŠ‚ç‚¹çš„åå­—å’ŒèŠ‚ç‚¹å¯¹åº”
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>  ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨æˆ‘ä»¬è¦å®ç°Layerçš„åŠŸèƒ½ï¼Œå…¶ä½œç”¨å…¶å®å°±æ˜¯è¿›è¡Œè®¡ç®—ï¼Œä¸ºæ‰€æœ‰ç®—å­çš„çˆ¶ç±»ã€‚</p>
<p>å…¶æ•´ä½“çš„å·¥ä½œæµç¨‹ä¸ºï¼šé€šè¿‡è®¿é—®<code>RuntimeOperator</code>çš„è¾“å…¥æ•°(<code>input_operand</code>)ï¼Œ<code>layer</code>å¯ä»¥è·å–è®¡ç®—æ‰€éœ€çš„è¾“å…¥å¼ é‡æ•°æ®ï¼Œ<strong>å¹¶æ ¹æ®<code>layer</code>å„æ´¾ç”Ÿç±»åˆ«ä¸­å®šä¹‰çš„è®¡ç®—å‡½æ•°(<code>forward</code>)å¯¹è¾“å…¥å¼ é‡æ•°æ®è¿›è¡Œè®¡ç®—</strong>ã€‚è®¡ç®—å®Œæˆåï¼Œè®¡ç®—ç»“æœå°†å­˜å‚¨åœ¨è¯¥èŠ‚ç‚¹çš„è¾“å‡ºæ•°(<code>output_operand</code>)ä¸­ã€‚</p>
<p>æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img99.jpg" alt=""></p>
<p>å„ä¸ªç±»ä¸æ–¹æ³•çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img100.jpg" alt=""></p>
<p><code>RuntimeOperator</code>ä¼šå»è°ƒç”¨<code>Layer</code>ç±»ä¸­çš„forwardæ–¹æ³•ï¼Œforwardæ–¹æ³•åˆ™ä¼šå»è°ƒç”¨å­æ–¹æ³•ã€‚</p>
<p>å…¶ä¸­ä¸å¸¦å‚æ•°çš„<code>forward</code>ç‰ˆæœ¬çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img101.jpg" alt=""></p>
<p>è¿™é‡Œçš„å‡†å¤‡è¾“å…¥è¾“å‡ºæ˜¯åœ¨çˆ¶ç±»Layerä¸­è¿›è¡Œçš„ï¼</p>
<blockquote>
<p>å¦‚ä½•è§£å†³å¤šä¸ªå‰ç½®è¾“å…¥èŠ‚ç‚¹çš„è®¡ç®—é—®é¢˜</p>
</blockquote>
<p><code>input_operand_datas</code>å­˜æ”¾äº†æ‰€æœ‰çš„è¾“å…¥æ•°æ®ï¼Œé€šè¿‡å¾ªç¯çš„æ–¹å¼å°†æ‰€æœ‰æ•°æ®å¹³é“ºæ”¾å…¥<code>Layerç±»</code>ä¸­çš„å˜é‡<code>layer_input_data</code>ä¸­ã€‚åŒæ ·çš„ï¼Œå‚æ•°<code>outputs</code>å­˜æ”¾è¾“å‡ºçš„ç»“æœï¼Œæ˜¯ä¸€ä¸ªé¢„ç”³è¯·çš„ç©ºé—´ï¼Œä»Layerç›¸å…³è”çš„Runtime_Operaterç±»ä¸­çš„<code>output_operand</code>ä½œä¸ºè¾“å‡ºæ•°ç»„ã€‚</p>
<blockquote>
<p>å…¨å±€ç®—å­æ³¨å†Œå™¨</p>
</blockquote>
<p>åœ¨<code>KuiperInfer</code>ä¸­ç®—å­æ³¨å†Œæœºåˆ¶ä½¿ç”¨äº†<code>å•ä¾‹æ¨¡å¼</code>å’Œ<code>å·¥å‚æ¨¡å¼</code>ã€‚é¦–å…ˆï¼Œåœ¨å…¨å±€èŒƒå›´å†…åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„æ³¨å†Œè¡¨<code>registry</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ª<code>map</code>å®ç°çš„ã€‚<strong>è¿™ä¸ªæ³¨å†Œè¡¨çš„é”®æ˜¯ç®—å­çš„ç±»å‹ï¼Œè€Œå€¼æ˜¯ç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåˆå§‹åŒ–è¿‡ç¨‹çš„å€¼å…·ä½“æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚</strong></p>
<p>å¼€å‘è€…å®Œæˆä¸€ä¸ªç®—å­çš„å¼€å‘åï¼Œéœ€è¦é€šè¿‡ç‰¹å®šçš„æ³¨å†Œæœºåˆ¶å°†ç®—å­å†™å…¥å…¨å±€æ³¨å†Œè¡¨ä¸­ã€‚éœ€è¦ä½¿ç”¨æŸä¸ªç®—å­æ—¶ï¼Œå¯ä»¥æ ¹æ®ç®—å­çš„ç±»å‹ä»å…¨å±€æ³¨å†Œè¡¨ä¸­æ–¹ä¾¿åœ°è·å–å¯¹åº”çš„ç®—å­ã€‚</p>
<p>å½“æ”¯æŒçš„ç®—å­è¢«æ·»åŠ åˆ°æ³¨å†Œè¡¨ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨<code>registry.find(layer_type)</code>æ¥è·å–ç‰¹å®šç±»å‹ç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¹¶è°ƒç”¨è¯¥è¿‡ç¨‹æ¥è·å–ç›¸åº”ç®—å­çš„å®ä¾‹ã€‚</p>
<ul>
<li>ç®—å­åˆå§‹åŒ–çš„å‡½æ•°éƒ½ç¬¦åˆä¸‹é¢çš„æ ‡å‡†ï¼š</li>
</ul>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span> <span style="color:#8b008b;font-weight:bold">typedef</span> <span style="color:#008b45">ParseParameterAttrStatus</span> (*Creator)
</span></span><span style="display:flex;"><span>      (<span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;op,std::shared_ptr&lt;Layer&gt; &amp;layer) {
</span></span><span style="display:flex;"><span>   <span style="color:#228b22">// å®ä¾‹åŒ–ä¸€ä¸ªlayerçš„ç©ºæŒ‡é’ˆï¼Œç”±äºè¿™é‡Œæ˜¯ç¤ºä¾‹ï¼Œæ²¡æœ‰ç”¨åˆ°opçš„å„ç§ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>   layer = std::make_shared&lt;Layer&gt;(<span style="color:#cd5555">&#34;test_layer&#34;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#8b008b;font-weight:bold">return</span> ParseParameterAttrStatus::kParameterAttrParseSuccess;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œopè®°å½•äº†ç®—å­åˆå§‹åŒ–éœ€è¦çš„å„ç§å˜é‡ï¼ˆå‚æ•°ã€æƒé‡ç­‰ç­‰ï¼‰ï¼Œlayerä½ä¸€ä¸ªå¾…åˆå§‹åŒ–çš„ç©ºæŒ‡é’ˆã€‚</em></p>
<blockquote>
<p>ä»æ³¨å†Œå™¨ä¸­å–å‡ºç®—å­</p>
</blockquote>
<p>æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œå› ä¸ºæ³¨å†Œå™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªmapï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>registry.find(layer_type)-&gt;second</code>æ¥å–å‡ºç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p>
<blockquote>
<p>ReLUç®—å­çš„å®ç°</p>
</blockquote>
<p><code>ReLU</code>çš„è®¡ç®—è¿‡ç¨‹éå¸¸ç®€å•ï¼Œæœ‰å¦‚ä¸‹çš„å®šä¹‰:$ReLU(x)=max(x,0)$.</p>
<p>æ ¹æ®å…¬å¼$ReLU(x) = max(x,0)$å¯ä»¥çœ‹å‡ºï¼Œ<code>ReLU</code>ç®—å­ä¸ä¼šæ”¹å˜è¾“å…¥å¼ é‡çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„ç»´åº¦åº”è¯¥æ˜¯ç›¸åŒçš„ã€‚å› æ­¤ï¼Œ<strong>ä»£ç é€»è¾‘ï¼š é¦–å…ˆæ£€æŸ¥è¾“å…¥æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œç„¶åæ£€æŸ¥è¾“å…¥æ•°ç»„å’Œè¾“å‡ºæ•°ç»„ä¸­çš„å…ƒç´ ï¼ˆå¼ é‡ï¼‰ä¸ªæ•°æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸æ»¡è¶³è¯¥æ¡ä»¶ï¼Œç¨‹åºè¿”å›å¹¶è®°å½•ç›¸å…³é”™è¯¯æ—¥å¿—ã€‚</strong></p>
<blockquote>
<p>ä½œä¸šï¼šSigmoidç®—å­å®ç°</p>
</blockquote>
<p>Sigmoid.hpp:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#1e889b">#ifndef KUIPER_DATAWHALE_SIGMOID_HPP
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#define KUIPER_DATAWHALE_SIGMOID_HPP
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&#34;layer/abstract/non_param_layer.hpp&#34;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">namespace</span> kuiper_infer{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">SigmoidLayer</span> : <span style="color:#8b008b;font-weight:bold">public</span> NonParamLayer{
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span>:
</span></span><span style="display:flex;"><span>    SigmoidLayer() : NonParamLayer(<span style="color:#cd5555">&#34;Sigmoid&#34;</span>){}
</span></span><span style="display:flex;"><span>        InferStatus <span style="color:#008b45">Forward</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;&gt;&amp; inputs,
</span></span><span style="display:flex;"><span>            std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;&gt;&amp; outputs) <span style="color:#8b008b;font-weight:bold">override</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">static</span> ParseParameterAttrStatus <span style="color:#008b45">GetInstance</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt;&amp; op,
</span></span><span style="display:flex;"><span>            std::shared_ptr&lt;Layer&gt;&amp; sigmoid_layer);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>} <span style="color:#228b22">// namespace kuiper_infer
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#1e889b">#endif </span><span style="color:#228b22">//KUIPER_DATAWHALE_SIGMOID_HPP
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Sigmoid.cpp:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#228b22">//
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">// Created by è”¡é›„æ±Ÿ on 2023/9/5.
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">//
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>
</span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&#34;sigmoid.hpp&#34;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b">#include</span> <span style="color:#1e889b">&#34;layer/abstract/layer_factory.hpp&#34;</span><span style="color:#1e889b">
</span></span></span><span style="display:flex;"><span><span style="color:#1e889b"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">namespace</span> kuiper_infer {
</span></span><span style="display:flex;"><span>    InferStatus SigmoidLayer::Forward(<span style="color:#8b008b;font-weight:bold">const</span> std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;&gt; &amp;inputs,
</span></span><span style="display:flex;"><span>                                      std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;&gt; &amp;outputs) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">//åˆ¤æ–­è¾“å…¥æ˜¯å¦ä¸ºç©º
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (inputs.empty()) {
</span></span><span style="display:flex;"><span>            LOG(ERROR) &lt;&lt; <span style="color:#cd5555">&#34;The input tensor array in the sigmoid layer is empty&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">return</span> InferStatus::kInferFailedInputEmpty;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// åˆ¤æ–­è¾“å…¥è¾“å‡ºç»´åº¦æ˜¯å¦ç›¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (inputs.size() != outputs.size()) {
</span></span><span style="display:flex;"><span>            LOG(ERROR) &lt;&lt; <span style="color:#cd5555">&#34;The input and output tensor array size of the sigmoid layer do not match&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">return</span> InferStatus::kInferFailedInputOutSizeMatchError;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> batch_size = inputs.size();
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> i = <span style="color:#b452cd">0</span>; i &lt; batch_size; ++i) {
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> sftensor &amp;input_data = inputs.at(i);
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> sftensor &amp;output_data = outputs.at(i);
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// åˆ¤æ–­æ¯ä¸€ä¸ªbatchæ˜¯å¦ä¸ºç©º
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">if</span> (input_data == <span style="color:#8b008b;font-weight:bold">nullptr</span> || input_data-&gt;empty()) {
</span></span><span style="display:flex;"><span>                LOG(ERROR)
</span></span><span style="display:flex;"><span>                        &lt;&lt; <span style="color:#cd5555">&#34;The input tensor array in the sigmoid layer has an empty tensor &#34;</span>
</span></span><span style="display:flex;"><span>                        &lt;&lt; i &lt;&lt; <span style="color:#cd5555">&#34; th&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">return</span> InferStatus::kInferFailedInputEmpty;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">//åˆ¤æ–­æ¯ä¸€ä¸ªbatchçš„ç»´åº¦æ˜¯å¦ç›¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">if</span> (output_data != <span style="color:#8b008b;font-weight:bold">nullptr</span> &amp;&amp; !output_data-&gt;empty()) {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">if</span> (input_data-&gt;shapes() != output_data-&gt;shapes()) {
</span></span><span style="display:flex;"><span>                    LOG(ERROR) &lt;&lt; <span style="color:#cd5555">&#34;The input and output tensor shapes of the sigmoid layer do not match &#34;</span>
</span></span><span style="display:flex;"><span>                               &lt;&lt; i &lt;&lt; <span style="color:#cd5555">&#34; th&#34;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">return</span> InferStatus::kInferFailedInputOutSizeMatchError;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> i = <span style="color:#b452cd">0</span>; i &lt; batch_size; ++i) {
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt; &amp;input = inputs.at(i); <span style="color:#228b22">// è¾“å…¥æ˜¯ä¿æŒä¸å˜çš„
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            CHECK(input != <span style="color:#8b008b;font-weight:bold">nullptr</span> || !input-&gt;empty())
</span></span><span style="display:flex;"><span>                            &lt;&lt; <span style="color:#cd5555">&#34;The input tensor array in the sigmoid layer has an empty tensor &#34;</span>
</span></span><span style="display:flex;"><span>                            &lt;&lt; i &lt;&lt; <span style="color:#cd5555">&#34; th&#34;</span>;
</span></span><span style="display:flex;"><span>            std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt; output = outputs.at(i); <span style="color:#228b22">// è¾“å‡ºæ˜¯è¦æ”¹å˜çš„ï¼Œæ‰€ä»¥æ˜¯å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">if</span> (output == <span style="color:#8b008b;font-weight:bold">nullptr</span> || output-&gt;empty()) {
</span></span><span style="display:flex;"><span>                DLOG(ERROR) &lt;&lt; <span style="color:#cd5555">&#34;The output tensor array in the sigmoid layer has an empty tensor &#34;</span>
</span></span><span style="display:flex;"><span>                            &lt;&lt; i &lt;&lt; <span style="color:#cd5555">&#34; th&#34;</span>;
</span></span><span style="display:flex;"><span>                output = std::make_shared&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;(input-&gt;shapes());
</span></span><span style="display:flex;"><span>                outputs.at(i) = output;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            CHECK(output-&gt;shapes() == input-&gt;shapes())
</span></span><span style="display:flex;"><span>                            &lt;&lt; <span style="color:#cd5555">&#34;The input and output tensor shapes of the sigmoid layer do not match &#34;</span>
</span></span><span style="display:flex;"><span>                            &lt;&lt; i &lt;&lt; <span style="color:#cd5555">&#34; th&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">/// Sigmoidç®—å­çš„è¿ç®—é€»è¾‘ï¼ˆå–å‡ºä¸€ä¸ªå¼ é‡çš„ä¸€ä¸ªæ•°æ®ï¼Œè¿›è¡Œè¿ç®—ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> j = <span style="color:#b452cd">0</span>; j &lt; input-&gt;size(); ++j) {
</span></span><span style="display:flex;"><span>                <span style="color:#00688b;font-weight:bold">float</span> value = input-&gt;index(j);
</span></span><span style="display:flex;"><span>                output-&gt;index(j) = <span style="color:#b452cd">1</span> / (<span style="color:#b452cd">1.f</span> + expf(-value));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> InferStatus::kInferSuccess;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/// å®ä¾‹åŒ–å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    ParseParameterAttrStatus SigmoidLayer::GetInstance(
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;op,
</span></span><span style="display:flex;"><span>            std::shared_ptr&lt;Layer&gt; &amp;sigmoid_layer) {
</span></span><span style="display:flex;"><span>        CHECK(op != <span style="color:#8b008b;font-weight:bold">nullptr</span>) &lt;&lt; <span style="color:#cd5555">&#34;Sigmoid operator is nullptr&#34;</span>;
</span></span><span style="display:flex;"><span>        sigmoid_layer = std::make_shared&lt;SigmoidLayer&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> ParseParameterAttrStatus::kParameterAttrParseSuccess;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">/// ä½¿ç”¨å·¥å…·ç±»æ³¨å†Œç®—å­
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    LayerRegistererWrapper <span style="color:#008b45">kSigmoidGetInstance</span>(<span style="color:#cd5555">&#34;nn.Sigmoid&#34;</span>, SigmoidLayer::GetInstance);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å…­å·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°">å…­ï¼šå·ç§¯å’Œæ± åŒ–ç®—å­çš„å®ç°</h3>
<blockquote>
<p>æ± åŒ–ç®—å­å®ç°</p>
</blockquote>
<p>æ± åŒ–ç®—å­æŒ‰ç…§ç±»å‹å¯ä»¥åˆ†ä¸ºå¹³å‡æ± åŒ–å’Œæœ€å¤§æ± åŒ–ï¼Œæ± åŒ–ç®—å­éœ€è¦ç¡®å®šçš„å‚æ•°æœ‰æ­¥é•¿(<code>stride height</code>)ï¼Œçª—å£å¤§å°ï¼ˆ<code>pooling height</code>ã€<code>pooling width</code>ï¼‰ï¼Œå…¶é¡ºåºä¸€èˆ¬æ˜¯ä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹ã€‚</p>
<p>è¾“å…¥å¤§å°å’Œè¾“å‡ºå¤§å°ä¹‹é—´æœ‰è¿™æ ·çš„å…³ç³»ï¼š
$$
output\ size = floor(\frac{input\ size - pooling\ size}{stride} + 1)
$$
$4\times 4$çš„æŒ‰ç…§å¤§å°ä¸º2ï¼Œstrideä¸º2çš„æ± åŒ–åï¼Œç‰¹å¾å›¾çš„å¤§å°å‡å°äº†2å€ã€‚</p>
<p><strong>å½“æ± åŒ–ä¸­åŠ å…¥äº†Paddingåï¼Œç­‰å¼å‘ç”Ÿäº†ä¸€äº›æ”¹å˜ï¼š</strong>
$$
output\ size = floor(\frac{input\ size + 2 \times padding- pooling\ size}{stride} + 1)
$$
å¯¹äºå¤šé€šé“çš„æ± åŒ–åªæ˜¯å•é€šé“æ± åŒ–çš„å †å ã€‚</p>
<ul>
<li>ä½¿ç”¨æœ€å¤§æ± åŒ–ä¸¾ä¾‹ï¼Œå¦‚ä½•å®šä½è¾“å‡ºå¼ é‡çš„å…·ä½“ä½ç½®ï¼Œå¹¶è¿›è¡Œèµ‹å€¼ï¼š</li>
</ul>
<ol>
<li><code>output_data-&gt;slice(ic)</code>è·å–ç¬¬<code>ic</code>ä¸ªè¾“å‡ºå¼ é‡</li>
<li><code>output_channel.colptr(int(c / stride_w_));</code>è®¡ç®—ç¬¬icä¸ªå¼ é‡çš„è¾“å‡ºåˆ—ä½ç½®</li>
<li><code>*(output_channel_ptr + int(r / stride_h_)) = max_value</code>ï¼Œå°†å¯¹åº”ä½ç½®çš„å€¼ä½¿ç”¨æœ€å¤§å€¼å¡«å……ã€‚</li>
</ol>
<blockquote>
<p>æ± åŒ–ç®—å­çš„æ³¨å†Œå’Œå®ä¾‹åŒ–</p>
</blockquote>
<p><strong>MaxPoolingLayer::GetInstance</strong>ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>LayerRegistererWrapper <span style="color:#008b45">kMaxPoolingGetInstance</span>(<span style="color:#cd5555">&#34;nn.MaxPool2d&#34;</span>,
</span></span><span style="display:flex;"><span>                                           MaxPoolingLayer::GetInstance);
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…·ä½“çš„å®ä¾‹åŒ–å‡½æ•°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>ParseParameterAttrStatus MaxPoolingLayer::GetInstance(
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> std::shared_ptr&lt;RuntimeOperator&gt;&amp; op,
</span></span><span style="display:flex;"><span>    std::shared_ptr&lt;Layer&gt;&amp; max_layer) {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> std::map&lt;std::string, std::shared_ptr&lt;RuntimeParameter&gt;&gt;&amp; params =
</span></span><span style="display:flex;"><span>      op-&gt;params;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å·ç§¯ç®—å­çš„å®ç°</p>
</blockquote>
<p>æˆ‘ä»¬è¿™é‡Œä»¥äºŒç»´çš„è¾“å…¥ä¸ºä¸»ï¼Œæ­¤å¤„ä»¥å•é€šé“ä¸ºä¾‹ï¼š
$$
Y[i, j] = \sum_{m} \sum_{n} H[m, n] \cdot X[i+m, j+n]
$$
å…¶ä¸­ï¼Œ$X$è¡¨ç¤ºè¾“å…¥çŸ©é˜µï¼Œ$H$è¡¨ç¤ºå·ç§¯æ ¸ï¼Œ$Y$è¡¨ç¤ºè¾“å‡ºçŸ©é˜µï¼Œ$i$å’Œ$j$è¡¨ç¤ºè¾“å‡ºçŸ©é˜µä¸­çš„è¾“å‡ºåƒç´ åæ ‡ï¼Œ$m$å’Œ$n$è¡¨ç¤ºå·ç§¯æ ¸ä¸­çš„åæ ‡ï¼Œ$i+m$å’Œ$j+n$ç”¨äºå°†å·ç§¯æ ¸å’Œè¾“å…¥çŸ©é˜µè¿›è¡Œå¯¹é½ï¼Œåˆ†åˆ«è¡¨ç¤ºè¾“å…¥å›¾åƒä¸­çš„æŸä¸ªå…ƒç´ åæ ‡ã€‚<strong>é€šè¿‡è¿™ä¸¤ä¸ªåç§»é‡ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šå·ç§¯æ ¸åœ¨è¾“å…¥çŸ©é˜µä¸­çš„ä½ç½®ï¼Œå¹¶å°†å…¶ä¸å¯¹åº”ä½ç½®çš„åƒç´ å€¼ç›¸ä¹˜ï¼Œç„¶åæ±‚å’Œå¾—åˆ°è¾“å‡ºçŸ©é˜µçš„æ¯ä¸ªå…ƒç´  $Y[i,j]$ã€‚</strong></p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img102.jpg" alt=""></p>
<p><em>å…¶ä¸­<code>i</code>ã€<code>j</code>å…¶å®ä»£è¡¨çš„æ˜¯å·ç§¯æ ¸çš„ä½ç½®ï¼ˆå·¦ä¸Šè§’ï¼‰ï¼Œè€Œ<code>m</code>å’Œ<code>n</code>ä»£è¡¨çš„æ˜¯å·ç§¯æ ¸å†…çš„åç§»é‡ã€‚</em></p>
<p>**å¦‚æœè¾“å…¥æ”¹ä¸ºå¤šé€šé“ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ªå•é€šé“ï¼Œéœ€è¦å¦‚ä½•å¤„ç†ï¼Ÿ**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img103.jpg" alt=""></p>
<p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåªæœ‰ä¸€ä¸ªå·ç§¯æ ¸ï¼Œç”»æˆä¸¤ä¸ªæ˜¯å› ä¸ºé‡å¤è®¡ç®—äº†(è¿™é‡Œå‡è®¾å¼ é‡æœ‰ä¸¤ä¸ªé€šé“)ï¼</em></p>
<p><strong>å¦‚æœè¾“å‡ºæ”¹æˆäº†å¤šé€šé“ï¼Œé‚£ä¹ˆå·ç§¯æ ¸çš„ä¸ªæ•°å°±è¦å¢åŠ </strong>ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img104.jpg" alt=""></p>
<p>ä»ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼ŒäºŒç»´å·ç§¯çš„è®¡ç®—å¦‚ä¸‹ï¼š
$$
output, size = floor(\frac{input,size+ 2\times padding-kernel ,size}{stride }+1)
$$
<em>å¯ä»¥å‘ç°å’Œæ± åŒ–ç®—å­çš„è¾“å…¥è¾“å‡ºå¤§å°è®¡ç®—æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼</em></p>
<blockquote>
<p>im2colä¼˜åŒ–å·ç§¯è®¡ç®—</p>
</blockquote>
<p>å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†å·ç§¯è®¡ç®—è½¬åŒ–ä¸ºçŸ©é˜µè®¡ç®—ï¼Œåˆ©ç”¨ç°æœ‰çš„çŸ©é˜µåŠ é€Ÿæ–¹æ³•å®ç°å·ç§¯è¿ç®—çš„åŠ é€Ÿã€‚</p>
<p>ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­å°±å¯ä»¥æ˜ç™½ï¼Œå…¶å®å°±æ˜¯å°†ä¸€ä¸ªå·ç§¯æ ¸å¤§å°çš„å¼ é‡è¿›è¡Œå±•å¼€æˆä¸ºçŸ©é˜µä¸­çš„ä¸€è¡Œï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img105.jpg" alt=""></p>
<p>å¦‚æœå¯¹äºå¤šé€šé“çš„è¾“å…¥ï¼Œéœ€è¦å¦‚ä½•è¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿ</p>
<p>å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯å°†æ¯ä¸ªé€šé“çš„çŸ©é˜µè¿›è¡Œå¹³é“ºï¼Œè€Œå·ç§¯æ ¸åˆ™è¿›è¡Œåˆ—é“ºå°±okäº†ï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img106.jpg" alt=""></p>
<p>è¾“å‡ºå¼ é‡ä¹Ÿå˜ä¸ºå¤šé€šé“ï¼Œåˆ™å¢åŠ å·ç§¯æ ¸çš„ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯å¢åŠ å·ç§¯æ ¸å¼ å¼€çš„å¼ é‡çš„åˆ—æ•°ï¼š</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img107.jpg" alt=""></p>
<blockquote>
<p>åˆ†ç»„å·ç§¯çš„å®ç°</p>
</blockquote>
<p>å‡è®¾<code>group</code> çš„æ•°é‡ä¸º2ï¼Œå¦‚æœè¾“å…¥ç‰¹å¾å›¾çš„é€šé“æ•°ä¸º4ï¼Œå…±æœ‰4ä¸ªå·ç§¯æ ¸ã€‚</p>
<p>é‚£ä¹ˆè¾“å…¥ç‰¹å¾å›¾çš„4ä¸ªé€šé“è¢«åˆ†ä¸º2ç»„ï¼Œæ¯ç»„çš„è¾“å…¥é€šé“æ•°ä¸º2ï¼Œå·ç§¯æ ¸ä¹Ÿè¢«åˆ†ä¸ºä¸¤ç»„ï¼Œæ¯ç»„çš„å·ç§¯æ ¸ä¸ªæ•°ä¹Ÿæ˜¯2ï¼</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img108.jpg" alt=""></p>
<p><strong>ä¸€ä¸ªçº¢æ¡†ä»£è¡¨ä¸€ä¸ªå·ç§¯æ ¸ï¼Œç”»ä¸¤æ¬¡æ˜¯å› ä¸ºè¾“å…¥å¼ é‡æ¯ç»„çš„é€šé“æ•°ä¸º2ï¼Œåˆ™éœ€è¦é‡å¤è®¡ç®—ä¸¤æ¬¡ï¼ä¸Šè¿°å›¾ä¸­æœ‰4ä¸ªå·ç§¯æ ¸ï¼Œåˆ†åˆ«å¤„ç†channelä¸º0ï¼Œ1ï¼Œ2ï¼Œ3çš„è¾“å…¥é€šé“æ•°ï¼å¯ä»¥çœ‹åˆ°åˆ†ç»„å·ç§¯ç›¸å¯¹æ™®é€šå·ç§¯å°‘äº†2å€ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥å¼ é‡æ¯æ¬¡éœ€è¦å¤„ç†çš„é€šé“æ•°å‡å°‘äº†ä¸€åŠï¼Œå·ç§¯æ ¸çš„æ€»æ•°æ˜¯ä¸å˜çš„ï¼</strong></p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img109.jpg" alt=""></p>
<p>å±•å¼€ä¹‹åå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåªæ˜¯è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼ŒæŠŠå·ç§¯æ ¸çš„å±•å¼€æ”¾åœ¨äº†å‰é¢ä¸”å˜æˆè¡Œå±•å¼€ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>å‡è®¾å•è¾“å…¥å•è¾“å‡ºé€šé“çš„å·ç§¯è®¡ç®—é‡ä¸º<code>X</code>ï¼Œé‚£ä¹ˆåŸå…ˆ4è¾“å‡º4è¾“å‡ºçš„çš„è®¡ç®—é‡ä¸º<code>16X</code>ï¼Œåˆ†ç»„å·ç§¯å˜ä¸ºäº†$2\times 2 + 2\times 2=8$,<code>8X</code>çš„è®¡ç®—é‡ã€‚</p>
<p><strong>å› ä¸ºæˆ‘ä»¬çš„armadilloè‡ªèº«æ˜¯åˆ—ä¸»åºçš„ï¼Œæ‰€ä»¥im2Colè‡ªç„¶å°±å˜ä¸ºäº†im2Rowï¼</strong></p>
<blockquote>
<p>å‚æ•°æ±‡æ€»</p>
</blockquote>
<p>é‚£ä¹ˆå®ç°ä¸Šè¿°åŠŸèƒ½çš„å·ç§¯ï¼Œéœ€è¦çš„å‚æ•°æœ‰ï¼š</p>
<ol>
<li>
<p><code>input</code>: è¾“å…¥ç‰¹å¾å›¾åƒ</p>
</li>
<li>
<p><code>kernel_*</code>: å·ç§¯æ ¸çš„å¤§å°</p>
</li>
<li>
<p><code>input_*</code>: è¾“å…¥ç‰¹å¾å›¾åƒçš„å°ºå¯¸å¤§å°ï¼Œä¹Ÿå°±æ˜¯<code>input</code>çš„å°ºå¯¸å¤§å°</p>
</li>
<li>
<p><code>input_c_group</code>: æ¯ä¸ª<code>group</code>å¤„ç†çš„é€šé“æ•°é‡ï¼Œ<strong>å¦‚å‰æ–‡æ‰€å™ï¼Œæˆ‘ä»¬ä¼šå°†è¾“å…¥ç‰¹å¾å›¾çš„é€šé“æŒ‰ç…§ç»„æ•°è¿›è¡Œåˆ‡åˆ†</strong></p>
</li>
<li>
<p><code>group</code>: å½“å‰è¿›è¡Œ<code>Im2Col</code>çš„ç»„æ•°(group)</p>
</li>
<li>
<p><code>row_len</code>: $kernel_w\times kernel_h$, ä¹Ÿå°±æ˜¯<strong>ä¸€ä¸ªå·ç§¯çª—å£å±•å¼€åçš„è¡Œé•¿åº¦ï¼ˆä¸‹å›¾ä¸­çš„9ï¼‰ã€‚</strong></p>
</li>
<li>
<p><code>col_len</code>: å·ç§¯æ»‘åŠ¨çš„æ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯**å·ç§¯çª—å£æ»‘åŠ¨çš„æ¬¡æ•°ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªé€šé“è¾“å…¥å±•å¼€åçš„åˆ—é•¿åº¦*ï¼ˆä¸‹å›¾ä¸­çš„4ï¼‰ã€‚*</p>
</li>
</ol>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img110.jpg" alt=""></p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  arma::fmat input_matrix(input_c_group * row_len, col_len);
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> input_padded_h = input_h + <span style="color:#b452cd">2</span> * padding_h_;
</span></span><span style="display:flex;"><span>  <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> input_padded_w = input_w + <span style="color:#b452cd">2</span> * padding_w_;
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>input_matrix</code>ç”¨äºå­˜å‚¨å¯¹è¾“å…¥å›¾åƒå±•å¼€åçš„çŸ©é˜µ, <code>input_padded_*</code>è¡¨ç¤ºè¾“å…¥å¡«å……åçš„å°ºå¯¸å¤§å°ã€‚ä¸ºä»€ä¹ˆè¿™é‡Œçš„<code>input_matrix</code>è¡Œæ•°ç­‰äº$input_c_group\times row_len$å‘¢ï¼Œæˆ‘ä»¬ä»ä¸‹æ–¹çš„å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºå¤šè¾“å…¥é€šé“çš„æƒ…å†µï¼Œå®ƒçš„åˆ—æ•°ç­‰äºè¾“å…¥é€šé“æ•°å’Œå·ç§¯æ ¸ç›¸ä¹˜ï¼ˆ<strong>å› ä¸ºæˆ‘ä»¬æ˜¯åˆ—ä¸»åºçš„ï¼Œå®é™…æ‰§è¡Œ<code>Im2Row</code>ï¼Œæ‰€ä»¥è¡Œåˆ—ç›¸å</strong>ï¼‰ï¼Œå®ƒçš„è¡Œæ•°ç­‰äº<code>col_len</code>ï¼ˆè¡Œåˆ—ç›¸åï¼‰ï¼Œä¹Ÿå°±æ˜¯å·ç§¯çª—å£è¿›è¡Œæ»‘åŠ¨çš„æ¬¡æ•°ã€‚</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img111.jpg" alt=""></p>
<p>æ¥ä¸‹å»å°±å°†è¾“å…¥çš„å·ç§¯åŒºåŸŸå±•å¼€ä¸ºçŸ©é˜µï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> ic = <span style="color:#b452cd">0</span>; ic &lt; input_c_group; ++ic) {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// è·å–å½“å‰é€šé“çš„è¾“å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>   <span style="color:#00688b;font-weight:bold">float</span>* input_channel_ptr =
</span></span><span style="display:flex;"><span>       input-&gt;matrix_raw_ptr(ic + group * input_c_group);
</span></span><span style="display:flex;"><span>   <span style="color:#00688b;font-weight:bold">uint32_t</span> current_col = <span style="color:#b452cd">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// å½“å‰é€šé“çš„å±•å¼€åº”è¯¥æ”¾åœ¨å“ªä¸ªè¡Œä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#228b22">// å› ä¸ºå¤šä¸ªé€šé“åŒä¸€ä½ç½®æ˜¯æ¨ªå‘æ‘†æ”¾çš„
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>   <span style="color:#00688b;font-weight:bold">uint32_t</span> channel_row = ic * row_len;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// è¡¨ç¤ºåœ¨ä¸€ä¸ªè¾“å…¥é€šé“ä¸Šè¿›è¡Œæ»‘åŠ¨
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>   <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> w = <span style="color:#b452cd">0</span>; w &lt; input_padded_w - kernel_w + <span style="color:#b452cd">1</span>; w += stride_w_) {
</span></span><span style="display:flex;"><span>     <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> r = <span style="color:#b452cd">0</span>; r &lt; input_padded_h - kernel_h + <span style="color:#b452cd">1</span>; r += stride_h_) {
</span></span><span style="display:flex;"><span>       <span style="color:#00688b;font-weight:bold">float</span>* input_matrix_ptr =
</span></span><span style="display:flex;"><span>           input_matrix.colptr(current_col) + channel_row;
</span></span><span style="display:flex;"><span>       <span style="color:#a61717;background-color:#e3d2d2">Â·Â·Â·</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åé¢å°±æ˜¯å®ç°çŸ©é˜µå†…éƒ¨çš„å¤„ç†äº†ï¼Œä¸å†æè¿°ã€‚</p>
<blockquote>
<p>å·ç§¯ç®—å­å®ç°çš„æµç¨‹</p>
</blockquote>
<ul>
<li>
<p>å¯¹æ‰¹æ¬¡æ•°æ®é€ä¸ªå¤„ç†ï¼ˆæŒ‰Batch Sizeçš„å¤§å°åšå¾ªç¯ï¼‰</p>
</li>
<li>
<p>è®¡ç®—è¾“å…¥è¾“å‡ºå¼ é‡çš„å°ºå¯¸ã€ä»¥åŠå·ç§¯çª—å£æ‰§è¡Œçš„æ¬¡æ•°ï¼ˆ<code>col_len</code>ï¼‰</p>
</li>
<li>
<p>å¯¹groupè¿›è¡Œè¿­ä»£éå†ï¼Œ<code>g</code>è¡¨ç¤ºå½“å‰ç»„å·ï¼Œ<strong><code>input_c_group</code>è¡¨ç¤ºæ¯ç»„å·ç§¯éœ€è¦å¤„ç†çš„é€šé“æ•°ï¼Œ<code>Im2Col</code>å‡½æ•°ä¸­ä¼šå¯¹å±äºè¯¥ç»„çš„è¾“å…¥é€šé“è¿›è¡Œå±•å¼€ã€‚</strong></p>
</li>
<li>
<p>éšåè¿›è¡ŒçŸ©é˜µç›¸ä¹˜çš„æ“ä½œ</p>
</li>
</ul>
<blockquote>
<p>KuiperInferä¸­çš„GEMMå®ç°ï¼ˆçŸ©é˜µä¹˜æ³•æ“ä½œï¼‰</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#00688b;font-weight:bold">void</span> ConvolutionLayer::ConvGemmBias(
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> arma::fmat&amp; input_matrix, sftensor output_tensor, <span style="color:#00688b;font-weight:bold">uint32_t</span> group,
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">uint32_t</span> kernel_index, <span style="color:#00688b;font-weight:bold">uint32_t</span> kernel_count_group,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> arma::frowvec&amp; kernel, <span style="color:#00688b;font-weight:bold">uint32_t</span> output_w, <span style="color:#00688b;font-weight:bold">uint32_t</span> output_h) <span style="color:#8b008b;font-weight:bold">const</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a61717;background-color:#e3d2d2">Â·Â·Â·</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¼ å…¥åˆ°è¿™ä¸ªå‡½æ•°ä¸­çš„å‚æ•°ï¼Œä¾æ¬¡æ˜¯ï¼š</p>
<ol>
<li><code>input_matrix</code>: å±•å¼€åçš„è¾“å…¥ç‰¹å¾</li>
<li><code>output_tensor</code>: ç”¨äºå­˜æ”¾è¾“å‡ºçš„çŸ©é˜µ</li>
<li><code>group</code>: å½“å‰è¿›è¡Œ<code>Im2Col</code>çš„ç»„(group)æ•°</li>
<li><code>kernel*</code> :ç”¨äºå®šä½å½“å‰å±•å¼€åçš„å·ç§¯æ ¸</li>
<li><code>output_*</code>: è¾“å‡ºçŸ©é˜µçš„å°ºåº¦å¤§å°</li>
</ol>
<p><strong>è¿™é‡Œåªéœ€è¦æ³¨æ„æ˜¯å¦æœ‰biaséœ€è¦åˆ†æƒ…å†µè®¨è®ºå³å¯</strong></p>
<blockquote>
<p>å·ç§¯ç®—å­çš„å®ä¾‹åŒ–</p>
</blockquote>
<ul>
<li>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†Runtime_operatorä¸­çš„ä¿¡æ¯(<code>params</code>)æ‹¿å‡ºæ¥</li>
<li>åŠ è½½å·ç§¯ç®—å­ä¸­çš„æƒé‡ï¼ˆ<code>Attributes</code>ï¼‰</li>
<li>ç„¶åèµ‹å€¼ç»™<code>Conv Layer</code>è¿›è¡Œåˆå§‹åŒ–åï¼Œæ³¨å†Œåˆ°ç®—å­å·¥å‚</li>
</ul>
<p><strong>å› ä¸ºå¯¹äºä¸€ä¸ªå·ç§¯ç®—å­æ¥è¯´ï¼Œå®ƒçš„è¾“å…¥æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿è¡Œæ—¶å†è°ƒç”¨<code>Im2Col</code>è¿›è¡Œå±•å¼€ï¼Œè€Œä¸€ä¸ªå·ç§¯ç®—å­ä¸­çš„æƒé‡æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œå±•å¼€ã€‚</strong></p>
<blockquote>
<p>è¯¾ç¨‹ä½œä¸šï¼šè°ƒè¯•ä»£ç  + å†™groupä¸ä¸º1çš„å•å…ƒæµ‹è¯•å¹¶è¿›è¡Œè°ƒè¯•</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#228b22">/// groupä¸º2çš„æƒ…å†µ ï¼ˆé€šé“æ•°å’Œå·ç§¯æ ¸ä¸ªæ•°å¿…é¡»ä¸ºå¶æ•°ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>TEST(test_registry, create_layer_convforward_group) {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> batch_size = <span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>    std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;&gt; inputs(batch_size);
</span></span><span style="display:flex;"><span>    std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;&gt; outputs(batch_size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> in_channel = <span style="color:#b452cd">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> i = <span style="color:#b452cd">0</span>; i &lt; batch_size; ++i) {
</span></span><span style="display:flex;"><span>        sftensor input = std::make_shared&lt;ftensor&gt;(in_channel, <span style="color:#b452cd">4</span>, <span style="color:#b452cd">4</span>);
</span></span><span style="display:flex;"><span>        input-&gt;data().slice(<span style="color:#b452cd">0</span>) = arma::fmat(<span style="color:#cd5555">&#34;1,2,3,4;&#34;</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cd5555">&#34;5,6,7,8;&#34;</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cd5555">&#34;9,10,11,12;&#34;</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cd5555">&#34;13,14,15,16;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        input-&gt;data().slice(<span style="color:#b452cd">1</span>) = arma::fmat(<span style="color:#cd5555">&#34;1,2,3,4;&#34;</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cd5555">&#34;5,6,7,8;&#34;</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cd5555">&#34;9,10,11,12;&#34;</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cd5555">&#34;13,14,15,16;&#34;</span>);
</span></span><span style="display:flex;"><span>        inputs.at(i) = input;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> kernel_h = <span style="color:#b452cd">3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> kernel_w = <span style="color:#b452cd">3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> stride_h = <span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> stride_w = <span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> kernel_count = <span style="color:#b452cd">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">const</span> <span style="color:#00688b;font-weight:bold">uint32_t</span> group = <span style="color:#b452cd">2</span>;  <span style="color:#228b22">// è®¾ç½®åˆ†ç»„æ•°ä¸º2
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>
</span></span><span style="display:flex;"><span>    std::vector&lt;sftensor&gt; weights;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> (<span style="color:#00688b;font-weight:bold">uint32_t</span> i = <span style="color:#b452cd">0</span>; i &lt; kernel_count; ++i) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">/// channelæ•°è®¡ç®—ï¼š in_channel / group  kernelçš„è®¡ç®—æ¬¡æ•°ä¹Ÿè¦éšç€åˆ†ç»„å‡å°‘
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        sftensor kernel = std::make_shared&lt;Tensor&lt;<span style="color:#00688b;font-weight:bold">float</span>&gt;&gt;(in_channel / group, kernel_h, kernel_w);  <span style="color:#228b22">// æ›´æ–°å·ç§¯æ ¸çš„é€šé“æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        kernel-&gt;data().slice(<span style="color:#b452cd">0</span>) = arma::fmat(<span style="color:#cd5555">&#34;1,2,3;&#34;</span>
</span></span><span style="display:flex;"><span>                                             <span style="color:#cd5555">&#34;3,2,1;&#34;</span>
</span></span><span style="display:flex;"><span>                                             <span style="color:#cd5555">&#34;1,2,3;&#34;</span>);
</span></span><span style="display:flex;"><span>        weights.push_back(kernel);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ConvolutionLayer <span style="color:#008b45">conv_layer</span>(kernel_count, in_channel, kernel_h, kernel_w, <span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>                                <span style="color:#b452cd">0</span>, stride_h, stride_w, group, <span style="color:#658b00">false</span>);  <span style="color:#228b22">// è®¾ç½®åˆ†ç»„æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    conv_layer.set_weights(weights);
</span></span><span style="display:flex;"><span>    conv_layer.Forward(inputs, outputs);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    outputs.at(<span style="color:#b452cd">0</span>)-&gt;Show();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä¸ƒè¡¨è¾¾å¼å±‚çš„å®ç°">ä¸ƒï¼šè¡¨è¾¾å¼å±‚çš„å®ç°</h3>
<p>è¡¨è¾¾å¼å±‚çš„å®ç°ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†<code>æŠ˜å è®¡ç®—è¿‡ç¨‹</code>å’Œ<code>æ¶ˆé™¤ä¸­é—´å˜é‡</code>ã€‚</p>
<p><code>PNNX</code>ä¸­çš„è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªäºŒå…ƒè®¡ç®—è¿‡ç¨‹ï¼Œç±»ä¼¼ï¼š</p>
<pre tabindex="0"><code>output_mid = input1 + input2;
output = output_mid * input3;
</code></pre><p>åœ¨<code>PNNX</code>çš„è¡¨è¾¾å¼å±‚ï¼ˆExpression Layerï¼‰ä¸­ï¼Œæä¾›äº†ä¸€ç§è®¡ç®—è¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼èƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸ŠæŠ˜å è®¡ç®—è¿‡ç¨‹å¹¶æ¶ˆé™¤ä¸­é—´å˜é‡ã€‚ä¾‹å¦‚ï¼Œåœ¨æ®‹å·®ç»“æ„ä¸­çš„addæ“ä½œåœ¨<code>PNNX</code>ä¸­å°±æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼å±‚ã€‚</p>
<p>ä¸‹é¢æ˜¯<code>PNNX</code>ä¸­å¯¹ä¸Šè¿°è¿‡ç¨‹çš„è®¡ç®—è¡¨è¾¾å¼è¡¨ç¤ºï¼Œå…¶ä¸­çš„<code>@0</code>å’Œ<code>@1</code>ä»£è¡¨ä¹‹å‰æåˆ°çš„è®¡ç®—æ•°<code>RuntimeOperand</code>ï¼Œç”¨äºè¡¨ç¤ºè®¡ç®—è¡¨è¾¾å¼ä¸­çš„è¾“å…¥èŠ‚ç‚¹ã€‚</p>
<pre tabindex="0"><code>mul(@2, add(@0, @1));
</code></pre><p>å¦‚æœåœ¨è¡¨è¾¾å¼æä¸ºå¤æ‚çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ä¸€ä¸ªå¼ºå¤§å¯é çš„è¡¨è¾¾å¼è§£æå’Œè¯­æ³•æ ‘æ„å»ºåŠŸèƒ½ã€‚</p>
<blockquote>
<p>è¯æ³•å®šä¹‰</p>
</blockquote>
<p>è¯æ³•è§£æçš„ç›®çš„æ˜¯å°†**add(@0, mul(@1, @2))**æ‹†åˆ†ä¸ºå¤šä¸ªTokenï¼Œæ‹†åˆ†åçš„Tokenä¾æ¬¡ä¸ºï¼š</p>
<ol>
<li>Identifier: <strong>add</strong></li>
<li>Left bracket: <strong>(</strong></li>
<li>Input number: <strong>@0</strong></li>
<li>Comma: <strong>,</strong></li>
<li>Identifier: <strong>mul</strong></li>
<li>Left bracket: <strong>(</strong></li>
<li>Input number: <strong>@1</strong></li>
<li>Comma: <strong>,</strong></li>
<li>Input number:  <strong>@2</strong></li>
<li>Right bracket: <strong>)</strong></li>
</ol>
<p><code>Token</code>çš„ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">enum</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">TokenType</span> {
</span></span><span style="display:flex;"><span>  TokenUnknown = -<span style="color:#b452cd">9</span>,
</span></span><span style="display:flex;"><span>  TokenInputNumber = -<span style="color:#b452cd">8</span>,
</span></span><span style="display:flex;"><span>  TokenComma = -<span style="color:#b452cd">7</span>,
</span></span><span style="display:flex;"><span>  TokenAdd = -<span style="color:#b452cd">6</span>,
</span></span><span style="display:flex;"><span>  TokenMul = -<span style="color:#b452cd">5</span>,
</span></span><span style="display:flex;"><span>  TokenLeftBracket = -<span style="color:#b452cd">4</span>,
</span></span><span style="display:flex;"><span>  TokenRightBracket = -<span style="color:#b452cd">3</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tokençš„å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å˜é‡ï¼š</p>
<ol>
<li>Tokenç±»å‹ï¼ŒåŒ…æ‹¬addï¼ˆåŠ æ³•ï¼‰ï¼Œmulï¼ˆä¹˜æ³•ï¼‰ï¼Œbracketï¼ˆå·¦å³æ‹¬å·ï¼‰ç­‰ï¼›</li>
<li>Tokenåœ¨åŸå¥å­ä¸­çš„å¼€å§‹å’Œç»“æŸä½ç½®ï¼Œå³<code>start_pos</code>å’Œ<code>end_pos</code>ï¼›</li>
</ol>
<p>å¯¹äºè¡¨è¾¾å¼<strong>add(@0, mul(@1, @2))</strong>ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒåˆ‡åˆ†ä¸ºå¤šä¸ªTokenï¼Œå…¶ä¸­Token(add)çš„<code>start_pos</code>ä¸º0ï¼Œ<code>end_pos</code>ä¸º3ã€‚Token(left bracket)çš„<code>start_pos</code>ä¸º3ï¼Œ<code>end_pos</code>ä¸º4ã€‚Token(@0)çš„<code>start_pos</code>ä¸º4ï¼Œ<code>end_pos</code>ä¸º5ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#228b22">// è¯è¯­Token
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">struct</span> <span style="color:#008b45;font-weight:bold">Token</span> {
</span></span><span style="display:flex;"><span>    TokenType token_type = TokenType::TokenUnknown;
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">int32_t</span> start_pos = <span style="color:#b452cd">0</span>; <span style="color:#228b22">// è¯è¯­å¼€å§‹çš„ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#00688b;font-weight:bold">int32_t</span> end_pos = <span style="color:#b452cd">0</span>;   <span style="color:#228b22">// è¯è¯­ç»“æŸçš„ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    Token(TokenType token_type, <span style="color:#00688b;font-weight:bold">int32_t</span> start_pos, <span style="color:#00688b;font-weight:bold">int32_t</span> end_pos)
</span></span><span style="display:flex;"><span>        : token_type(token_type), start_pos(start_pos), end_pos(end_pos) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€åï¼Œåœ¨è¯æ³•è§£æç»“æŸåï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŒ‰ç…§å®ƒä»¬<code>å‡ºç°çš„é¡ºåº</code>å’Œ<code>å±‚çº§å…³ç³»</code>ç»„æˆä¸€é¢—è¯­æ³•æ ‘ã€‚</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#228b22">// è¯­æ³•æ ‘çš„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">struct</span> <span style="color:#008b45;font-weight:bold">TokenNode</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00688b;font-weight:bold">int32_t</span> num_index = -<span style="color:#b452cd">1</span>;
</span></span><span style="display:flex;"><span>    std::shared_ptr&lt;TokenNode&gt; left = <span style="color:#8b008b;font-weight:bold">nullptr</span>;   <span style="color:#228b22">// è¯­æ³•æ ‘çš„å·¦èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    std::shared_ptr&lt;TokenNode&gt; right = <span style="color:#8b008b;font-weight:bold">nullptr</span>;  <span style="color:#228b22">// è¯­æ³•æ ‘çš„å³èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    TokenNode(<span style="color:#00688b;font-weight:bold">int32_t</span> num_index, std::shared_ptr&lt;TokenNode&gt; left,
</span></span><span style="display:flex;"><span>              std::shared_ptr&lt;TokenNode&gt; right);
</span></span><span style="display:flex;"><span>    TokenNode() = <span style="color:#8b008b;font-weight:bold">default</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è¯æ³•è§£æ</p>
</blockquote>
<p>æ­¤éƒ¨åˆ†å¯ä»¥çœ‹ä»£ç ï¼Œåœ¨<code>course7</code>ä¸­çš„<code>source/parser/parse_expression.cpp</code>ä¸­ã€‚</p>
<blockquote>
<p>è¯­æ³•è§£æ</p>
</blockquote>
<p>åœ¨è¿›è¡Œè¯­æ³•åˆ†ææ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¯æ³•åˆ†æå¾—åˆ°çš„ <code>token</code> æ•°ç»„æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ã€‚æŠ½è±¡è¯­æ³•æ ‘æ˜¯ä¸€ä¸ªç”±äºŒå‰æ ‘ç»„æˆçš„ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨äº†æ“ä½œç¬¦å·æˆ–å€¼ï¼Œå¹¶é€šè¿‡å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹ä¸å…¶ä»–èŠ‚ç‚¹è¿æ¥ã€‚</p>
<p>å¯¹äºè¡¨è¾¾å¼ &ldquo;add (@0, @1)&quot;ï¼Œå½“ <code>num_index</code> ç­‰äº 1 æ—¶ï¼Œè¡¨ç¤ºè®¡ç®—æ•°ä¸º @0ï¼›å½“ <code>num_index</code> ç­‰äº 2 æ—¶ï¼Œè¡¨ç¤ºè®¡ç®—æ•°ä¸º @1ã€‚è‹¥ <code>num_index</code> ä¸ºè´Ÿæ•°ï¼Œåˆ™è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹ï¼Œå¦‚ &ldquo;mul&rdquo; æˆ– &ldquo;add&rdquo; ç­‰ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p>
<pre tabindex="0"><code>     add
    /   \
  @0     @1
</code></pre><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæ ¹èŠ‚ç‚¹æ˜¯ &ldquo;add&rdquo;ï¼Œå·¦å­èŠ‚ç‚¹æ˜¯ &ldquo;@0&rdquo;ï¼Œå³å­èŠ‚ç‚¹æ˜¯ &ldquo;@1&rdquo;ã€‚è¿™ä¸ªæŠ½è±¡è¯­æ³•æ ‘è¡¨ç¤ºäº†ä¸€ä¸ªå°† &ldquo;@0&rdquo; å’Œ &ldquo;@1&rdquo; è¿›è¡Œç›¸åŠ çš„è¡¨è¾¾å¼ã€‚</p>
<p>é€šè¿‡å°†è¯æ³•åˆ†æå¾—åˆ°çš„ <code>token</code> æ•°ç»„è§£æå¹¶æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥å¯¹è¡¨è¾¾å¼è¿›è¡Œè¯­ä¹‰åˆ†æå’Œæ±‚å€¼ç­‰æ“ä½œã€‚</p>
<ul>
<li>current_tokenä»£è¡¨ç¬¬ä¸€ä¸ªtokenï¼Œå¿…é¡»è¦ä»¥ä¸‹é¢ä¸‰ä¸ªç±»å‹å¼€å¤´ï¼ˆInputNumberã€Addã€Mulï¼‰&quot;ï¼Œ&quot;ã€&rdquo;(&quot; &ldquo;)&ldquo;ä¸èƒ½ä¸ºå¼€å¤´</li>
<li>current_token ä¸º InputNumberçš„æƒ…å†µï¼Œç›´æ¥è¿”å›ä¸€ä¸ªå¶å­èŠ‚ç‚¹</li>
<li>current_token ä¸º mulæˆ–è€…addçš„æƒ…å†µ éœ€è¦è¿›è¡Œä¸‹ä¸€å±‚é€’å½’æ„å»ºå¯¹åº”çš„å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹ï¼ˆå…·ä½“è§„åˆ™çœ‹ä»£ç ï¼‰</li>
</ul>
<blockquote>
<p>æµç¨‹è§£æ</p>
</blockquote>
<p>æŒ‰ç…§<code>add(@0, @1)</code>çš„æµç¨‹è¿›è¡Œè§£æã€‚</p>
<ol>
<li>è¯æ³•è§£æï¼Œå°†<code>add</code>ã€<code>(</code>ã€<code>@0</code>ã€<code>,</code>ã€<code>@1</code>ã€<code>)</code>æ„å»ºæˆä¸ºä¸€ä¸ªå•è¯ï¼ˆTokenï¼‰æ•°ç»„</li>
<li>è¡¨è¾¾å¼ä¼ å…¥è¯­æ³•è§£ææ¨¡å—ï¼ŒæŒ‰ç…§è¯­æ³•è§£æçš„è§„åˆ™æ„å»º<code>æŠ½è±¡è¯­æ³•æ ‘</code>ã€‚</li>
</ol>
<blockquote>
<p>å¯¹è¯­æ³•æ ‘è¡¨è¾¾å¼çš„è½¬åŒ–ï¼šé€†æ³¢å…°å¼</p>
</blockquote>
<p>ä¾‹å­ï¼š</p>
<p><code>add(@0, @1)</code>ï¼Œé€†æ³¢å…°å¼ä¸ºï¼š<code>@0, @1, add</code></p>
<p>åšæ³•å¾ˆç®€å•ï¼Œå…¶å®å°±æ˜¯å¯¹åŸæœ‰çš„äºŒå‰æ ‘è¿›è¡Œåç»­éå†ï¼Œå†å°†æ‹¬å·æ¶ˆé™¤å³å¯ã€‚<strong>è¿™æ ·çš„è®¡ç®—é¡ºåºæ›´åŠ ç›´è§‚ï¼Œå¹¶ä¸”å†é‡åˆ°è®¡ç®—ï¼ˆaddã€mulï¼‰æ—¶å¯ä»¥ç«‹å³è¿›è¡Œè¿ç®—ï¼Œå› ä¸ºéœ€è¦çš„è¾“å…¥æ•°å·²ç»å‡†å¤‡å¥½äº†ã€‚</strong></p>
<blockquote>
<p>ä¸¤ä¸ªè¾“å…¥æ“ä½œæ•° &amp;&amp; ä¸‰ä¸ªè¾“å…¥æ“ä½œæ•°</p>
</blockquote>
<ul>
<li>ä¸¤ä¸ªè¾“å…¥æ“ä½œæ•°ï¼š</li>
</ul>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img112.jpg" alt=""></p>
<ul>
<li>ä¸‰ä¸ªè¾“å…¥æ“ä½œæ•°ï¼š</li>
</ul>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97/img113.jpg" alt=""></p>
<p>è¡¨è¾¾å¼å±‚çš„è®¡ç®—ï¼Œå…¶å®å°±æ˜¯ç”¨äº†ä¸€ä¸ªç»å…¸çš„æ ˆç»“æ„çš„è®¡ç®—ï¼Œé‡åˆ°è¾“å…¥æ•°å°±å‹å…¥æ ˆä¸­ï¼Œé‡åˆ°æ“ä½œæ•°å°±å°†å‰é¢çš„è¾“å…¥æ•°å‡ºæ ˆè¿›è¡Œè®¡ç®—ï¼Œå°†å¾—åˆ°çš„ç»“æœå†æ¬¡å‹å…¥æ ˆä¸­ã€‚å¾ªç¯ä¸‹å»ï¼Œç›´åˆ°ç»“æŸã€‚</p>
<blockquote>
<p>è¯¾ç¨‹ä½œä¸šï¼š</p>
<ol>
<li>
<p>è¯æ³•è§£æå’Œè¯­æ³•è§£ææ”¯æŒsin(ä¸‰è§’å‡½æ•°)æ“ä½œ</p>
</li>
<li>
<p>å¯¹äºsin(@1)ï¼Œå•è¾“å…¥å¦‚ä½•é€‚åº”ï¼Œä¿è¯è¾“å‡ºç»“æœçš„æ­£ç¡®æ€§</p>
</li>
</ol>
</blockquote>
<p>å…·ä½“è§<code>source/parser/parse_expression.cpp</code>ï¼Œ<code>source/layer/details/expression.cpp</code>ã€<code>include/data/tensor_util.hpp</code>å’Œ<code>source/tensor_utils.cpp</code>çš„ä¿®æ”¹ï¼Œå·²ç»é€šè¿‡homeworkçš„æµ‹è¯•ä»¥åŠåŸæœ‰çš„æµ‹è¯•ï¼ˆä¿è¯åŸæœ‰åŠŸèƒ½çš„æ­£ç¡®æ€§ï¼‰ã€‚</p>
<p><strong>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯åœ¨è¿›è¡Œforwardé€»è¾‘ä¿®æ”¹çš„æ—¶å€™ï¼Œéœ€è¦å•ç‹¬è€ƒè™‘sin(@1)çš„é€»è¾‘ï¼Œä¸è¦å’Œaddï¼Œmulä¸€èµ·è€ƒè™‘ã€‚å¦‚æœé‡åˆ°sinå°±å•ç‹¬åšä¸€æ¬¡å‡ºæ ˆï¼Œsinä¹‹åå†å…¥æ ˆï¼Œè·³è¿‡å‰©ä¸‹çš„éƒ¨åˆ†ï¼Œé‡æ–°è¿›è¡Œå¤„ç†é€»è¾‘ï¼</strong></p>

                    
                    <HR width="100%" id="EOF">
		            <p style="color:#777;">æœ€åä¿®æ”¹äº 2023-09-01</p>
                    
                    
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" style="border-width:0" src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210508215939.png" /></a><br />æœ¬ä½œå“é‡‡ç”¨<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯ã€‚
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://caixiongjiang.github.io/blog/2023/%E5%8D%8E%E4%B8%BA%E6%98%87%E8%85%BE%E9%83%A8%E7%BD%B2/%E6%98%87%E8%85%BE%E8%AE%A1%E7%AE%97%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">
			ä¸‹å›<br>æ˜‡è…¾è®¡ç®—å¼€å‘ç¯å¢ƒé…ç½®
                </a>
                
                
                
                <a class="older-posts" href="https://caixiongjiang.github.io/blog/2023/%E5%AE%9E%E4%B9%A0/m1-mac-%E5%AE%89%E8%A3%85labelimg/">
			ä¸Šå›<br>M1 Macå®‰è£…LabelImgåŠä½¿ç”¨
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                








<div id="tcomment"></div>



            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
é­”æ”¹è‡ª <a href="https://github.com/riba2534/hugo-blog">Riba2534</a> by <a href="https://caixiongjiang.github.io">Jarson Cai</a>
<br>

&copy;
	
	2023 ğŸŒ€Jarson Cai&#39;s Blog
	</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            },
            debounce(func, wait, options) {
                let lastArgs,
                    lastThis,
                    maxWait,
                    result,
                    timerId,
                    lastCallTime

                let lastInvokeTime = 0
                let leading = false
                let maxing = false
                let trailing = true

                
                const useRAF = (!wait && wait !== 0 && typeof root.requestAnimationFrame === 'function')

                if (typeof func !== 'function') {
                    throw new TypeError('Expected a function')
                }
                function isObject(value) {
                    const type = typeof value
                    return value != null && (type === 'object' || type === 'function')
                }

                wait = +wait || 0
                if (isObject(options)) {
                    leading = !!options.leading
                    maxing = 'maxWait' in options
                    maxWait = maxing ? Math.max(+options.maxWait || 0, wait) : maxWait
                    trailing = 'trailing' in options ? !!options.trailing : trailing
                }

                function invokeFunc(time) {
                    const args = lastArgs
                    const thisArg = lastThis

                    lastArgs = lastThis = undefined
                    lastInvokeTime = time
                    result = func.apply(thisArg, args)
                    return result
                }

                function startTimer(pendingFunc, wait) {
                    if (useRAF) {
                    root.cancelAnimationFrame(timerId)
                    return root.requestAnimationFrame(pendingFunc)
                    }
                    return setTimeout(pendingFunc, wait)
                }

                function cancelTimer(id) {
                    if (useRAF) {
                    return root.cancelAnimationFrame(id)
                    }
                    clearTimeout(id)
                }

                function leadingEdge(time) {
                    
                    lastInvokeTime = time
                    
                    timerId = startTimer(timerExpired, wait)
                    
                    return leading ? invokeFunc(time) : result
                }

                function remainingWait(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime
                    const timeWaiting = wait - timeSinceLastCall

                    return maxing
                    ? Math.min(timeWaiting, maxWait - timeSinceLastInvoke)
                    : timeWaiting
                }

                function shouldInvoke(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime

                    
                    
                    
                    return (lastCallTime === undefined || (timeSinceLastCall >= wait) ||
                    (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait))
                }

                function timerExpired() {
                    const time = Date.now()
                    if (shouldInvoke(time)) {
                    return trailingEdge(time)
                    }
                    
                    timerId = startTimer(timerExpired, remainingWait(time))
                }

                function trailingEdge(time) {
                    timerId = undefined

                    
                    
                    if (trailing && lastArgs) {
                    return invokeFunc(time)
                    }
                    lastArgs = lastThis = undefined
                    return result
                }

                function cancel() {
                    if (timerId !== undefined) {
                    cancelTimer(timerId)
                    }
                    lastInvokeTime = 0
                    lastArgs = lastCallTime = lastThis = timerId = undefined
                }

                function flush() {
                    return timerId === undefined ? result : trailingEdge(Date.now())
                }

                function pending() {
                    return timerId !== undefined
                }

                function debounced(...args) {
                    const time = Date.now()
                    const isInvoking = shouldInvoke(time)

                    lastArgs = args
                    lastThis = this
                    lastCallTime = time

                    if (isInvoking) {
                    if (timerId === undefined) {
                        return leadingEdge(lastCallTime)
                    }
                    if (maxing) {
                        
                        timerId = startTimer(timerExpired, wait)
                        return invokeFunc(lastCallTime)
                    }
                    }
                    if (timerId === undefined) {
                    timerId = startTimer(timerExpired, wait)
                    }
                    return result
                }
                debounced.cancel = cancel
                debounced.flush = flush
                debounced.pending = pending
                return debounced
                }

    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
        
        
            twikoo.init({
                envId: "https://twikoo-rho-olive.vercel.app/",
                el: '#tcomment',
                region:  null ,
            });
        

        document.querySelectorAll("table").forEach(function(elem){
            elem.classList.add("table-striped");
            elem.classList.add("table");
            elem.classList.add("table-responsive");
            elem.classList.add("table-hover");
        })

        
        spy();
        window.addEventListener('scroll', this.debounce(spy, 250, { 'maxWait': 250 }), false);
        
        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});



</script>
    </body>
</html>
