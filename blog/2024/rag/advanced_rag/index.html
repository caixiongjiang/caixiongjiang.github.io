<!DOCTYPE html>
<html><head>
<title>Advanced-RAG: RAG进阶使用技巧</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="RAG在工程中的进阶使用技巧">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="Advanced-RAG: RAG进阶使用技巧" />
<meta property="og:description" content="RAG在工程中的进阶使用技巧" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://caixiongjiang.github.io/blog/2024/rag/advanced_rag/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-08-25T18:18:05+08:00" />
<meta property="article:modified_time" content="2024-08-27T09:19:06+08:00" />












<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>


  




<link rel="icon" href="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/avater.jfif">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>


  
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script type="text/javascript" id="MathJax-script"
async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
MathJax.Hub.Queue(function() {



var all = MathJax.Hub.getAllJax(), i;
for(i = 0; i < all.length; i += 1) {
all[i].SourceElement().parentNode.className += ' has-jax';
}
});
</script>

<style>
code.has-jax {
font: inherit;
font-size: 100%;
background: inherit;
border: inherit;
color: #515151;
}
</style>





  
    <script src="/js/toc.js"></script>
  











<script src="https://cdn.jsdelivr.net/npm/twikoo@1.5.11/dist/twikoo.all.min.js"></script>




</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://caixiongjiang.github.io/">
    
        <div class="nav-title">
            🌀Jarson Cai&#39;s Blog
        </div>
        
        <div class="nav-subtitle">
            头脑是日用品，不是装饰品
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/blog">
                文章📖
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                分类📌
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                标签🏷️
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/series">
                系列📚
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/archive">
                归档📃
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                关于👋
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friends">
                友链🔗
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS📢
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<a href="https://github.com/caixiongjiang">
    GitHub
</a>
<br>

<a href="mailto:nau_cxj@163.com">
    Email
</a>
<br>

<a href="https://leetcode-cn.com/u/cai-xiong-jiang/">
    Leetcode
</a>
<br>

        <hr>
        
魔改自 <a href="https://github.com/riba2534/hugo-blog">Riba2534</a> by <a href="https://caixiongjiang.github.io">Jarson Cai</a>
<br>

&copy;
	
	2024 🌀Jarson Cai&#39;s Blog
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#naive-rag" onclick="onNavClick(`#naive-rag-nav`)" id="naive-rag-nav">
									Naive RAG
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#advanced-rag-rag%e8%bf%9b%e9%98%b6%e4%bd%bf%e7%94%a8%e6%8a%80%e5%b7%a7" onclick="onNavClick(`#advanced-rag-rag进阶使用技巧-nav`)" id="advanced-rag-rag进阶使用技巧-nav">
									Advanced-RAG: RAG进阶使用技巧
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%96%87%e6%9c%ac%e5%88%86%e5%9d%97" onclick="onNavClick(`#文本分块-nav`)" id="文本分块-nav">
									文本分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%95%bf%e7%9f%ad%e4%b8%8d%e4%b8%80%e7%9a%84%e6%96%87%e6%9c%ac%e5%88%87%e5%88%86" onclick="onNavClick(`#长短不一的文本切分-nav`)" id="长短不一的文本切分-nav">
									长短不一的文本切分
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e5%9d%97chunking%e8%80%83%e8%99%91%e5%9b%a0%e7%b4%a0" onclick="onNavClick(`#分块chunking考虑因素-nav`)" id="分块chunking考虑因素-nav">
									分块（chunking）考虑因素
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e5%9d%97%e6%96%b9%e6%b3%95" onclick="onNavClick(`#分块方法-nav`)" id="分块方法-nav">
									分块方法
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9b%ba%e5%ae%9a%e5%a4%a7%e5%b0%8f%e5%88%86%e5%9d%97fixed-size-chunking" onclick="onNavClick(`#固定大小分块fixed-size-chunking-nav`)" id="固定大小分块fixed-size-chunking-nav">
									固定大小分块（Fixed-size Chunking）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e5%ae%b9%e6%84%9f%e7%9f%a5%e5%88%86%e5%9d%97content-aware-chunking" onclick="onNavClick(`#内容感知分块content-aware-chunking-nav`)" id="内容感知分块content-aware-chunking-nav">
									“内容感知”分块（“Content-aware” Chunking）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%80%92%e5%bd%92%e5%88%86%e5%9d%97" onclick="onNavClick(`#递归分块-nav`)" id="递归分块-nav">
									递归分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%93%e7%94%a8%e5%88%86%e5%9d%97" onclick="onNavClick(`#专用分块-nav`)" id="专用分块-nav">
									专用分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%af%ad%e4%b9%89%e5%88%86%e5%9d%97" onclick="onNavClick(`#语义分块-nav`)" id="语义分块-nav">
									语义分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%a1%ae%e5%ae%9a%e9%80%82%e7%94%a8%e4%ba%8e%e5%ba%94%e7%94%a8%e7%9a%84%e6%9c%80%e4%bd%b3%e5%9d%97%e5%a4%a7%e5%b0%8f" onclick="onNavClick(`#确定适用于应用的最佳块大小-nav`)" id="确定适用于应用的最佳块大小-nav">
									确定适用于应用的最佳块大小
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%90%91%e9%87%8f%e5%8c%96" onclick="onNavClick(`#向量化-nav`)" id="向量化-nav">
									向量化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%90%9c%e7%b4%a2%e7%b4%a2%e5%bc%95" onclick="onNavClick(`#搜索索引-nav`)" id="搜索索引-nav">
									搜索索引
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%90%91%e9%87%8f%e5%ad%98%e5%82%a8%e7%b4%a2%e5%bc%95" onclick="onNavClick(`#向量存储索引-nav`)" id="向量存储索引-nav">
									向量存储索引
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%a4%9a%e5%b1%82%e7%b4%a2%e5%bc%95" onclick="onNavClick(`#多层索引-nav`)" id="多层索引-nav">
									多层索引
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%81%87%e8%ae%be%e9%97%ae%e9%a2%98%e5%92%8c%e5%81%87%e8%ae%be%e5%90%91%e9%87%8f%e6%96%87%e6%a1%a3hypothetical-questions-and-hyde" onclick="onNavClick(`#假设问题和假设向量文档hypothetical-questions-and-hyde-nav`)" id="假设问题和假设向量文档hypothetical-questions-and-hyde-nav">
									假设问题和假设向量文档（Hypothetical Questions and HyDE）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%8a%e4%b8%8b%e6%96%87%e5%a2%9e%e5%bc%ba" onclick="onNavClick(`#上下文增强-nav`)" id="上下文增强-nav">
									上下文增强
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%85%b3%e9%94%ae%e8%af%8d%e6%a3%80%e7%b4%a2" onclick="onNavClick(`#关键词检索-nav`)" id="关键词检索-nav">
									关键词检索
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86" onclick="onNavClick(`#基本原理-nav`)" id="基本原理-nav">
									基本原理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bb%a3%e7%a0%81%e4%bd%bf%e7%94%a8" onclick="onNavClick(`#代码使用-nav`)" id="代码使用-nav">
									代码使用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#elasticsearch%e6%a3%80%e7%b4%a2%e5%99%a8" onclick="onNavClick(`#elasticsearch检索器-nav`)" id="elasticsearch检索器-nav">
									ElasticSearch检索器
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2" onclick="onNavClick(`#混合检索-nav`)" id="混合检索-nav">
									混合检索
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%87%8d%e6%8e%92%e5%ba%8f%e5%92%8c%e8%bf%87%e6%bb%a4" onclick="onNavClick(`#重排序和过滤-nav`)" id="重排序和过滤-nav">
									重排序和过滤
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%9f%a5%e8%af%a2%e8%bd%ac%e6%8d%a2" onclick="onNavClick(`#查询转换-nav`)" id="查询转换-nav">
									查询转换
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%94%9f%e6%88%90%e5%8f%8d%e9%a6%88%e5%be%aa%e7%8e%afgenerative-feedback-loop-in-rag" onclick="onNavClick(`#生成反馈循环generative-feedback-loop-in-rag-nav`)" id="生成反馈循环generative-feedback-loop-in-rag-nav">
									生成反馈循环（Generative Feedback Loop in RAG）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83%e5%bc%95%e7%94%a8" onclick="onNavClick(`#参考引用-nav`)" id="参考引用-nav">
									参考引用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%81%8a%e5%a4%a9%e5%bc%95%e6%93%8e%e5%a4%9a%e8%bd%ae%e5%af%b9%e8%af%9d" onclick="onNavClick(`#聊天引擎多轮对话-nav`)" id="聊天引擎多轮对话-nav">
									聊天引擎（多轮对话）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%9f%a5%e8%af%a2%e8%b7%af%e7%94%b1" onclick="onNavClick(`#查询路由-nav`)" id="查询路由-nav">
									查询路由
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%a4%9a%e6%96%87%e6%a1%a3%e6%99%ba%e8%83%bd%e4%bd%93%e6%96%b9%e6%a1%88" onclick="onNavClick(`#多文档智能体方案-nav`)" id="多文档智能体方案-nav">
									多文档智能体方案
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%93%8d%e5%ba%94%e5%90%88%e6%88%90%e5%99%a8" onclick="onNavClick(`#响应合成器-nav`)" id="响应合成器-nav">
									响应合成器
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rag%e7%9b%b8%e5%85%b3%e7%9a%84%e5%be%ae%e8%b0%83" onclick="onNavClick(`#rag相关的微调-nav`)" id="rag相关的微调-nav">
									RAG相关的微调
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8c%87%e6%a0%87%e8%af%84%e4%bc%b0" onclick="onNavClick(`#指标评估-nav`)" id="指标评估-nav">
									指标评估
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e4%ba%8e%e4%ba%ba%e5%b7%a5%e7%9a%84%e6%95%b0%e6%8d%ae%e9%9b%86%e8%af%84%e6%b5%8b" onclick="onNavClick(`#基于人工的数据集评测-nav`)" id="基于人工的数据集评测-nav">
									基于人工的数据集评测
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%9f%ba%e4%ba%8e%e5%a4%a7%e6%a8%a1%e5%9e%8b%e7%9a%84%e6%95%b0%e6%8d%ae%e9%9b%86%e8%af%84%e6%b5%8b" onclick="onNavClick(`#基于大模型的数据集评测-nav`)" id="基于大模型的数据集评测-nav">
									基于大模型的数据集评测
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/blog">
                    文章📖
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    分类📌
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    标签🏷️
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/series">
                    系列📚
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/archive">
                    归档📃
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    关于👋
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friends">
                    友链🔗
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS📢
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#naive-rag" onclick="onNavClick(`#naive-rag-nav`)" id="naive-rag-nav">
									Naive RAG
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#advanced-rag-rag%e8%bf%9b%e9%98%b6%e4%bd%bf%e7%94%a8%e6%8a%80%e5%b7%a7" onclick="onNavClick(`#advanced-rag-rag进阶使用技巧-nav`)" id="advanced-rag-rag进阶使用技巧-nav">
									Advanced-RAG: RAG进阶使用技巧
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%96%87%e6%9c%ac%e5%88%86%e5%9d%97" onclick="onNavClick(`#文本分块-nav`)" id="文本分块-nav">
									文本分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%95%bf%e7%9f%ad%e4%b8%8d%e4%b8%80%e7%9a%84%e6%96%87%e6%9c%ac%e5%88%87%e5%88%86" onclick="onNavClick(`#长短不一的文本切分-nav`)" id="长短不一的文本切分-nav">
									长短不一的文本切分
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e5%9d%97chunking%e8%80%83%e8%99%91%e5%9b%a0%e7%b4%a0" onclick="onNavClick(`#分块chunking考虑因素-nav`)" id="分块chunking考虑因素-nav">
									分块（chunking）考虑因素
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e5%9d%97%e6%96%b9%e6%b3%95" onclick="onNavClick(`#分块方法-nav`)" id="分块方法-nav">
									分块方法
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9b%ba%e5%ae%9a%e5%a4%a7%e5%b0%8f%e5%88%86%e5%9d%97fixed-size-chunking" onclick="onNavClick(`#固定大小分块fixed-size-chunking-nav`)" id="固定大小分块fixed-size-chunking-nav">
									固定大小分块（Fixed-size Chunking）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e5%ae%b9%e6%84%9f%e7%9f%a5%e5%88%86%e5%9d%97content-aware-chunking" onclick="onNavClick(`#内容感知分块content-aware-chunking-nav`)" id="内容感知分块content-aware-chunking-nav">
									“内容感知”分块（“Content-aware” Chunking）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%80%92%e5%bd%92%e5%88%86%e5%9d%97" onclick="onNavClick(`#递归分块-nav`)" id="递归分块-nav">
									递归分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%93%e7%94%a8%e5%88%86%e5%9d%97" onclick="onNavClick(`#专用分块-nav`)" id="专用分块-nav">
									专用分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%af%ad%e4%b9%89%e5%88%86%e5%9d%97" onclick="onNavClick(`#语义分块-nav`)" id="语义分块-nav">
									语义分块
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%a1%ae%e5%ae%9a%e9%80%82%e7%94%a8%e4%ba%8e%e5%ba%94%e7%94%a8%e7%9a%84%e6%9c%80%e4%bd%b3%e5%9d%97%e5%a4%a7%e5%b0%8f" onclick="onNavClick(`#确定适用于应用的最佳块大小-nav`)" id="确定适用于应用的最佳块大小-nav">
									确定适用于应用的最佳块大小
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%90%91%e9%87%8f%e5%8c%96" onclick="onNavClick(`#向量化-nav`)" id="向量化-nav">
									向量化
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%90%9c%e7%b4%a2%e7%b4%a2%e5%bc%95" onclick="onNavClick(`#搜索索引-nav`)" id="搜索索引-nav">
									搜索索引
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%90%91%e9%87%8f%e5%ad%98%e5%82%a8%e7%b4%a2%e5%bc%95" onclick="onNavClick(`#向量存储索引-nav`)" id="向量存储索引-nav">
									向量存储索引
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%a4%9a%e5%b1%82%e7%b4%a2%e5%bc%95" onclick="onNavClick(`#多层索引-nav`)" id="多层索引-nav">
									多层索引
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%81%87%e8%ae%be%e9%97%ae%e9%a2%98%e5%92%8c%e5%81%87%e8%ae%be%e5%90%91%e9%87%8f%e6%96%87%e6%a1%a3hypothetical-questions-and-hyde" onclick="onNavClick(`#假设问题和假设向量文档hypothetical-questions-and-hyde-nav`)" id="假设问题和假设向量文档hypothetical-questions-and-hyde-nav">
									假设问题和假设向量文档（Hypothetical Questions and HyDE）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%b8%8a%e4%b8%8b%e6%96%87%e5%a2%9e%e5%bc%ba" onclick="onNavClick(`#上下文增强-nav`)" id="上下文增强-nav">
									上下文增强
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%85%b3%e9%94%ae%e8%af%8d%e6%a3%80%e7%b4%a2" onclick="onNavClick(`#关键词检索-nav`)" id="关键词检索-nav">
									关键词检索
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86" onclick="onNavClick(`#基本原理-nav`)" id="基本原理-nav">
									基本原理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bb%a3%e7%a0%81%e4%bd%bf%e7%94%a8" onclick="onNavClick(`#代码使用-nav`)" id="代码使用-nav">
									代码使用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#elasticsearch%e6%a3%80%e7%b4%a2%e5%99%a8" onclick="onNavClick(`#elasticsearch检索器-nav`)" id="elasticsearch检索器-nav">
									ElasticSearch检索器
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2" onclick="onNavClick(`#混合检索-nav`)" id="混合检索-nav">
									混合检索
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e9%87%8d%e6%8e%92%e5%ba%8f%e5%92%8c%e8%bf%87%e6%bb%a4" onclick="onNavClick(`#重排序和过滤-nav`)" id="重排序和过滤-nav">
									重排序和过滤
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%9f%a5%e8%af%a2%e8%bd%ac%e6%8d%a2" onclick="onNavClick(`#查询转换-nav`)" id="查询转换-nav">
									查询转换
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%94%9f%e6%88%90%e5%8f%8d%e9%a6%88%e5%be%aa%e7%8e%afgenerative-feedback-loop-in-rag" onclick="onNavClick(`#生成反馈循环generative-feedback-loop-in-rag-nav`)" id="生成反馈循环generative-feedback-loop-in-rag-nav">
									生成反馈循环（Generative Feedback Loop in RAG）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83%e5%bc%95%e7%94%a8" onclick="onNavClick(`#参考引用-nav`)" id="参考引用-nav">
									参考引用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%81%8a%e5%a4%a9%e5%bc%95%e6%93%8e%e5%a4%9a%e8%bd%ae%e5%af%b9%e8%af%9d" onclick="onNavClick(`#聊天引擎多轮对话-nav`)" id="聊天引擎多轮对话-nav">
									聊天引擎（多轮对话）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%9f%a5%e8%af%a2%e8%b7%af%e7%94%b1" onclick="onNavClick(`#查询路由-nav`)" id="查询路由-nav">
									查询路由
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%a4%9a%e6%96%87%e6%a1%a3%e6%99%ba%e8%83%bd%e4%bd%93%e6%96%b9%e6%a1%88" onclick="onNavClick(`#多文档智能体方案-nav`)" id="多文档智能体方案-nav">
									多文档智能体方案
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%93%8d%e5%ba%94%e5%90%88%e6%88%90%e5%99%a8" onclick="onNavClick(`#响应合成器-nav`)" id="响应合成器-nav">
									响应合成器
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#rag%e7%9b%b8%e5%85%b3%e7%9a%84%e5%be%ae%e8%b0%83" onclick="onNavClick(`#rag相关的微调-nav`)" id="rag相关的微调-nav">
									RAG相关的微调
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8c%87%e6%a0%87%e8%af%84%e4%bc%b0" onclick="onNavClick(`#指标评估-nav`)" id="指标评估-nav">
									指标评估
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e4%ba%8e%e4%ba%ba%e5%b7%a5%e7%9a%84%e6%95%b0%e6%8d%ae%e9%9b%86%e8%af%84%e6%b5%8b" onclick="onNavClick(`#基于人工的数据集评测-nav`)" id="基于人工的数据集评测-nav">
									基于人工的数据集评测
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%9f%ba%e4%ba%8e%e5%a4%a7%e6%a8%a1%e5%9e%8b%e7%9a%84%e6%95%b0%e6%8d%ae%e9%9b%86%e8%af%84%e6%b5%8b" onclick="onNavClick(`#基于大模型的数据集评测-nav`)" id="基于大模型的数据集评测-nav">
									基于大模型的数据集评测
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://caixiongjiang.github.io/">
            🌀Jarson Cai&#39;s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://caixiongjiang.github.io/">
        <div class="single-column-header-title">🌀Jarson Cai&#39;s Blog</div>
        
        <div class="single-column-header-subtitle">头脑是日用品，不是装饰品</div>
        

    </a>
</div>

            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/rag_title.jpg')"
                    
                
            >
                <div class="post-title">
                    Advanced-RAG: RAG进阶使用技巧
                    
                    <div class="post-subtitle">
                        RAG在工程中的进阶使用技巧
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2024-08-25 18:18
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/">[NLP]</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/rag">RAG</a>
                                &nbsp;
                            
                        
                        
                            <i class="material-icons" style="">schedule</i>
                            

                            
                            

                            
                            60 min
                            
                            53 s.
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h1 id="naive-rag">Naive RAG</h1>
<p>前言：目前下述的代码都基于Langchain 0.1的版本进行，目前Langchain已经更新到0.2，还有在构建RAG应用的时候还是不要过分依赖框架，降低灵活性，这有时候会让你的工程开发陷入被动！</p>
<p>首先先介绍一下最简单的RAG的流程，其主要的流程如下图所示：</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img7.jpg" alt=""></p>
<p>将知识库文本拆分为块，然后使用一些Transformer Encoder模型将这些块嵌入向量中，将所有这些向量放入索引中，最后为LLM创建一个提示，告诉模型根据我们在搜索步骤中发现的上下文，回答用户的查询。</p>
<p>在运行时，我们使用相同的编码器模型矢量化用户的查询，然后针对索引执行此查询矢量的搜索，找到top-k结果，从我们的数据库中检索相应的文本块，并将其作为上下文输入LLM提示符。</p>
<p>示例的RAG提示词模版如下：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#228b22"># 英文提示词</span>
</span></span><span style="display:flex;"><span>prompt_template = <span style="color:#cd5555">&#34;&#34;&#34;Give the answer to the user query delimited by triple backticks ```</span><span style="color:#cd5555">{query}</span><span style="color:#cd5555">```</span><span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#cd5555">                using the information given in context delimited by triple backticks ```</span><span style="color:#cd5555">{context}</span><span style="color:#cd5555">```.</span><span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#cd5555">                If there is no relevant information in the provided context, try to answer yourself, 
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">                but tell user that you did not have any relevant context to base your answer on.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">                Be concise and output the answer of size less than 80 tokens.
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 中文版本</span>
</span></span><span style="display:flex;"><span>prompt_template_zh = <span style="color:#cd5555">&#34;&#34;&#34;给出由三重反引号分隔的用户查询的答案````</span><span style="color:#cd5555">{query}</span><span style="color:#cd5555">```</span><span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">使用由三重反引号```</span><span style="color:#cd5555">{context}</span><span style="color:#cd5555">```分隔的上下文中给出的信息。</span><span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">如果提供的上下文中没有相关信息，请尝试回答自己，
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">但告诉用户，您没有任何相关上下文来作为答案的基础。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">简明扼要，并输出大小小于80个代币的答案。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="advanced-rag-rag进阶使用技巧">Advanced-RAG: RAG进阶使用技巧</h1>
<p>做过RAG应用的都知道一句话叫“RAG demo5分钟，上线上一年。”</p>
<p>使用简单的RAG流程必然不可能有很好的检索效果，大模型的回答也一定是一塌糊涂。</p>
<p>放一张国外的博客的图：
<img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img8.jpg" alt="">
绿色的部分下面我们将会深入展开，蓝色部分则是处理好的文本元素。</p>
<p>下面将会记录的所有RAG相关的技术都或多或少与上面这个图相关。我们将会介绍所有与RAG相关的步骤中相关的进阶技术，以及RAG效果测试数据集的建立、评估、测试。</p>
<h2 id="文本分块">文本分块</h2>
<p><strong>分块的目的主要是为了确保在内容向量化时尽可能减少噪声，同时保持语义相关性。<strong>例如，在</strong>语义搜索</strong>(semantic search)中为一个包含特定主题信息的文档语料库建立索引。可以通过应用有效的分块策略，确保搜索结果准确捕捉用户查询的真实意图。如果分块太小或太大，可能导致搜索结果不精确或错过表面相关内容。作为经验之谈，如果文本块在没有周围上下文的情况下对人类来说可读可理解，它对语言模型也同样有意义。因此，找到语料库中文档的最佳块大小对于确保搜索结果的准确性和相关性至关重要。</p>
<h3 id="长短不一的文本切分">长短不一的文本切分</h3>
<p><strong>短内容向量化</strong>：当一个句子被向量化时，生成的向量专注于该句子的具体含义，在与其他句子向量进行比较时也会更多关注句子层面的上。这也意味着<strong>短内容向量化可能会丢失句子在段落或全文中所包含的上下文信息。</strong></p>
<p><strong>长内容向量化</strong>：当整个段落或文档被向量化时，向量化过程考虑了整体上下文以及文本内部句子和短语之间的关系，这样向量化时包含的内容可能更全面，捕捉到的文本含义和主题更准确。但是，<strong>较大的文本块大小可能更容易引入噪声，或稀释某些句子或短语的重要性，使得在查询索引时的精确匹配变得更加困难。</strong></p>
<blockquote>
<p>较短的查询，如单个句子或短语，将集中于具体细节，并可能更适合与句子级别的向量匹配。较长的查询，跨越多个句子或段落，可能与段落或文档级别的向量更为协调。</p>
</blockquote>
<p>索引可能也是非均质的，包含不同大小的块向量。这可能在查询结果相关性方面带来挑战，但也可能带来一些积好处。一方面，由于<strong>长短内容之间语义表示的差异可能会导致查询与结果相关性的波动</strong>。另一方面，<strong>非均质索引可能捕捉到更全面的上下文信息，因为不同大小的块代表了文本中不同层次的细节</strong>。这样可能会有利于更灵活地适应不同类型的查询。</p>
<h3 id="分块chunking考虑因素">分块（chunking）考虑因素</h3>
<ul>
<li><strong>内容的性质</strong>：处理的是长文档（如文章或书籍）还是较短的内容（如推文或即时消息）？这将决定哪种模型更适合您的目标，从而影响应用的分块策略。</li>
<li><strong>使用的向量模型</strong>：接下来要考虑的是应该使用的向量模型，以及它在哪些块大小上表现最佳。这部分主要是探究模型在多少个数量的令牌（token）上表现更好，以此来辅助决定分块的大小。</li>
<li><strong>用户查询的预期长度和复杂度</strong>：RAG是与用户相关的应用问题，一般来说都会预先定义一些查询结果样例，这些<strong>样例的形式和长度</strong>在文本分块中起到重要的作用。</li>
<li><strong>检索结果在特定应用中的使用方式</strong>：如果检索结果要被放入大模型里使用，则需要检索结果的内容长度作一定的限制，因为大模型支持的令牌（token）数是有限的。（按照经验来说，带多轮对话的RAG一般上下文长度限定在8K个token左右）</li>
</ul>
<h3 id="分块方法">分块方法</h3>
<p>在文本分块方面，有几种不同的方法可供选择，每种方法适用于不同的情况。以下是一些主要的分块方法，以及它们的优势和劣势。</p>
<h4 id="固定大小分块fixed-size-chunking">固定大小分块（Fixed-size Chunking）</h4>
<p>这是最常见且直接的分块方法，简单地决定每个块中的token数量，并可选择性地决定它们之间是否应该有重叠。通常用户会希望在块之间保持一些重叠，以确保上下文语义不会在块之间丢失。<strong>在多数情况下，固定大小分块将是最优方法。</strong></p>
<p>Langchain中执行的例子：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>text = <span style="color:#cd5555">&#34;...&#34;</span> <span style="color:#228b22"># your text</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> CharacterTextSplitter
</span></span><span style="display:flex;"><span>text_splitter = CharacterTextSplitter(
</span></span><span style="display:flex;"><span>    separator = <span style="color:#cd5555">&#34;</span><span style="color:#cd5555">\n\n</span><span style="color:#cd5555">&#34;</span>,
</span></span><span style="display:flex;"><span>    chunk_size = <span style="color:#b452cd">256</span>,
</span></span><span style="display:flex;"><span>    chunk_overlap  = <span style="color:#b452cd">20</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>docs = text_splitter.create_documents([text])
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="内容感知分块content-aware-chunking">“内容感知”分块（“Content-aware” Chunking）</h4>
<p>1、<strong>原始分割法</strong>：一种按照简单的标点符号或者换行符来分割文本。这种方法快速且易于实现，但可能不会考虑到所有可能的边界情况，如缩写、省略号或带有句号的引用等。所以虽然朴素分割在某些情况下足够有效，但它可能无法准确地处理<strong>相对复杂的文本结构</strong>。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>text = <span style="color:#cd5555">&#34;...&#34;</span> <span style="color:#228b22"># your text</span>
</span></span><span style="display:flex;"><span>docs = text.split(<span style="color:#cd5555">&#34;.&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>2、 <strong>自然语言工具包</strong>（Nature Language Toolkit, NLTK）：NLTK是一个比较流行的Python库，用于处理人类语言数据。其中有一个文本分割器，可以将文本分割成单独的句子，NLTK句子分词器考虑了更多的语言规则和边界情况，更加精确。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>text = <span style="color:#cd5555">&#34;...&#34;</span> <span style="color:#228b22"># your text</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> NLTKTextSplitter
</span></span><span style="display:flex;"><span>text_splitter = NLTKTextSplitter()
</span></span><span style="display:flex;"><span>docs = text_splitter.split_text(text)
</span></span></code></pre></td></tr></table>
</div>
</div><p>3、<strong>spaCy</strong>是另一个强大的Python库，用于各种NLP任务。它提供了一个高级的句子分割功能，<strong>能够有效地将文本划分为单独的句子，从而在生成的块中更好地保留上下文</strong>。spaCy的句子分割功能使用复杂的算法和模型来理解文本结构，因此它能够更准确地处理各种文本格式和风格。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>text = <span style="color:#cd5555">&#34;...&#34;</span> <span style="color:#228b22"># your text</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> SpacyTextSplitter
</span></span><span style="display:flex;"><span>text_splitter = SpaCyTextSplitter()
</span></span><span style="display:flex;"><span>docs = text_splitter.split_text(text)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="递归分块">递归分块</h4>
<p>递归分块使用一组分隔符以分层和迭代的方式将输入文本分割成更小的块。<strong>如果最初的分割尝试没有产生所需大小或结构的块，该方法会递归地在结果块上使用不同的分隔符或标准进行调用</strong>，直到达到所需的块大小或结构。这意味着虽然块的大小不会完全相同，但它们仍然会“努力”达到类似的大小。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>text = <span style="color:#cd5555">&#34;...&#34;</span> <span style="color:#228b22"># your text</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> RecursiveCharacterTextSplitter
</span></span><span style="display:flex;"><span>text_splitter = RecursiveCharacterTextSplitter(
</span></span><span style="display:flex;"><span>    <span style="color:#228b22"># Set a really small chunk size, just to show.</span>
</span></span><span style="display:flex;"><span>    chunk_size = <span style="color:#b452cd">256</span>,
</span></span><span style="display:flex;"><span>    chunk_overlap  = <span style="color:#b452cd">20</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docs = text_splitter.create_documents([text])
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="专用分块">专用分块</h4>
<p>这部分的内容主要是针对文本的类型来决定的，比如特殊的文本类型，<code>markdown</code>和<code>latex</code>等。
这两种文本类型都具有高度的结构化属性，它们可以通过语法来生成高质量的结构化文本。前者往往用于工程代码的说明书和文档，后者则一般用于论文的编写。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> MarkdownTextSplitter
</span></span><span style="display:flex;"><span>markdown_text = <span style="color:#cd5555">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>markdown_splitter = MarkdownTextSplitter(chunk_size=<span style="color:#b452cd">100</span>, chunk_overlap=<span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>docs = markdown_splitter.create_documents([markdown_text])
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> LatexTextSplitter
</span></span><span style="display:flex;"><span>latex_text = <span style="color:#cd5555">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>latex_splitter = LatexTextSplitter(chunk_size=<span style="color:#b452cd">100</span>, chunk_overlap=<span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>docs = latex_splitter.create_documents([latex_text])
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="语义分块">语义分块</h4>
<p>Greg Kamradt首次引入了一种新的接近块状的实验技术。在他的笔记本中，Kamradt正确地指出，一个事实是，即全局块大小可能太微不足道，无法考虑文档中段的含义。如果我们使用这种类型的机制，我们无法知道我们是否在组合彼此有任何关系的片段。</p>
<p>幸运的是，如果您正在使用LLM构建应用程序，您很可能已经有能力创建嵌入——嵌入可用于提取数据中存在的语义。这种语义分析可用于创建由谈论相同主题或话题的句子组成的块。</p>
<p>以下是使语义分块的步骤：
1、将文档分解成句子。</p>
<p>2、创建句子组：对于每个句子，创建一个包含给定句子前后一些句子的组。该组本质上被用于创建它的句子“安置”。您可以决定每个组之前或之后的具体数字，但组中的所有句子都将与一个“anchor”句子相关联。</p>
<p>3、为每个句子组生成嵌入，并将其与他们的“anchor”句子相关联。</p>
<p>4、按顺序比较每个组之间的距离：当您按顺序查看文档中的句子时，只要主题或主题相同-为给定句子嵌入的句子组和它前面的句子组之间的距离将很低。另一方面，更高的语义距离表明主题或话题已经改变。这可以有效地从下一个块中划定一个块。</p>
<p>Langchain中已经将这种方法集成进去了，但它是一个实验性的方法：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_experimental.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> SemanticChunker
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_openai.embeddings</span> <span style="color:#8b008b;font-weight:bold">import</span> OpenAIEmbeddings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">with</span> <span style="color:#658b00">open</span>(<span style="color:#cd5555">&#34;../../state_of_the_union.txt&#34;</span>) <span style="color:#8b008b;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>    state_of_the_union = f.read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>text_splitter = SemanticChunker(OpenAIEmbeddings())
</span></span><span style="display:flex;"><span>docs = text_splitter.create_documents([state_of_the_union])
</span></span><span style="display:flex;"><span><span style="color:#658b00">print</span>(docs[<span style="color:#b452cd">0</span>].page_content)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="确定适用于应用的最佳块大小">确定适用于应用的最佳块大小</h3>
<p>说了这么多，我们还没有研究如何确定最佳的分块大小（比如是固定大小分块），只是一些通用的建议。</p>
<ul>
<li>数据预处理：首先拿到语料需要对数据进行一定的数据预处理确保数据的质量，然后才能确定块的大小。（去掉一些不合理的标签，文档数据的不合理读取）。</li>
<li><strong>选择一系列块大小</strong>：一旦数据预处理完成，下一步是选择一系列潜在的块大小进行测试。如文章前面提到的，选择时应考虑<strong>内容的性质（例如，短消息或长文档）</strong>、将要使用的<strong>向量模型及其能力（例如，token数量限制）</strong>。目标是在保留上下文语境和维持准确性之间找到平衡点。开始时可以探索各种块大小，包括较小的块（例如，128或256个token）以捕获更细粒度的语义信息，然后再探索较大的块（例如，512或1024个token）以保留更多上下文语境。</li>
<li><strong>评估每种块大小的性能</strong>：可以使用多个索引或一个带有多个命名空间的单一索引测试不同的块大小的性能。使用代表性数据集为想要测试的块大小创建向量，并将它们保存在一个或多个索引中。然后运行一系列查询以评估质量，并比较各种块大小的性能。这很可能是一个迭代过程，需要测试不同的块大小针对不同的查询，直到能够确定最适合内容和预期查询的块大小。</li>
</ul>
<h2 id="向量化">向量化</h2>
<p>在简单的RAG流程中，不管是知识库的建立还是问题的查询，首先都要经过向量化。向量化的模型排行榜可以在<a href="https://huggingface.co/spaces/mteb/leaderboard">leaderboard</a>中找到，向量化模型的选择需要根据业务类型和文本分块的长度来联合确定，并不是使用排行越高的的模型效果就一定更好。</p>
<p>Langchain中使用向量化，使用Chroma、faiss举例：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_community.vectorstores</span> <span style="color:#8b008b;font-weight:bold">import</span> Chroma, FAISS
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_huggingface</span> <span style="color:#8b008b;font-weight:bold">import</span> HuggingFaceEmbeddings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>embedding_instance = HuggingFaceEmbeddings(model_name=model_path,
</span></span><span style="display:flex;"><span>                                           model_kwargs={<span style="color:#cd5555">&#34;device&#34;</span>: device},
</span></span><span style="display:flex;"><span>                                           encode_kwargs={<span style="color:#cd5555">&#34;normalize_embeddings&#34;</span>: <span style="color:#8b008b;font-weight:bold">True</span>})
</span></span><span style="display:flex;"><span>vector_path = <span style="color:#cd5555">&#34;./vector_store&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chroma.from_documents(
</span></span><span style="display:flex;"><span>    documents=texts,
</span></span><span style="display:flex;"><span>    embedding=embedding_instance,
</span></span><span style="display:flex;"><span>    persist_directory=vector_path
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vs = FAISS.from_documents(
</span></span><span style="display:flex;"><span>    documents=texts,
</span></span><span style="display:flex;"><span>    embedding=embedding_instance
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>vs.save_local(vector_path)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="搜索索引">搜索索引</h3>
<h4 id="向量存储索引">向量存储索引</h4>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img9.jpg" alt=""></p>
<p>RAG 管道的关键部分是搜索索引，存储我们在上一步获得的矢量化内容。最简单的实现使用平面索引——查询向量和所有块向量之间的暴力距离计算。</p>
<p>一个适合在10000+元素规模上进行高效检索的搜索索引是向量索引(vector index)，如<a href="https://faiss.ai/">faiss</a>、<a href="https://github.com/nmslib/nmslib">nmslib</a>或<a href="https://github.com/spotify/annoy">annoy</a>，使用一些近似最近邻(Approximate Nearest Neighbours, ANN)实现，如聚类、树或HNSW(Hierarchical Navigable Small World)算法。</p>
<p>还有一些托管解决方案，如<code>openSearch</code>或<code>ElasticSearch</code>，以及向量数据库，它们在后台处理了前面描述的数据摄取管道，如Pinecone、Weaviate或Chroma。</p>
<p><strong>根据索引选择、数据和搜索需求，用户还可以在存储向量的同时存储元数据(metadata)</strong>，然后使用元数据filter来搜索某些日期或来源内的信息。主要的元数据包括页码，上级标题，自定义文档索引等等，这些都有助于检索，也有助于后续建立测试数据集。</p>
<h4 id="多层索引">多层索引</h4>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img10.jpg" alt=""></p>
<p>如果知识库中的文档很多，那么我们必须更加高效地搜索其中的信息，更快更好地找到相关的文档。<strong>这部分在检索时必须存储引用来源的单一答案</strong>。在处理大型数据库时，高效做到这个点的方法是<strong>创建两个索引——一个由摘要组成，另一个由文档块组成</strong>。如图所示，进行两步搜索，首先通过摘要筛选出相关的满足要求的文档，然后再在这些文档中继续检索。</p>
<p><strong>具体实现方式</strong>：
1、对整体文本内容分块，向量化，入库
2、相关文档进行摘要总结，添加对应关系，向量化，入库
3、输入问题在摘要库中进行检索，通过对应的摘要-文本映射表找到文本库中相关的部分。
4、在相关文本库的部分重新进行二次检索，找到相关的内容</p>
<p>上述方法在由多个文件组成的内容知识库中尤其适用，每个文件代表的内容是主题比较明确。这会在对检索到的文本进行过滤也会更加轻松搞笑。假设知识库为一整本书的内容，可能需要人工总结摘要，或者使用LLM来总结摘要，形成结构化信息，提供更加精准的检索。</p>
<h4 id="假设问题和假设向量文档hypothetical-questions-and-hyde">假设问题和假设向量文档（Hypothetical Questions and HyDE）</h4>
<p>另一种方法是<strong>让LLM为每个块生成问题，并将这些问题以向量形式嵌入，在运行时对这些问题向量索引执行查询搜索（在我们的索引中用问题向量替换块向量），然后在检索后路由到原始文本块</strong>，并将它们作为上下文发送给LLM以获取答案。这相比多层索引的方案粒度更细，对于能命中的问题，精度较高，命中不了的问题则完全错误，需要根据场景来谨慎选择。</p>
<p>实现步骤：
1、为每个相关的向量生成对应的问题，向量化，
2、在问题库里面进行检索，命中后根据映射表拿到对应上下文，送给大模型回答。（由于这里按照问题进行检索本身在生成问题时已经比较精确，不需要二次检索了）</p>
<p>这种方法通过在查询和假设问题之间的更高语义相似性来提高搜索质量，与我们对实际块所拥有的相比。</p>
<p>还有一种逆向逻辑方法称为<strong>假设向量文档(Hypothetical Document Embeddings, HyDE)——用户可以让LLM为给定的查询生成一个假设性响应，然后使用它的向量以及查询向量来增强搜索质量。</strong></p>
<p>实现步骤：
1、使用提示词工程让大模型回答问题，尽量简短，向量化
2、向量化的回答做为内容进行检索，将检索到的内容拼装到RAG的提示词中回答</p>
<h4 id="上下文增强">上下文增强</h4>
<p>这里的上下文增强是检索较小的块以提高搜索质量，但增强上下文内容语境以供LLM推理。</p>
<p>上下文增强有两套方案，一是利用在较小检索块附件的句子来扩展上下文，二是递归地将文档分割成包含更小子块的更大父块。</p>
<blockquote>
<p>句子窗口检索</p>
</blockquote>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img11.jpg" alt=""></p>
<p>在这个方案中，**文档中的每个句子都被单独嵌入，这为查询与上下文的余弦距离(cosine distance)搜索提供了极高的准确性。**为了在获取最相关的单个句子后更好地推理所找到的上下文，我们通过在检索到的句子前后各扩展k个句子来扩展上下文窗口，然后将这个扩展的上下文发送给LLM。</p>
<blockquote>
<p>自动合并检索（父文档检索器）</p>
</blockquote>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img12.jpg" alt=""></p>
<p>这里的想法与句子窗口检索器非常相似——搜索更颗粒度更细的信息，然后在将检索到的上下文送给LLM推理前扩展上下文窗口。文档被递归地分割成更大父块中更小的子块。</p>
<p>这种方法需要在文本分块的时候做出记录结构化的父子块信息，通常通过记录metadata来实现。</p>
<h3 id="关键词检索">关键词检索</h3>
<p>BM25是一种比较常用的关键词检索组件</p>
<p>BM25 是一种基于概率的排名函数，用于信息检索系统。<strong>BM25原理是根据查询词在文档中的出现频率以及查询词在整个文本集中的出现频率，来计算查询词和文档的相似度</strong>。BM25模型的主要思想是：如果一个词在一份文档（这里的文档一般是指分块之后的document）中出现的频率高，且在其他文档中出现的频率低，那么这个词对于这份文档的重要性就越高，相似度就越高。BM25模型对于长文档和短文档有一个平衡处理，防止因文档长度不同，而导致的词频偏差。</p>
<h4 id="基本原理">基本原理</h4>
<p>BM25基于这样一个假设：对于一个特定的查询项，它在相关文档中出现的频率高于在非相关文档中的频率。算法通过结合词项频率（TF）和文档频率（DF）来计算文档的得分。</p>
<p><strong>TF（词项频率）</strong>
词项频率是指一个词项在文档中出现的次数。BM25对传统TF的计算方法进行了调整，引入了饱和度和长度归一化，以防止长文档由于包含更多词项而获得不公平的高评分。</p>
<p><strong>IDF（逆文档频率）</strong>
逆文档频率是衡量词项稀有程度的指标。它的计算基于整个文档集合，用来降低常见词项的权重，并提升罕见词项的权重。</p>
<p><strong>计算公式</strong>：</p>
<p>$$
\text{BM25}(D, Q) = \sum_{i=1}^n\text{IDF}(q_i)\cdot\frac{f(q_i, D)\cdot(k_1 + 1)}{f(q_i, D) + k_1\cdot(1-b+b\cdot \frac{\text{len}(D)}{\text{avg_len}})}
$$</p>
<p>其中：</p>
<ul>
<li>$n$是查询中的词项数。</li>
<li>$q_i$是查询中的第$i$个词项。</li>
<li>$\text{IDF}(q_i)$是逆文档频率，计算方式通常是$\text{log}\frac{N-n(q_i)+0.5}{n(q_i)+0.5}$，其中$N$是文档总数，$n(q_i)$ 是包含词项$q_i$的文档数。</li>
<li>$\text{len}(D)$是文档$D$的长度。</li>
<li>$\text{avg_len}$是所有文档的平均长度。</li>
<li>$k_1$和$b$是调整参数，通常设置为$k_1=1.5$和$b=0.75$</li>
</ul>
<h4 id="代码使用">代码使用</h4>
<p>在LangChain中已经集成了该方法，模块名叫<code>BM25Retriever</code>。</p>
<p>示例使用代码：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">typing</span> <span style="color:#8b008b;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>    List
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.schema</span> <span style="color:#8b008b;font-weight:bold">import</span> Document
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">jieba</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">jieba.posseg</span> <span style="color:#8b008b;font-weight:bold">as</span> <span style="color:#008b45;text-decoration:underline">pseg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># jieba_dictionnary为分词内部自带的分词文件地址</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># jieba_user_dict为自己定义的特殊分词表</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">func</span>(text: <span style="color:#658b00">str</span>) -&gt; List[<span style="color:#658b00">str</span>]:
</span></span><span style="display:flex;"><span>    jieba.set_dictionary(jieba_dictionary)
</span></span><span style="display:flex;"><span>    jieba.load_userdict(jieba_user_dict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    jieba_list = jieba.lcut(text, cut_all=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>    words = pseg.cut(text)
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> word, flag <span style="color:#8b008b">in</span> words:
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> flag == <span style="color:#cd5555">&#34;nr&#34;</span>:
</span></span><span style="display:flex;"><span>            jieba_list.append(word)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> jieba_list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 该部分为通过文本切分之后的chunk块</span>
</span></span><span style="display:flex;"><span>texts: List[Document] = [...]
</span></span><span style="display:flex;"><span><span style="color:#228b22"># BM25检索器，获取前5个最相关的结果</span>
</span></span><span style="display:flex;"><span>bm25_retriever = BM25Retriever(docs=texts, k=<span style="color:#b452cd">5</span>) 
</span></span><span style="display:flex;"><span><span style="color:#228b22"># BM25检索器有默认的前处理分词策略，你也可以实现自己的分词策略，这里我使用jieba分词</span>
</span></span><span style="display:flex;"><span>my_bm25_retriever = BM25Retriever(docs=texts, k=<span style="color:#b452cd">5</span>, preprocess_func=func)
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中词汇的内容通常用以下格式：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span># 名称 词频 词性（词频越高，优先级越高）
</span></span><span style="display:flex;"><span>苹果 3 n
</span></span><span style="display:flex;"><span>iPhone 5 nz
</span></span><span style="display:flex;"><span>Python 10 n
</span></span><span style="display:flex;"><span>深度学习 8 n
</span></span><span style="display:flex;"><span>jieba 5 nr
</span></span></code></pre></td></tr></table>
</div>
</div><p>除了上述的格式，词频和词性都是可以省略的，当然，标注完整效果会更佳。</p>
<h4 id="elasticsearch检索器">ElasticSearch检索器</h4>
<p>Elasticsearch 是位于 Elastic Stack 中心的分布式搜索和分析引擎。Logstach 和 Beats 促进采集、合计以及充实你的数据并在 Elasticsearch 中存储它们。Kibana 允许你去交互式的探索、可视化和共享对数据的见解，以及监视这个栈（Elastic Stack）。Elasticsearch 为各种数据类型提供接近实时的搜索和分析。不论你有结构化或非结构化的文本、数字数据，还是地理空间数据，Elasticsearch 能以支持快速搜索的方式高效地存储和索引它。</p>
<p>Elasticsearch默认使用BM25算法作为默认检索算法，Elasticsearch允许分布式部署，可以随着数据规模的增长而无缝增长，提供了灵活性。</p>
<ul>
<li>Elasticsearch部署（以Linux系统为例）：</li>
</ul>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.11.1-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>tar -xvf elasticsearch-7.11.1-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#658b00">cd</span> elasticsearch-7.11.1/bin
</span></span><span style="display:flex;"><span>./elasticsearch
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>其余系统的部署教程详细见<a href="https://elasticsearch.bookhub.tech/getting_started/install">链接🔗</a></em></p>
<p>这样单个节点的Elasticsearch 集群就启动好了！</p>
<ul>
<li>Langchain集成ElasticSearch检索器：</li>
</ul>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">ssl</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">openai</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">elasticsearch</span> <span style="color:#8b008b;font-weight:bold">import</span> Elasticsearch
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_community.vectorstores</span> <span style="color:#8b008b;font-weight:bold">import</span> ElasticsearchStore
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_openai</span> <span style="color:#8b008b;font-weight:bold">import</span> OpenAIEmbeddings
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.text_splitter</span> <span style="color:#8b008b;font-weight:bold">import</span> CharacterTextSplitter
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_community.document_loaders</span> <span style="color:#8b008b;font-weight:bold">import</span> TextLoader
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 设置代理访问 API</span>
</span></span><span style="display:flex;"><span>os.environ[<span style="color:#cd5555">&#34;HTTP_PROXY&#34;</span>] = <span style="color:#cd5555">&#34;http://127.0.0.1:33210&#34;</span>
</span></span><span style="display:flex;"><span>os.environ[<span style="color:#cd5555">&#34;HTTPS_PROXY&#34;</span>] = <span style="color:#cd5555">&#34;http://127.0.0.1:33210&#34;</span>
</span></span><span style="display:flex;"><span>os.environ[<span style="color:#cd5555">&#34;ALL_PROXY&#34;</span>] = <span style="color:#cd5555">&#34;socks5://127.0.0.1:33211&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 加载文档</span>
</span></span><span style="display:flex;"><span>file_path = <span style="color:#cd5555">&#39;conf/state_of_the_union.txt&#39;</span>
</span></span><span style="display:flex;"><span>encoding = <span style="color:#cd5555">&#39;utf-8&#39;</span>
</span></span><span style="display:flex;"><span>loader = TextLoader(file_path, encoding=encoding)
</span></span><span style="display:flex;"><span>documents = loader.load()
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 文档分割</span>
</span></span><span style="display:flex;"><span>text_splitter = CharacterTextSplitter(chunk_size=<span style="color:#b452cd">1000</span>, chunk_overlap=<span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>docs = text_splitter.split_documents(documents)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 连接 Elasticsearch</span>
</span></span><span style="display:flex;"><span>conn = Elasticsearch(
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;https://127.0.0.1:9200&#34;</span>,
</span></span><span style="display:flex;"><span>    ca_certs = <span style="color:#cd5555">&#34;certs/http_ca.crt&#34;</span>,
</span></span><span style="display:flex;"><span>    basic_auth = (<span style="color:#cd5555">&#34;elastic&#34;</span>, <span style="color:#cd5555">&#34;changeme&#34;</span>),
</span></span><span style="display:flex;"><span>    verify_certs=<span style="color:#8b008b;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 创建索引并进行检索</span>
</span></span><span style="display:flex;"><span>embeddings = OpenAIEmbeddings()
</span></span><span style="display:flex;"><span>db = ElasticsearchStore.from_documents(docs, embeddings, index_name=<span style="color:#cd5555">&#34;test_index&#34;</span>, es_connection=conn)
</span></span><span style="display:flex;"><span>db.client.indices.refresh(index=<span style="color:#cd5555">&#34;test_index&#34;</span>)
</span></span><span style="display:flex;"><span>query = <span style="color:#cd5555">&#34;What did the president say about Ketanji Brown Jackson&#34;</span>
</span></span><span style="display:flex;"><span>results = db.similarity_search(query)
</span></span><span style="display:flex;"><span><span style="color:#658b00">print</span>(results)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="混合检索">混合检索</h3>
<p>一个简单的想法，就是将传统搜索行业的<code>关键词检索</code>（稀疏检索算法）和最新的<code>语义搜索</code>，<code>向量检索</code>结合起来，生成一个最优的检索结果。但是一般不通过简单的融合来实现，这里关键的技巧是正确地结合具有不同相似度得分的检索结果——这个问题通常通过互惠排名融合(Reciprocal Rank Fusion, RRF)算法解决。最终的实现方式如图所示：</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img13.jpg" alt=""></p>
<p>在Langchain中，这是在<code>Ensemble Retriever</code>类中实现的，它结合了用户定义的一系列检索器，例如基于faiss的向量索引和基于BM25的检索器，并使用RRF进行重新排序。</p>
<p>示例demo:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.retrievers</span> <span style="color:#8b008b;font-weight:bold">import</span> EnsembleRetriever
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_community.retrievers</span> <span style="color:#8b008b;font-weight:bold">import</span> BM25Retriever
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_community.vectorstores</span> <span style="color:#8b008b;font-weight:bold">import</span> FAISS
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_openai</span> <span style="color:#8b008b;font-weight:bold">import</span> OpenAIEmbeddings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>doc_list_1 = [
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;I like apples&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;I like oranges&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Apples and oranges are fruits&#34;</span>,
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># initialize the bm25 retriever and faiss retriever</span>
</span></span><span style="display:flex;"><span>bm25_retriever = BM25Retriever.from_texts(
</span></span><span style="display:flex;"><span>    doc_list_1, metadatas=[{<span style="color:#cd5555">&#34;source&#34;</span>: <span style="color:#b452cd">1</span>}] * <span style="color:#658b00">len</span>(doc_list_1)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>bm25_retriever.k = <span style="color:#b452cd">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>doc_list_2 = [
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;You like apples&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;You like oranges&#34;</span>,
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>embedding = OpenAIEmbeddings()
</span></span><span style="display:flex;"><span>faiss_vectorstore = FAISS.from_texts(
</span></span><span style="display:flex;"><span>    doc_list_2, embedding, metadatas=[{<span style="color:#cd5555">&#34;source&#34;</span>: <span style="color:#b452cd">2</span>}] * <span style="color:#658b00">len</span>(doc_list_2)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>faiss_retriever = faiss_vectorstore.as_retriever(search_kwargs={<span style="color:#cd5555">&#34;k&#34;</span>: <span style="color:#b452cd">2</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># initialize the ensemble retriever</span>
</span></span><span style="display:flex;"><span>ensemble_retriever = EnsembleRetriever(
</span></span><span style="display:flex;"><span>    retrievers=[bm25_retriever, faiss_retriever], weights=[<span style="color:#b452cd">0.5</span>, <span style="color:#b452cd">0.5</span>]
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>但在实际的检索过程中，这种合并的过程并不总是理想。举一个自己在做RAG的一个例子，下图是自己做的产品库的信息检索方案：</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img14.jpg" alt=""></p>
<p>因为并不能简单通过权重来评判不同的检索器的好坏。我个人的做法是通过reranker Model（下面会讲到）先对不同的检索结果进行排序，然后进行合并去重，最后取<code>top_n</code>的检索结果。<strong>将reranker模型前置的好处是，在各自的检索器检索到的内容，其相似度得分并不一定准确，可以减少多检索器在RRF排序过程的关键检索信息损失。</strong></p>
<p>合并和去重检索结果的位置排布变得很重要，一般会有两种排布方式：</p>
<ul>
<li>按照各自的排序结果交替排序并进行去重：</li>
</ul>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img15.jpg" alt=""></p>
<p>这种方式将不同检索器得到的结果交替进行排序，每次将结果压入是需要先判断是否存在。</p>
<ul>
<li>按照各自的排序结果头尾排序并进行去重：</li>
</ul>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img16.jpg" alt=""></p>
<p>这种方式是将不同的结果分别放在头和尾，需要注意的是尾部的顺序需要倒过来。这种做法是根据大模型对较长的文本中头和尾的信息更加敏感的特点，所以这种方法一般针对检索结果较多以及最终的文本较长的情况。</p>
<h2 id="重排序和过滤">重排序和过滤</h2>
<p>重排序是指通过一个<code>reranker</code>模型对最终检索到的结果重新进行排序，过滤则是通过一些明显的业务属性来过滤明显错误的结果，或者通过<code>metadata</code>中的一些信息进行排序，过滤，增加，删减等一系列操作，这个主要看业务的属性来决定。</p>
<h2 id="查询转换">查询转换</h2>
<p>查询转换是一系列技术的总称，使用<strong>LLM作为推理引擎</strong>来修改用户输入，以提高检索质量。有几种不同的方法可以做到这一点。</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img17.jpg" alt=""></p>
<p>查询转换有几种方式：</p>
<ul>
<li>一种是通过根据提问的问题转化为更加通用的主题的方式来降低检索的难度。例如，我在问办理某个产品的需要多少钱？通常的做法是让LLM将其转化为带关键词的更加高效的检索。</li>
</ul>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#228b22"># 这里的资费通常知识库常用的关键词</span>
</span></span><span style="display:flex;"><span>办理&lt;某产品&gt;的需要多少钱<span style="color:#a61717;background-color:#e3d2d2">？</span> --&gt; &lt;某产品&gt;的资费
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>另一种查询转换则是将复杂的查询分解为子查询。例如，如果用户问：“在Github上，Langchain和LlamaIndex哪个更优秀？”，而我们不太可能在语料库中的某些文本中找到直接的比较，所以将这个问题分解为两个子查询是有意义的，假设更简单、更具体的信息检索：“Langchain在Github上有多少星星？”“Llamaindex在Github上有多少星星？”它们将并行执行，然后将检索到的上下文合并到一个提示中，供LLM合成对初始查询的最终答案。这两个库都实现了这个功能——在Langchain中作为多查询检索器(Multi Query Retriever)，在Llamaindex中作为子问题查询引擎(Sub Question Query Engine)。</li>
</ul>
<p>Langchain demo:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.retrievers.multi_query</span> <span style="color:#8b008b;font-weight:bold">import</span> MultiQueryRetriever
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_openai</span> <span style="color:#8b008b;font-weight:bold">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>question = <span style="color:#cd5555">&#34;What are the approaches to Task Decomposition?&#34;</span>
</span></span><span style="display:flex;"><span>llm = ChatOpenAI(temperature=<span style="color:#b452cd">0</span>)
</span></span><span style="display:flex;"><span>retriever_from_llm = MultiQueryRetriever.from_llm(
</span></span><span style="display:flex;"><span>    retriever=vectordb.as_retriever(), llm=llm
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>回退提示(Step-back prompting)使用LLM生成一个更普适的查询，检索它我们获得一个更普适或更高层次的上下文语境，有助于支撑初始查询的答案。初始查询的检索同时被执行，两个上下文都被提交到LLM以便在最后一步生成答案。</li>
</ul>
<h2 id="生成反馈循环generative-feedback-loop-in-rag">生成反馈循环（Generative Feedback Loop in RAG）</h2>
<p>RAG中的生成反馈循环是基于RAG系统的大模型回答<strong>生成一系列的记忆以及一些QA回答信息</strong>，将这些信息不断地存储进向量数据库中，来增强RAG系统回答的质量。</p>
<p>常规的RAG链路如下：
<img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img27.jpg" alt=""></p>
<p>常规的RAG在LLM和向量数据库之间并没有交互，而生成反馈循环实际上是增强了两者的联系。基本的流程是LLM产生的输出，会被反馈到RAG系统中，也就是将问题和生成的答案的内容加入到新的向量数据库中，稍候进行使用。</p>
<p>增加了生成反馈循环的RAG链路如下：
<img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img28.jpg" alt=""></p>
<ul>
<li>生成反馈循环的优势：</li>
</ul>
<p>1、该循环将新的数据输入和交互纳入训练数据中。</p>
<p>2、这允许模型适应不断变化的模式和趋势，提高未来产出的相关性和准确性。</p>
<p>3、会产生部分的用户个性化定制回答。</p>
<p>这部分新产生的QA数据可以与常规知识库分开保存，它类似于一个cache，用户在输入问题后，可以在这部分额外QA库先进行搜索。这将会降低一部分开销，因为额外的QA库规模远小于常规的知识库。</p>
<p>4、如果在返回的模块中，加入人类的反馈，或者LLM的评估反馈，基于评估，有选择性地增加额外QA库，这样可以<strong>减少初始数据的偏见和错误</strong>。</p>
<ul>
<li>生成反馈循环的例子：</li>
</ul>
<p><strong>步骤一</strong>：用户提问，搜索先前生成的额外的QA问答库，然后同步搜索知识库，如果没有搜索到相关内容，则去知识库去搜索得到结果。</p>
<p><strong>步骤二</strong>：较为强大的LLM会生成相应的QA回答内容，RAG系统会将它存储下来，并进入向量数据库。</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img29.jpg" alt=""></p>
<p><strong>步骤三</strong>：如果当前提问的问题和之前的QA库中问题相同或者相似，这时候可以使用一个小的LLM根据给定的历史QA回答进行调整做出响应。对应的相应时间会减少，相应的内容质量也与强大的LLM相当，因为它使用了强大的LLM遗留下的知识。（这与缓存非常相似，甚至如果问题完全相同，可以忽略搜索这个步骤，直接取回答案。）</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img30.jpg" alt=""></p>
<h2 id="参考引用">参考引用</h2>
<p>如果用户使用多个检索来源生成答案，无论是因为初始查询的复杂性（用户不得不执行多个子查询，然后将检索到的上下文合并为一个答案），还是因为在不同文档中找到了某个查询的相关上下文，那么就会出现一个问题，即Generator是否能准确地显示所使用的引用来源。</p>
<p>有几种方法可以做到这一点：</p>
<p>1、将这个<strong>显示引用源的任务插入到prompt中</strong>，要求LLM说明所使用的引用源编号。</p>
<p>例子：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>prompt = <span style="color:#cd5555">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">...
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">[
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    retrieve_results_1, source: A
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    retrieve_results_2, source: B
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">]
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">...
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">请你说明你的回答使用了哪些检索结果，标注出相应的引用源。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2、将生成的答案部分与索引中的原始文本块匹配——LlamaIndex为这种情况提供了一种高效的模糊匹配解决方案(fuzzy matching based solution)(模糊匹配(fuzzy matching)是一种非常强大的字符串匹配技术)。</p>
<p><strong>这种方法是通过算法来解决文本块使用的问题。</strong></p>
<p>上述两种方法各有优劣，需要根据实际情况进行灵活选择。</p>
<h2 id="聊天引擎多轮对话">聊天引擎（多轮对话）</h2>
<p>单体的RAG流程仅仅是针对单次问答的情况，并不会考虑上下文。如果要构建多次问答的RAG系统，则需要支持历史对话，但是多轮历史对话往往会很长，而大模型支持的token数比较有限。</p>
<p>要构建一个能够对单个查询多次执行操作的高效RAG系统，下一个重要步骤是实现聊天逻辑，这与经典聊天机器人在LLM时代之前处理对话上下文的方式类似。采用这种方式是为了<strong>支持后续问题、指代解析或与之前对话上下文相关的任何用户指令</strong>。解决这一问题的方法是通过<strong>查询压缩(query compression)技术</strong>，同时考虑聊天上下文和用户查询。</p>
<p>在上下文压缩方面，有几种方法可供选择：</p>
<ul>
<li>一种比较流行且相对简单的方法是使用<code>ContextChatEngine</code>，它<strong>首先检索与用户查询相关的上下文，然后将其连同聊天历史记录从内存缓冲区取出发送给LLM</strong>，以便LLM在生成下一个答案时能够了解之前的上下文。</li>
<li>另一种相对复杂的情况是<code>CondensePlusContextMode</code>，在这种模式下，<strong>每次交互中的聊天记录和最后一条消息被压缩成一个新的查询，然后这个查询被发送到索引里</strong>，并把检索到的上下文连同原始用户消息一起传递给LLM以生成答案。这种技术需要LLM将最近几条的聊天记录和最新的一条消息进行压缩，保证整体的语义与用户的真实意图相同。</li>
</ul>
<p>在实际的生产环境中，<code>ContextChatEngine</code>往往是不work的，因为你无法保证用户在输入问题时使用书面化的问法，<strong>大部分口语化的问答方式，关键信息会保留在上一次问题中，而在本次提问中仅仅进行追问。在本次的查询中缺少关键信息，检索效果往往不佳。</strong></p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img18.jpg" alt=""></p>
<p>聊天引擎是RAG系统中的一个关键组件，它不仅处理用户的直接查询，还能够理解和响应与之前对话上下文相关的内容。通过这种方式，RAG系统能够提供更连贯、更自然的对话体验。</p>
<h2 id="查询路由">查询路由</h2>
<p>查询路由是指针对用户的查询，由LLM来决定下一步操作的决策步骤。通常的选择包括总结信息、对某些数据索引进行搜索，或尝试多种不同的路径并将它们的输出合成为唯一的答案。实现方式便是<code>Agent智能体</code>。</p>
<p><strong>查询路由器</strong>(Query Routers)还用于选择索引，或者更通俗地说是选择执行用户查询命令的数据源。无论是拥有多个数据源（比如经典的向量存储、图形数据库或关系数据库），还是拥有多层索引结构（比如处理在多文档存储的时候，一个典型的索引创建方案很可能是一个由摘要组成的索引和另一个由文档块向量组成的索引），都需要进行查询路径选择。</p>
<p>其中所有的查询选择，结果判断，都需要大模型自己判断，而不是人工定制好一个路径。</p>
<h3 id="多文档智能体方案">多文档智能体方案</h3>
<blockquote>
<p>Agents的概念：一个能够进行推理、提供一系列工具和一个完成特定任务的LLM</p>
</blockquote>
<p>智能体提供的工具可能包括如各种语言代码功能，各种外部API，甚至各种其他智能体——这种LLM链式的想法是LangChain名字的由来。目前市面上的大模型都适配了工具调用能力，也就是将语言文本转化为使用API调用外部工具或数据库查询的能力。</p>
<p><img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img19.jpg" alt=""></p>
<p>上述图片中的<code>多文档智能体</code>的方案，将多个文档检索的方式都制作为智能体，每个智能体都能自行判断需要进行哪些子查询，自行决定查询完了之后需要使用哪个查询出来的结果。顶层的智能体则单纯使用路由的能力，来选择使用哪些查询智能体。</p>
<p>这种复杂方案的缺点基本可以从上图中推测出来——由于涉及智能体内部的多次LLM迭代，所以执行效率比较低下。<strong>需要注意的是，LLM调用总是RAG管道中最费时的操作</strong>。因此，对于大型多文档存储，建议考虑对这个方案进行一些简化，以便提高其可扩展性。最简单的方法就是将所有的文档智能体使用一套通用的固定查询路径。</p>
<h2 id="响应合成器">响应合成器</h2>
<p>这是每个RAG管道的最后一步——基于用户精心检索到的所有上下文和初始用户查询生成答案。最简单的方法是将所有检索到的上下文（高于某个相关性阈值）与查询一起连续地提交给LLM。但总有其他更复杂的方案，比如多次执行LLM调用来细化检索到的上下文，以生成更完美的答案。</p>
<p>响应合成的主要方法包括：</p>
<p>1、通过将检索到的上下文逐块提交给LLM来迭代优化答案。
2、摘要检索到的上下文以匹配prompt。
3、基于不同上下文块生成多个答案，然后将它们融合或摘要。</p>
<h2 id="rag相关的微调">RAG相关的微调</h2>
<ul>
<li>embedding模型微调：<a href="https://docs.llamaindex.ai/en/stable/examples/finetuning/embeddings/finetune_embedding/">LLamaIndex</a>提供了embedding模型微调的方式，根据国外博主的实测，bge-large-en-v1.5的embedding模型微调能够对RAG系统带来2%的性能提升。</li>
<li>reranker模型微调：另一个好的旧选择是，如果您不完全信任基础编码器，则有一个交叉编码器来重新排名检索到的结果。它的工作方式如下——您将查询和每个检索到的前k个文本块传递给交叉编码器，由SEP令牌隔开，并微调为相关块输出1，不相关块输出0。这种调整过程的一个很好的例子可以在<a href="https://docs.llamaindex.ai/en/latest/examples/finetuning/cross_encoder_finetuning/cross_encoder_finetuning.html#">这里</a>找到，结果显示，通过交叉编码器微调，配对得分提高了4%。</li>
</ul>
<h2 id="指标评估">指标评估</h2>
<h3 id="基于人工的数据集评测">基于人工的数据集评测</h3>
<p>基于人工的RAG评测需要人工构建问题和对应目标文本的数据集。这是一个示例的数据集格式：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a61717;background-color:#e3d2d2">#</span> <span style="color:#a61717;background-color:#e3d2d2">relevant_docs_source是在整个知识库中的document-ID（存储在metadata信息中）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;query_id&#34;</span>: <span style="color:#b452cd">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;query_text&#34;</span>: <span style="color:#cd5555">&#34;&lt;某产品&gt;的优势是什么？&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;relevant_docs_source&#34;</span>: [<span style="color:#b452cd">40</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于不同的类别，可以在其上层继续构建分类，用于不同的类别。
关于定量指标，通常选择一些常用的：<code>recall</code>, <code>precison</code>, <code>f1_score</code>, <code>hit_rate</code>。</p>
<ul>
<li>召回率（Recall）：召回率是指系统正确检索到的相关文档数与所有相关文档数的比例。</li>
</ul>
<p>$$
Recall = \frac{检索到的相关文档数}{所有相关文档数}
$$</p>
<ul>
<li>精确率（Precision）：精确率是指系统检索到的相关文档数与检索到的所有文档数的比例。</li>
</ul>
<p>$$
Precision = \frac{检索到的相关文档数}{检索到的所有文档数}
$$</p>
<ul>
<li>F1分数（F1 Score）：F1分数是精确率和召回率的调和平均值，用于综合衡量系统的性能。</li>
</ul>
<p>$$
F1-Score = 2 \times \frac{Precision * Recall}{Precision + Recall}
$$</p>
<ul>
<li>命中率（Hit Rate）：命中率是指系统在检索到的文档中至少有一个相关文档的比例。</li>
</ul>
<p>$$
Hit Rate = \frac{至少有一个相关文档的查询数}{总查询数}
$$</p>
<p><strong>上述所有指标都需要结合最终检索的格式<code>top_n</code>结合起来看，在上面几个指标中，最重要的是<code>召回率</code>和<code>命中率</code>。这是因为你即便召回了部分噪声，大模型本身具有判断的能力，但如果没有正确的没有召回，大模型则没有信息来源，是不可能回答正确的。</strong></p>
<h3 id="基于大模型的数据集评测">基于大模型的数据集评测</h3>
<p>《Evaluating RAG Applications with RAGAs》文章介绍了一个用于评估RAG应用的框架，称为RAGAs，这篇文章详细介绍了RAGAS框架，它的核心目标是提供一套综合性的评估指标和方法，以量化地评估**RAG管道(RAG Pipeline)<strong>在不同组件层面上的性能。RAGAs特别适用于那些结合了</strong>检索（Retrieval）和生成（Generation）**两个主要组件的RAG系统。</p>
<p><strong>无参考评估</strong>：RAGAs最初设计为一种“无参考”评估框架，意味着它不依赖于人工注释的真实标签，而是利用大型语言模型（LLM）进行评估。</p>
<p><strong>组件级评估</strong>：RAGAs允许对RAG管道的两个主要组件——检索器和生成器——分别进行评估。这种分离评估方法有助于精确地识别管道中的性能瓶颈。</p>
<p><strong>综合性评估指标</strong>：RAGAs提供了一系列评估指标，包括<strong>上下文精度(Context Precision)、上下文召回(Context Recall)、忠实度(Faithfulness)和答案相关性(Answer Relevancy)</strong>。这些指标共同构成了RAGAs评分，用于全面评估RAG管道的性能。</p>
<p>具体的评估流程和代码示例：<a href="https://towardsdatascience.com/evaluating-rag-applications-with-ragas-81d67b0ee31a">https://towardsdatascience.com/evaluating-rag-applications-with-ragas-81d67b0ee31a</a></p>
<p><strong>Reference</strong>:<a href="https://pub.towardsai.net/advanced-rag-techniques-an-illustrated-overview-04d193d8fec6">https://pub.towardsai.net/advanced-rag-techniques-an-illustrated-overview-04d193d8fec6</a></p>

                    
                    <HR width="100%" id="EOF">
		            <p style="color:#777;">最后修改于 2024-08-27</p>
                    
                    
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210508215939.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://caixiongjiang.github.io/blog/2024/rag/%E9%AB%98%E7%BA%A7rag-kg/">
			下回<br>高级RAG检索策略之知识图谱
                </a>
                
                
                
                <a class="older-posts" href="https://caixiongjiang.github.io/blog/2024/rag/document_ai/">
			上回<br>Document-AI: 使用模型工具处理非结构化、复杂的各类文档
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                








<div id="tcomment"></div>



            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
魔改自 <a href="https://github.com/riba2534/hugo-blog">Riba2534</a> by <a href="https://caixiongjiang.github.io">Jarson Cai</a>
<br>

&copy;
	
	2024 🌀Jarson Cai&#39;s Blog
	</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            },
            debounce(func, wait, options) {
                let lastArgs,
                    lastThis,
                    maxWait,
                    result,
                    timerId,
                    lastCallTime

                let lastInvokeTime = 0
                let leading = false
                let maxing = false
                let trailing = true

                
                const useRAF = (!wait && wait !== 0 && typeof root.requestAnimationFrame === 'function')

                if (typeof func !== 'function') {
                    throw new TypeError('Expected a function')
                }
                function isObject(value) {
                    const type = typeof value
                    return value != null && (type === 'object' || type === 'function')
                }

                wait = +wait || 0
                if (isObject(options)) {
                    leading = !!options.leading
                    maxing = 'maxWait' in options
                    maxWait = maxing ? Math.max(+options.maxWait || 0, wait) : maxWait
                    trailing = 'trailing' in options ? !!options.trailing : trailing
                }

                function invokeFunc(time) {
                    const args = lastArgs
                    const thisArg = lastThis

                    lastArgs = lastThis = undefined
                    lastInvokeTime = time
                    result = func.apply(thisArg, args)
                    return result
                }

                function startTimer(pendingFunc, wait) {
                    if (useRAF) {
                    root.cancelAnimationFrame(timerId)
                    return root.requestAnimationFrame(pendingFunc)
                    }
                    return setTimeout(pendingFunc, wait)
                }

                function cancelTimer(id) {
                    if (useRAF) {
                    return root.cancelAnimationFrame(id)
                    }
                    clearTimeout(id)
                }

                function leadingEdge(time) {
                    
                    lastInvokeTime = time
                    
                    timerId = startTimer(timerExpired, wait)
                    
                    return leading ? invokeFunc(time) : result
                }

                function remainingWait(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime
                    const timeWaiting = wait - timeSinceLastCall

                    return maxing
                    ? Math.min(timeWaiting, maxWait - timeSinceLastInvoke)
                    : timeWaiting
                }

                function shouldInvoke(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime

                    
                    
                    
                    return (lastCallTime === undefined || (timeSinceLastCall >= wait) ||
                    (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait))
                }

                function timerExpired() {
                    const time = Date.now()
                    if (shouldInvoke(time)) {
                    return trailingEdge(time)
                    }
                    
                    timerId = startTimer(timerExpired, remainingWait(time))
                }

                function trailingEdge(time) {
                    timerId = undefined

                    
                    
                    if (trailing && lastArgs) {
                    return invokeFunc(time)
                    }
                    lastArgs = lastThis = undefined
                    return result
                }

                function cancel() {
                    if (timerId !== undefined) {
                    cancelTimer(timerId)
                    }
                    lastInvokeTime = 0
                    lastArgs = lastCallTime = lastThis = timerId = undefined
                }

                function flush() {
                    return timerId === undefined ? result : trailingEdge(Date.now())
                }

                function pending() {
                    return timerId !== undefined
                }

                function debounced(...args) {
                    const time = Date.now()
                    const isInvoking = shouldInvoke(time)

                    lastArgs = args
                    lastThis = this
                    lastCallTime = time

                    if (isInvoking) {
                    if (timerId === undefined) {
                        return leadingEdge(lastCallTime)
                    }
                    if (maxing) {
                        
                        timerId = startTimer(timerExpired, wait)
                        return invokeFunc(lastCallTime)
                    }
                    }
                    if (timerId === undefined) {
                    timerId = startTimer(timerExpired, wait)
                    }
                    return result
                }
                debounced.cancel = cancel
                debounced.flush = flush
                debounced.pending = pending
                return debounced
                }

    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
        
        
            twikoo.init({
                envId: "https://twikoo-rho-olive.vercel.app/",
                el: '#tcomment',
                region:  null ,
            });
        

        document.querySelectorAll("table").forEach(function(elem){
            elem.classList.add("table-striped");
            elem.classList.add("table");
            elem.classList.add("table-responsive");
            elem.classList.add("table-hover");
        })

        
        spy();
        window.addEventListener('scroll', this.debounce(spy, 250, { 'maxWait': 250 }), false);
        
        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});



</script>
    </body>
</html>
