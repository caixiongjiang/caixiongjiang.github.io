<!DOCTYPE html>
<html><head>
<title>LLM启动大全</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="记录一下当前市场上各种框架启动大模型，以及使用方法记录">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="LLM启动大全" />
<meta property="og:description" content="记录一下当前市场上各种框架启动大模型，以及使用方法记录" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://caixiongjiang.github.io/blog/2024/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8/llm%E9%83%A8%E7%BD%B2%E5%A4%A7%E5%85%A8/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-05-06T18:18:05+08:00" />
<meta property="article:modified_time" content="2024-05-07T09:19:06+08:00" />
<meta property="og:see_also" content="https://caixiongjiang.github.io/blog/2024/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8/vllm%E5%B9%B6%E5%8F%91/" /><meta property="og:see_also" content="https://caixiongjiang.github.io/blog/2024/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8/nlpllm/" /><meta property="og:see_also" content="https://caixiongjiang.github.io/blog/2024/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8/langchain%E5%85%A5%E9%97%A8/" /><meta property="og:see_also" content="https://caixiongjiang.github.io/blog/2023/llm/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83%E6%8A%80%E6%9C%AF/" />











<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>


  




<link rel="icon" href="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/avater.jfif">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://caixiongjiang.github.io/scss/dark-mode.min.c0082f0b082177f6fb3768ff91439a097de49689bd26f4d49f76d94ebb81e02d.css" integrity="sha256-wAgvCwghd/b7N2j/kUOaCX3klom9JvTUn3bZTruB4C0=" media="screen">


<script src="/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>


  
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script type="text/javascript" id="MathJax-script"
async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
MathJax.Hub.Queue(function() {



var all = MathJax.Hub.getAllJax(), i;
for(i = 0; i < all.length; i += 1) {
all[i].SourceElement().parentNode.className += ' has-jax';
}
});
</script>

<style>
code.has-jax {
font: inherit;
font-size: 100%;
background: inherit;
border: inherit;
color: #515151;
}
</style>





  
    <script src="/js/toc.js"></script>
  











<script src="https://cdn.jsdelivr.net/npm/twikoo@1.5.11/dist/twikoo.all.min.js"></script>




</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://caixiongjiang.github.io/">
    
        <div class="nav-title">
            🌀Jarson Cai&#39;s Blog
        </div>
        
        <div class="nav-subtitle">
            头脑是日用品，不是装饰品
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/blog">
                文章📖
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                分类📌
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                标签🏷️
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/series">
                系列📚
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/archive">
                归档📃
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                关于👋
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friends">
                友链🔗
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS📢
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<a href="https://github.com/caixiongjiang">
    GitHub
</a>
<br>

<a href="mailto:nau_cxj@163.com">
    Email
</a>
<br>

<a href="https://leetcode-cn.com/u/cai-xiong-jiang/">
    Leetcode
</a>
<br>

        <hr>
        
魔改自 <a href="https://github.com/riba2534/hugo-blog">Riba2534</a> by <a href="https://caixiongjiang.github.io">Jarson Cai</a>
<br>

&copy;
	
	2024 🌀Jarson Cai&#39;s Blog
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#llm%e5%90%af%e5%8a%a8%e5%a4%a7%e5%85%a8" onclick="onNavClick(`#llm启动大全-nav`)" id="llm启动大全-nav">
									LLM启动大全
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%a8%a1%e5%9e%8b%e4%b8%8b%e8%bd%bd" onclick="onNavClick(`#模型下载-nav`)" id="模型下载-nav">
									模型下载
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%a8%a1%e5%9e%8b%e5%90%af%e5%8a%a8" onclick="onNavClick(`#模型启动-nav`)" id="模型启动-nav">
									模型启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%8e%9f%e7%94%9ftransformers%e5%ba%93%e5%90%af%e5%8a%a8" onclick="onNavClick(`#原生transformers库启动-nav`)" id="原生transformers库启动-nav">
									原生Transformers库启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#llamacpp%e5%90%af%e5%8a%a8" onclick="onNavClick(`#llamacpp启动-nav`)" id="llamacpp启动-nav">
									llama.cpp启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#ollama%e5%90%af%e5%8a%a8" onclick="onNavClick(`#ollama启动-nav`)" id="ollama启动-nav">
									Ollama启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#vllm%e5%90%af%e5%8a%a8" onclick="onNavClick(`#vllm启动-nav`)" id="vllm启动-nav">
									vLLM启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#skypilot%e9%83%a8%e7%bd%b2" onclick="onNavClick(`#skypilot部署-nav`)" id="skypilot部署-nav">
									SkyPilot部署
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%ac%ac%e4%b8%89%e6%96%b9llm%e6%a1%86%e6%9e%b6%e6%8e%a5%e5%85%a5" onclick="onNavClick(`#第三方llm框架接入-nav`)" id="第三方llm框架接入-nav">
									第三方LLM框架接入
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#langchain-llama_index%e6%9c%ac%e5%9c%b0%e5%90%af%e5%8a%a8%e6%a8%a1%e5%9e%8b" onclick="onNavClick(`#langchain-llama_index本地启动模型-nav`)" id="langchain-llama_index本地启动模型-nav">
									LangChain, llama_index本地启动模型
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#langchain-llama_index%e8%b0%83%e7%94%a8%e6%9c%ac%e5%9c%b0openai%e6%8e%a5%e5%8f%a3%e6%9c%8d%e5%8a%a1" onclick="onNavClick(`#langchain-llama_index调用本地openai接口服务-nav`)" id="langchain-llama_index调用本地openai接口服务-nav">
									Langchain, llama_index调用本地OpenAI接口服务
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/blog">
                    文章📖
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    分类📌
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    标签🏷️
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/series">
                    系列📚
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/archive">
                    归档📃
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    关于👋
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friends">
                    友链🔗
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS📢
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#llm%e5%90%af%e5%8a%a8%e5%a4%a7%e5%85%a8" onclick="onNavClick(`#llm启动大全-nav`)" id="llm启动大全-nav">
									LLM启动大全
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%a8%a1%e5%9e%8b%e4%b8%8b%e8%bd%bd" onclick="onNavClick(`#模型下载-nav`)" id="模型下载-nav">
									模型下载
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%a8%a1%e5%9e%8b%e5%90%af%e5%8a%a8" onclick="onNavClick(`#模型启动-nav`)" id="模型启动-nav">
									模型启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%8e%9f%e7%94%9ftransformers%e5%ba%93%e5%90%af%e5%8a%a8" onclick="onNavClick(`#原生transformers库启动-nav`)" id="原生transformers库启动-nav">
									原生Transformers库启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#llamacpp%e5%90%af%e5%8a%a8" onclick="onNavClick(`#llamacpp启动-nav`)" id="llamacpp启动-nav">
									llama.cpp启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#ollama%e5%90%af%e5%8a%a8" onclick="onNavClick(`#ollama启动-nav`)" id="ollama启动-nav">
									Ollama启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#vllm%e5%90%af%e5%8a%a8" onclick="onNavClick(`#vllm启动-nav`)" id="vllm启动-nav">
									vLLM启动
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#skypilot%e9%83%a8%e7%bd%b2" onclick="onNavClick(`#skypilot部署-nav`)" id="skypilot部署-nav">
									SkyPilot部署
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%ac%ac%e4%b8%89%e6%96%b9llm%e6%a1%86%e6%9e%b6%e6%8e%a5%e5%85%a5" onclick="onNavClick(`#第三方llm框架接入-nav`)" id="第三方llm框架接入-nav">
									第三方LLM框架接入
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#langchain-llama_index%e6%9c%ac%e5%9c%b0%e5%90%af%e5%8a%a8%e6%a8%a1%e5%9e%8b" onclick="onNavClick(`#langchain-llama_index本地启动模型-nav`)" id="langchain-llama_index本地启动模型-nav">
									LangChain, llama_index本地启动模型
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#langchain-llama_index%e8%b0%83%e7%94%a8%e6%9c%ac%e5%9c%b0openai%e6%8e%a5%e5%8f%a3%e6%9c%8d%e5%8a%a1" onclick="onNavClick(`#langchain-llama_index调用本地openai接口服务-nav`)" id="langchain-llama_index调用本地openai接口服务-nav">
									Langchain, llama_index调用本地OpenAI接口服务
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://caixiongjiang.github.io/">
            🌀Jarson Cai&#39;s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://caixiongjiang.github.io/">
        <div class="single-column-header-title">🌀Jarson Cai&#39;s Blog</div>
        
        <div class="single-column-header-subtitle">头脑是日用品，不是装饰品</div>
        

    </a>
</div>

            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/LLM/LLM_title.jpg')"
                    
                
            >
                <div class="post-title">
                    LLM启动大全
                    
                    <div class="post-subtitle">
                        记录一下当前市场上各种框架启动大模型，以及使用方法记录
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2024-05-06 18:18
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/">[大模型]</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/deep_learning">Deep_learning</a>
                                &nbsp;
                            
                        
                        
                            <i class="material-icons" style="">schedule</i>
                            

                            
                            

                            
                            39 min
                            
                            18 s.
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="llm启动大全">LLM启动大全</h2>
<p>大模型发展至今，已经诞生了各种各样的部署框架以及使用方式，他们通常适用于不同的场景。现在通过自己了解的知识对大模型的各种启动方式做一个总结。</p>
<h3 id="模型下载">模型下载</h3>
<p>首先启动大模型，首先需要下载一个模型，模型的下载首选地址为HF官网模型库：https://huggingface.co/models</p>
<p>假设你的网络不能进入上述网址，可以进入魔搭社区下载，大部分模型都会同步到这里：https://www.modelscope.cn/models</p>
<p>我们这里使用Qwen1.5系列的模型做示例，具体的模型型号为<a href="https://www.modelscope.cn/models/qwen/Qwen1.5-4B-Chat/summary">Qwen1.5-4B-Chat</a>。</p>
<h3 id="模型启动">模型启动</h3>
<h4 id="原生transformers库启动">原生Transformers库启动</h4>
<p>使用最原始的Transformer框架启动，需要写一小部分代码，官方已经为你写好了Demo，地址在https://www.modelscope.cn/models/qwen/Qwen1.5-4B-Chat/summary。</p>
<p>为了通用性，我对代码做了略微的修改：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">torch</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">transformers</span> <span style="color:#8b008b;font-weight:bold">import</span> AutoTokenizer, AutoModelForCausalLM, TextStreamer, TextIteratorStreamer
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">threading</span> <span style="color:#8b008b;font-weight:bold">import</span> Thread
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">os</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">.model_zoo</span> <span style="color:#8b008b;font-weight:bold">import</span> *
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">.utils</span> <span style="color:#8b008b;font-weight:bold">import</span> highlight_text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">Qwen1_5</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> __init__(self, modelName) -&gt; <span style="color:#8b008b;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 检查是否支持模型</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">assert</span> modelName <span style="color:#8b008b">in</span> llm_weight_zoo, <span style="color:#cd5555">&#34;modelName should be in </span><span style="color:#cd5555">{}</span><span style="color:#cd5555">&#34;</span>.format(llm_weight_zoo.keys())
</span></span><span style="display:flex;"><span>        modelWeightPath = llm_weight_zoo[modelName]
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 检查本地是否下载模型</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">assert</span> os.path.exists(modelWeightPath), <span style="color:#cd5555">&#34;Model weight file: </span><span style="color:#cd5555">{}</span><span style="color:#cd5555"> &#34;</span>.format(modelWeightPath) + \
</span></span><span style="display:flex;"><span>                                                <span style="color:#cd5555">&#34;does not exist.</span><span style="color:#cd5555">\n</span><span style="color:#cd5555"> Please download </span><span style="color:#cd5555">{}</span><span style="color:#cd5555"> &#34;</span>.format(modelName) + \
</span></span><span style="display:flex;"><span>                                                <span style="color:#cd5555">&#34;model in &#34;</span> + \
</span></span><span style="display:flex;"><span>                                                highlight_text(<span style="color:#cd5555">&#34;&#39;</span><span style="color:#cd5555">{}</span><span style="color:#cd5555">&#39;&#34;</span>.format(llm_model_url_zoo[modelName]))
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 加载分词器</span>
</span></span><span style="display:flex;"><span>        self.tokenizer = AutoTokenizer.from_pretrained(modelWeightPath, trust_remote_code=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 加载模型</span>
</span></span><span style="display:flex;"><span>        self.model =  AutoModelForCausalLM.from_pretrained(modelWeightPath, torch_dtype=<span style="color:#cd5555">&#34;auto&#34;</span>,
</span></span><span style="display:flex;"><span>                                                           device_map=<span style="color:#cd5555">&#34;auto&#34;</span>,
</span></span><span style="display:flex;"><span>                                                           trust_remote_code=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        self.device = torch.device(<span style="color:#cd5555">&#34;cuda&#34;</span> <span style="color:#8b008b;font-weight:bold">if</span> torch.cuda.is_available() <span style="color:#8b008b;font-weight:bold">else</span> <span style="color:#cd5555">&#34;cpu&#34;</span>)
</span></span><span style="display:flex;"><span>        self.model_name = modelName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">get_prompt</span>(self, user_message, system_message):
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> system_message == <span style="color:#cd5555">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>            system_message = <span style="color:#cd5555">&#34;You are a helpful assistant.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">assert</span> user_message != <span style="color:#8b008b;font-weight:bold">None</span>, <span style="color:#cd5555">&#34;我是</span><span style="color:#cd5555">{}</span><span style="color:#cd5555">大模型,你必须输入提问问题&#34;</span>.format(self.model_name)
</span></span><span style="display:flex;"><span>        messages = [
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;system&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: system_message},
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;user&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: user_message}
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">chat</span>(self, messages, max_tokens=<span style="color:#b452cd">2048</span>, temperature=<span style="color:#b452cd">0.6</span>, top_p=<span style="color:#b452cd">0.9</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 调用模型进行对话生成</span>
</span></span><span style="display:flex;"><span>        input_ids = self.tokenizer.apply_chat_template(messages, tokenize=<span style="color:#8b008b;font-weight:bold">False</span>, add_generation_prompt=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        model_inputs = self.tokenizer([input_ids], return_tensors=<span style="color:#cd5555">&#34;pt&#34;</span>).to(self.device)
</span></span><span style="display:flex;"><span>        generated_ids = self.model.generate(model_inputs.input_ids, max_new_tokens=max_tokens,
</span></span><span style="display:flex;"><span>                                            temperature=temperature,
</span></span><span style="display:flex;"><span>                                            top_p=top_p)
</span></span><span style="display:flex;"><span>        generated_ids = [
</span></span><span style="display:flex;"><span>            output_ids[<span style="color:#658b00">len</span>(input_ids):] <span style="color:#8b008b;font-weight:bold">for</span> input_ids, output_ids <span style="color:#8b008b">in</span> <span style="color:#658b00">zip</span>(model_inputs.input_ids, generated_ids)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        response = self.tokenizer.batch_decode(generated_ids, skip_special_tokens=<span style="color:#8b008b;font-weight:bold">True</span>)[<span style="color:#b452cd">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">streamChat</span>(self, messages, max_tokens=<span style="color:#b452cd">2048</span>, temperature=<span style="color:#b452cd">0.6</span>, top_p=<span style="color:#b452cd">0.9</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 流式输出对话</span>
</span></span><span style="display:flex;"><span>        input_ids = self.tokenizer.apply_chat_template(messages, tokenize=<span style="color:#8b008b;font-weight:bold">False</span>, add_generation_prompt=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        model_inputs = self.tokenizer([input_ids], return_tensors=<span style="color:#cd5555">&#34;pt&#34;</span>).to(self.device)
</span></span><span style="display:flex;"><span>        streamer = TextStreamer(self.tokenizer, skip_prompt=<span style="color:#8b008b;font-weight:bold">True</span>, skip_special_tokens=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        generated_ids = self.model.generate(model_inputs.input_ids, max_new_tokens=max_tokens,
</span></span><span style="display:flex;"><span>                                            temperature=temperature,
</span></span><span style="display:flex;"><span>                                            top_p=top_p, 
</span></span><span style="display:flex;"><span>                                            streamer=streamer)
</span></span><span style="display:flex;"><span>        generated_ids = [
</span></span><span style="display:flex;"><span>            output_ids[<span style="color:#658b00">len</span>(input_ids):] <span style="color:#8b008b;font-weight:bold">for</span> input_ids, output_ids <span style="color:#8b008b">in</span> <span style="color:#658b00">zip</span>(model_inputs.input_ids, generated_ids)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        response = self.tokenizer.batch_decode(generated_ids, skip_special_tokens=<span style="color:#8b008b;font-weight:bold">True</span>)[<span style="color:#b452cd">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">streamIterChat</span>(self, messages, max_tokens=<span style="color:#b452cd">2048</span>, temperature=<span style="color:#b452cd">0.6</span>, top_p=<span style="color:#b452cd">0.9</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 流式输出对话迭代器</span>
</span></span><span style="display:flex;"><span>        input_ids = self.tokenizer.apply_chat_template(messages, tokenize=<span style="color:#8b008b;font-weight:bold">False</span>, add_generation_prompt=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        model_inputs = self.tokenizer([input_ids], return_tensors=<span style="color:#cd5555">&#34;pt&#34;</span>).to(self.device)
</span></span><span style="display:flex;"><span>        streamer = TextIteratorStreamer(self.tokenizer, skip_prompt=<span style="color:#8b008b;font-weight:bold">True</span>, skip_special_tokens=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        generation_kwargs = <span style="color:#658b00">dict</span>(model_inputs, max_new_tokens=max_tokens,
</span></span><span style="display:flex;"><span>                                 temperature=temperature,
</span></span><span style="display:flex;"><span>                                 top_p=top_p, 
</span></span><span style="display:flex;"><span>                                 streamer=streamer)
</span></span><span style="display:flex;"><span>        thread = Thread(target=self.model.generate, kwargs=generation_kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        thread.start()
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">yield from</span> streamer
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中<code>model_zoo.py</code>用于做模型名字和模型文件地址的映射。这样一来，只要实例化Qwen1_5这个类便会在本地加载大模型，然后调用不同的方法进行大模型问答。</p>
<blockquote>
<p>模型调用结果示例</p>
</blockquote>
<p>使用Postman进行外部调用：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;prompt&#34;</span>: <span style="color:#cd5555">&#34;你好,请给我讲一个故事，随便编一个&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;system_prompt&#34;</span>: <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用结果：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;response&#34;</span>: <span style="color:#cd5555">&#34;好的，下面是一个关于小猫咪的故事：\n\n从前有一只可爱的小猫咪，名叫咪咪。它住在一个美丽的花园里，每天都会在花园里玩耍和探索。\n\n有一天，咪咪发现了一个隐藏的洞穴。这个洞穴看起来非常神秘，里面充满了未知的冒险。于是，咪咪决定要深入洞穴探险。\n\n咪咪走进洞穴，发现里面有许多有趣的生物和奇妙的事物。它遇到了一些友善的兔子，还有一些凶猛的野猫。但是，咪咪并没有被吓到，反而更加兴奋地探索这个神秘的世界。\n\n在这个过程中，咪咪还学会了如何使用它的爪子挖掘洞穴，如何用鼻子寻找食物，甚至如何在黑暗中找到回家的路。它也结识了一些新的朋友，并且从中学到了很多新知识。\n\n最终，咪咪成功地回到了家，告诉了主人它的冒险经历。虽然它有些疲惫，但它非常开心，因为它知道它已经成长了许多。\n\n这就是关于咪咪的一个故事，希望你喜欢！&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;status&#34;</span>: <span style="color:#b452cd">200</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>流式接口调用：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;prompt&#34;</span>: <span style="color:#cd5555">&#34;你好,请给我讲一个故事，随便编一个&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;system_prompt&#34;</span>: <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用结果：
<img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/LLM/img52.jpg" alt=""></p>
<h4 id="llamacpp启动">llama.cpp启动</h4>
<p><code>llama.cpp</code>是一个C++库，用于简化LLM推理的设置。该库是一个纯C/C++实现，不依赖任何外部库，并且针对x86架构提供了AVX、AVX2和AVX512加速支持。此外，它还提供了2、3、4、5、6以及8位量化功能，以加快推理速度并减少内存占用。对于大于总VRAM容量的大规模模型，该库还支持CPU+GPU混合推理模式进行部分加速。本质上，llama.cpp的用途在于运行GGUF（由GPT生成的统一格式）模型。llama.cpp的官方仓库地址如下：https://github.com/ggerganov/llama.cpp。我们将演示如何使用llama.cpp运行Qwen。</p>
<blockquote>
<p>安装llama.cpp</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/ggerganov/llama.cpp
</span></span><span style="display:flex;"><span><span style="color:#658b00">cd</span> llama.cpp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>下载GGUF文件并启动</p>
</blockquote>
<p>找到<code>Qwen1.5-4B-Chat</code>官方的GGUF文件：https://www.modelscope.cn/models/qwen/Qwen1.5-4B-Chat-GGUF/summary，下载到本地。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./main -m Qwen1.5-7B-Chat-GGUF -n <span style="color:#b452cd">512</span> --color -i -cml -f prompts/chat-with-qwen.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>-n</code>代表要生成的最大token数量，如果要查看启动命令中的其他超参数介绍：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./main -h 
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ollama启动">Ollama启动</h4>
<p><code>Ollama</code>帮助您通过少量命令即可在本地运行LLM。它适用于MacOS、Linux和Windows操作系统。</p>
<blockquote>
<p>下载Ollama</p>
</blockquote>
<p>Ollama的官方仓库：https://github.com/ollama/ollama
Ollama官网：https://ollama.com/</p>
<p>Ollama的运行非常简单，对于Windows和MacOS，其专门制作了APP来运行。</p>
<p>Linux系统安装Ollama：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://ollama.com/install.sh | sh
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>运行Qwen1.5-4B-Chat</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ollama run qwen:4b
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>使用Ollama提供一个API服务</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ollama serve
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样会在本地启动一个地址来访问，一般为http://localhost:11434
具体详细使用：https://github.com/ollama/ollama/blob/main/docs/api.md</p>
<p>这里写一下网上别人使用的记录：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl http://localhost:11434/api/generate -d <span style="color:#cd5555">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    &#34;model&#34;:&#34;llama3&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    &#34;prompt&#34;: &#34;请分别翻译成中文、韩文、日文 -&gt; Meta Llama 3: The most capable openly available LLM to date&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    &#34;stream&#34;: false
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其他详细的参数解释：https://ducafecat.medium.com/%E7%A7%81%E6%9C%89%E5%8C%96%E9%83%A8%E7%BD%B2-llama3-%E5%A4%A7%E6%A8%A1%E5%9E%8B-%E6%94%AF%E6%8C%81-api-%E8%AE%BF%E9%97%AE-9012e17d9400</p>
<p>返回json数据:</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;model&#34;</span>: <span style="color:#cd5555">&#34;llama3&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;created_at&#34;</span>: <span style="color:#cd5555">&#34;2024-04-23T08:05:11.020314Z&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;response&#34;</span>: <span style="color:#cd5555">&#34;Here are the translations:\n\n**Chinese:** 《Meta Llama 3》：迄今最强大的公开可用的LLM\n\n**Korean:** 《Meta Llama 3》：현재 가장 강력한 공개 사용 가능한 LLM\n\n**Japanese:**\n\n《Meta Llama 3》：現在最強の公開使用可能なLLM\n\n\n\nNote: (Meta Llama 3) is a literal translation, as there is no direct equivalent for \&#34;Meta\&#34; in Japanese. In Japan, it&#39;s common to use the English term \&#34;\&#34; or \&#34;\&#34; when referring to Meta.&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;done&#34;</span>: <span style="color:#8b008b;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;context&#34;</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#a61717;background-color:#e3d2d2">...</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;total_duration&#34;</span>: <span style="color:#b452cd">30786629492</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;load_duration&#34;</span>: <span style="color:#b452cd">3000782</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;prompt_eval_count&#34;</span>: <span style="color:#b452cd">32</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;prompt_eval_duration&#34;</span>: <span style="color:#b452cd">6142245000</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;eval_count&#34;</span>: <span style="color:#b452cd">122</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;eval_duration&#34;</span>: <span style="color:#b452cd">24639975000</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="vllm启动">vLLM启动</h4>
<p>vLLM优化了内存的分配和搬运，它易于使用，且具有最先进的服务吞吐量、高效的注意力键值内存管理（通过PagedAttention实现）、连续批处理输入请求、优化的CUDA内核等功能。要了解更多关于vLLM的信息。</p>
<p>文档：https://vllm.readthedocs.io/</p>
<blockquote>
<p>vLLM环境依赖</p>
</blockquote>
<p>vLLM对环境及GPU卡要求非常严格，支持<code>CUDA118+Pytroch212</code>和<code>CUDA121+Pytorch212</code>。
前者需要下载专门的pip包：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#228b22"># Install vLLM with CUDA 11.8.</span>
</span></span><span style="display:flex;"><span><span style="color:#658b00">export</span> <span style="color:#00688b">VLLM_VERSION</span>=0.4.0
</span></span><span style="display:flex;"><span><span style="color:#658b00">export</span> <span style="color:#00688b">PYTHON_VERSION</span>=<span style="color:#b452cd">39</span>
</span></span><span style="display:flex;"><span>pip install https://github.com/vllm-project/vllm/releases/download/v<span style="color:#cd5555">${</span><span style="color:#00688b">VLLM_VERSION</span><span style="color:#cd5555">}</span>/vllm-<span style="color:#cd5555">${</span><span style="color:#00688b">VLLM_VERSION</span><span style="color:#cd5555">}</span>+cu118-cp<span style="color:#cd5555">${</span><span style="color:#00688b">PYTHON_VERSION</span><span style="color:#cd5555">}</span>-cp<span style="color:#cd5555">${</span><span style="color:#00688b">PYTHON_VERSION</span><span style="color:#cd5555">}</span>-manylinux1_x86_64.whl --extra-index-url https://download.pytorch.org/whl/cu118
</span></span></code></pre></td></tr></table>
</div>
</div><p>后者则直接下载vllm即可：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install vllm
</span></span></code></pre></td></tr></table>
</div>
</div><p>目前在服务器上能够成功的Docker环境示例如下：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">FROM</span><span style="color:#cd5555"> nvidia/cuda:12.1.0-cudnn8-devel-ubuntu22.04</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 设置环境变量 非交互式</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">ENV</span> <span style="color:#00688b">DEBIAN_FRONTEND</span>=noninteractive
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 指定工作目录</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">WORKDIR</span><span style="color:#cd5555"> /model_infer</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 替换为阿里云的 Ubuntu 源</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> sed -i <span style="color:#cd5555">&#39;s/archive.ubuntu.com/mirrors.aliyun.com/g&#39;</span> /etc/apt/sources.list<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> sed -i <span style="color:#cd5555">&#39;s/security.ubuntu.com/mirrors.aliyun.com/g&#39;</span> /etc/apt/sources.list<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 更新其他必需的包</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> apt-get update &amp;&amp; apt-get install -y <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    zlib1g-dev <span style="color:#cd5555">\ </span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span>    libbz2-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libssl-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libncurses5-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libsqlite3-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libreadline-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    tk-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libgdbm-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libdb-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libpcap-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    xz-utils <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libexpat1-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    liblzma-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libffi-dev <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    libc6-dev<span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    wget <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    vim <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    curl<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 指定容器位置和时区</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#34;Asia/Shanghai&#34;</span> &gt; /etc/timezone<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 安装Python3.10</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> <span style="color:#658b00">cd</span> /usr/local &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    wget https://mirrors.huaweicloud.com/python/3.10.0/Python-3.10.0.tgz &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    chmod +x Python-3.10.0.tgz &amp;&amp; tar -xvf Python-3.10.0.tgz &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    rm -rf Python-3.10.0.tgz &amp;&amp; <span style="color:#658b00">cd</span> Python-3.10.0 &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    ./configure --prefix=/usr/local/python3 --enable-optimizations &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    make &amp;&amp; make install &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    rm -rf Python-3.10.0 &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    ln -s /usr/local/python3/bin/python3.10 /usr/bin/python3 &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    ln -s /usr/local/python3/bin/pip3 /usr/bin/pip3<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 替换为清华大学 pip 源</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> mkdir -p /root/.pip <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    &amp;&amp; <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#34;[global]&#34;</span> &gt; /root/.pip/pip.conf <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    &amp;&amp; <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#34;index-url = https://pypi.tuna.tsinghua.edu.cn/simple&#34;</span> &gt;&gt; /root/.pip/pip.conf <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    &amp;&amp; <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#34;trusted-host = pypi.tuna.tsinghua.edu.cn&#34;</span> &gt;&gt; /root/.pip/pip.conf<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 安装Pytorch</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> python3 -m pip install --upgrade pip &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    pip3 install <span style="color:#00688b">torch</span>==2.1.2 <span style="color:#00688b">torchvision</span>==0.16.2 <span style="color:#00688b">torchaudio</span>==2.1.2 --index-url https://mirror.sjtu.edu.cn/pytorch-wheels/cu121<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 安装相关的包</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> pip3 install transformers fastapi sse_starlette vllm accelerate openai<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 清除 pip 缓存</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> rm -rf /root/.cache/pip/*<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#228b22"># 设置容器的编码为UTF-8</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#8b008b;font-weight:bold">RUN</span> <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#39;LANG=en_US.UTF-8&#39;</span> &gt; /etc/locale.conf &amp;&amp; <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#39;LC_ALL=en_US.UTF-8&#39;</span> &gt;&gt; /etc/locale.conf<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>本地加载模型启动vLLM</p>
</blockquote>
<p>vLLM和Transformer启动模型的代码略有不同。</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">torch</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">transformers</span> <span style="color:#8b008b;font-weight:bold">import</span> AutoTokenizer
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">vllm</span> <span style="color:#8b008b;font-weight:bold">import</span> LLM, SamplingParams
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">threading</span> <span style="color:#8b008b;font-weight:bold">import</span> Thread
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">os</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">.model_zoo</span> <span style="color:#8b008b;font-weight:bold">import</span> *
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">.utils</span> <span style="color:#8b008b;font-weight:bold">import</span> highlight_text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">vllmQwen1_5</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> __init__(self, modelName) -&gt; <span style="color:#8b008b;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 检查是否支持模型</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">assert</span> modelName <span style="color:#8b008b">in</span> llm_weight_zoo, <span style="color:#cd5555">&#34;modelName should be in </span><span style="color:#cd5555">{}</span><span style="color:#cd5555">&#34;</span>.format(llm_weight_zoo.keys())
</span></span><span style="display:flex;"><span>        modelWeightPath = llm_weight_zoo[modelName]
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 检查本地是否下载模型</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">assert</span> os.path.exists(modelWeightPath), <span style="color:#cd5555">&#34;Model weight file: </span><span style="color:#cd5555">{}</span><span style="color:#cd5555"> &#34;</span>.format(modelWeightPath) + \
</span></span><span style="display:flex;"><span>                                                <span style="color:#cd5555">&#34;does not exist.</span><span style="color:#cd5555">\n</span><span style="color:#cd5555"> Please download </span><span style="color:#cd5555">{}</span><span style="color:#cd5555"> &#34;</span>.format(modelName) + \
</span></span><span style="display:flex;"><span>                                                <span style="color:#cd5555">&#34;model in &#34;</span> + \
</span></span><span style="display:flex;"><span>                                                highlight_text(<span style="color:#cd5555">&#34;&#39;</span><span style="color:#cd5555">{}</span><span style="color:#cd5555">&#39;&#34;</span>.format(llm_model_url_zoo[modelName]))
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 加载分词器</span>
</span></span><span style="display:flex;"><span>        self.tokenizer = AutoTokenizer.from_pretrained(modelWeightPath)
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 加载模型 Tesla T4需要使用float16 tokenizer=None会默认使用配套的标记器</span>
</span></span><span style="display:flex;"><span>        self.model = LLM(model=modelWeightPath, tokenizer=<span style="color:#8b008b;font-weight:bold">None</span>, 
</span></span><span style="display:flex;"><span>                         dtype=<span style="color:#cd5555">&#34;auto&#34;</span>, trust_remote_code=<span style="color:#8b008b;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>                         max_model_len=<span style="color:#b452cd">2048</span>)
</span></span><span style="display:flex;"><span>        self.device = torch.device(<span style="color:#cd5555">&#34;cuda&#34;</span> <span style="color:#8b008b;font-weight:bold">if</span> torch.cuda.is_available() <span style="color:#8b008b;font-weight:bold">else</span> <span style="color:#cd5555">&#34;cpu&#34;</span>)
</span></span><span style="display:flex;"><span>        self.model_name = modelName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">get_prompt</span>(self, user_message, system_message):
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> system_message == <span style="color:#cd5555">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>            system_message = <span style="color:#cd5555">&#34;You are a helpful assistant.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">assert</span> user_message != <span style="color:#8b008b;font-weight:bold">None</span>, <span style="color:#cd5555">&#34;我是</span><span style="color:#cd5555">{}</span><span style="color:#cd5555">大模型,你必须输入提问问题&#34;</span>.format(self.model_name)
</span></span><span style="display:flex;"><span>        messages = [
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;system&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: system_message},
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;user&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: user_message}
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">chat</span>(self, messages, max_tokens=<span style="color:#b452cd">2048</span>, temperature=<span style="color:#b452cd">0.9</span>, top_p=<span style="color:#b452cd">0.8</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#228b22"># 调用模型进行对话生成</span>
</span></span><span style="display:flex;"><span>        sampling_params = SamplingParams(temperature=temperature, top_p=top_p, max_tokens=max_tokens)
</span></span><span style="display:flex;"><span>        input_ids = self.tokenizer.apply_chat_template(messages, tokenize=<span style="color:#8b008b;font-weight:bold">False</span>, add_generation_prompt=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>        output = self.model.generate([input_ids], sampling_params)[<span style="color:#b452cd">0</span>]
</span></span><span style="display:flex;"><span>        response = output.outputs[<span style="color:#b452cd">0</span>].text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> response
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里并没有实现流式接口，对于模型启动的参数设置，可以参考文档：https://docs.vllm.ai/en/latest/models/engine_args.html</p>
<blockquote>
<p>本地启动模型加载openai API服务</p>
</blockquote>
<p>为了方便调用，vLLM包内部已经写好了调用api的服务，它的接口形式与OpenAI的接口格式是相同的。这样做的好处是本地私域大模型服务，也可以使用调用OpenAI接口的方式进行调用，更容易集成。</p>
<p>启动api：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#00688b">CUDA_VISIBLE_DEVICES</span>=<span style="color:#b452cd">0</span> <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>python3 -m vllm.entrypoints.openai.api_server <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--model ./data/model_zoo/llm_weight/qwen1.5-4b-chat <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--served-model-name qwen1.5-4b-chat <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--host 0.0.0.0 <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--port <span style="color:#b452cd">10005</span> <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--max-model-len <span style="color:#b452cd">2048</span> <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--dtype half <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--max-num-seqs <span style="color:#b452cd">256</span> <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--gpu-memory-utilization 0.9 <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--lora-dtype=<span style="color:#cd5555">&#34;auto&#34;</span> <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>--trust-remote-code
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里<code>dtype</code>参数设置为了<code>half</code>，是因为Tesla T4 GPU不支持Bfloat16的数据格式。更多的参数设置同样可以看模型启动的参数设置，与代码中的参数设置是相同的：https://docs.vllm.ai/en/latest/models/engine_args.html</p>
<blockquote>
<p>服务调用结果示例</p>
</blockquote>
<p>非流式调用：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;model&#34;</span>: <span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;messages&#34;</span>: [
</span></span><span style="display:flex;"><span>        {<span style="color:#8b008b;font-weight:bold">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;system&#34;</span>, <span style="color:#8b008b;font-weight:bold">&#34;content&#34;</span>: <span style="color:#cd5555">&#34;You are a helpful assistant.&#34;</span>},
</span></span><span style="display:flex;"><span>        {<span style="color:#8b008b;font-weight:bold">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;user&#34;</span>, <span style="color:#8b008b;font-weight:bold">&#34;content&#34;</span>: <span style="color:#cd5555">&#34;你好,请给我讲一个的故事&#34;</span>}
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;temperature&#34;</span>: <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用结果：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;id&#34;</span>: <span style="color:#cd5555">&#34;cmpl-6a53f4f0464c4088a55342a842927c64&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;object&#34;</span>: <span style="color:#cd5555">&#34;chat.completion&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;created&#34;</span>: <span style="color:#b452cd">1715152496</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;model&#34;</span>: <span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;choices&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;index&#34;</span>: <span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;message&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">&#34;content&#34;</span>: <span style="color:#cd5555">&#34;好的，我来给你讲一个故事。从前，有一个小村庄，村庄里的人们过着平静的生活。有一天，村庄里来了一位神秘的老人，他告诉村民们，村庄的水源将会被污染，只有找到一种神奇的草药，才能拯救村庄。村民们开始寻找这种草药，最后，他们找到了一种叫做“生命之草”的草药，用它净化了水源，村庄恢复了平静。&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;logprobs&#34;</span>: <span style="color:#8b008b;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;finish_reason&#34;</span>: <span style="color:#cd5555">&#34;stop&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">&#34;stop_reason&#34;</span>: <span style="color:#8b008b;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;usage&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;prompt_tokens&#34;</span>: <span style="color:#b452cd">26</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;total_tokens&#34;</span>: <span style="color:#b452cd">117</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">&#34;completion_tokens&#34;</span>: <span style="color:#b452cd">91</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>流式调用：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;model&#34;</span>: <span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;messages&#34;</span>: [
</span></span><span style="display:flex;"><span>        {<span style="color:#8b008b;font-weight:bold">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;system&#34;</span>, <span style="color:#8b008b;font-weight:bold">&#34;content&#34;</span>: <span style="color:#cd5555">&#34;You are a helpful assistant.&#34;</span>},
</span></span><span style="display:flex;"><span>        {<span style="color:#8b008b;font-weight:bold">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;user&#34;</span>, <span style="color:#8b008b;font-weight:bold">&#34;content&#34;</span>: <span style="color:#cd5555">&#34;你好,请给我讲一个的故事&#34;</span>}
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;temperature&#34;</span>: <span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&#34;stream&#34;</span>: <span style="color:#8b008b;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用结果：
<img src="https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/LLM/img53.jpg" alt=""></p>
<p>你也可以使用Python脚本来调用OpenAI的接口：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">requests</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">import</span> <span style="color:#008b45;text-decoration:underline">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>headers = {
</span></span><span style="display:flex;"><span>    <span style="color:#cd5555">&#34;Content-Type&#34;</span>: <span style="color:#cd5555">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">post</span>(url, json, headers):
</span></span><span style="display:flex;"><span>    response = requests.post(url, json=json, headers=headers)
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">def</span> <span style="color:#008b45">streamPost</span>(url, json, headers):
</span></span><span style="display:flex;"><span>    response = requests.post(url, json=json, headers=headers, stream=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">if</span> __name__ == <span style="color:#cd5555">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    ip = <span style="color:#cd5555">&#34;localhost&#34;</span>
</span></span><span style="display:flex;"><span>    port = <span style="color:#b452cd">10005</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sys_prompt = <span style="color:#cd5555">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    你是一个乐于助人的助手
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    prompt = <span style="color:#cd5555">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    请给我讲一个故事
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    body = {
</span></span><span style="display:flex;"><span>        <span style="color:#cd5555">&#34;model&#34;</span>: <span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#cd5555">&#34;messages&#34;</span>: [
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;system&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: sys_prompt},
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;user&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: prompt}
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        <span style="color:#cd5555">&#34;temperature&#34;</span>: <span style="color:#b452cd">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stream_body = {
</span></span><span style="display:flex;"><span>        <span style="color:#cd5555">&#34;model&#34;</span>: <span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#cd5555">&#34;messages&#34;</span>: [
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;system&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: sys_prompt},
</span></span><span style="display:flex;"><span>            {<span style="color:#cd5555">&#34;role&#34;</span>: <span style="color:#cd5555">&#34;user&#34;</span>, <span style="color:#cd5555">&#34;content&#34;</span>: prompt}
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        <span style="color:#cd5555">&#34;temperature&#34;</span>: <span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#cd5555">&#34;stream&#34;</span>: <span style="color:#8b008b;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    url = <span style="color:#cd5555">f</span><span style="color:#cd5555">&#34;http://</span><span style="color:#cd5555">{</span>ip<span style="color:#cd5555">}</span><span style="color:#cd5555">:</span><span style="color:#cd5555">{</span>port<span style="color:#cd5555">}</span><span style="color:#cd5555">/v1/chat/completions&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#228b22"># 发送 POST 请求</span>
</span></span><span style="display:flex;"><span>    response = post(url, json=body, headers=headers)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22"># 解析响应</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> response.status_code == <span style="color:#b452cd">200</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#658b00">print</span>(<span style="color:#cd5555">&#34;Return:&#34;</span>, response.text)
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#658b00">print</span>(<span style="color:#cd5555">&#34;Error:&#34;</span>, response.text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22"># 发送stream Post 请求</span>
</span></span><span style="display:flex;"><span>    response = streamPost(url, json=stream_body, headers=headers)
</span></span><span style="display:flex;"><span>    full_text = <span style="color:#cd5555">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">for</span> line <span style="color:#8b008b">in</span> response.iter_lines():
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">if</span> line:
</span></span><span style="display:flex;"><span>            line_str = line.decode(<span style="color:#cd5555">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#658b00">print</span>(line_str)
</span></span><span style="display:flex;"><span>            data = json.loads(line_str.split(<span style="color:#cd5555">&#34;: &#34;</span>, <span style="color:#b452cd">1</span>)[<span style="color:#b452cd">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">if</span> data[<span style="color:#cd5555">&#34;choices&#34;</span>][<span style="color:#b452cd">0</span>][<span style="color:#cd5555">&#34;finish_reason&#34;</span>] != <span style="color:#cd5555">&#34;stop&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">if</span> data[<span style="color:#cd5555">&#34;choices&#34;</span>][<span style="color:#b452cd">0</span>][<span style="color:#cd5555">&#34;delta&#34;</span>].get(<span style="color:#cd5555">&#34;content&#34;</span>) <span style="color:#8b008b">is</span> <span style="color:#8b008b">not</span> <span style="color:#8b008b;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>                    full_text += data[<span style="color:#cd5555">&#34;choices&#34;</span>][<span style="color:#b452cd">0</span>][<span style="color:#cd5555">&#34;delta&#34;</span>][<span style="color:#cd5555">&#34;content&#34;</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#8b008b;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#658b00">print</span>(<span style="color:#cd5555">&#34;大模型完整回答：</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#34;</span>, full_text)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="skypilot部署">SkyPilot部署</h4>
<p><code>SkyPilot</code>是一个可以在任何云上运行LLM、AI应用以及批量任务的框架，旨在实现最大程度的成本节省、最高的GPU可用性以及受管理的执行过程。其特性包括：</p>
<ul>
<li>
<p>通过跨区域和跨云充分利用多个资源池，以获得最佳的GPU可用性。</p>
</li>
<li>
<p>把费用降到最低—— SkyPilot在各区域和云平台中为您挑选最便宜的资源。无需任何托管解决方案的额外加价。</p>
</li>
<li>
<p>将服务扩展到多个副本上，所有副本通过单一endpoint对外提供服务</p>
</li>
<li>
<p>所有内容均保存在您的云账户中（包括您的虚拟机和bucket）</p>
</li>
<li>
<p>完全私密 - 没有其他人能看到您的聊天记录</p>
</li>
</ul>
<blockquote>
<p>安装SkyPilot</p>
</blockquote>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install <span style="color:#cd5555">&#34;skypilot-nightly[aws,gcp]&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查是否可用</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sky check
</span></span></code></pre></td></tr></table>
</div>
</div><p>你也参考官方文档：https://skypilot.readthedocs.io/en/latest/getting-started/installation.html</p>
<blockquote>
<p>运行Qwen1.5-72B-Chat</p>
</blockquote>
<ol>
<li>可以使用 serve-72b.yaml 中的可用的 GPU 来在单个实例上部署 Qwen1.5-72B-Chat的基于vLLM的适配OpenAI API的服务</li>
</ol>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sky launch -c qwen serve-72b.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>向该endpoint发送<code>续写</code>请求：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#00688b">IP</span>=<span style="color:#8b008b;font-weight:bold">$(</span>sky status --ip qwen<span style="color:#8b008b;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -L http://<span style="color:#00688b">$IP</span>:8000/v1/completions <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    -H <span style="color:#cd5555">&#34;Content-Type: application/json&#34;</span> <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    -d <span style="color:#cd5555">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">      &#34;model&#34;: &#34;Qwen/Qwen1.5-72B-Chat&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">      &#34;prompt&#34;: &#34;My favorite food is&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">      &#34;max_tokens&#34;: 512
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">  }&#39;</span> | jq -r <span style="color:#cd5555">&#39;.choices[0].text&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>向该endpoint发送<code>chat</code>请求</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -L http://<span style="color:#00688b">$IP</span>:8000/v1/chat/completions <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    -H <span style="color:#cd5555">&#34;Content-Type: application/json&#34;</span> <span style="color:#cd5555">\
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span>    -d <span style="color:#cd5555">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">      &#34;model&#34;: &#34;Qwen/Qwen1.5-72B-Chat&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">      &#34;messages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">        {
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">          &#34;role&#34;: &#34;system&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">          &#34;content&#34;: &#34;You are a helpful and honest chat expert.&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">        },
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">        {
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">          &#34;role&#34;: &#34;user&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">          &#34;content&#34;: &#34;What is the best food?&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">        }
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">      ],
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">      &#34;max_tokens&#34;: 512
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">  }&#39;</span> | jq -r <span style="color:#cd5555">&#39;.choices[0].message.content&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="第三方llm框架接入">第三方LLM框架接入</h3>
<p>目前使用大模型做应用的成熟框架有两款：<code>LangChain</code>以及<code>llama_index</code>。</p>
<p><code>LangChain</code>相对使用更为广泛，代码更新频率相对较慢，功能范围更广泛。
<code>llama_index</code>使用并没有那么广泛，代码更新频率很快，支持的东西更细致，集成度更高，其本身也兼容了<code>LangChain</code>的部分功能，文档更加细致。</p>
<p>LangChain官方文档：https://python.langchain.com/docs/get_started/introduction
llama_index官方文档：https://docs.llamaindex.ai/en/stable</p>
<h4 id="langchain-llama_index本地启动模型">LangChain, llama_index本地启动模型</h4>
<p><code>LangChain</code>和<code>llama_index</code>都支持本地加载模型做对应的应用。其也支持不同的启动框架，包括<code>原生Transformers</code>，<code>llama.cpp</code>，<code>Ollama</code>以及<code>vLLM</code>等。</p>
<p>具体实现请查看其官方文档。</p>
<h4 id="langchain-llama_index调用本地openai接口服务">Langchain, llama_index调用本地OpenAI接口服务</h4>
<p>由于GPU资源有限，对于大模型服务通常会使用并发框架<code>vLLM</code>单独封装启动OpenAI格式的接口，上层应用调用下层暴露的接口。</p>
<blockquote>
<p>LangChain调用</p>
</blockquote>
<p>使用<code>ChatOpenAI</code>函数：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain.prompts</span> <span style="color:#8b008b;font-weight:bold">import</span> PromptTemplate
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_openai</span> <span style="color:#8b008b;font-weight:bold">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_community.llms</span> <span style="color:#8b008b;font-weight:bold">import</span> VLLMOpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>template = <span style="color:#cd5555">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">你是一名NLP算法工程师，现在你需要执行一个信息概述的任务：根据用户输入的产品相关信息，总结生成一段该产品的介绍性话术。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">为了得到符合要求的答案，请按照下面的过程，一步步思考并得出回答：
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">1、观察以下话术样例，学习产品介绍性话术的描述方式：[和对讲是融合集群调度和视频能力的公网对讲产品，依托于中国移动通信网络面向用户提供无距离限制、安全可靠、低时延的超高清视频对讲服务具备灵活组织架构管理、地图可视化调度、软硬终端互通、数据云化备份等优势可根据客户需求进行入驻式和定制化开发，为行业用户提供全方位综合调度管理系统。]。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">2、你会拿到产品名称、产品简介、产品应用场景、产品功能、产品优势信息这六个字段信息，你需要逐字逐句的阅读过去，了解该产品的全貌信息。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">3、仿造第1步的话术描述方式，结合你拿到的产品信息，用你自己的语言生成一段针对该产品的介绍性话术。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">4、使用第三步生成的话术，进行精简润色，最终压缩到200字以内。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">最后强调一下：生成的答案必须严格经过这三个步骤，且严格限制只能使用我提供给你的信息，严禁生成额外信息。
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">% USER INPUT:
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555"></span><span style="color:#cd5555">{user_input}</span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">YOUR RESPONSE:
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 将我们的格式描述嵌入到prompt中去，告诉llm我们需要他输出什么样格式的内容</span>
</span></span><span style="display:flex;"><span>prompt = PromptTemplate(
</span></span><span style="display:flex;"><span>    input_variables=[<span style="color:#cd5555">&#34;user_input&#34;</span>],
</span></span><span style="display:flex;"><span>    template=template
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>llm = ChatOpenAI(
</span></span><span style="display:flex;"><span>    openai_api_key=<span style="color:#cd5555">&#34;EMPTY&#34;</span>,
</span></span><span style="display:flex;"><span>    openai_api_base=<span style="color:#cd5555">&#34;http://20.20.136.251:10005/v1&#34;</span>,
</span></span><span style="display:flex;"><span>    model_name=<span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>    temperature=<span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>    streaming=<span style="color:#8b008b;font-weight:bold">True</span> 
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 使用这种接口输出的格式与上述函数是相同的</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># llm = VLLMOpenAI(</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">#     openai_api_key=&#34;EMPTY&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">#     openai_api_base=&#34;http://20.20.136.251:10005/v1&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">#     model_name=&#34;qwen1.5-4b-chat&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">#     temperature=0.8,</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22">#     streaming=True,</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>llm_chain = LLMChain(prompt=prompt, llm=llm)
</span></span><span style="display:flex;"><span>user_input = <span style="color:#cd5555">&#34;产品名称：商务快线。产品简介：商务快线是指以有线方式提供的、面向中小企业客户的互联网宽带接入服务。其满足客户对静态IP需求的同时，可提供多种增值业务，一站式解决企业客户多种信息化需求。产品应用场景：（高端酒店、商务楼宇、产业园区）。产品功能：（提供千兆宽带高速上网，多样化实惠套餐，以及专席客服保障的高品质服务。）。产品优势信息：（提供静态IP的大宽带网络接入，确保流畅上网体验，并以网络接入为基础，提供一站式解决方案，覆盖公共WiFi、语音通话、娱乐、安全、监控和企业办公等多样化需求。）。请针对以上产品，生成一段200字以内的介绍性话术。&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#658b00">print</span>(llm_chain.invoke(user_input))
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出结果：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>{<span style="color:#cd5555">&#39;user_input&#39;</span>: <span style="color:#cd5555">&#39;产品名称：商务快线。产品简介：商务快线是指以有线方式提供的、面向中小企业客户的互联网宽带接入服务。其满足客户对静态IP需求的同时，可提供多种增值业务，一站式解决企业客户多种信息化需求。产品应用场景：（高端酒店、商务楼宇、产业园区）。产品功能：（提供千兆宽带高速上网，多样化实惠套餐，以及专席客服保障的高品质服务。）。产品优势信息：（提供静态IP的大宽带网络接入，确保流畅上网体验，并以网络接入为基础，提供一站式解决方案，覆盖公共WiFi、语音通话、娱乐、安全、监控和企业办公等多样化需求。）。请针对以上产品，生成一段200字以内的介绍性话术。&#39;</span>, <span style="color:#cd5555">&#39;text&#39;</span>: <span style="color:#cd5555">&#39;商务快线是面向中小企业客户的互联网宽带接入服务，以有线方式提供，满足客户对静态IP的需求，同时提供多种增值业务，一站式解决企业客户多种信息化需求。其应用场景广泛，包括高端酒店、商务楼宇、产业园区等。商务快线提供千兆宽带高速上网，多样化实惠套餐，以及专席客服保障的高品质服务。商务快线的优势在于，它提供静态IP的大宽带网络接入，确保流畅上网体验，并以网络接入为基础，提供一站式解决方案，覆盖公共WiFi、语音通话、娱乐、安全、监控和企业办公等多样化需求。&#39;</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>你也可以直接使用llm的流式输出接口：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_openai</span> <span style="color:#8b008b;font-weight:bold">import</span> ChatOpenAI
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">langchain_community.llms</span> <span style="color:#8b008b;font-weight:bold">import</span> VLLMOpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>llm = ChatOpenAI(
</span></span><span style="display:flex;"><span>    openai_api_key=<span style="color:#cd5555">&#34;EMPTY&#34;</span>,
</span></span><span style="display:flex;"><span>    openai_api_base=<span style="color:#cd5555">&#34;http://20.20.136.251:10005/v1&#34;</span>,
</span></span><span style="display:flex;"><span>    model_name=<span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>    temperature=<span style="color:#b452cd">0</span>,
</span></span><span style="display:flex;"><span>    streaming=<span style="color:#8b008b;font-weight:bold">True</span> 
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>messages = [
</span></span><span style="display:flex;"><span>    (<span style="color:#cd5555">&#34;system&#34;</span>, <span style="color:#cd5555">&#34;你是编程助手。&#34;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#cd5555">&#34;human&#34;</span>, <span style="color:#cd5555">&#34;把下面这句代码写一下注释：print(&#39;你好&#39;)&#34;</span>),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#658b00">print</span>(llm.invoke(messages)) <span style="color:#228b22"># 普通输出</span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 流式输出</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">for</span> chunk <span style="color:#8b008b">in</span> llm.stream(messages):
</span></span><span style="display:flex;"><span>    <span style="color:#658b00">print</span>(chunk)
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出内容：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;```python\n# 这是Python语言的print函数，用于在控制台输出文本\nprint(\&#39;</span>你好<span style="color:#cd5555">\&#39;</span>)<span style="color:#cd5555">\n</span><span style="color:#cd5555">```</span><span style="color:#cd5555">\n\n</span>这段代码的作用是在控制台输出字符串 <span style="color:#cd5555">&#34;你好&#34;</span>。<span style="color:#cd5555">&#39; response_metadata={&#39;</span>finish_reason<span style="color:#cd5555">&#39;: &#39;</span>stop<span style="color:#cd5555">&#39;} id=&#39;</span>run-8e6c2718-d53f-4693-9bd3-25fa70c36bdd-0<span style="color:#cd5555">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">content=&#39;&#39; id=&#39;</span>run-70885497-4254-4dca-a50e-c0a376165907<span style="color:#cd5555">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">content=&#39;</span><span style="color:#cd5555">```</span><span style="color:#cd5555">&#39; id=&#39;</span>run-70885497-4254-4dca-a50e-c0a376165907<span style="color:#cd5555">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">content=&#39;</span>python<span style="color:#cd5555">&#39; id=&#39;</span>run-70885497-4254-4dca-a50e-c0a376165907<span style="color:#cd5555">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">content=&#39;</span><span style="color:#cd5555">\n</span><span style="color:#cd5555">&#39; id=&#39;</span>run-70885497-4254-4dca-a50e-c0a376165907<span style="color:#cd5555">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#cd5555">content=&#39;</span><span style="color:#228b22">#&#39; id=&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39; 这&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;是&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;Python&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;语言&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;的&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;print&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;函数&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;，&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;用于&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;在&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;控制&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;台&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;输出&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;文本&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;\n&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;print&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#34;(&#39;&#34;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;你好&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#34;&#39;)\n&#34;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;``&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;`\n\n&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;这段&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;代码&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;的作用&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;是在&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;控制&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;台&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;输出&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;字符串&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39; &#34;&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;你好&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;&#34;&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;。&#39;</span> <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#00688b">content</span>=<span style="color:#cd5555">&#39;&#39;</span> <span style="color:#00688b">response_metadata</span>={<span style="color:#cd5555">&#39;finish_reason&#39;</span>: <span style="color:#cd5555">&#39;stop&#39;</span>} <span style="color:#00688b">id</span>=<span style="color:#cd5555">&#39;run-70885497-4254-4dca-a50e-c0a376165907&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>llama_index调用</p>
</blockquote>
<p>llama_index调用OpenAI的接口都使用<code>OpenAILike</code>模块：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">llama_index.llms.openai_like</span> <span style="color:#8b008b;font-weight:bold">import</span> OpenAILike
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">from</span> <span style="color:#008b45;text-decoration:underline">llama_index.llms</span> <span style="color:#8b008b;font-weight:bold">import</span> ChatMessage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>llm3 = OpenAILike(
</span></span><span style="display:flex;"><span>    model=<span style="color:#cd5555">&#34;qwen1.5-4b-chat&#34;</span>,
</span></span><span style="display:flex;"><span>    api_base=<span style="color:#cd5555">&#34;http://20.20.136.251:10005/v1&#34;</span>, 
</span></span><span style="display:flex;"><span>    api_key=<span style="color:#cd5555">&#34;EMPTY&#34;</span>,
</span></span><span style="display:flex;"><span>    is_chat_model=<span style="color:#8b008b;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>    temperature=<span style="color:#cd5555">&#34;0.8&#34;</span>,
</span></span><span style="display:flex;"><span>    timeout=<span style="color:#b452cd">60</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>messages_2 = [
</span></span><span style="display:flex;"><span>                ChatMessage(role=<span style="color:#cd5555">&#34;system&#34;</span>, content=<span style="color:#cd5555">&#34;You are a helpful assistant.&#34;</span>),  
</span></span><span style="display:flex;"><span>                ChatMessage(role=<span style="color:#cd5555">&#34;user&#34;</span>, content=<span style="color:#cd5555">&#34;你好，请给我讲一个故事&#34;</span>),
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response = llm3.chat(messages=messages_2)
</span></span><span style="display:flex;"><span><span style="color:#658b00">print</span>(response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 流式输出</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">for</span> chunk <span style="color:#8b008b">in</span> llm3.stream_chat(messages=messages_2):
</span></span><span style="display:flex;"><span>    <span style="color:#658b00">print</span>(chunk, flush=<span style="color:#8b008b;font-weight:bold">True</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用结果：</p>
<div class="highlight"><div style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#228b22"># 非流式</span>
</span></span><span style="display:flex;"><span>assistant: 好的，我来给你讲一个故事吧。从前，有一只小猫，他很聪明，也很勇敢。有一天，小猫决定去森林探险，他遇到了一只凶猛的老虎，但是小猫没有害怕，他用智慧和勇气战胜了老虎。最后，小猫成功地回到了家。
</span></span><span style="display:flex;"><span><span style="color:#228b22"># 流式</span>
</span></span><span style="display:flex;"><span>assistant: 
</span></span><span style="display:flex;"><span>assistant: 当然
</span></span><span style="display:flex;"><span>assistant: 当然可以
</span></span><span style="display:flex;"><span>assistant: 当然可以，
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>从前
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>从前，
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>从前，有一个
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>从前，有一个男孩
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>从前，有一个男孩叫
</span></span><span style="display:flex;"><span>assistant: 当然可以，以下是一个故事的开始：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>从前，有一个男孩叫杰
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>目前llama_index的流式调用输出很怪，后续会继续修改！</em></p>

                    
                    <HR width="100%" id="EOF">
		            <p style="color:#777;">最后修改于 2024-05-07</p>
                    
                    
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20210508215939.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
			下回<br>已经到头啦。
                </a>
                
                
                
                <a class="older-posts" href="https://caixiongjiang.github.io/blog/2024/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8/vllm%E5%B9%B6%E5%8F%91/">
			上回<br>vLLM如何提高并发？
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                








<div id="tcomment"></div>



            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
魔改自 <a href="https://github.com/riba2534/hugo-blog">Riba2534</a> by <a href="https://caixiongjiang.github.io">Jarson Cai</a>
<br>

&copy;
	
	2024 🌀Jarson Cai&#39;s Blog
	</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            },
            debounce(func, wait, options) {
                let lastArgs,
                    lastThis,
                    maxWait,
                    result,
                    timerId,
                    lastCallTime

                let lastInvokeTime = 0
                let leading = false
                let maxing = false
                let trailing = true

                
                const useRAF = (!wait && wait !== 0 && typeof root.requestAnimationFrame === 'function')

                if (typeof func !== 'function') {
                    throw new TypeError('Expected a function')
                }
                function isObject(value) {
                    const type = typeof value
                    return value != null && (type === 'object' || type === 'function')
                }

                wait = +wait || 0
                if (isObject(options)) {
                    leading = !!options.leading
                    maxing = 'maxWait' in options
                    maxWait = maxing ? Math.max(+options.maxWait || 0, wait) : maxWait
                    trailing = 'trailing' in options ? !!options.trailing : trailing
                }

                function invokeFunc(time) {
                    const args = lastArgs
                    const thisArg = lastThis

                    lastArgs = lastThis = undefined
                    lastInvokeTime = time
                    result = func.apply(thisArg, args)
                    return result
                }

                function startTimer(pendingFunc, wait) {
                    if (useRAF) {
                    root.cancelAnimationFrame(timerId)
                    return root.requestAnimationFrame(pendingFunc)
                    }
                    return setTimeout(pendingFunc, wait)
                }

                function cancelTimer(id) {
                    if (useRAF) {
                    return root.cancelAnimationFrame(id)
                    }
                    clearTimeout(id)
                }

                function leadingEdge(time) {
                    
                    lastInvokeTime = time
                    
                    timerId = startTimer(timerExpired, wait)
                    
                    return leading ? invokeFunc(time) : result
                }

                function remainingWait(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime
                    const timeWaiting = wait - timeSinceLastCall

                    return maxing
                    ? Math.min(timeWaiting, maxWait - timeSinceLastInvoke)
                    : timeWaiting
                }

                function shouldInvoke(time) {
                    const timeSinceLastCall = time - lastCallTime
                    const timeSinceLastInvoke = time - lastInvokeTime

                    
                    
                    
                    return (lastCallTime === undefined || (timeSinceLastCall >= wait) ||
                    (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait))
                }

                function timerExpired() {
                    const time = Date.now()
                    if (shouldInvoke(time)) {
                    return trailingEdge(time)
                    }
                    
                    timerId = startTimer(timerExpired, remainingWait(time))
                }

                function trailingEdge(time) {
                    timerId = undefined

                    
                    
                    if (trailing && lastArgs) {
                    return invokeFunc(time)
                    }
                    lastArgs = lastThis = undefined
                    return result
                }

                function cancel() {
                    if (timerId !== undefined) {
                    cancelTimer(timerId)
                    }
                    lastInvokeTime = 0
                    lastArgs = lastCallTime = lastThis = timerId = undefined
                }

                function flush() {
                    return timerId === undefined ? result : trailingEdge(Date.now())
                }

                function pending() {
                    return timerId !== undefined
                }

                function debounced(...args) {
                    const time = Date.now()
                    const isInvoking = shouldInvoke(time)

                    lastArgs = args
                    lastThis = this
                    lastCallTime = time

                    if (isInvoking) {
                    if (timerId === undefined) {
                        return leadingEdge(lastCallTime)
                    }
                    if (maxing) {
                        
                        timerId = startTimer(timerExpired, wait)
                        return invokeFunc(lastCallTime)
                    }
                    }
                    if (timerId === undefined) {
                    timerId = startTimer(timerExpired, wait)
                    }
                    return result
                }
                debounced.cancel = cancel
                debounced.flush = flush
                debounced.pending = pending
                return debounced
                }

    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
        
        
            twikoo.init({
                envId: "https://twikoo-rho-olive.vercel.app/",
                el: '#tcomment',
                region:  null ,
            });
        

        document.querySelectorAll("table").forEach(function(elem){
            elem.classList.add("table-striped");
            elem.classList.add("table");
            elem.classList.add("table-responsive");
            elem.classList.add("table-hover");
        })

        
        spy();
        window.addEventListener('scroll', this.debounce(spy, 250, { 'maxWait': 250 }), false);
        
        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});



</script>
    </body>
</html>
